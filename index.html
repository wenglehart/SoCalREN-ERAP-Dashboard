<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>SoCalREN's ERAP Dashboard</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto:wght@300;400&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css" type="text/css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        header {
            width: 100%;
            background: linear-gradient(to right, #2c3e50, #3498db);
            color: #ecf0f1;
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            height: 60px;
            box-sizing: border-box;
        }
        .header-left {
            flex: 0 0 auto;
        }
        .header-left h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 20px;
            margin: 0;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
            justify-content: flex-end;
            max-width: 800px;
            margin-left: 40px;
        }
        .geocoder-container {
            flex: 1;
            max-width: 400px;
            min-width: 200px;
        }
        .style-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 4px;
        }
        .style-selector label {
            font-size: 14px;
            white-space: nowrap;
        }
        .style-selector select {
            background-color: transparent;
            color: #ecf0f1;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        .style-selector select:hover {
            border-color: rgba(255, 255, 255, 0.5);
        }
        .style-selector select option {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        .mapboxgl-ctrl-geocoder {
            box-shadow: none !important;
            width: 100% !important;
            max-width: none !important;
            font-family: 'Montserrat', sans-serif !important;
            border-radius: 4px;
        }
        .mapboxgl-ctrl-geocoder--input {
            height: 36px !important;
            padding: 6px 35px !important;
        }
        #container {
            flex: 1;
            display: flex;
            flex-direction: row;
            position: relative;
            overflow: hidden;
            height: calc(100vh - 60px);
        }
        #map {
            position: relative;
            flex: 3;
            min-height: 400px;
            width: 100%;
        }
        .map-overlay {
            position: relative;
            flex: 1;
            font: 14px/22px 'Roboto', sans-serif;
            background: linear-gradient(to bottom, #fff, #f8f9fa);
            border-left: 1px solid rgba(0,0,0,0.1);
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        fieldset {
            background: #f0f0f0;
            border: none;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        input[type="text"], input[type="number"], input[type="range"] {
            border: 1px solid #ccc;
            width: 100%;
            border-radius: 5px;
            padding: 8px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        #agency-filter {
            position: relative;
        }
        #agency-suggestions {
            position: absolute;
            background: #fff;
            border: 1px solid #ccc;
            width: calc(100% - 16px);
            margin: 0;
            padding: 0;
            list-style: none;
            max-height: 150px;
            overflow-y: auto;
            z-index: 9999;
        }
        #agency-suggestions li {
            padding: 8px;
            cursor: pointer;
        }
        #agency-suggestions li:hover {
            background: #e0f7fa;
            color: #00796b;
        }
        .listing {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        .listing a {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            color: #404;
            text-decoration: none;
            display: block;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
            font-size: 14px;
        }
        .facilities-container {
            position: relative;
            z-index: 2;
            margin-top: 10px;
            display: block;
            max-height: none;
            overflow-y: visible;
        }

        #listing {
            position: relative;
            height: auto;
            min-height: 200px;
            max-height: none;
            overflow-y: visible;
            padding: 10px;
            margin-top: 10px;
        }
        .listing a:hover {
            background: #e0f7fa;
            color: #00796b;
        }
        .filters {
            margin-bottom: 10px;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        .filters label {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .filters input[type=checkbox] {
            margin-right: 5px;
        }
        .filters select {
            width: 100%;
            margin-bottom: 10px;
            font-size: 12px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .dashboard {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 30px;
            font-size: 14px;
            margin-top: 20px;
            height: auto;
            overflow-y: visible;
        }

        .dashboard::-webkit-scrollbar {
            width: 8px;
        }

        .dashboard::-webkit-scrollbar-track {
            background: #f5f6fa;
            border-radius: 4px;
        }

        .dashboard::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 4px;
        }

        .dashboard h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 20px;
            margin-top: 0;
            padding-bottom: 15px;
            margin-bottom: 25px;
            border-bottom: 2px solid #ecf0f1;
            font-weight: bold;
            color: #2c3e50;
        }

        .dashboard h4 {
            margin-top: 30px;
            margin-bottom: 20px;
            font-size: 16px;
            color: #34495e;
        }

        .metric {
            margin-bottom: 20px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #agency-data, #facility-data {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }

        #back-button {
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            transition: background-color 0.2s ease;
        }

        #back-button:hover {
            background-color: #34495e;
        }

        #back-button::before {
            content: "←";
            font-size: 16px;
        }

        .cog-section {
            margin-bottom: 10px;
        }
        .cog-header {
            background: #2c3e50;
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
            color: #ffffff;
            margin-bottom: 8px;
        }
        .cog-header::after {
            content: '▼';
            font-size: 12px;
            color: #ffffff;
            transition: transform 0.3s ease;
            margin-left: 10px;
            opacity: 0.9;
        }
        .cog-header.expanded::after {
            transform: rotate(180deg);
        }
        .cog-header:hover {
            background: #34495e;
        }
        .agency-list {
            margin-top: 5px;
            margin-bottom: 15px;
            padding-left: 10px;
            height: auto;
            overflow-y: visible;
        }
        .agency-title {
            font-size: 14px;
            font-weight: normal;
            margin: 5px 0;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s ease;
            color: #2c3e50;
            background: #f8f9fa;
        }
        .agency-title:hover {
            background: #e0f7fa;
            color: #00796b;
            transform: translateX(5px);
        }
        .facility-title {
            display: block;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: #2c3e50;
            text-decoration: none;
            border: 1px solid #e9ecef;
        }

        .facility-title:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        #listing {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            margin-top: 10px;
        }

        /* Add this to ensure facility titles are visible */
        #listing h4 {
            margin: 10px 0;
            color: #2c3e50;
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            color: #2c3e50;
            margin: 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            font-weight: bold;
        }

        /* Style for when no facilities are found */
        #no-facilities-msg {
            padding: 10px;
            color: #666;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 4px;
            margin: 10px 0;
        }

        .style-overlay {
            background-color: #34495e;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #ecf0f1;
            margin-right: 10px;
        }
        .style-overlay label {
            display: block;
            margin-bottom: 5px;
            font-weight: normal;
        }
        .style-overlay select {
            width: 100%;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            color: #000;
        }
        #welcome-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(44, 62, 80, 0.90);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.4s ease;
            backdrop-filter: blur(5px);
        }

        #welcome-popup.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        #welcome-popup .welcome-content {
            background: white;
            padding: 60px 70px;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            text-align: center;  /* Center all content */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            position: relative;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        #welcome-popup h1 {
            font-family: 'Nunito', sans-serif;
            font-size: 23px;
            margin-bottom: 30px;
            color: #2c3e50;  /* dark navy */
            line-height: 1.4;
            font-weight: 700;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 20px;
        }

        #welcome-popup h1 .title-line {
            display: block;
            margin-bottom: 5px;
        }

        #welcome-popup h2 {
            font-family: 'Nunito', sans-serif;
            font-size: 22px;  /* Increased from 22px */
            color: #ff9800;  /* orange */
            margin: 30px 0 25px;
            font-weight: 600;
            line-height: 1.4;
            text-align: center;  /* Center the subtitle */
        }

        #welcome-popup p {
            font-family: 'Nunito', sans-serif;
            font-size: 17px;
            margin-bottom: 25px;
            color: #546e7a;
            line-height: 1.8;
            font-weight: 400;
            text-align: center;
            max-width: 650px;  /* Limit line length for better readability */
            margin-left: auto;  /* Center the paragraph block */
            margin-right: auto;
        }

        #welcome-popup button {
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 17px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Nunito', sans-serif;
            display: block;
            margin: 40px auto 0;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        #welcome-popup button:hover {
            background-color: #34495e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #welcome-popup button:active {
            transform: translateY(0);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #welcome-popup .welcome-content {
                padding: 40px;
                width: 85%;
            }

            #welcome-popup h1 {
                font-size: 28px;
            }

            #welcome-popup h2 {
                font-size: 20px;
            }

            #welcome-popup p {
                font-size: 16px;
            }

            #welcome-popup button {
                padding: 14px 35px;
                font-size: 16px;
            }
        }
        /* Responsive styling */
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            #map {
                flex: none;
                height: 50vh;
            }
            .map-overlay {
                position: relative;
                transform: none !important;
            }
        }

        /* Intro section (revised to "Welcome to SoCalREN's ERAP Dashboard") */
        #intro-section {
            margin-top: 20px;
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            display: none; /* Start hidden and show only when agencies are listed */
        }
        #intro-section h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-family: 'Montserrat', sans-serif;
            color: #2c3e50;
        }
        #intro-section p {
            margin: 0 0 15px 0;
            font-size: 14px;
            line-height: 1.6;
            color: #34495e;
        }
        #intro-section ul {
            list-style: inside square;
            margin: 0 0 15px 0;
            padding: 0;
        }   
        #intro-section li {
            margin-bottom: 8px;
            font-size: 14px;
            color: #34495e;
        }

        .facility-popup .mapboxgl-popup-content {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-family: 'Montserrat', sans-serif;
            font-size: 13px;
            line-height: 1.4;
        }

        .facility-popup .mapboxgl-popup-tip {
            border-top-color: rgba(255, 255, 255, 0.95);
        }

        .facility-title.active {
            background: #fff3e0;
            border-left: 3px solid #ff9800;
            transform: translateX(5px);
        }

        .mapboxgl-ctrl-geocoder {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            font-family: 'Montserrat', sans-serif !important;
        }

        .mapboxgl-ctrl-geocoder--input {
            font-family: 'Roboto', sans-serif !important;
        }

        .mapboxgl-ctrl-geocoder--suggestion {
            font-family: 'Roboto', sans-serif !important;
        }

        .fullscreen-container {
            margin-left: 10px;
        }

        .mapboxgl-ctrl-fullscreen {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .mapboxgl-ctrl-fullscreen:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        #populationChartContainer {
            height: 300px;
            margin-bottom: 20px;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #populationChart {
            width: 100%;
            height: 100%;
        }

        /* Style for fullscreen mode */
        .mapboxgl-map.mapboxgl-fullscreen {
            height: 100vh !important;
        }

        /* Ensure the container maintains proper layout in fullscreen */
        #container.mapboxgl-fullscreen {
            height: 100vh !important;
            width: 100vw !important;
        }

        .header-left img {
            transition: transform 0.3s ease;
        }

        .header-left img:hover {
            transform: scale(1.05);
        }

        .map-overlay {
            background: linear-gradient(to bottom, #fff, #f8f9fa);
            border-left: 1px solid rgba(0,0,0,0.1);
            padding: 25px;
        }

        .dashboard {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }

        .dashboard:hover {
            transform: translateY(-2px);
        }

        .facility-title {
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .facility-title:hover {
            background: linear-gradient(to right, #e3f2fd, transparent);
            border-left-color: #2196f3;
        }

        .mapboxgl-popup {
            animation: fadeIn 0.3s ease;
        }

        @media (max-width: 768px) {
            .header-controls {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .map-overlay {
                height: 50vh;
                overflow-y: auto;
            }
        }

        /* Better focus states */
        :focus {
            outline: 2px solid #2196f3;
            outline-offset: 2px;
        }

        /* ARIA labels and roles */
        [role="button"] {
            cursor: pointer;
        }

        .search-box {
            background: #fff;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 12px 16px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33,150,243,0.1);
        }

        .population-filter {
            margin-top: 15px;
        }

        .population-filter label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #2c3e50;
        }

        .population-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .population-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: calc(50% - 15px);
        }

        .population-inputs span {
            color: #666;
            font-size: 14px;
        }

        .population-input:focus {
            border-color: #2196f3;
            outline: none;
            box-shadow: 0 0 0 2px rgba(33,150,243,0.1);
        }

    </style>
</head>
<body>
<header>
    <div class="header-left">
        <a href="https://socalren.org/" target="_blank">
            <img src="images/socalren_erapdashboard.png" alt="SoCalREN ERAP Logo" style="height: 50px;">
        </a>
    </div>
    <div class="header-controls">
        <div class="geocoder-container" id="geocoder"></div>
        <div class="style-selector">
            <label for="style-selector">Map Style</label>
            <select id="style-selector">
                <option value="mapbox://styles/wengle1/cm4m4sedc001v01sqdtx0cioz" selected>Custom Style</option>
                <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
                <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
                <option value="mapbox://styles/mapbox/light-v10">Light</option>
                <option value="mapbox://styles/mapbox/dark-v10">Dark</option>
                <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
            </select>
        </div>
        <div class="fullscreen-container" id="fullscreen-control"></div>
    </div>
</header>
<div id="container">
    <div id="map"></div>
    <div class="map-overlay" id="dashboard-panel">
        <fieldset>
            <input id="agency-filter" type="text" placeholder="Search for an agency">
            <ul id="agency-suggestions" style="display:none;"></ul>
        </fieldset>

        <fieldset class="filters" id="agency-filters">
            <legend>Agency Filters</legend>
            <label>
                <input type="checkbox" id="dac-filter"> 
                Show only Underserved and/or Hard to Reach Communities
            </label>
            <label>
                <input type="checkbox" id="ces90-filter"> 
                Show only agencies with CalEnviroScreen Score > 90
            </label>
            
            <div class="population-filter">
                <label for="population-min">Population Range:</label>
                <div class="population-inputs">
                    <input type="number" 
                           id="population-min" 
                           placeholder="Min Population" 
                           min="0" 
                           class="population-input">
                    <span>to</span>
                    <input type="number" 
                           id="population-max" 
                           placeholder="Max Population" 
                           min="0" 
                           class="population-input">
                </div>
            </div>
        </fieldset>

        <fieldset class="filters" id="facility-filters" style="display:none;">
            <legend>Facility Filters</legend>
            <label>
                <input type="checkbox" id="pv-filter"> 
                Show only facilities with PV or Battery Storage Capabilities
            </label>
            <label>
                <input type="checkbox" id="ev-filter"> 
                Show only facilities with existing EV chargers
            </label>
            <label>
                <input type="checkbox" id="cooling-filter"> 
                Show only facilities with Existing Resilience Designation
            </label>
        </fieldset>

        <div id="listing" class="listing"></div>

        <div id="intro-section">
            <h4>Welcome to SoCalREN's ERAP Dashboard</h4>
            <p>
                This dashboard provides insights into public agencies' energy resilience planning efforts across Southern California that have received support from the SoCalREN Public Agency Programs. Use the filters above to find agencies by name, select a council of governments, or set population thresholds. Click on an agency to view detailed metrics and access facility information.
            </p>
            <p>
                The data displayed here includes key metrics collected throughout an agency's involvement in the ERAP program. The dashboard can help you understand community needs, identify facilities equipped with Electric Vehicle chargers, Solar or Battery Storage, and plans for resilience improvements.
            </p>
            
            <h4>Getting Started</h4>
            <ul>
                <li>Use the "Filter by agency name" box to quickly locate a participating agency.</li>
                <li>Adjust the range filter to focus on agencies with larger populations.</li>
                <li>Click an agency name to view its details and a list of associated facilities that were assessed by SoCalREN.</li>
            </ul>
            
            <h4>What is ERAP?</h4>
            <p>
                SoCalREN's Energy Resilience Action Plan (ERAP) program aims to address the growing impacts of climate change. Developed in collaboration with regional partners, the ERAP program enhances the energy resilience of critical infrastructure and future resilience hub locations for public agencies. By incorporating data-driven analysis and stakeholder input into the planning and development process, ERAP supports agencies in developing an actionable roadmap for near-term to long-term energy resilience strategies that will best serve the community.
            </p>
        </div>

        <div class="dashboard" id="dashboard" style="display: none;">
            <h3 id="data-overview-title">Data Overview</h3>
        
            <div id="agency-data" style="display:none; margin-top:20px;">
                <h4>Agency-Level Data</h4>
                <div class="metric">
                    <span class="metric-label">Underserved and/or Hard to Reach Communities:</span>
                    <span class="metric-value" id="agency-dac">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">CalEnviroScreen Score:</span>
                    <span class="metric-value" id="agency-cal">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Pollution Burden Percentile:</span>
                    <span class="metric-value" id="agency-pollution">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Population:</span>
                    <span class="metric-value" id="agency-pop">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">% Children and Seniors:</span>
                    <span class="metric-value" id="agency-children-seniors">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Agency Area (sq. miles):</span>
                    <span class="metric-value" id="agency-area">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Population Density (per sq. mile):</span>
                    <span class="metric-value" id="agency-density">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Extreme Heat Days (days/year):</span>
                    <span class="metric-value" id="agency-heat-days">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Average Household Income:</span>
                    <span class="metric-value" id="agency-income">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">% Low-Income Census Tracts:</span>
                    <span class="metric-value" id="agency-low-income">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label"># of Electric Circuits:</span>
                    <span class="metric-value" id="agency-circuits">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Annual Consumption (kWh):</span>
                    <span class="metric-value" id="agency-kwh">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Annual Consumption (Therms):</span>
                    <span class="metric-value" id="agency-therms">N/A</span>
                </div>
            </div>
        
            <div id="facility-data" style="display:none; margin-top:20px;">
                <h4>Facility-Level Data</h4>
                <div class="metric">
                    <span class="metric-label">Year Built:</span>
                    <span class="metric-value" id="facility-year">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Gross Floor Area (sq ft):</span>
                    <span class="metric-value" id="facility-sqft">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Walkability:</span>
                    <span class="metric-value" id="facility-walkability">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Existing Resilience Designation:</span>
                    <span class="metric-value" id="facility-resilience">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Existing EV Chargers:</span>
                    <span class="metric-value" id="facility-ev">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Planned EV Chargers:</span>
                    <span class="metric-value" id="facility-planned-ev">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Existing PV/Battery Storage:</span>
                    <span class="metric-value" id="facility-pv">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Planned PV (hours):</span>
                    <span class="metric-value" id="facility-planned-pv">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Planned Battery Storage (hours):</span>
                    <span class="metric-value" id="facility-planned-battery">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Building Type:</span>
                    <span class="metric-value" id="facility-type">N/A</span>
                </div>
            </div>
        </div>

<div id="welcome-popup">
    <div class="welcome-content">
        <img src="images/SoCalREN_Logo_2017_PRIMARY.png" alt="SoCalREN Logo" style="width: 500px; margin-bottom: 20px;">
        <h1>
            <span class="title-line">Welcome to Southern California Regional Energy Network (SoCalREN)'s</span>
            <span class="title-line">Energy Resilience Action Plan (ERAP) Dashboard</span>
        </h1>
        <h2>Explore energy resilience planning efforts across Southern California</h2>
        <p>This interactive dashboard provides comprehensive information about facilities and agencies participating in SoCalREN's ERAP program. Use the map to explore geographical data, or search for specific details.</p>
        <button onclick="closeWelcome()">Enter Dashboard</button>
    </div>
</div>

<div id="loading-spinner">
    <i class="fas fa-spinner fa-spin"></i> Loading...
</div>

<!-- Include external scripts -->
<script src="https://unpkg.com/@mapbox/mapbox-sdk/umd/mapbox-sdk.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css" type="text/css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>

<script>
    // Mapbox access token and map initialization
        mapboxgl.accessToken = 'pk.eyJ1Ijoid2VuZ2xlMSIsImEiOiJjbHBtaWx0N2IwMGljMmxwNjBsMnU4a2E4In0.Dzf3G-WBKzDfgnXsGHiMXw';

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/wengle1/cm4m4sedc001v01sqdtx0cioz',
        center: [-118.2437, 34.0522],
        zoom: 5,
        pitch: 35,
        maxBounds: [[-119.5, 33.2], [-117.0, 34.8]]  // LA County bounds
    });

    map.addControl(new mapboxgl.FullscreenControl({
        container: document.querySelector('#container')
    }), 'top-right');

    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    map.on('load', function () {
        fetch('data/la_boundaries.geojson')
            .then(response => response.json())
            .then(data => {
                if (!map.getSource('la-boundaries')) {
                    map.addSource('la-boundaries', {
                        type: 'geojson',
                        data: data
                    });
                }

                if (map.getLayer('la-boundaries-outline')) {
                    map.removeLayer('la-boundaries-outline');
                }

                map.addLayer({
                    id: 'la-boundaries-layer',
                    type: 'fill',
                    source: 'la-boundaries',
                    layout: {},
                    paint: {
                        'fill-color': [
                            'case',
                            ['boolean', ['feature-state', 'hover'], false],
                            '#78BE20',
                            '#003865'
                        ],
                        'fill-opacity': 0.4
                    }
                });

                // Variable to store the currently hovered stateId
                let hoveredStateId = null;

                map.on('mousemove', 'la-boundaries-layer', function (e) {
                    if (e.features.length > 0) {
                        if (hoveredStateId) {
                            map.setFeatureState(
                                { source: 'la-boundaries', id: hoveredStateId },
                                { hover: false }
                            );
                        }
                        hoveredStateId = e.features[0].id;
                        map.setFeatureState(
                            { source: 'la-boundaries', id: hoveredStateId },
                            { hover: true }
                        );
                    }
                });

                map.on('mouseleave', 'la-boundaries-layer', function () {
                    if (hoveredStateId) {
                        map.setFeatureState(
                            { source: 'la-boundaries', id: hoveredStateId },
                            { hover: false }
                        );
                    }
                    hoveredStateId = null;
                    map.getCanvas().style.cursor = '';
                });

                map.on('mouseenter', 'la-boundaries-layer', function () {
                    map.getCanvas().style.cursor = 'pointer';
                });

                //map.addLayer({
                  //  id: 'la-boundaries-labels',
                   // type: 'symbol',
                    //source: 'la-boundaries',
                    //layout: {
                      //  'text-field': ['get', 'CITY_COMM_NAME'],
                        //'text-font': ['Nunito Sans Bold', 'Arial Unicode MS Bold'],
                        //'text-size': 12,
                        //'text-max-width': 10,
                        //'text-allow-overlap': false
                    //},
                    //paint: {
                      //  'text-color': '#00008b',
                       // 'text-halo-color': '#FFFFFF',
                        //'text-halo-width': 1
                    //}
                //});

                // Add click event to handle clicks on boundary layers
                map.on('click', 'la-boundaries-layer', function (e) {
                    if (e.features.length > 0) {
                        const cityName = e.features[0].properties.CITY_COMM_NAME;
                        showCityDataInDashboard(cityName);
                    }
                });
            })
            .catch(error => console.error('Error loading GeoJson data:', error));
    });

    // Function to show city data in the dashboard
    function showCityDataInDashboard(cityName) {
        // Fetch and display city data in the dashboard
        fetch(`data/${cityName}_data.json`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Update dashboard with city data
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('data-overview-title').textContent = `${cityName} Data Overview`;
                // Populate data fields with fetched data
                document.getElementById('agency-dac').textContent = data.dac || 'N/A';
                document.getElementById('agency-cal').textContent = data.calEnviroScreenScore || 'N/A';
                document.getElementById('agency-pollution').textContent = data.pollutionBurdenPercentile || 'N/A';
                document.getElementById('agency-pop').textContent = data.population || 'N/A';
                document.getElementById('agency-children-seniors').textContent = data.percentChildrenSeniors || 'N/A';
                document.getElementById('agency-area').textContent = data.agencyArea || 'N/A';
                document.getElementById('agency-density').textContent = data.populationDensity || 'N/A';
                document.getElementById('agency-heat-days').textContent = data.extremeHeatDays || 'N/A';
                document.getElementById('agency-income').textContent = data.averageHouseholdIncome || 'N/A';
                document.getElementById('agency-low-income').textContent = data.percentLowIncomeCensusTracts || 'N/A';
                document.getElementById('agency-circuits').textContent = data.numElectricCircuits || 'N/A';
                document.getElementById('agency-kwh').textContent = data.annualConsumptionKwh || 'N/A';
                document.getElementById('agency-therms').textContent = data.annualConsumptionTherms || 'N/A';
            })
            .catch(error => console.error('Error fetching city data:', error));
}

    // Utility functions
    function parseCoordinate(coordStr) {
        if (!coordStr || coordStr.trim().toUpperCase() === 'N/A') return null;
        let parts = coordStr.split('°');
        if (parts.length < 2) return null;
        let value = parseFloat(parts[0].trim());
        let direction = parts[1].trim().toUpperCase();
        if (direction.startsWith('S') || direction.startsWith('W')) {
            value = -value;
        }
        return value;
    }

    // Add the missing processFacilityData function here
    function processFacilityData(rawData) {
        return rawData.map(row => ({
            Agency: row[0],
            FacilityName: row[1],
            Address: row[2],
            Latitude: parseCoordinate(row[3]),
            Longitude: parseCoordinate(row[4]),
            ExistingResilienceDesignation: row[5],
            ExistingEVChargers: row[6],
            PlannedEVChargers: row[7],
            ExistingPV: row[8],
            PlannedPV: row[9],
            PlannedBattery: row[10],
            BuildingType: row[11],
            Walkability: row[12],
            GrossFloorArea: row[13],
            YearBuilt: row[14]
        }));
    }

    // Data arrays and processing
    const agencyData = [
        {"Agency":"City of Bell","Council":"Gateway Cities Council of Governments","DAC":"Yes","CalEnviroscreen":96,"Population":31864,"AgencyArea":2.5,"PopulationDensity":13400,"ExtremeHeatDays":91,"ChildrenSeniors":36,"AvgHouseholdIncome":47800,"PollutionBurden":88,"LowIncomeTracts":100,"ElectricCircuits":14,"AnnualKWh":2200000,"AnnualTherms":91100},
        {"Agency":"City of Maywood","Council":"Gateway Cities Council of Governments","DAC":"Yes","CalEnviroscreen":90,"Population":27127,"AgencyArea":1.18,"PopulationDensity":23257,"ExtremeHeatDays":77,"ChildrenSeniors":38,"AvgHouseholdIncome":50996,"PollutionBurden":92,"LowIncomeTracts":100,"ElectricCircuits":6,"AnnualKWh":939153,"AnnualTherms":1232},
        {"Agency":"City of Bell Gardens","Council":"Gateway Cities Council of Governments","DAC":"Yes","CalEnviroscreen":92,"Population":37467,"AgencyArea":2.5,"PopulationDensity":17100,"ExtremeHeatDays":90,"ChildrenSeniors":30,"AvgHouseholdIncome":45300,"PollutionBurden":97,"LowIncomeTracts":100,"ElectricCircuits":9,"AnnualKWh":1597960,"AnnualTherms":25833},
        {"Agency":"City of Pomona","Council":"San Gabriel Valley Council of Governments","DAC":"Yes","CalEnviroscreen":97,"Population":151100,"AgencyArea":22.99,"PopulationDensity":6572,"ExtremeHeatDays":118,"ChildrenSeniors":37,"AvgHouseholdIncome":62400,"PollutionBurden":81,"LowIncomeTracts":82,"ElectricCircuits":56,"AnnualKWh":20971427,"AnnualTherms":23848},
        {"Agency":"City of Irwindale","Council":"San Gabriel Valley Council of Governments","DAC":"Yes","CalEnviroscreen":83,"Population":1400,"AgencyArea":9.5,"PopulationDensity":142,"ExtremeHeatDays":146,"ChildrenSeniors":"N/A","AvgHouseholdIncome":86250,"PollutionBurden":100,"LowIncomeTracts":100,"ElectricCircuits":30,"AnnualKWh":2452708,"AnnualTherms":11686},
        {"Agency":"El Monte Union High School District (EMUSHD)","Council":"Council of Governments","DAC":"Yes","CalEnviroscreen":80,"Population":163151,"AgencyArea":22.38,"PopulationDensity":7290,"ExtremeHeatDays":129,"ChildrenSeniors":"N/A","AvgHouseholdIncome":62000,"PollutionBurden":92,"LowIncomeTracts":"N/A","ElectricCircuits":79,"AnnualKWh":"N/A","AnnualTherms":"N/A"},
        {"Agency":"City of Cudahy","Council":"Gateway Cities Council of Governments","DAC":"Yes","CalEnviroscreen":95,"Population":21700,"AgencyArea":1.23,"PopulationDensity":17642,"ExtremeHeatDays":85,"ChildrenSeniors":36,"AvgHouseholdIncome":49600,"PollutionBurden":94,"LowIncomeTracts":100,"ElectricCircuits":20,"AnnualKWh":"N/A","AnnualTherms":"N/A"},
        {"Agency":"City of South El Monte","Council":"San Gabriel Valley Council of Governments","DAC":"Yes","CalEnviroscreen":97,"Population":19000,"AgencyArea":2.84,"PopulationDensity":6690,"ExtremeHeatDays":124,"ChildrenSeniors":37,"AvgHouseholdIncome":67700,"PollutionBurden":98,"LowIncomeTracts":80,"ElectricCircuits":12,"AnnualKWh":593500,"AnnualTherms":39700},
        {"Agency":"City of Lynwood","Council":"Gateway Cities Council of Governments","DAC":"Yes","CalEnviroscreen":91,"Population":63200,"AgencyArea":4.84,"PopulationDensity":13058,"ExtremeHeatDays":33,"ChildrenSeniors":35,"AvgHouseholdIncome":67400,"PollutionBurden":92,"LowIncomeTracts":66,"ElectricCircuits":22,"AnnualKWh":1340300,"AnnualTherms":30100},
        {"Agency":"City of Duarte","Council":"San Gabriel Valley Council of Governments","DAC":"Yes","CalEnviroscreen":78,"Population":23100,"AgencyArea":6.71,"PopulationDensity":3443,"ExtremeHeatDays":132,"ChildrenSeniors":38,"AvgHouseholdIncome":93900,"PollutionBurden":58,"LowIncomeTracts":20,"ElectricCircuits":10,"AnnualKWh":417700,"AnnualTherms":"N/A"},
        {"Agency":"City of Rancho Palos Verdes","Council":"South Bay Cities Council of Governments","DAC":"Yes","CalEnviroscreen":11,"Population":41600,"AgencyArea":13.5,"PopulationDensity":3081,"ExtremeHeatDays":11,"ChildrenSeniors":"N/A","AvgHouseholdIncome":146200,"PollutionBurden":29,"LowIncomeTracts":0,"ElectricCircuits":25,"AnnualKWh":359100,"AnnualTherms":900},
        {"Agency":"City of El Segundo","Council":"South Bay Cities Council of Governments","DAC":"Yes","CalEnviroscreen":26,"Population":16500,"AgencyArea":5.5,"PopulationDensity":3000,"ExtremeHeatDays":7,"ChildrenSeniors":"N/A","AvgHouseholdIncome":115900,"PollutionBurden":87,"LowIncomeTracts":0,"ElectricCircuits":20,"AnnualKWh":94470,"AnnualTherms":40800}
    ];

    const rawFacilityData = [
        ["City of Bell","Bell Library","4411 Gage Ave, Bell, CA","33.9765° N","118.1856° W","N/A","No","2","N/A","3,912","25","Library","High","5,622","1965"],
        ["City of Bell","Community Center","6250 Pine Ave, Bell, CA","33.9760° N","118.1820° W","Cooling Center","No","2","Solar went live in August 2020","1,899","1,748","Community center","High","16,011","1980"],
        ["City of Bell","Camp Little Bear Park","6704 Orchard Ave, Bell, CA","33.9770° N","118.1890° W","N/A","No","0","N/A","664","81","Park","Medium","5,783","1962"],
        ["City of Bell","Veterans Memorial Park","6500 Wilcox Ave, Bell, CA","33.9765° N","118.1875° W","Cooling Center","No Capacity","0","N/A","3,397","381","Park","Medium","7,500","1955"],
        ["City of Maywood","City Hall & Sheriff's Office","4319 Slauson Ave, Maywood, CA","33.9880° N","118.1850° W","Cooling Center","No","4","No","2,646","0","Office","High","9,534","1938"],
        ["City of Maywood","Teen Center","4801 E. Slauson Ave, Maywood, CA","33.9885° N","118.1700° W","N/A","No","0","No","Whole Year","Whole year","Community center","Medium","N/A","N/A"],
        ["City of Maywood","Maywood Park (YMCA)","4801 E. 58th St, Maywood, CA","33.9890° N","118.1705° W","N/A","No","4","No","1,140","5","Community center","Medium","30,819","1999"],
        ["City of Maywood","Cesar Chavez Library","4323 Slauson Ave, Maywood, CA","33.9880° N","118.1845° W","N/A","No","0","No","2,311","5","Library","High","3,382","1938"],
        ["City of Bell Gardens","Ford Park and Recreation Center","8000 Park Lane, Bell Gardens, CA","33.9650° N","118.1510° W","N/A","No","10","N/A","3,563","13","Community center","High","9,083","1976"],
        ["City of Bell Gardens","Community Family Services Center & Veterans Park","6662 Loveland St, Bell Gardens, CA","33.9660° N","118.1530° W","N/A","No","0","N/A","3,330","71","Community center","Low","20,000","1976"],
        ["City of Bell Gardens","Youth Center","5856 Ludell St, Bell Gardens, CA","33.9680° N","118.1500° W","N/A","No","0","N/A","3,406","11","Community center","Medium","11,446","1948"],
        ["City of Bell Gardens","Civic Center","7100 Garfield St, Bell Gardens, CA","33.9655° N","118.1515° W","N/A","No","0","N/A","5","0","City Hall","Medium","18,500","1967"],
        ["City of Pomona","Library","625 S Garey Ave, Pomona, CA","34.0530° N","117.7500° W","Cooling Center","Yes","0","N/A","2,057","0","Library","High","25,977","1956"],
        ["City of Pomona","City Hall","505 S Garey Ave, Pomona, CA","34.0525° N","117.7505° W","N/A","No","0","N/A","2,482","14","Office","High","44,996","1969"],
        ["City of Pomona","Palomares Park","499 E Arrow Hwy, Pomona, CA","34.1000° N","117.7400° W","Cooling Center","Yes","19","N/A","6,470","48","Community center","Low","15,704","1983"],
        ["City of Pomona","Washington Senior Center","865 E Granf Ave, Pomona, CA","34.0600° N","117.7400° W","Cooling Center","No","6","N/A","4,070","883","Senior Center","Low","2,539","1935"],
        ["City of Irwindale","Dan Diaz Recreation Center and Library","16053 Calle De Paseo, Irwindale, CA","34.1100° N","117.9700° W","N/A","No","0","N/A","1,068","1","Library and recreation center","Low","22,855","1970"],
        ["City of Irwindale","City Hall and Police Department","5050 N Irwindale Ave, Irwindale, CA","34.1105° N","117.9350° W","Emergency Operations Center","No","4","N/A","4","0","Office","Low","20,600","1957"],
        ["City of Irwindale","Senior Center and Annex","16116 Arrow Hwy, Irwindale, CA","34.1100° N","117.9705° W","Cooling Center","No","4","N/A","24","0","Multi-purpose/ office","Low","20,678","1985"],
        ["City of Irwindale","New Library (Planned for 2026)","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","Library","N/A","N/A","N/A"]
    ];

    // Process the facility data
    const facilityData = processFacilityData(rawFacilityData);

    console.log('Initial facility data:', facilityData);

    // Convert facility data to GeoJSON features
    function facilityToFeature(f) {
        if (f.Latitude !== null && f.Longitude !== null) {
            return {
                'type': 'Feature',
                'properties': {
                    Agency: f.Agency,
                    FacilityName: f.FacilityName,
                    BuildingType: f.BuildingType,
                    ExistingEVChargers: f.ExistingEVChargers,
                    ExistingPV: f.ExistingPV,
                    ExistingResilienceDesignation: f.ExistingResilienceDesignation,
                    PlannedEVChargers: f.PlannedEVChargers,
                    PlannedPV: f.PlannedPV,
                    PlannedBattery: f.PlannedBattery,
                    Walkability: f.Walkability,
                    GrossFloorArea: f.GrossFloorArea,
                    YearBuilt: f.YearBuilt
                },
                'geometry': {
                    'type': 'Point',
                    'coordinates': [f.Longitude, f.Latitude]
                }
            };
        }
        return null;
    }

    const facilityFeatures = facilityData.map(f => facilityToFeature(f)).filter(x => x !== null);
    const facilityGeoJSON = {
        "type": "FeatureCollection",
        "features": facilityFeatures
    };

    // Add the renderListing function before it's called
    function renderListing() {
        const listingElement = document.getElementById('listing');
        const introSection = document.getElementById('intro-section');
        const agencyFilters = document.getElementById('agency-filters');
        const facilityFilters = document.getElementById('facility-filters');
        if (!listingElement) return;

        // Clear existing content
        listingElement.innerHTML = '';
        
        // Show the intro section and agency filters, hide facility filters
        introSection.style.display = 'block';
        agencyFilters.style.display = 'block';
        facilityFilters.style.display = 'none';
        
        // Group agencies by Council
        const councilGroups = {
            'Gateway Cities Council of Governments': [],
            'San Gabriel Valley Council of Governments': [],
            'South Bay Cities Council of Governments': []
        };

        // Sort agencies into their respective councils
        agencyData.forEach(agency => {
            if (councilGroups.hasOwnProperty(agency.Council)) {
                councilGroups[agency.Council].push(agency);
            }
        });

        // Create sections for each Council of Government
        Object.entries(councilGroups).forEach(([council, agencies]) => {
            if (agencies.length > 0) {
                // Create council section
                const cogSection = document.createElement('div');
                cogSection.className = 'cog-section';

                // Add council header
                const cogHeader = document.createElement('div');
                cogHeader.className = 'cog-header';
                cogHeader.textContent = council;
                cogHeader.addEventListener('click', () => {
                    cogHeader.classList.toggle('expanded');
                    agencyList.style.display = agencyList.style.display === 'none' ? 'block' : 'none';
                });

                // Create agency list container
                const agencyList = document.createElement('div');
                agencyList.className = 'agency-list';

                // Sort agencies alphabetically
                agencies.sort((a, b) => a.Agency.localeCompare(b.Agency));

                // Add agencies to the list
                agencies.forEach(agency => {
                    const agencyDiv = document.createElement('div');
                    agencyDiv.className = 'agency-title';
                    agencyDiv.textContent = agency.Agency;
                    
                    // Add click event to show facilities
                    agencyDiv.addEventListener('click', () => {
                        const facilities = facilityData.filter(f => f.Agency === agency.Agency);
                        showFacilities(agency, facilities);
                    });

                    agencyList.appendChild(agencyDiv);
                });

                cogSection.appendChild(cogHeader);
                cogSection.appendChild(agencyList);
                listingElement.appendChild(cogSection);
            }
        });

        // Hide loading spinner
        document.getElementById('loading-spinner').style.display = 'none';
    }

    // Add this function to handle facility filtering
    function filterFacilities(facilities) {
        const pvFilter = document.getElementById('pv-filter').checked;
        const evFilter = document.getElementById('ev-filter').checked;
        const coolingFilter = document.getElementById('cooling-filter').checked;

        return facilities.filter(facility => {
            // Check for PV or Battery Storage
            const hasPV = facility.ExistingPV && facility.ExistingPV.toLowerCase() !== 'n/a' && facility.ExistingPV.toLowerCase() !== 'no';
            
            // Check for EV chargers
            const hasEV = facility.ExistingEVChargers && 
                         facility.ExistingEVChargers.toLowerCase() !== 'n/a' && 
                         facility.ExistingEVChargers.toLowerCase() !== 'no' &&
                         facility.ExistingEVChargers !== '0';
            
            // Check for Resilience Designation
            const hasResilience = facility.ExistingResilienceDesignation && 
                                facility.ExistingResilienceDesignation.toLowerCase() !== 'n/a' && 
                                facility.ExistingResilienceDesignation.toLowerCase() !== 'no';

            // Apply filters
            const matchesPV = !pvFilter || hasPV;
            const matchesEV = !evFilter || hasEV;
            const matchesResilience = !coolingFilter || hasResilience;

            return matchesPV && matchesEV && matchesResilience;
        });
    }

    // Update the showFacilities function to only include one back button
    function showFacilities(agency, facilities) {
        const listingElement = document.getElementById('listing');
        const dashboardElement = document.getElementById('dashboard');
        const agencyDataElement = document.getElementById('agency-data');
        const facilityDataElement = document.getElementById('facility-data');
        const introSection = document.getElementById('intro-section');
        const agencyFilters = document.getElementById('agency-filters');
        const facilityFilters = document.getElementById('facility-filters');

        // Apply facility filters
        const filteredFacilities = filterFacilities(facilities);
        
        // Create and insert only one back button
        listingElement.innerHTML = `
            <button id="back-button">Back to Agencies</button>
            <h4>Facilities in ${agency.Agency}</h4>
            ${filteredFacilities.length > 0 
                ? filteredFacilities.map(facility => `
                    <div class="facility-title" onclick="showFacilityDetails('${facility.Agency}', '${facility.FacilityName}')">
                        ${facility.FacilityName}
                    </div>
                `).join('')
                : '<div id="no-facilities-msg">No facilities found matching the selected filters.</div>'
            }
        `;

        // Add back button functionality
        document.getElementById('back-button').onclick = () => {
            dashboardElement.style.display = 'none';
            renderListing();
        };
        
        // Hide the intro section and agency filters, show facility filters
        introSection.style.display = 'none';
        agencyFilters.style.display = 'none';
        facilityFilters.style.display = 'block';
        
        // Show the dashboard and agency data, hide facility data initially
        dashboardElement.style.display = 'block';
        agencyDataElement.style.display = 'block';
        facilityDataElement.style.display = 'none';
        
        // Update agency data in the dashboard
        updateAgencyDashboard(agency);
    }

    // Add event listeners for facility filters
    document.getElementById('pv-filter').addEventListener('change', function() {
        const agency = getCurrentlyDisplayedAgency(); // You'll need to implement this
        if (agency) {
            const facilities = facilityData.filter(f => f.Agency === agency.Agency);
            showFacilities(agency, facilities);
        }
    });

    document.getElementById('ev-filter').addEventListener('change', function() {
        const agency = getCurrentlyDisplayedAgency();
        if (agency) {
            const facilities = facilityData.filter(f => f.Agency === agency.Agency);
            showFacilities(agency, facilities);
        }
    });

    document.getElementById('cooling-filter').addEventListener('change', function() {
        const agency = getCurrentlyDisplayedAgency();
        if (agency) {
            const facilities = facilityData.filter(f => f.Agency === agency.Agency);
            showFacilities(agency, facilities);
        }
    });

    // Helper function to get the currently displayed agency
    function getCurrentlyDisplayedAgency() {
        const agencyName = document.querySelector('#data-overview-title').textContent.replace('Data Overview', '').trim();
        return agencyData.find(a => a.Agency === agencyName);
    }

    // Helper function to update agency dashboard
    function updateAgencyDashboard(agency) {
        document.getElementById('agency-dac').textContent = agency.DAC || 'N/A';
        document.getElementById('agency-cal').textContent = agency.CalEnviroscreen || 'N/A';
        document.getElementById('agency-pollution').textContent = agency.PollutionBurden || 'N/A';
        document.getElementById('agency-pop').textContent = agency.Population?.toLocaleString() || 'N/A';
        document.getElementById('agency-children-seniors').textContent = agency.ChildrenSeniors || 'N/A';
        document.getElementById('agency-area').textContent = agency.AgencyArea || 'N/A';
        document.getElementById('agency-density').textContent = agency.PopulationDensity?.toLocaleString() || 'N/A';
        document.getElementById('agency-heat-days').textContent = agency.ExtremeHeatDays || 'N/A';
        document.getElementById('agency-income').textContent = `$${agency.AvgHouseholdIncome?.toLocaleString()}` || 'N/A';
        document.getElementById('agency-low-income').textContent = `${agency.LowIncomeTracts}%` || 'N/A';
        document.getElementById('agency-circuits').textContent = agency.ElectricCircuits || 'N/A';
        document.getElementById('agency-kwh').textContent = agency.AnnualKWh?.toLocaleString() || 'N/A';
        document.getElementById('agency-therms').textContent = agency.AnnualTherms?.toLocaleString() || 'N/A';
    }

    function showFacilityDetails(agencyName, facilityName) {
        const facility = facilityData.find(f => 
            f.Agency === agencyName && f.FacilityName === facilityName
        );
        
        if (!facility) return;

        // Show facility data section and hide agency data section
        document.getElementById('facility-data').style.display = 'block';
        document.getElementById('agency-data').style.display = 'none'; // Hide agency data

        // Update the dashboard title to show facility name
        document.getElementById('data-overview-title').textContent = facilityName;

        // Update facility data values
        document.getElementById('facility-year').textContent = facility.YearBuilt || 'N/A';
        document.getElementById('facility-sqft').textContent = facility.GrossFloorArea || 'N/A';
        document.getElementById('facility-walkability').textContent = facility.Walkability || 'N/A';
        document.getElementById('facility-resilience').textContent = facility.ExistingResilienceDesignation || 'N/A';
        document.getElementById('facility-ev').textContent = facility.ExistingEVChargers || 'N/A';
        document.getElementById('facility-planned-ev').textContent = facility.PlannedEVChargers || 'N/A';
        document.getElementById('facility-pv').textContent = facility.ExistingPV || 'N/A';
        document.getElementById('facility-planned-pv').textContent = facility.PlannedPV || 'N/A';
        document.getElementById('facility-planned-battery').textContent = facility.PlannedBattery || 'N/A';
        document.getElementById('facility-type').textContent = facility.BuildingType || 'N/A';

        // Highlight selected facility in the listing
        const facilityElements = document.querySelectorAll('.facility-title');
        facilityElements.forEach(el => {
            el.classList.toggle('active', el.textContent.trim() === facilityName);
        });

        // Center map on facility
        if (facility.Latitude && facility.Longitude) {
            map.flyTo({
                center: [facility.Longitude, facility.Latitude],
                zoom: 15
            });
        }
    }

    // Map 'load' event handler
    map.on('load', () => {
        console.log('Map loaded');
        
        // Add boundaries source
       // map.addSource('la-boundaries', {
       //     'type': 'geojson',
        //    'data': 'https://raw.githubusercontent.com/wbeng69527/erap/main/path_to_la_boundaries.geojson'
       // });

        // Add boundaries layer
        map.addLayer({
            'id': 'la-fills',
            'type': 'fill',
            'source': 'la-boundaries',
            'layout': {},
            'paint': {
                'fill-color': '#3498db',
                'fill-opacity': 0.4
            }
        });

        // Add facilities source
        map.addSource('facilities', {
            'type': 'geojson',
            'data': facilityGeoJSON,
            'cluster': true,
            'clusterMaxZoom': 14,
            'clusterRadius': 50
        });

        // Add layers for clusters and unclustered points
        map.addLayer({
            'id': 'clusters',
            'type': 'circle',
            'source': 'facilities',
            'filter': ['has', 'point_count'],
            'paint': {
                'circle-radius': [
                    'step',
                    ['get', 'point_count'],
                    25,    // radius for clusters with count < 10
                    10,    
                    30,    // radius for clusters with count < 25
                    25,    
                    35     // radius for clusters with count >= 25
                ],
                'circle-color': [
                    'step',
                    ['get', 'point_count'],
                    '#ff9800',  // small clusters
                    10,
                    '#f57c00',  // medium clusters
                    25,
                    '#e65100'   // large clusters
                ],
                'circle-opacity': 0.9,
                'circle-stroke-width': 2,
                'circle-stroke-color': '#ffffff',
                'circle-stroke-opacity': 0.8
            }
        });

        map.addLayer({
            'id': 'cluster-count',
            'type': 'symbol',
            'source': 'facilities',
            'filter': ['has', 'point_count'],
            'layout': {
                'text-field': '{point_count_abbreviated}',
                'text-font': ['DIN Offc Pro Bold', 'Arial Unicode MS Bold'],
                'text-size': 16,
                'text-allow-overlap': true
            },
            'paint': {
                'text-color': '#ffffff',
                'text-halo-color': 'rgba(0, 0, 0, 0.2)',
                'text-halo-width': 1
            }
        });

        map.addLayer({
            'id': 'unclustered-point',
            'type': 'circle',
            'source': 'facilities',
            'filter': ['!', ['has', 'point_count']],
            'paint': {
                'circle-color': '#ff9800',
                'circle-radius': 8,
                'circle-stroke-width': 2,
                'circle-stroke-color': '#ffffff',
                'circle-opacity': 0.9,
                'circle-stroke-opacity': 0.8
            }
        });

        // Update popup styling
        const popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false,
            anchor: 'bottom',
            offset: [0, -10],
            className: 'facility-popup'
        });

        // Add mouse events for popups
        map.on('mouseenter', 'unclustered-point', (e) => {
            map.getCanvas().style.cursor = 'pointer';
            const props = e.features[0].properties;
            const desc = `
                <strong>${props.FacilityName}</strong><br>
                Use: ${props.BuildingType || 'N/A'}<br>
                EV: ${props.ExistingEVChargers || 'N/A'}<br>
                PV: ${props.ExistingPV || 'N/A'}
            `;
            popup.setLngLat(e.features[0].geometry.coordinates)
                 .setHTML(desc)
                 .addTo(map);
        });

        map.on('mouseleave', 'unclustered-point', () => {
            map.getCanvas().style.cursor = '';
            popup.remove();
        });

        // Add click event for clusters
        map.on('click', 'clusters', (e) => {
            const features = map.queryRenderedFeatures(e.point, {
                layers: ['clusters']
            });
            const clusterId = features[0].properties.cluster_id;
            map.getSource('facilities').getClusterExpansionZoom(
                clusterId,
                (err, zoom) => {
                    if (err) return;
                    map.easeTo({
                        center: features[0].geometry.coordinates,
                        zoom: zoom
                    });
                }
            );
        });

        // Change cursor when hovering over clusters
        map.on('mouseenter', 'clusters', () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        
        map.on('mouseleave', 'clusters', () => {
            map.getCanvas().style.cursor = '';
        });

        // Add this click handler for boundary areas after your other map event listeners
        map.on('click', 'la-fills', (e) => {
            if (e.features.length > 0) {
                const cityName = e.features[0].properties.CITY_COMM_NAME;
                // Find matching agency (accounting for "City of" prefix)
                const matchingAgency = agencyData.find(a => 
                    a.Agency.replace('City of ', '').trim().toUpperCase() === cityName.trim().toUpperCase()
                );
                
                if (matchingAgency) {
                    // Get facilities for this agency
                    const facilities = facilityData.filter(f => f.Agency === matchingAgency.Agency);
                    
                    // Show the agency's facilities and data
                    showFacilities(matchingAgency, facilities);
                    
                    // Scroll dashboard into view if needed
                    document.getElementById('dashboard-panel').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            }
        });

        // Update the click handler for individual facility points
        map.on('click', 'unclustered-point', (e) => {
            const props = e.features[0].properties;
            
            // Find the matching agency first
            const matchingAgency = agencyData.find(a => a.Agency === props.Agency);
            if (matchingAgency) {
                // First show the agency's information
                onAgencyClick(matchingAgency);
                
                // Then find and show the facility's information
                const matchingFacility = facilityData.find(f => 
                    f.Agency === props.Agency && 
                    f.FacilityName === props.FacilityName
                );
                
                if (matchingFacility) {
                    // Update facility dashboard
                    updateFacilityDashboard(matchingFacility);
                    
                    // Find and highlight the facility in the listing
                    const facilityLinks = document.querySelectorAll('.facility-title');
                    facilityLinks.forEach(link => {
                        if (link.textContent === props.FacilityName) {
                            link.classList.add('active');
                            link.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            link.classList.remove('active');
                        }
                    });
                }
                
                // Scroll dashboard into view
                document.getElementById('dashboard-panel').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        });

        // Call renderListing after data sources and layers are added
        renderListing();

        // Hide loading spinner
        document.getElementById('loading-spinner').style.display = 'none';
    });

    // Function to geocode a single address
    async function geocodeAddress(address) {
        const accessToken = mapboxgl.accessToken;
        const query = encodeURIComponent(address + ', CA');
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${query}.json?access_token=${accessToken}&country=US&types=address`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.features && data.features.length > 0) {
                return data.features[0].center;
            }
            return null;
        } catch (error) {
            console.error('Geocoding error:', error);
            return null;
        }
    }

    // Update facility coordinates
    async function updateFacilityCoordinates() {
        const updatedFacilities = [...facilityData]; // Create a copy of the array
        
        for (let facility of updatedFacilities) {
            if (!facility.Latitude || !facility.Longitude) {
                const address = `${facility.Address}`;
                const coordinates = await geocodeAddress(address);
                if (coordinates) {
                    facility.Longitude = coordinates[0];
                    facility.Latitude = coordinates[1];
                }
            }
        }  // <-- Closing brace for 'for' loop

        // Update the GeoJSON
        const updatedGeoJSON = {
            type: 'FeatureCollection',
            features: updatedFacilities.map(f => ({
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [f.Longitude, f.Latitude]
                },
                properties: {
                    ...f // Spread all facility properties
                }
            })).filter(f => f.geometry.coordinates[0] && f.geometry.coordinates[1]) // Filter out invalid coordinates
        };

        // Update the map source if it exists
        if (map.getSource('facilities')) {
            map.getSource('facilities').setData(updatedGeoJSON);
        }
    }  // This closes the 'updateFacilityCoordinates' function

    // Call this function after your data is loaded
    updateFacilityCoordinates();

    // Function to close the welcome popup
    function closeWelcome() {
        const popup = document.getElementById('welcome-popup');
        popup.classList.add('fade-out');
        setTimeout(() => {
            popup.style.display = 'none';
        }, 400);
    }

    // Additional functions and event listeners
    // ...

    // Add the geocoder control
    const geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        placeholder: 'Search for a location',
        bbox: [-119.5, 33.2, -117.0, 34.8], // Restrict to LA County bounds
        proximity: {
            longitude: -118.2437,
            latitude: 34.0522
        }
    });

    document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

    // Add these event listeners after your map.on('load') function
    document.getElementById('population-min').addEventListener('input', filterAgencies);
    document.getElementById('population-max').addEventListener('input', filterAgencies);

    function filterAgencies() {
        const minPop = parseInt(document.getElementById('population-min').value) || 0;
        const maxPop = parseInt(document.getElementById('population-max').value) || Infinity;
        const searchText = document.getElementById('agency-filter').value.toLowerCase().trim();
        const dacFilter = document.getElementById('dac-filter').checked;
        const ces90Filter = document.getElementById('ces90-filter').checked;

        const filteredAgencies = agencyData.filter(agency => {
            // Check if the agency name matches the search text
            const matchesSearch = searchText === '' || agency.Agency.toLowerCase().includes(searchText);
            
            // Check if the agency's population is within the specified range
            const matchesPopulation = agency.Population >= minPop && 
                                     (maxPop === Infinity || agency.Population <= maxPop);
            
            // Check if the agency meets the DAC filter criteria
            const matchesDAC = !dacFilter || (agency.DAC && agency.DAC.toLowerCase() === 'yes');
            
            // Check if the agency meets the CalEnviroScreen filter criteria
            const matchesCES = !ces90Filter || (agency.CalEnviroscreen && agency.CalEnviroscreen > 90);

            // Agency must match all active filters
            return matchesSearch && matchesPopulation && matchesDAC && matchesCES;
        });

        // Update the listing with filtered agencies
        const listingElement = document.getElementById('listing');
        listingElement.innerHTML = '';

        // Group filtered agencies by Council
        const councilGroups = {};
        filteredAgencies.forEach(agency => {
            if (!councilGroups[agency.Council]) {
                councilGroups[agency.Council] = [];
            }
            councilGroups[agency.Council].push(agency);
        });

        // Render the filtered and grouped agencies
        Object.entries(councilGroups).forEach(([council, agencies]) => {
            if (agencies.length > 0) {
                const cogSection = document.createElement('div');
                cogSection.className = 'cog-section';

                const cogHeader = document.createElement('div');
                cogHeader.className = 'cog-header';
                cogHeader.textContent = council;

                const agencyList = document.createElement('div');
                agencyList.className = 'agency-list';
                agencyList.style.display = 'block';

                agencies.sort((a, b) => a.Agency.localeCompare(b.Agency));

                agencies.forEach(agency => {
                    const agencyDiv = document.createElement('div');
                    agencyDiv.className = 'agency-title';
                    agencyDiv.textContent = agency.Agency;
                    agencyDiv.onclick = () => {
                        const facilities = facilityData.filter(f => f.Agency === agency.Agency);
                        showFacilities(agency, facilities);
                    };
                    agencyList.appendChild(agencyDiv);
                });

                cogSection.appendChild(cogHeader);
                cogSection.appendChild(agencyList);
                listingElement.appendChild(cogSection);
            }
        });

        // Show/hide intro section based on whether there are results
        const introSection = document.getElementById('intro-section');
        if (introSection) {
            introSection.style.display = filteredAgencies.length > 0 ? 'block' : 'none';
        }

        // Log filtering results for debugging
        console.log('Filtered Agencies:', filteredAgencies.length);
        console.log('DAC Filter:', dacFilter);
        console.log('CES Filter:', ces90Filter);
    }

    // Make sure all filter inputs trigger the filterAgencies function
    document.getElementById('agency-filter').addEventListener('input', filterAgencies);
    document.getElementById('population-min').addEventListener('input', filterAgencies);
    document.getElementById('population-max').addEventListener('input', filterAgencies);
    document.getElementById('dac-filter').addEventListener('change', filterAgencies);
    document.getElementById('ces90-filter').addEventListener('change', filterAgencies);

</script>

</body>
</html>
