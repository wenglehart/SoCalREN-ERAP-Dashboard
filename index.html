<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SoCalREN's ERAP Dashboard</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

  <!-- MAPBOX & FONTS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.js"></script>

  <!-- Aptos font-face (sample) -->
  <style>
  @font-face {
    font-family: 'Aptos';
    /* If you have a local or hosted source for Aptos, declare it here.
       Otherwise, user’s system must have Aptos installed. */
    font-weight: 400;
    font-style: normal;
  }
  </style>

  <!-- Mapbox Geocoder (for searching the map) -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css" type="text/css">

  <!-- FontAwesome for icons -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Aptos', sans-serif;
      background-color: #ffffff;
      overflow: hidden; /* Hide scrollbars */
    }

    /* ============ PASSWORD MODAL ============ */
    #password-modal {
      position: fixed;
      z-index: 99999;
      top: 0; 
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(0,0,0,0.4);
      backdrop-filter: blur(10px);
    }
    #password-modal-content {
      background: #ffffff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.2);
      width: 400px;
      text-align: center;
    }
    #password-modal-content h2 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-size: 16px;
      line-height: 1.4;
    }
    #password-input {
      width: 100%;
      padding: 10px;
      font-size: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      font-family: 'Aptos', sans-serif;
    }
    #password-submit {
      background: linear-gradient(to right, #374852, #2D3E4F);
      color: #ffffff;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Aptos', sans-serif;
    }
    #password-submit:hover {
      background: linear-gradient(to right, #4a5c6b, #2D3E4F);
    }

    /* ============ HEADER ============ */
    header {
      width: 100%;
      background: linear-gradient(to right, #2D3E4F, #202f3e);
      color: #ffffff;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      box-sizing: border-box;
      height: 60px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .header-left img {
      height: 50px;
    }

    /* ============ MAIN CONTAINER LAYOUT ============ */
    #container {
      width: 100%;
      height: calc(100vh - 60px);
      display: flex;
      flex-direction: row;
      overflow: hidden;
    }
    #map {
      flex: 1; 
      position: relative;
      min-height: 400px;
    }

    /* ============ SIDEBAR WITH THREE SUB-PANELS ============ */
    .map-overlay {
      width: 400px; 
      background: #ffffff;
      border-left: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
      font-family: 'Aptos', sans-serif;
    }
    /* Make top area smaller, bottom area moderate, middle area bigger: */
    #top-area {
      flex: 0 0 25%;
      overflow-y: auto;
      padding: 10px 20px 0 20px;
    }
    #middle-area {
      flex: 0 0 45%;
      overflow-y: auto;
      padding: 10px 20px 0 20px;
    }
    #bottom-area {
      flex: 0 0 30%;
      overflow-y: auto;
      padding: 10px 20px 0 20px;
    }

    #loading-spinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      color: #2c3e50;
      z-index: 999;
      display: none;
    }

    /* MAPBOX GEOCODER */
    .mapboxgl-ctrl-geocoder {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 300px;
      z-index: 10;
      font-family: 'Aptos', sans-serif !important;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    }
    .mapboxgl-ctrl-geocoder--input {
      height: 36px !important;
      padding: 6px 35px !important;
    }

    /* SEARCH & FILTERS */
    fieldset {
      background: #f0f0f0;
      border: none;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    input[type="text"], input[type="number"] {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 8px;
      box-sizing: border-box;
      margin-bottom: 10px;
      font-size: 14px;
      width: 100%;
      font-family: 'Aptos', sans-serif;
    }
    .filters {
      background: #f0f0f0;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      font-family: 'Aptos', sans-serif;
    }
    .filters label {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .filters input[type=checkbox] {
      margin-right: 5px;
    }

    /* ============ LISTING & DASHBOARD ============ */
    #listing {
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 15px;
      background-color: #ffffff;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .facility-title {
      display: block;
      padding: 12px;
      margin: 8px 0;
      background: #f8f9fa;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      color: #2c3e50;
      text-decoration: none;
      border: 1px solid #e9ecef;
    }
    .facility-title:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }
    .facility-title.active {
      background: #fff3e0;
      border-left: 3px solid #F05A28;
      transform: translateX(5px);
    }

    .cog-section { margin-bottom: 10px; }
    .cog-header {
      background: #2D3E4F;
      padding: 12px 15px;
      cursor: pointer;
      border-radius: 5px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s ease;
      color: #ffffff;
      margin-bottom: 8px;
      font-family: 'Aptos', sans-serif;
    }
    .cog-header::after {
      content: '▼';
      font-size: 12px;
      color: #ffffff;
      transition: transform 0.3s ease;
      margin-left: 10px;
      opacity: 0.9;
    }
    .cog-header.expanded::after { transform: rotate(180deg); }
    .cog-header:hover { background: #455463; }

    .agency-list {
      margin-top: 5px;
      margin-bottom: 15px;
      padding-left: 10px;
      height: auto;
      overflow-y: visible;
    }
    .agency-title {
      font-size: 14px;
      font-weight: normal;
      margin: 5px 0;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 5px;
      transition: all 0.2s ease;
      color: #2c3e50;
      background: #f8f9fa;
      font-family: 'Aptos', sans-serif;
    }
    .agency-title:hover {
      background: #e0f7fa;
      color: #00796b;
      transform: translateX(5px);
    }
    #no-facilities-msg {
      padding: 10px;
      color: #666;
      font-style: italic;
      background: #f8f9fa;
      border-radius: 4px;
      margin: 10px 0;
      font-family: 'Aptos', sans-serif;
    }

    /* ============ DASHBOARD (AGENCY/FACILITY DETAILS) ============ */
    .dashboard {
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 20px;
      font-size: 14px;
      margin-top: 10px;
      font-family: 'Aptos', sans-serif;
    }
    .dashboard h3 {
      font-size: 20px;
      margin-top: 0;
      padding-bottom: 15px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ecf0f1;
      font-weight: bold;
      color: #2c3e50;
    }
    .dashboard h4 {
      margin-top: 20px;
      margin-bottom: 15px;
      font-size: 16px;
      color: #34495e;
      font-family: 'Aptos', sans-serif;
    }
    .metric {
      margin-bottom: 14px;
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .metric .metric-label { margin-right: 15px; flex: 0 0 auto; }
    .metric .metric-value { flex: 1; text-align: right; }

    #agency-data, #facility-data {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #ecf0f1;
    }
    #back-button {
      background-color: #2D3E4F;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Aptos', sans-serif;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
      transition: background-color 0.2s ease;
    }
    #back-button:hover { background-color: #455463; }
    #back-button::before {
      content: "←";
      font-size: 16px;
    }

    /* ============ INTRO / WELCOME AT BOTTOM ============ */
    #intro-section {
      font-family: 'Aptos', sans-serif;
      background-color: #ffffff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }
    #intro-section h4 {
      font-size: 16px;
      margin: 0 0 10px 0;
      color: #2c3e50;
    }
    #intro-section p, #intro-section li {
      font-size: 14px;
      color: #34495e;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    /* ============ WELCOME POPUP ============ */
    #welcome-popup {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-color: rgba(44,62,80,0.90);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.4s ease;
      backdrop-filter: blur(5px);
    }
    #welcome-popup.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    .welcome-content {
      background: white;
      padding: 60px 70px;
      border-radius: 16px;
      max-width: 800px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      position: relative;
      animation: slideIn 0.5s ease-out;
      font-family: 'Aptos', sans-serif;
    }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    #welcome-popup h1 {
      font-size: 22px;
      margin-bottom: 30px;
      color: #2c3e50;
      line-height: 1.4;
      font-weight: 700;
      border-bottom: 2px solid #ecf0f1;
      padding-bottom: 20px;
    }
    #welcome-popup h2 {
      font-size: 20px;
      color: #F05A28;
      margin: 30px 0 25px;
      font-weight: 600;
      line-height: 1.4;
      text-align: center;
    }
    #welcome-popup p {
      font-size: 16px;
      margin-bottom: 25px;
      color: #546e7a;
      line-height: 1.8;
      font-weight: 400;
      text-align: center;
      max-width: 650px;
      margin-left: auto;
      margin-right: auto;
    }
    #welcome-popup button {
      background-color: #2D3E4F;
      color: white;
      border: none;
      padding: 16px 40px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: block;
      margin: 40px auto 0;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    #welcome-popup button:hover {
      background-color: #455463;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* POPUPS FOR BOUNDARIES & FACILITIES */
    .boundary-popup .mapboxgl-popup-content,
    .facility-popup .mapboxgl-popup-content {
      background-color: rgba(255,255,255,0.95);
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      font-family: 'Aptos', sans-serif;
      font-size: 13px;
      line-height: 1.4;
    }
    .boundary-popup .mapboxgl-popup-tip,
    .facility-popup .mapboxgl-popup-tip {
      border-top-color: rgba(255,255,255,0.95);
    }
    .mapboxgl-popup {
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      #container {
        flex-direction: column;
      }
      #map {
        height: 50vh;
      }
      .map-overlay {
        position: relative;
        width: 100%;
        height: auto;
        max-height: 50vh;
      }
      #top-area,
      #middle-area,
      #bottom-area {
        flex: 0 0 auto;
        height: auto;
      }
      .welcome-content {
        padding: 40px;
        width: 85%;
      }
      #listing {
        max-height: 120px;
      }
    }
  </style>
</head>
<body>

<!-- ============ PASSWORD MODAL ============ -->
<div id="password-modal">
  <div id="password-modal-content">
    <h2>
      To access SoCalREN’s ERAP Dashboard <br>
      please enter your provided access code
    </h2>
    <input type="password" id="password-input" placeholder="Access Code">
    <button id="password-submit">Submit</button>
  </div>
</div>

<!-- ============ HEADER ============ -->
<header>
  <div class="header-left">
    <a href="https://socalren.org/" target="_blank">
      <img src="images/socalren_erapdashboard.png" alt="SoCalREN ERAP Logo">
    </a>
  </div>
</header>

<!-- ============ MAIN CONTAINER ============ -->
<div id="container">
  <div id="map"></div>

  <div class="map-overlay" id="dashboard-panel">
    <!-- ~~~ TOP AREA: Search & Filters ~~~ -->
    <div id="top-area">
      <fieldset>
        <input id="agency-filter" type="text" placeholder="Search for an agency">
      </fieldset>

      <fieldset class="filters" id="agency-filters">
        <legend>Agency Filters</legend>
        <label>
          <input type="checkbox" id="dac-filter"> 
          Show only Underserved and/or Hard to Reach
        </label>
        <label>
          <input type="checkbox" id="ces90-filter">
          Show only agencies with CalEnviroScreen Score > 90
        </label>
        <div style="margin-top:10px;">
          <label for="population-min">Population Range:</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="number" id="population-min" placeholder="Min" min="0" style="flex:1;">
            <span>to</span>
            <input type="number" id="population-max" placeholder="Max" min="0" style="flex:1;">
          </div>
        </div>
      </fieldset>

      <fieldset class="filters" id="facility-filters" style="display:none;">
        <legend>Facility Filters</legend>
        <label>
          <input type="checkbox" id="pv-filter"> 
          Show only facilities with PV/Battery
        </label>
        <label>
          <input type="checkbox" id="ev-filter"> 
          Show only facilities with EV chargers
        </label>
        <label>
          <input type="checkbox" id="cooling-filter"> 
          Show only Cooling Center/Emergency Ops
        </label>
      </fieldset>
    </div>

    <!-- ~~~ MIDDLE AREA: Listing & Dashboard ~~~ -->
    <div id="middle-area">
      <div id="listing"></div>

      <div class="dashboard" id="dashboard" style="display: none;">
        <h3 id="data-overview-title">Data Overview</h3>

        <!-- AGENCY DATA -->
        <div id="agency-data" style="display:none; margin-top:20px;">
          <h4>Agency-Level Data</h4>
          <div class="metric">
            <span class="metric-label">Underserved/Hard to Reach:</span>
            <span class="metric-value" id="agency-underserved">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">CalEnviroScreen Score:</span>
            <span class="metric-value" id="agency-calenviroscore">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Pollution Burden Percentile:</span>
            <span class="metric-value" id="agency-pollutionburden">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Population:</span>
            <span class="metric-value" id="agency-population">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">% Children and Seniors:</span>
            <span class="metric-value" id="agency-children-seniors">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Agency Area (sq miles):</span>
            <span class="metric-value" id="agency-area">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Population Density (per sq. mi):</span>
            <span class="metric-value" id="agency-density">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Extreme Heat Days (days/yr):</span>
            <span class="metric-value" id="agency-heat-days">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Average Household Income ($):</span>
            <span class="metric-value" id="agency-income">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">% Low-Income Census Tracts:</span>
            <span class="metric-value" id="agency-low-income">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label"># of Electric Circuits:</span>
            <span class="metric-value" id="agency-circuits">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Annual Consumption (kWh):</span>
            <span class="metric-value" id="agency-kwh">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Annual Consumption (Therms):</span>
            <span class="metric-value" id="agency-therms">Not yet available</span>
          </div>
        </div>

        <!-- FACILITY DATA -->
        <div id="facility-data" style="display:none; margin-top:20px;">
          <h4>Facility-Level Data</h4>
          <div class="metric">
            <span class="metric-label">Year Built:</span>
            <span class="metric-value" id="facility-year">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Gross Floor Area (sq ft):</span>
            <span class="metric-value" id="facility-sqft">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Walk Score (RHOA):</span>
            <span class="metric-value" id="facility-walkability">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Existing Use (Cooling/Emergency):</span>
            <span class="metric-value" id="facility-resilience">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Existing EV Chargers:</span>
            <span class="metric-value" id="facility-ev">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label"># of Planned EV Chargers:</span>
            <span class="metric-value" id="facility-planned-ev">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Existing PV/Battery?:</span>
            <span class="metric-value" id="facility-pv">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Planned PV (hours):</span>
            <span class="metric-value" id="facility-planned-pv">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Planned Battery (hours):</span>
            <span class="metric-value" id="facility-planned-battery">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Building Type:</span>
            <span class="metric-value" id="facility-type">Not yet available</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ~~~ BOTTOM AREA: Intro & Welcome ~~~ -->
    <div id="bottom-area">
      <div id="intro-section">
        <h4>Welcome to SoCalREN's ERAP Dashboard</h4>
        <p>
          This dashboard provides insights into public agencies' energy resilience planning efforts across Southern California that have received support from the SoCalREN Public Agency Programs. Use the filters above to find agencies by name, select a council of governments, or set population thresholds. Click on an agency name to view detailed metrics and access facility information.
        </p>
        <p>
          The data displayed here includes key metrics collected throughout an agency's involvement in the ERAP program. The dashboard can help you understand community needs, identify facilities equipped with Electric Vehicle chargers, Solar or Battery Storage, and plans for resilience improvements.
        </p>
        <h4>Getting Started</h4>
        <ul>
          <li>Use the "Search for an agency" box to quickly locate a participating agency.</li>
          <li>Adjust the range filter to focus on agencies with larger or smaller populations.</li>
          <li>Click an agency name to view its details and a list of associated facilities.</li>
        </ul>
        <h4>What is ERAP?</h4>
        <p>
          SoCalREN's Energy Resilience Action Plan (ERAP) program aims to address the growing impacts of climate change. Developed in collaboration with regional partners, the ERAP program enhances the energy resilience of critical infrastructure and future resilience hub locations for public agencies. By incorporating data-driven analysis and stakeholder input, ERAP supports agencies in developing a roadmap of near-term and long-term energy resilience strategies.
        </p>
        <p><em>This dashboard is a living tool. We welcome your feedback!</em></p>
      </div>
    </div>
  </div>
</div>

<!-- WELCOME POPUP -->
<div id="welcome-popup">
  <div class="welcome-content">
    <img src="images/SoCalREN_Logo_2017_PRIMARY.png" alt="SoCalREN Logo" style="width: 500px; margin-bottom: 20px;">
    <h1>
      <span class="title-line">Welcome to Southern California Regional Energy Network (SoCalREN)'s</span>
      <span class="title-line">Energy Resilience Action Plan (ERAP) Dashboard</span>
    </h1>
    <h2>Explore energy resilience planning efforts across Southern California</h2>
    <p>This interactive dashboard provides comprehensive information about facilities and agencies participating in SoCalREN's ERAP program. Use the map to explore geographical data, or search for specific details.</p>
    <button onclick="closeWelcome()">Enter Dashboard</button>
  </div>
</div>

<div id="loading-spinner">
  <i class="fas fa-spinner fa-spin"></i> Loading...
</div>

<script>
/* ============ PASSWORD PROMPT LOGIC ============ */
const passwordModal = document.getElementById('password-modal');
const passwordInput = document.getElementById('password-input');
const passwordSubmit = document.getElementById('password-submit');

document.addEventListener('DOMContentLoaded', () => {
  passwordModal.style.display = 'flex';
});

passwordSubmit.addEventListener('click', () => {
  if (passwordInput.value === 'test') {
    passwordModal.style.display = 'none';
    initMap();
  } else {
    location.reload(); 
  }
});

/* ============ MAPBOX SETUP ============ */
mapboxgl.accessToken = 'pk.eyJ1Ijoid2VuZ2xlMSIsImEiOiJjbGh0bTJ0OTUzN2dzM21tbTB0NzFmM2QyIn0.-ItjIktoJtcQUsk6l9TbbQ';
let map;

function initMap() {
  map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [-118.2437, 34.0522],
    zoom: 10,
    pitch: 45
  });

  map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
  map.addControl(new mapboxgl.NavigationControl(), 'top-right');

  // Add geocoder for general location search
  const geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    mapboxgl: mapboxgl,
    placeholder: 'Search for a location'
  });
  map.addControl(geocoder, 'top-left');

  map.on('load', () => {
    document.getElementById('loading-spinner').style.display = 'block';
    loadBoundariesAndFacilities(); 
  });
}

/* ============ AGENCIES DATA & FACILITIES (same as you provided) =========== */

/* (Insert your agenciesData / facilitiesData arrays here exactly as in your current code) */
const agenciesData = [
  /* ... your full agency objects ... */
];
const facilitiesData = [
  /* ... your full facility objects with lat/lon ... */
];

/* ============ LOADING BOUNDARIES + MAKING FACILITY MARKERS =========== */
async function loadBoundariesAndFacilities() {
  // 1) boundary data
  fetch('data/la_boundaries.geojson')
    .then(resp => resp.json())
    .then(geojson => {
      map.addSource('la-boundaries', { type: 'geojson', data: geojson });
      // fill-extrusion
      map.addLayer({
        id: 'la-boundaries-extrusion',
        type: 'fill-extrusion',
        source: 'la-boundaries',
        paint: {
          'fill-extrusion-color': '#9A5CA7',
          'fill-extrusion-height': 500,
          'fill-extrusion-opacity': 0.4
        }
      });

      // boundary hover popup
      let hoveredId = null;
      const boundaryPopup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false,
        anchor: 'top',
        offset: [0,0],
        className: 'boundary-popup'
      });

      map.on('mousemove', 'la-boundaries-extrusion', e => {
        map.getCanvas().style.cursor = 'pointer';
        if (e.features.length > 0) {
          if (hoveredId) {
            map.setFeatureState({ source: 'la-boundaries', id: hoveredId }, { hover: false });
          }
          hoveredId = e.features[0].id;
          map.setFeatureState({ source: 'la-boundaries', id: hoveredId }, { hover: true });

          const cityName = e.features[0].properties.CITY_COMM_NAME || '';
          let matchedAgency = agenciesData.find(a => a.Agency.toLowerCase() === cityName.toLowerCase());
          if (!matchedAgency) {
            matchedAgency = agenciesData.find(a => cityName.toLowerCase().includes(a.Agency.toLowerCase()));
          }
          let popupHtml = `<strong>${cityName}</strong><br><em>No data found</em>`;
          if (matchedAgency) {
            const pop = matchedAgency.Population || 'N/A';
            const income = matchedAgency["Average Household Income"] || 'N/A';
            popupHtml = `
              <strong>${matchedAgency.Agency}</strong><br>
              Population: ${pop.toLocaleString()}<br>
              Income: $${income.toLocaleString()}
            `;
          }
          boundaryPopup.setLngLat(e.lngLat).setHTML(popupHtml).addTo(map);
        }
      });

      map.on('mouseleave', 'la-boundaries-extrusion', () => {
        map.getCanvas().style.cursor = '';
        boundaryPopup.remove();
        if (hoveredId) {
          map.setFeatureState({ source: 'la-boundaries', id: hoveredId }, { hover: false });
        }
        hoveredId = null;
      });

      // on click => show that agency
      map.on('click', 'la-boundaries-extrusion', e => {
        if (!e.features.length) return;
        const cityName = e.features[0].properties.CITY_COMM_NAME || '';
        if (cityName) {
          let matched = agenciesData.find(a => a.Agency.toLowerCase() === cityName.toLowerCase());
          if (!matched) {
            matched = agenciesData.find(a => cityName.toLowerCase().includes(a.Agency.toLowerCase()));
          }
          if (matched) {
            const facs = facilitiesData.filter(f => f.Agency === matched.Agency);
            showFacilities(matched, facs);
          }
        }
      });
    })
    .catch(err => console.error('Error loading boundaries:', err));

  // 2) build a FeatureCollection from lat/lon
  const facilityFeatures = [];
  facilitiesData.forEach(fac => {
    const lat = parseFloat(fac.Latitude);
    const lng = parseFloat(fac.Longitude);
    if (!isNaN(lat) && !isNaN(lng)) {
      facilityFeatures.push({
        type: 'Feature',
        geometry: {
          type: 'Point',
          coordinates: [lng, lat]
        },
        properties: { ...fac }
      });
    }
  });
  const facilityGeoJSON = {
    type: 'FeatureCollection',
    features: facilityFeatures
  };

  // add facility data with clustering
  map.addSource('facilities', {
    type: 'geojson',
    data: facilityGeoJSON,
    cluster: true,
    clusterMaxZoom: 14,
    clusterRadius: 50
  });

  map.addLayer({
    id: 'clusters',
    type: 'circle',
    source: 'facilities',
    filter: ['has','point_count'],
    paint: {
      'circle-radius': [
        'step', ['get','point_count'],
        25, 10,
        30, 25,
        35
      ],
      'circle-color': [
        'step', ['get','point_count'],
        '#F37B43', 10,
        '#F05A28', 25,
        '#9A5CA7'
      ],
      'circle-opacity': 0.9,
      'circle-stroke-width': 2,
      'circle-stroke-color': '#ffffff',
      'circle-stroke-opacity': 0.9
    }
  });

  map.addLayer({
    id: 'cluster-count',
    type: 'symbol',
    source: 'facilities',
    filter: ['has','point_count'],
    layout: {
      'text-field': '{point_count_abbreviated}',
      'text-font': ['DIN Offc Pro Bold','Arial Unicode MS Bold'],
      'text-size': 16,
      'text-allow-overlap': true
    },
    paint: {
      'text-color': '#ffffff',
      'text-halo-color': 'rgba(0,0,0,0.2)',
      'text-halo-width': 1
    }
  });

  // unclustered
  map.addLayer({
    id: 'unclustered-point',
    type: 'circle',
    source: 'facilities',
    filter: ['!',['has','point_count']],
    paint: {
      'circle-color': '#F37B43',
      'circle-radius': 8,
      'circle-stroke-width': 2,
      'circle-stroke-color': '#ffffff',
      'circle-opacity': 0.9,
      'circle-stroke-opacity': 0.9
    }
  });

  // Move facility layers above the boundary layer
  map.moveLayer('clusters', 'la-boundaries-extrusion');
  map.moveLayer('cluster-count', 'la-boundaries-extrusion');
  map.moveLayer('unclustered-point', 'la-boundaries-extrusion');

  // popup on hover
  const facilityPopup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false,
    anchor: 'bottom',
    offset: [0, -10],
    className: 'facility-popup'
  });

  map.on('mouseenter', 'unclustered-point', e => {
    map.getCanvas().style.cursor = 'pointer';
    const props = e.features[0].properties;
    const content = `
      <strong>${props["Facility Name"] || "Unknown Facility"}</strong><br>
      Existing Use: ${props["Existing use"] || "N/A"}<br>
      EV Chargers: ${props["Existing EV Chargers (Yes/No)"] || "N/A"}
    `;
    facilityPopup.setLngLat(e.lngLat).setHTML(content).addTo(map);
  });

  map.on('mouseleave', 'unclustered-point', () => {
    map.getCanvas().style.cursor = '';
    facilityPopup.remove();
  });

  // cluster click => zoom
  map.on('click','clusters', e => {
    const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
    if (!features.length) return;
    const clusterId = features[0].properties.cluster_id;
    map.getSource('facilities').getClusterExpansionZoom(clusterId, (err, zoom) => {
      if (err) return;
      map.easeTo({ center: features[0].geometry.coordinates, zoom });
    });
  });

  // unclustered point click => show facility
  map.on('click','unclustered-point', e => {
    const props = e.features[0].properties;
    const matchedAgency = agenciesData.find(a => a.Agency === props["Agency"]);
    if (matchedAgency) {
      const facs = facilitiesData.filter(f => f.Agency === matchedAgency.Agency);
      showFacilities(matchedAgency, facs);
      showFacilityDetails(props["Agency"], props["Facility Name"]);
    }
  });

  document.getElementById('loading-spinner').style.display = 'none';
}

/* ============ FILTERING & DASHBOARD LOGIC =========== */
function renderListing() {
  const listingElement = document.getElementById('listing');
  const agencyFilters = document.getElementById('agency-filters');
  const facilityFilters = document.getElementById('facility-filters');

  listingElement.innerHTML = '';
  agencyFilters.style.display = 'block';
  facilityFilters.style.display = 'none';

  // group agencies by COG
  const groups = {};
  agenciesData.forEach(a => {
    const cog = a.COG;
    if (!groups[cog]) groups[cog] = [];
    groups[cog].push(a);
  });

  for (const [cog, agencies] of Object.entries(groups)) {
    if (agencies.length > 0) {
      const cogSection = document.createElement('div');
      cogSection.className = 'cog-section';

      const cogHeader = document.createElement('div');
      cogHeader.className = 'cog-header';
      cogHeader.textContent = cog;

      const agencyList = document.createElement('div');
      agencyList.className = 'agency-list';
      agencyList.style.display = 'none';

      cogHeader.addEventListener('click', () => {
        const isHidden = agencyList.style.display === 'none';
        cogHeader.classList.toggle('expanded', isHidden);
        agencyList.style.display = isHidden ? 'block' : 'none';
      });

      agencies.sort((a,b) => a.Agency.localeCompare(b.Agency));
      agencies.forEach(a => {
        const div = document.createElement('div');
        div.className = 'agency-title';
        div.textContent = a.Agency;
        div.onclick = () => {
          const facs = facilitiesData.filter(f => f.Agency === a.Agency);
          showFacilities(a, facs);
        };
        agencyList.appendChild(div);
      });

      cogSection.appendChild(cogHeader);
      cogSection.appendChild(agencyList);
      listingElement.appendChild(cogSection);
    }
  }
}

function filterAgencies() {
  const minPop = parseInt(document.getElementById('population-min').value) || 0;
  const maxPop = parseInt(document.getElementById('population-max').value) || Infinity;
  const searchText = document.getElementById('agency-filter').value.toLowerCase().trim();
  const dacFilter = document.getElementById('dac-filter').checked;
  const ces90Filter = document.getElementById('ces90-filter').checked;

  const filtered = agenciesData.filter(a => {
    const nameMatch = !searchText || a.Agency.toLowerCase().includes(searchText);
    const popVal = Number(a.Population) || 0;
    const popMatch = (popVal >= minPop && popVal <= maxPop);
    const isUnderserved = (a["Underserved and/or  Hard to Reach"] || '').toLowerCase() === 'yes';
    const matchDAC = !dacFilter || isUnderserved;
    const calVal = Number(a["CalEnviroScreen Score"]) || 0;
    const matchCal = !ces90Filter || (calVal > 90);

    return nameMatch && popMatch && matchDAC && matchCal;
  });

  const listingElement = document.getElementById('listing');
  listingElement.innerHTML = '';

  if (!filtered.length) {
    listingElement.innerHTML = `<p style="color:#666;font-style:italic;">No matching agencies found.</p>`;
    return;
  }

  const groupByCOG = {};
  filtered.forEach(a => {
    const c = a.COG;
    if (!groupByCOG[c]) groupByCOG[c] = [];
    groupByCOG[c].push(a);
  });

  for (const [cog, agencies] of Object.entries(groupByCOG)) {
    if (agencies.length > 0) {
      const cogSection = document.createElement('div');
      cogSection.className = 'cog-section';

      const cogHeader = document.createElement('div');
      cogHeader.className = 'cog-header';
      cogHeader.textContent = cog;

      const agencyList = document.createElement('div');
      agencyList.className = 'agency-list';
      agencyList.style.display = 'none';

      cogHeader.addEventListener('click', () => {
        const isHidden = agencyList.style.display === 'none';
        cogHeader.classList.toggle('expanded', isHidden);
        agencyList.style.display = isHidden ? 'block' : 'none';
      });

      agencies.sort((a,b) => a.Agency.localeCompare(b.Agency));
      agencies.forEach(a => {
        const agencyDiv = document.createElement('div');
        agencyDiv.className = 'agency-title';
        agencyDiv.textContent = a.Agency;
        agencyDiv.onclick = () => {
          const facs = facilitiesData.filter(f => f.Agency === a.Agency);
          showFacilities(a, facs);
        };
        agencyList.appendChild(agencyDiv);
      });

      cogSection.appendChild(cogHeader);
      cogSection.appendChild(agencyList);
      listingElement.appendChild(cogSection);
    }
  }
}

// event listeners for agency filters
document.getElementById('population-min').addEventListener('input', filterAgencies);
document.getElementById('population-max').addEventListener('input', filterAgencies);
document.getElementById('agency-filter').addEventListener('input', filterAgencies);
document.getElementById('dac-filter').addEventListener('change', filterAgencies);
document.getElementById('ces90-filter').addEventListener('change', filterAgencies);

// facility filters
document.getElementById('pv-filter').addEventListener('change', refreshFacilityList);
document.getElementById('ev-filter').addEventListener('change', refreshFacilityList);
document.getElementById('cooling-filter').addEventListener('change', refreshFacilityList);

function refreshFacilityList() {
  const title = document.querySelector('#data-overview-title').textContent;
  const foundAgency = agenciesData.find(a => title.includes(a.Agency));
  if (foundAgency) {
    const facs = facilitiesData.filter(f => f.Agency === foundAgency.Agency);
    showFacilities(foundAgency, facs);
  }
}

function showFacilities(agency, facilityList) {
  const listingElement = document.getElementById('listing');
  const dashboardElement = document.getElementById('dashboard');
  const agencyDataElement = document.getElementById('agency-data');
  const facilityDataElement = document.getElementById('facility-data');
  const agencyFilters = document.getElementById('agency-filters');
  const facilityFilters = document.getElementById('facility-filters');

  // Clear listing
  listingElement.innerHTML = '';

  // Back button
  const backButton = document.createElement('button');
  backButton.id = 'back-button';
  backButton.textContent = 'Back to Agencies';
  backButton.onclick = () => {
    dashboardElement.style.display = 'none';
    renderListing();
  };
  listingElement.appendChild(backButton);

  // Title
  const header = document.createElement('h4');
  header.textContent = `Facilities in ${agency.Agency}`;
  listingElement.appendChild(header);

  // Hide agency filters, show facility filters
  agencyFilters.style.display = 'none';
  facilityFilters.style.display = 'block';

  // Apply facility checkboxes
  const filteredFacilities = filterFacilities(facilityList);

  if (filteredFacilities.length > 0) {
    filteredFacilities.forEach(f => {
      const facilityDiv = document.createElement('div');
      facilityDiv.className = 'facility-title';
      facilityDiv.textContent = f["Facility Name"];
      facilityDiv.onclick = () => showFacilityDetails(f.Agency, f["Facility Name"]);
      listingElement.appendChild(facilityDiv);
    });
  } else {
    const noFacilitiesMsg = document.createElement('div');
    noFacilitiesMsg.id = 'no-facilities-msg';
    noFacilitiesMsg.textContent = 'No facilities found matching the selected filters.';
    listingElement.appendChild(noFacilitiesMsg);
  }

  // Show the dashboard
  dashboardElement.style.display = 'block';
  agencyDataElement.style.display = 'block';
  facilityDataElement.style.display = 'none';

  updateAgencyDashboard(agency);
}

function filterFacilities(facList) {
  const pvChecked = document.getElementById('pv-filter').checked;
  const evChecked = document.getElementById('ev-filter').checked;
  const coolChecked = document.getElementById('cooling-filter').checked;

  return facList.filter(f => {
    if (pvChecked) {
      const hasPV = f["Exisiting PV or Battery Capabilities (Yes/No)"] 
        && f["Exisiting PV or Battery Capabilities (Yes/No)"].toLowerCase() !== 'no'
        && f["Exisiting PV or Battery Capabilities (Yes/No)"].toLowerCase() !== 'n/a';
      if (!hasPV) return false;
    }
    if (evChecked) {
      const evVal = (f["Existing EV Chargers (Yes/No)"] || '').toLowerCase();
      if (!evVal.includes('yes')) return false;
    }
    if (coolChecked) {
      const usage = (f["Existing Use? (cooling center or emergency ops)"] || '').toLowerCase();
      if (!usage.includes('cooling') && !usage.includes('emergency')) return false;
    }
    return true;
  });
}

function updateAgencyDashboard(agency) {
  document.getElementById('data-overview-title').textContent = agency.Agency + " Data Overview";

  const getSafe = (obj, key) => {
    if (obj[key] === null || obj[key] === undefined) return "N/A";
    if (String(obj[key]).toUpperCase() === 'N/A') return "N/A";
    return obj[key];
  };

  const underscore = agency["Underserved and/or  Hard to Reach"] || "No";
  document.getElementById('agency-underserved').textContent = underscore;
  document.getElementById('agency-calenviroscore').textContent = getSafe(agency, "CalEnviroScreen Score");
  document.getElementById('agency-pollutionburden').textContent = getSafe(agency, "Pollution Burden");

  let popVal = getSafe(agency, "Population");
  if (!isNaN(popVal)) popVal = parseInt(popVal).toLocaleString();
  document.getElementById('agency-population').textContent = popVal;

  const csVal = getSafe(agency, "% Children and Seniors");
  document.getElementById('agency-children-seniors').textContent = csVal;

  document.getElementById('agency-area').textContent = getSafe(agency, "Agency Area (sq. miles)");

  let denVal = getSafe(agency, "Population Density (per sq mile)");
  if (!isNaN(denVal)) denVal = parseInt(denVal).toLocaleString();
  document.getElementById('agency-density').textContent = denVal;

  document.getElementById('agency-heat-days').textContent = getSafe(agency, "Number of Extreme Heat Days");

  let incVal = getSafe(agency, "Average Household Income");
  if (!isNaN(incVal)) incVal = parseInt(incVal).toLocaleString();
  document.getElementById('agency-income').textContent = incVal;

  document.getElementById('agency-low-income').textContent = getSafe(agency, "% Low-Income Census Tracts");
  document.getElementById('agency-circuits').textContent = getSafe(agency, "Number of Electric Circuits");

  let kwhVal = getSafe(agency, "Annual kWh consumption");
  if (!isNaN(kwhVal)) kwhVal = parseInt(kwhVal).toLocaleString();
  document.getElementById('agency-kwh').textContent = kwhVal;

  let thermVal = getSafe(agency, "Annual Therms Consumption");
  if (!isNaN(thermVal)) thermVal = parseInt(thermVal).toLocaleString();
  document.getElementById('agency-therms').textContent = thermVal;
}

function showFacilityDetails(agencyName, facilityName) {
  const facility = facilitiesData.find(f => f.Agency === agencyName && f["Facility Name"] === facilityName);
  if (!facility) return;

  document.getElementById('facility-data').style.display = 'block';
  document.getElementById('agency-data').style.display = 'none';
  document.getElementById('data-overview-title').textContent = facilityName;

  const safeVal = (val) => {
    if (!val || val.toString().toUpperCase() === 'N/A') return "Not yet available";
    return val;
  };

  document.getElementById('facility-year').textContent = safeVal(facility["Yr Built (RHOA)"]);
  document.getElementById('facility-sqft').textContent = safeVal(facility["Sq Ft"]);
  document.getElementById('facility-walkability').textContent = safeVal(facility["Walk Score (RHOA)"]);
  document.getElementById('facility-resilience').textContent = safeVal(facility["Existing Use? (cooling center or emergency ops)"]);
  document.getElementById('facility-ev').textContent = safeVal(facility["Existing EV Chargers (Yes/No)"]);
  document.getElementById('facility-planned-ev').textContent = safeVal(facility["Number of Planned EV Chargers"]);
  document.getElementById('facility-pv').textContent = safeVal(facility["Exisiting PV or Battery Capabilities (Yes/No)"]);
  document.getElementById('facility-planned-pv').textContent = safeVal(facility["Planned PV (hours of autonomy)"]);
  document.getElementById('facility-planned-battery').textContent = safeVal(facility["Planned Battery Storage (hours of autonomy)"]);
  document.getElementById('facility-type').textContent = safeVal(facility["Existing use"]);

  // highlight the clicked facility
  const facilityEls = document.querySelectorAll('.facility-title');
  facilityEls.forEach(el => {
    el.classList.toggle('active', el.textContent.trim() === facilityName);
  });
}

/* ============ WELCOME POPUP =========== */
function closeWelcome() {
  const popup = document.getElementById('welcome-popup');
  popup.classList.add('fade-out');
  setTimeout(() => {
    popup.style.display = 'none';
  }, 400);
}

/* INITIALIZE THE AGENCY LIST RIGHT AWAY */
renderListing();
</script>
</body>
</html>
