<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SoCalREN's ERAP Dashboard</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

  <!-- MAPBOX & FONTS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.js"></script>

  <!-- Aptos font-face (sample) -->
  <style>
  @font-face {
    font-family: 'Aptos';
    font-weight: 400;
    font-style: normal;
  }
  </style>

  <!-- Mapbox Geocoder (for searching the map) -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css" type="text/css">

  <!-- FontAwesome for icons -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>

  <style>
    /* ============ BASE & LAYOUT ============ */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #ffffff;
      font-family: 'Aptos', sans-serif;
      overflow: hidden; /* Hide scrollbars */
    }
    body {
      color: #2D3E4F;  /* Navy-ish text */
      font-size: 16px; /* overall base */
    }

    /* ============ PASSWORD MODAL ============ */
    #password-modal {
      position: fixed;
      z-index: 99999;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(0,0,0,0.4);
      backdrop-filter: blur(10px);
    }
    #password-modal-content {
      background: #ffffff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.2);
      width: 400px;
      text-align: center;
    }
    #password-modal-content h2 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-size: 16px;
      line-height: 1.4;
    }
    #password-input {
      width: 100%;
      padding: 10px;
      font-size: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      font-family: 'Aptos', sans-serif;
    }
    #password-submit {
      background: linear-gradient(to right, #374852, #2D3E4F);
      color: #ffffff;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Aptos', sans-serif;
    }
    #password-submit:hover {
      background: linear-gradient(to right, #4a5c6b, #2D3E4F);
    }

    /* ============ HEADER ============ */
    header {
      width: 100%;
      background: linear-gradient(to right, #2D3E4F, #202f3e);
      color: #ffffff;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      box-sizing: border-box;
      height: 60px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .header-left img {
      height: 50px;
    }

    /* ============ MAIN WRAPPER ============ */
    #container {
      display: flex;
      width: 100%;
      height: calc(100vh - 60px);
      flex-direction: row;
    }

    /* ============ MAP (70%) ============ */
    #map {
      flex: 0 0 70%; /* 70% of the screen for the map */
      position: relative;
      min-height: 400px;
    }

    /* ============ PANEL (30%) ============ */
    .map-overlay {
      flex: 0 0 30%; /* 30% of the screen for the panel */
      display: flex;
      flex-direction: column;
      background-color: #ffffff;
      border-left: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      overflow-x: hidden; /* remove side scroll */
      overflow-y: auto;   /* vertical scrolling if needed */
      font-size: 14px;    /* reduced text scale in the panel */
      box-sizing: border-box;
    }

    /* ============ LOADING SPINNER ============ */
    #loading-spinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      color: #2c3e50;
      z-index: 999;
      display: none;
    }

    /* ============ MAPBOX GEOCODER ============ */
    .mapboxgl-ctrl-geocoder {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 300px;
      z-index: 10;
      font-family: 'Aptos', sans-serif !important;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    }
    .mapboxgl-ctrl-geocoder--input {
      height: 36px !important;
      padding: 6px 35px !important;
    }

    /* ============ PANEL CONTENT SECTIONS ============ */
    /* We'll place filters, listing, agency data, and intro as separate sections stacked. */

    /* FILTERS SECTION */
    #filters-section {
      padding: 15px 20px;
      border-bottom: 1px solid #e0e0e0;
    }
    fieldset {
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 12px;
    }
    fieldset legend {
      font-size: 14px;
      margin-bottom: 8px;
      color: #2D3E4F;
      font-weight: 600;
    }
    input[type="text"], input[type="number"] {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 8px;
      box-sizing: border-box;
      font-size: 14px;
      width: 100%;
      font-family: 'Aptos', sans-serif;
      margin-bottom: 8px;
    }
    .filters label {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      font-size: 14px;
      color: #2D3E4F;
      cursor: pointer;
    }
    .filters input[type=checkbox] {
      margin-right: 6px;
      cursor: pointer;
    }

    /* LISTING SECTION */
    #listing-section {
      padding: 15px 20px;
      border-bottom: 1px solid #e0e0e0;
    }
    #listing {
      width: 100%;
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
    }
    #listing h4 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 14px;
      font-weight: 600;
      color: #2D3E4F;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 4px;
    }
    .cog-section {
      margin-bottom: 10px;
    }
    .cog-header {
      background: #2D3E4F;
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 5px;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .cog-header::after {
      content: '▼';
      font-size: 12px;
      transition: transform 0.3s ease;
      margin-left: 10px;
      opacity: 0.9;
    }
    .cog-header.expanded::after {
      transform: rotate(180deg);
    }
    .cog-header:hover {
      background: #374852;
    }
    .agency-list {
      margin: 0;
      padding-left: 0;
    }
    .agency-title {
      background: #f9f9f9;
      margin-bottom: 5px;
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
      color: #2D3E4F;
      cursor: pointer;
      transition: background-color 0.2s ease;
      font-size: 14px;
    }
    .agency-title:hover {
      background: #f0f7fa;
      border-color: #34A794; /* teal accent on hover */
    }
    #no-facilities-msg {
      padding: 10px;
      color: #666;
      font-style: italic;
      background: #f9f9f9;
      border-radius: 4px;
      margin: 10px 0;
      border: 1px solid #e0e0e0;
    }

    /* AGENCY DASHBOARD SECTION */
    #agency-dashboard {
      padding: 15px 20px;
      border-bottom: 1px solid #e0e0e0;
    }
    #dashboard {
      background-color: #ffffff;
      border-radius: 6px;
      border: 1px solid #ddd;
      padding: 15px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.05);
    }
    #dashboard h3 {
      font-size: 16px;
      margin-bottom: 10px;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 4px;
      color: #2D3E4F;
    }
    #agency-data {
      margin-top: 10px;
    }
    #agency-data h4 {
      font-size: 14px;
      margin-bottom: 6px;
      color: #2D3E4F;
    }
    .metric {
      margin-bottom: 8px;
      background-color: #f9f9f9;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .metric .metric-label {
      color: #2D3E4F;
      font-weight: 500;
      margin-right: 10px;
      flex: 0 0 auto;
      font-size: 13px;
    }
    .metric .metric-value {
      flex: 1;
      text-align: right;
      font-size: 13px;
      color: #34495e;
    }

    /* BACK BUTTON */
    #back-button {
      background-color: #2D3E4F;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Aptos', sans-serif;
      font-size: 13px;
      margin-bottom: 10px;
      transition: background-color 0.2s ease;
      display: inline-flex;
      align-items: center;
    }
    #back-button:hover {
      background-color: #374852;
    }
    #back-button::before {
      content: "←";
      font-size: 14px;
      margin-right: 6px;
    }

    /* INTRO SECTION */
    #intro-section {
      padding: 15px 20px;
      background-color: #ffffff;
    }
    #intro-section h4 {
      margin-top: 0;
      font-size: 14px;
      color: #2D3E4F;
      margin-bottom: 8px;
    }
    #intro-section p,
    #intro-section li {
      font-size: 13px;
      color: #34495e;
      line-height: 1.5;
      margin-bottom: 8px;
    }

    /* WELCOME POPUP */
    #welcome-popup {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-color: rgba(44,62,80,0.90);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.4s ease;
      backdrop-filter: blur(5px);
    }
    #welcome-popup.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    .welcome-content {
      background: white;
      padding: 40px 50px;
      border-radius: 8px;
      max-width: 800px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      position: relative;
      animation: slideIn 0.5s ease-out;
      font-family: 'Aptos', sans-serif;
    }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    #welcome-popup h1 {
      font-size: 18px;
      margin-bottom: 18px;
      color: #2c3e50;
      line-height: 1.4;
      font-weight: 700;
      border-bottom: 1px solid #ecf0f1;
      padding-bottom: 10px;
    }
    #welcome-popup h2 {
      font-size: 16px;
      color: #F05A28;
      margin: 20px 0 15px;
      font-weight: 600;
      line-height: 1.4;
      text-align: center;
    }
    #welcome-popup p {
      font-size: 13px;
      margin-bottom: 15px;
      color: #546e7a;
      line-height: 1.6;
      font-weight: 400;
      text-align: center;
      max-width: 650px;
      margin-left: auto;
      margin-right: auto;
    }
    #welcome-popup button {
      background-color: #2D3E4F;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      letter-spacing: 0.5px;
      margin-top: 20px;
    }
    #welcome-popup button:hover {
      background-color: #455463;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* BOUNDARY & FACILITY POPUPS */
    .boundary-popup .mapboxgl-popup-content,
    .facility-popup .mapboxgl-popup-content {
      background-color: rgba(255,255,255,0.95);
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      font-family: 'Aptos', sans-serif;
      font-size: 13px;
      line-height: 1.4;
    }
    .boundary-popup .mapboxgl-popup-tip,
    .facility-popup .mapboxgl-popup-tip {
      border-top-color: rgba(255,255,255,0.95);
    }
    .mapboxgl-popup {
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      #container {
        flex-direction: column;
      }
      #map {
        flex: 0 0 auto;
        height: 50vh;
      }
      .map-overlay {
        flex: 1;
        max-height: 50vh;
      }
      #filters-section, #listing-section, #agency-dashboard, #intro-section {
        padding: 10px;
      }
    }
  </style>
</head>
<body>

<!-- ============ PASSWORD MODAL ============ -->
<div id="password-modal">
  <div id="password-modal-content">
    <h2>To access SoCalREN’s ERAP Dashboard <br> please enter your provided access code</h2>
    <input type="password" id="password-input" placeholder="Access Code">
    <button id="password-submit">Submit</button>
  </div>
</div>

<!-- ============ HEADER ============ -->
<header>
  <div class="header-left">
    <a href="https://socalren.org/" target="_blank">
      <img src="images/socalren_erapdashboard.png" alt="SoCalREN ERAP Logo">
    </a>
  </div>
</header>

<!-- ============ MAIN CONTAINER ============ -->
<div id="container">
  <!-- ============ MAP (70%) ============ -->
  <div id="map"></div>

  <!-- ============ PANEL (30%) ============ -->
  <div class="map-overlay" id="dashboard-panel">

    <!-- ~~~ FILTERS SECTION ~~~ -->
    <section id="filters-section">
      <fieldset>
        <input id="agency-filter" type="text" placeholder="Search for an agency">
      </fieldset>

      <fieldset class="filters" id="agency-filters">
        <legend>Agency Filters</legend>
        <label>
          <input type="checkbox" id="dac-filter">
          Show only Underserved and/or Hard to Reach
        </label>
        <label>
          <input type="checkbox" id="ces90-filter">
          Show only agencies with CalEnviroScreen Score > 90
        </label>
        <div style="margin-top:8px;">
          <label for="population-min" style="margin-bottom:4px;">Population Range:</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="number" id="population-min" placeholder="Min" min="0" style="flex:1;">
            <span>to</span>
            <input type="number" id="population-max" placeholder="Max" min="0" style="flex:1;">
          </div>
        </div>
      </fieldset>

      <fieldset class="filters" id="facility-filters" style="display:none;">
        <legend>Facility Filters</legend>
        <label>
          <input type="checkbox" id="pv-filter">
          Show only facilities with PV/Battery
        </label>
        <label>
          <input type="checkbox" id="ev-filter">
          Show only facilities with EV chargers
        </label>
        <label>
          <input type="checkbox" id="cooling-filter">
          Show only Cooling Center/Emergency Ops
        </label>
      </fieldset>
    </section>

    <!-- ~~~ LISTING SECTION ~~~ -->
    <section id="listing-section">
      <div id="listing"></div>
    </section>

    <!-- ~~~ AGENCY DASHBOARD SECTION ~~~ -->
    <section id="agency-dashboard">
      <div class="dashboard" id="dashboard" style="display: none;">
        <h3 id="data-overview-title">Data Overview</h3>

        <div id="agency-data" style="display:none;">
          <h4>Agency-Level Data</h4>

          <div class="metric">
            <span class="metric-label">Underserved/Hard to Reach:</span>
            <span class="metric-value" id="agency-underserved">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">CalEnviroScreen Score:</span>
            <span class="metric-value" id="agency-calenviroscore">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Pollution Burden Percentile:</span>
            <span class="metric-value" id="agency-pollutionburden">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Population:</span>
            <span class="metric-value" id="agency-population">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">% Children and Seniors:</span>
            <span class="metric-value" id="agency-children-seniors">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Agency Area (sq miles):</span>
            <span class="metric-value" id="agency-area">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Population Density (per sq. mi):</span>
            <span class="metric-value" id="agency-density">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Extreme Heat Days (days/yr):</span>
            <span class="metric-value" id="agency-heat-days">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Average Household Income ($):</span>
            <span class="metric-value" id="agency-income">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">% Low-Income Census Tracts:</span>
            <span class="metric-value" id="agency-low-income">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label"># of Electric Circuits:</span>
            <span class="metric-value" id="agency-circuits">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Annual Consumption (kWh):</span>
            <span class="metric-value" id="agency-kwh">Not yet available</span>
          </div>
          <div class="metric">
            <span class="metric-label">Annual Consumption (Therms):</span>
            <span class="metric-value" id="agency-therms">Not yet available</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ~~~ INTRO / WELCOME AT BOTTOM ~~~ -->
    <section id="intro-section">
      <h4>Welcome to SoCalREN's ERAP Dashboard</h4>
      <p>
        This dashboard provides insights into public agencies' energy resilience planning efforts across Southern California that have received support from the SoCalREN Public Agency Programs. Use the filters above to find agencies by name, select a council of governments, or set population thresholds. Click on an agency name to view detailed metrics and access facility information.
      </p>
      <p>
        The data displayed here includes key metrics collected throughout an agency's involvement in the ERAP program. The dashboard can help you understand community needs, identify facilities equipped with Electric Vehicle chargers, Solar or Battery Storage, and plans for resilience improvements.
      </p>
      <h4>Getting Started</h4>
      <ul>
        <li>Use the "Search for an agency" box to quickly locate a participating agency.</li>
        <li>Adjust the range filter to focus on agencies with larger or smaller populations.</li>
        <li>Click an agency name to view its details and a list of associated facilities.</li>
      </ul>
      <h4>What is ERAP?</h4>
      <p>
        SoCalREN's Energy Resilience Action Plan (ERAP) program aims to address the growing impacts of climate change. Developed in collaboration with regional partners, the ERAP program enhances the energy resilience of critical infrastructure and future resilience hub locations for public agencies. By incorporating data-driven analysis and stakeholder input, ERAP supports agencies in developing a roadmap of near-term and long-term energy resilience strategies.
      </p>
      <p><em>This dashboard is a living tool. We welcome your feedback!</em></p>
    </section>
  </div>
</div>

<!-- WELCOME POPUP -->
<div id="welcome-popup">
  <div class="welcome-content">
    <img src="images/SoCalREN_Logo_2017_PRIMARY.png" alt="SoCalREN Logo" style="width: 300px; margin-bottom: 20px;">
    <h1>Welcome to Southern California Regional Energy Network (SoCalREN)'s <br>Energy Resilience Action Plan (ERAP) Dashboard</h1>
    <h2>Explore energy resilience planning efforts across Southern California</h2>
    <p>This interactive dashboard provides comprehensive information about facilities and agencies participating in SoCalREN's ERAP program. Use the map to explore geographical data, or search for specific details.</p>
    <button onclick="closeWelcome()">Enter Dashboard</button>
  </div>
</div>

<div id="loading-spinner">
  <i class="fas fa-spinner fa-spin"></i> Loading...
</div>

<script>
/* ============ PASSWORD PROMPT ============ */
const passwordModal = document.getElementById('password-modal');
const passwordInput = document.getElementById('password-input');
const passwordSubmit = document.getElementById('password-submit');

document.addEventListener('DOMContentLoaded', () => {
  passwordModal.style.display = 'flex'; // Show on load
});

passwordSubmit.addEventListener('click', () => {
  if (passwordInput.value === 'SoCalREN2025') {
    passwordModal.style.display = 'none';
    initMap();
  } else {
    location.reload();
  }
});

/* ============ MAPBOX SETUP ============ */
mapboxgl.accessToken = 'pk.eyJ1Ijoid2VuZ2xlMSIsImEiOiJjbHBtaWx0N2IwMGljMmxwNjBsMnU4a2E4In0.Dzf3G-WBKzDfgnXsGHiMXw';
let map;

/* ============ CUSTOM COG LOOKUP ============ */
const COGMapping = {
  "GCCOG": "Gateway Cities Council of Governments",
  "SGVCOG": "San Gabriel Valley Council of Governments",
  "SBCOG": "South Bay Cities Council of Governments"
};

/* ============ AGENCIES DATA (FULL) =========== */
const agenciesData = [
  {
    "Agency": "Bell",
    "COG": "GCCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 96,
    "Population": 31864,
    "Agency Area (sq. miles)": 2.5,
    "Population Density (per sq mile)": 13400,
    "Number of Extreme Heat Days": 91,
    "% Children and Seniors": 36.1,
    "Average Household Income": 47800,
    "Pollution Burden": 88,
    "% Low-Income Census Tracts": 100,
    "Number of Electric Circuits": 14,
    "Annual kWh consumption": 2200000,
    "Annual Therms Consumption": 91100,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "Maywood",
    "COG": "GCCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 90,
    "Population": 27127,
    "Agency Area (sq. miles)": 1.18,
    "Population Density (per sq mile)": 23257,
    "Number of Extreme Heat Days": 77,
    "% Children and Seniors": 37.9,
    "Average Household Income": 50996,
    "Pollution Burden": 92,
    "% Low-Income Census Tracts": 100,
    "Number of Electric Circuits": 6,
    "Annual kWh consumption": 939153,
    "Annual Therms Consumption": 1232,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "Bell Gardens",
    "COG": "GCCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 92,
    "Population": 37467,
    "Agency Area (sq. miles)": 2.5,
    "Population Density (per sq mile)": 17100,
    "Number of Extreme Heat Days": 90,
    "% Children and Seniors": 30.4,
    "Average Household Income": 45300,
    "Pollution Burden": 97,
    "% Low-Income Census Tracts": 100,
    "Number of Electric Circuits": 9,
    "Annual kWh consumption": 1597960,
    "Annual Therms Consumption": 25833,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "Pomona",
    "COG": "SGVCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 97,
    "Population": 151100,
    "Agency Area (sq. miles)": 22.99,
    "Population Density (per sq mile)": 6572,
    "Number of Extreme Heat Days": 118,
    "% Children and Seniors": 36.5,
    "Average Household Income": 62400,
    "Pollution Burden": 81,
    "% Low-Income Census Tracts": 81.5,
    "Number of Electric Circuits": 56,
    "Annual kWh consumption": 20971427,
    "Annual Therms Consumption": 23848,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "Irwindale",
    "COG": "SGVCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 83,
    "Population": 1400,
    "Agency Area (sq. miles)": 9.5,
    "Population Density (per sq mile)": 142,
    "Number of Extreme Heat Days": 146,
    "% Children and Seniors": null,
    "Average Household Income": 86250,
    "Pollution Burden": 100,
    "% Low-Income Census Tracts": 100,
    "Number of Electric Circuits": 30,
    "Annual kWh consumption": 2452708,
    "Annual Therms Consumption": 11686,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "El Monte Union High School District",
    "COG": "SGVCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 80,
    "Population": 163151,
    "Agency Area (sq. miles)": 22.38,
    "Population Density (per sq mile)": 7290.035746,
    "Number of Extreme Heat Days": 129,
    "% Children and Seniors": null,
    "Average Household Income": 62000,
    "Pollution Burden": 92,
    "% Low-Income Census Tracts": null,
    "Number of Electric Circuits": 79,
    "Annual kWh consumption": null,
    "Annual Therms Consumption": null,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "Cudahy",
    "COG": "GCCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 95,
    "Population": 21700,
    "Agency Area (sq. miles)": 1.23,
    "Population Density (per sq mile)": 17642.27642,
    "Number of Extreme Heat Days": 85,
    "% Children and Seniors": 36,
    "Average Household Income": 49600,
    "Pollution Burden": 94,
    "% Low-Income Census Tracts": 100,
    "Number of Electric Circuits": 20,
    "Annual kWh consumption": null,
    "Annual Therms Consumption": null,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "South El Monte",
    "COG": "SGVCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 97,
    "Population": 19000,
    "Agency Area (sq. miles)": 2.84,
    "Population Density (per sq mile)": 6690.140845,
    "Number of Extreme Heat Days": 124,
    "% Children and Seniors": 37,
    "Average Household Income": 67700,
    "Pollution Burden": 98,
    "% Low-Income Census Tracts": 80,
    "Number of Electric Circuits": 12,
    "Annual kWh consumption": 593500,
    "Annual Therms Consumption": 39700,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "Lynwood",
    "COG": "GCCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 91,
    "Population": 63200,
    "Agency Area (sq. miles)": 4.84,
    "Population Density (per sq mile)": 13057.85124,
    "Number of Extreme Heat Days": 33,
    "% Children and Seniors": 35,
    "Average Household Income": 67400,
    "Pollution Burden": 92,
    "% Low-Income Census Tracts": 66,
    "Number of Electric Circuits": 22,
    "Annual kWh consumption": 1340300,
    "Annual Therms Consumption": 30100,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "Duarte",
    "COG": "SGVCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 78,
    "Population": 23100,
    "Agency Area (sq. miles)": 6.71,
    "Population Density (per sq mile)": 3442.622951,
    "Number of Extreme Heat Days": 132,
    "% Children and Seniors": 38,
    "Average Household Income": 93900,
    "Pollution Burden": 58,
    "% Low-Income Census Tracts": 20,
    "Number of Electric Circuits": 10,
    "Annual kWh consumption": 417700,
    "Annual Therms Consumption": null,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "Rancho Palos Verdes",
    "COG": "SBCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 11,
    "Population": 41600,
    "Agency Area (sq. miles)": 13.5,
    "Population Density (per sq mile)": 3081.481481,
    "Number of Extreme Heat Days": 11,
    "% Children and Seniors": null,
    "Average Household Income": 146200,
    "Pollution Burden": 29,
    "% Low-Income Census Tracts": 0,
    "Number of Electric Circuits": 25,
    "Annual kWh consumption": 359100,
    "Annual Therms Consumption": 900,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "El Segundo",
    "COG": "SBCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 26,
    "Population": 16500,
    "Agency Area (sq. miles)": 5.5,
    "Population Density (per sq mile)": 3000,
    "Number of Extreme Heat Days": 7,
    "% Children and Seniors": null,
    "Average Household Income": 115900,
    "Pollution Burden": 87,
    "% Low-Income Census Tracts": 0,
    "Number of Electric Circuits": 20,
    "Annual kWh consumption": 94470,
    "Annual Therms Consumption": 40800,
    "Underserved and/or  Hard to Reach": "Yes"
  }
];

/* ============ FACILITIES DATA (FULL) =========== */
const facilitiesData = [
  {
    "Agency": "Bell",
    "Facility Name": "Bell Library",
    "Address": "4411 Gage Ave, Bell, CA",
    "Latitude": 33.97842,
    "Longitude": -118.188728,
    "Existing Use? (cooling center or emergency ops)": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 2,
    "Exisiting PV or Battery Capabilities (Yes/No)": "N/A",
    "Planned PV (hours of autonomy)": 3912,
    "Planned Battery Storage (hours of autonomy)": 25,
    "Existing use": "Library",
    "Walk Score (RHOA)": "High",
    "Sq Ft": 5622,
    "Yr Built (RHOA)": 1965
  },
  {
    "Agency": "Bell",
    "Facility Name": "Community Center",
    "Address": "6250 Pine Ave, Bell, CA",
    "Latitude": 33.979983,
    "Longitude": -118.188726,
    "Existing Use? (cooling center or emergency ops)": "Cooling Center",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 2,
    "Exisiting PV or Battery Capabilities (Yes/No)": "Solar went live in August 2020",
    "Planned PV (hours of autonomy)": 1899,
    "Planned Battery Storage (hours of autonomy)": 1748,
    "Existing use": "Community center",
    "Walk Score (RHOA)": "High",
    "Sq Ft": 16011,
    "Yr Built (RHOA)": 1980
  },
  {
    "Agency": "Bell",
    "Facility Name": "Camp Little Bear Park",
    "Address": "6704 Orchard Ave, Bell, CA",
    "Latitude": 33.976608,
    "Longitude": -118.19976,
    "Existing Use? (cooling center or emergency ops)": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities (Yes/No)": "N/A",
    "Planned PV (hours of autonomy)": 664,
    "Planned Battery Storage (hours of autonomy)": 81,
    "Existing use": "Park",
    "Walk Score (RHOA)": "Medium",
    "Sq Ft": 5783,
    "Yr Built (RHOA)": 1962
  },
  {
    "Agency": "Bell",
    "Facility Name": "Veterans Memorial Park",
    "Address": "6500 Wilcox Ave, Bell, CA",
    "Latitude": 33.975866,
    "Longitude": -118.176767,
    "Existing Use? (cooling center or emergency ops)": "Cooling Center",
    "Existing EV Chargers (Yes/No)": "No Capacity",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities (Yes/No)": "N/A",
    "Planned PV (hours of autonomy)": 3397,
    "Planned Battery Storage (hours of autonomy)": 381,
    "Existing use": "Park",
    "Walk Score (RHOA)": "Medium",
    "Sq Ft": 7500,
    "Yr Built (RHOA)": 1955
  },
  {
    "Agency": "Maywood",
    "Facility Name": "City Hall + Sheriff's Office",
    "Address": "4319 Slauson Ave, Bell, CA",
    "Latitude": 33.986554,
    "Longitude": -118.170803,
    "Existing Use? (cooling center or emergency ops)": "Cooling Center",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 4,
    "Exisiting PV or Battery Capabilities (Yes/No)": "No",
    "Planned PV (hours of autonomy)": 2646,
    "Planned Battery Storage (hours of autonomy)": 0,
    "Existing use": "Office",
    "Walk Score (RHOA)": "High",
    "Sq Ft": 9534,
    "Yr Built (RHOA)": 1938
  },
  {
    "Agency": "Maywood",
    "Facility Name": "Teen Center",
    "Address": "4801 E. Slauson Ave, Bell, CA",
    "Latitude": 33.986554,
    "Longitude": -118.170803,
    "Existing Use? (cooling center or emergency ops)": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities (Yes/No)": "No",
    "Planned PV (hours of autonomy)": "Whole year",
    "Planned Battery Storage (hours of autonomy)": "Whole year",
    "Existing use": "Community center",
    "Walk Score (RHOA)": "Medium",
    "Sq Ft": "N/A",
    "Yr Built (RHOA)": "N/A"
  },
  {
    "Agency": "Maywood",
    "Facility Name": "(YMCA) Maywood Park",
    "Address": "4801 E. 58th St, Bell, CA",
    "Latitude": 33.98746,
    "Longitude": -118.178804,
    "Existing Use? (cooling center or emergency ops)": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 4,
    "Exisiting PV or Battery Capabilities (Yes/No)": "No",
    "Planned PV (hours of autonomy)": 1140,
    "Planned Battery Storage (hours of autonomy)": 5,
    "Existing use": "Community center",
    "Walk Score (RHOA)": "Medium",
    "Sq Ft": 30819,
    "Yr Built (RHOA)": 1999
  },
  {
    "Agency": "Maywood",
    "Facility Name": "Cesar Chavez Library",
    "Address": "4323 Slauson Ave, Bell, CA",
    "Latitude": 33.986554,
    "Longitude": -118.170803,
    "Existing Use? (cooling center or emergency ops)": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities (Yes/No)": "No",
    "Planned PV (hours of autonomy)": 2311,
    "Planned Battery Storage (hours of autonomy)": 5,
    "Existing use": "Library",
    "Walk Score (RHOA)": "High",
    "Sq Ft": 3382,
    "Yr Built (RHOA)": 1938
  },
  {
    "Agency": "Bell Gardens",
    "Facility Name": "Ford Park and Recreation Center",
    "Address": "8000 Park Lane, Bell, CA",
    "Latitude": 33.959218,
    "Longitude": -118.154753,
    "Existing Use? (cooling center or emergency ops)": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 10,
    "Exisiting PV or Battery Capabilities (Yes/No)": "N/A",
    "Planned PV (hours of autonomy)": 3563,
    "Planned Battery Storage (hours of autonomy)": 13,
    "Existing use": "Community center",
    "Walk Score (RHOA)": "High",
    "Sq Ft": 9083,
    "Yr Built (RHOA)": 1976
  },
  {
    "Agency": "Bell Gardens",
    "Facility Name": "Community Family Services Center & Veterans Park",
    "Address": "6662 Loveland St, Bell, CA",
    "Latitude": 33.968177,
    "Longitude": -118.143887,
    "Existing Use? (cooling center or emergency ops)": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities (Yes/No)": "N/A",
    "Planned PV (hours of autonomy)": 3330,
    "Planned Battery Storage (hours of autonomy)": 71,
    "Existing use": "Community center",
    "Walk Score (RHOA)": "Low",
    "Sq Ft": 20000,
    "Yr Built (RHOA)": 1976
  },
  {
    "Agency": "Bell Gardens",
    "Facility Name": "Youth Center",
    "Address": "5856 Ludell St, Bell, CA",
    "Latitude": 33.968683,
    "Longitude": -118.160906,
    "Existing Use? (cooling center or emergency ops)": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities (Yes/No)": "N/A",
    "Planned PV (hours of autonomy)": 3406,
    "Planned Battery Storage (hours of autonomy)": 11,
    "Existing use": "Community center",
    "Walk Score (RHOA)": "Medium",
    "Sq Ft": 11446,
    "Yr Built (RHOA)": 1948
  },
  {
    "Agency": "Bell Gardens",
    "Facility Name": "Civic Center",
    "Address": "7100 Garfield St, Bell, CA",
    "Latitude": 33.967687,
    "Longitude": -118.150114,
    "Existing Use? (cooling center or emergency ops)": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities (Yes/No)": "N/A",
    "Planned PV (hours of autonomy)": 5,
    "Planned Battery Storage (hours of autonomy)": 0,
    "Existing use": "City Hall",
    "Walk Score (RHOA)": "Medium",
    "Sq Ft": 18500,
    "Yr Built (RHOA)": 1967
  },
  {
    "Agency": "Pomona",
    "Facility Name": "Library",
    "Address": "625 S Garey Ave, Pomona, CA",
    "Latitude": 34.053897,
    "Longitude": -117.750631,
    "Existing Use? (cooling center or emergency ops)": "Cooling Center",
    "Existing EV Chargers (Yes/No)": "Yes",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities (Yes/No)": "N/A",
    "Planned PV (hours of autonomy)": 2057,
    "Planned Battery Storage (hours of autonomy)": 0,
    "Existing use": "Library",
    "Walk Score (RHOA)": "High",
    "Sq Ft": 25977,
    "Yr Built (RHOA)": 1956
  },
  {
    "Agency": "Pomona",
    "Facility Name": "City Hall",
    "Address": "505 S Garey Ave, Pomona, CA",
    "Latitude": 34.054554,
    "Longitude": -117.751251,
    "Existing Use? (cooling center or emergency ops)": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities (Yes/No)": "N/A",
    "Planned PV (hours of autonomy)": 2482,
    "Planned Battery Storage (hours of autonomy)": 14,
    "Existing use": "Office",
    "Walk Score (RHOA)": "High",
    "Sq Ft": 44996,
    "Yr Built (RHOA)": 1969
  },
  {
    "Agency": "Pomona",
    "Facility Name": "Palomares Park",
    "Address": "499 E Arrow Hwy, Pomona, CA",
    "Latitude": 34.090168,
    "Longitude": -117.742428,
    "Existing Use? (cooling center or emergency ops)": "Cooling Center",
    "Existing EV Chargers (Yes/No)": "Yes",
    "Number of Planned EV Chargers": 19,
    "Exisiting PV or Battery Capabilities (Yes/No)": "N/A",
    "Planned PV (hours of autonomy)": 6470,
    "Planned Battery Storage (hours of autonomy)": 48,
    "Existing use": "Community center",
    "Walk Score (RHOA)": "Low",
    "Sq Ft": 15704,
    "Yr Built (RHOA)": 1983
  },
  {
    "Agency": "Pomona",
    "Facility Name": "Washington Senior Center",
    "Address": "865 E Granf Ave, Pomona, CA",
    "Latitude": 34.048184,
    "Longitude": -117.739664,
    "Existing Use? (cooling center or emergency ops)": "Cooling Center",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 6,
    "Exisiting PV or Battery Capabilities (Yes/No)": "N/A",
    "Planned PV (hours of autonomy)": 4070,
    "Planned Battery Storage (hours of autonomy)": 883,
    "Existing use": "Senior Center",
    "Walk Score (RHOA)": "Low",
    "Sq Ft": 2539,
    "Yr Built (RHOA)": 1935
  },
  {
    "Agency": "Irwindale",
    "Facility Name": "Dan Diaz Recreation Center and Library",
    "Address": "16053 Calle De Paseo, Irwindale, CA",
    "Latitude": 34.103841,
    "Longitude": -117.932137,
    "Existing Use? (cooling center or emergency ops)": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities (Yes/No)": "N/A",
    "Planned PV (hours of autonomy)": 1068,
    "Planned Battery Storage (hours of autonomy)": 1,
    "Existing use": "Library and recreation center",
    "Walk Score (RHOA)": "Low",
    "Sq Ft": 22855,
    "Yr Built (RHOA)": 1970
  },
  {
    "Agency": "Irwindale",
    "Facility Name": "City Hall and Police Department",
    "Address": "5050 N Irwindale Ave, Irwindale, CA",
    "Latitude": 34.127586,
    "Longitude": -117.933637,
    "Existing Use? (cooling center or emergency ops)": "Emergency Operations Center",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 4,
    "Exisiting PV or Battery Capabilities (Yes/No)": "N/A",
    "Planned PV (hours of autonomy)": 4,
    "Planned Battery Storage (hours of autonomy)": 0,
    "Existing use": "Office",
    "Walk Score (RHOA)": "Low",
    "Sq Ft": 20600,
    "Yr Built (RHOA)": 1957
  },
  {
    "Agency": "Irwindale",
    "Facility Name": "Senior Center and Annex",
    "Address": "16116 Arrow Hwy, Irwindale, CA",
    "Latitude": 34.106818,
    "Longitude": -117.930958,
    "Existing Use? (cooling center or emergency ops)": "Cooling Center",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 4,
    "Exisiting PV or Battery Capabilities (Yes/No)": "N/A",
    "Planned PV (hours of autonomy)": 24,
    "Planned Battery Storage (hours of autonomy)": 0,
    "Existing use": "Multi-purpose/ office",
    "Walk Score (RHOA)": "Low",
    "Sq Ft": 20678,
    "Yr Built (RHOA)": 1985
  },
  {
    "Agency": "Irwindale",
    "Facility Name": "New Library (Planned for 2026)",
    "Address": "TBD - south of City Hall/west of existing library",
    "Latitude": null,
    "Longitude": null,
    "Existing Use? (cooling center or emergency ops)": "N/A",
    "Existing EV Chargers (Yes/No)": "N/A",
    "Number of Planned EV Chargers": "N/A",
    "Exisiting PV or Battery Capabilities (Yes/No)": "N/A",
    "Planned PV (hours of autonomy)": "N/A",
    "Planned Battery Storage (hours of autonomy)": "N/A",
    "Existing use": "Library",
    "Walk Score (RHOA)": "N/A",
    "Sq Ft": "N/A",
    "Yr Built (RHOA)": "N/A"
  }
];

/* ============ INITIALIZE MAP ETC ============ */
function initMap() {
  map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [-118.2437, 34.0522],
    zoom: 10,
    pitch: 45
  });

  map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
  map.addControl(new mapboxgl.NavigationControl(), 'top-right');

  // Add geocoder for location search
  const geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    mapboxgl: mapboxgl,
    placeholder: 'Search for a location'
  });
  map.addControl(geocoder, 'top-left');

  map.on('load', () => {
    document.getElementById('loading-spinner').style.display = 'block';
    loadBoundariesAndFacilities();
  });
}

/* ============ LOAD BOUNDARIES AND FACILITIES =========== */
async function loadBoundariesAndFacilities() {
  fetch('data/la_boundaries.geojson')
    .then(resp => resp.json())
    .then(geojson => {
      map.addSource('la-boundaries', { type: 'geojson', data: geojson });

      // 3D extrusions
      map.addLayer({
        id: 'la-boundaries-extrusion',
        type: 'fill-extrusion',
        source: 'la-boundaries',
        paint: {
          'fill-extrusion-color': '#9A5CA7',
          'fill-extrusion-height': 500,
          'fill-extrusion-opacity': 0.4
        }
      });

      let hoveredId = null;
      const boundaryPopup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false,
        anchor: 'top',
        offset: [0,0],
        className: 'boundary-popup'
      });

      // Hover => show Agency Name, DAC Status, Score, Population
      map.on('mousemove', 'la-boundaries-extrusion', e => {
        map.getCanvas().style.cursor = 'pointer';
        if (e.features.length > 0) {
          if (hoveredId) {
            map.setFeatureState(
              { source: 'la-boundaries', id: hoveredId },
              { hover: false }
            );
          }
          hoveredId = e.features[0].id;
          map.setFeatureState(
            { source: 'la-boundaries', id: hoveredId },
            { hover: true }
          );

          const cityName = e.features[0].properties.CITY_COMM_NAME || '';
          let matchedAgency = agenciesData.find(a => a.Agency.toLowerCase() === cityName.toLowerCase());
          if (!matchedAgency) {
            matchedAgency = agenciesData.find(a => cityName.toLowerCase().includes(a.Agency.toLowerCase()));
          }

          let popupHtml = `<strong>${cityName}</strong><br><em>No data found</em>`;
          if (matchedAgency) {
            const dac = matchedAgency["DAC Status"] || 'N/A';
            const score = matchedAgency["CalEnviroScreen Score"] || 'N/A';
            const pop = matchedAgency["Population"] || 'N/A';

            popupHtml = `
              <strong>${matchedAgency.Agency}</strong><br>
              DAC Status: ${dac}<br>
              CalEnviroScreen Score: ${score}<br>
              Population: ${Number(pop).toLocaleString()}
            `;
          }
          boundaryPopup.setLngLat(e.lngLat).setHTML(popupHtml).addTo(map);
        }
      });

      map.on('mouseleave', 'la-boundaries-extrusion', () => {
        map.getCanvas().style.cursor = '';
        boundaryPopup.remove();
        if (hoveredId) {
          map.setFeatureState(
            { source: 'la-boundaries', id: hoveredId },
            { hover: false }
          );
        }
        hoveredId = null;
      });

      // On click => show that agency’s listing/facilities
      map.on('click', 'la-boundaries-extrusion', e => {
        if (!e.features.length) return;
        const cityName = e.features[0].properties.CITY_COMM_NAME || '';
        if (cityName) {
          let matched = agenciesData.find(a => a.Agency.toLowerCase() === cityName.toLowerCase());
          if (!matched) {
            matched = agenciesData.find(a => cityName.toLowerCase().includes(a.Agency.toLowerCase()));
          }
          if (matched) {
            const facs = facilitiesData.filter(f => f.Agency === matched.Agency);
            showFacilities(matched, facs);
          }
        }
      });
    })
    .catch(err => console.error('Error loading boundaries:', err));

  // Build facility FeatureCollection
  const facilityFeatures = [];
  facilitiesData.forEach(fac => {
    const lat = parseFloat(fac.Latitude);
    const lng = parseFloat(fac.Longitude);
    if (!isNaN(lat) && !isNaN(lng)) {
      facilityFeatures.push({
        type: 'Feature',
        geometry: { type: 'Point', coordinates: [lng, lat] },
        properties: { ...fac }
      });
    }
  });

  const facilityGeoJSON = {
    type: 'FeatureCollection',
    features: facilityFeatures
  };

  map.addSource('facilities', {
    type: 'geojson',
    data: facilityGeoJSON,
    cluster: true,
    clusterMaxZoom: 14,
    clusterRadius: 50
  });

  // cluster circles
  map.addLayer({
    id: 'clusters',
    type: 'circle',
    source: 'facilities',
    filter: ['has','point_count'],
    paint: {
      'circle-radius': [
        'step', ['get','point_count'],
        25, 10,
        30, 25,
        35
      ],
      'circle-color': [
        'step', ['get','point_count'],
        '#F37B43', 10,
        '#F05A28', 25,
        '#9A5CA7'
      ],
      'circle-opacity': 0.9,
      'circle-stroke-width': 2,
      'circle-stroke-color': '#ffffff',
      'circle-stroke-opacity': 0.9,
      'circle-pitch-scale': 'viewport',
      'circle-pitch-alignment': 'map'
    }
  });

  // cluster counts
  map.addLayer({
    id: 'cluster-count',
    type: 'symbol',
    source: 'facilities',
    filter: ['has','point_count'],
    layout: {
      'text-field': '{point_count_abbreviated}',
      'text-font': ['DIN Offc Pro Bold','Arial Unicode MS Bold'],
      'text-size': 16,
      'text-allow-overlap': true,
      'text-pitch-alignment': 'viewport',
      'text-rotation-alignment': 'viewport'
    },
    paint: {
      'text-color': '#ffffff',
      'text-halo-color': 'rgba(0,0,0,0.2)',
      'text-halo-width': 1
    }
  });

  // unclustered points
  map.addLayer({
    id: 'unclustered-point',
    type: 'circle',
    source: 'facilities',
    filter: ['!',['has','point_count']],
    paint: {
      'circle-color': '#F37B43',
      'circle-radius': 8,
      'circle-stroke-width': 2,
      'circle-stroke-color': '#ffffff',
      'circle-opacity': 0.9,
      'circle-stroke-opacity': 0.9,
      'circle-pitch-scale': 'viewport',
      'circle-pitch-alignment': 'map'
    }
  });

  // Reorder to ensure on top
  map.moveLayer('clusters');
  map.moveLayer('cluster-count');
  map.moveLayer('unclustered-point');

  // Facility popup on hover => Name, Address, Existing use
  const facilityPopup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false,
    anchor: 'bottom',
    offset: [0, -10],
    className: 'facility-popup'
  });

  map.on('mouseenter', 'unclustered-point', e => {
    map.getCanvas().style.cursor = 'pointer';
    const props = e.features[0].properties;

    const name = props["Facility Name"] || "Unknown Facility";
    const address = props["Address"] || "N/A";
    const usage = props["Existing use"] || "N/A";

    const content = `
      <strong>${name}</strong><br>
      Address: ${address}<br>
      Existing use: ${usage}
    `;
    facilityPopup.setLngLat(e.lngLat).setHTML(content).addTo(map);
  });

  map.on('mouseleave', 'unclustered-point', () => {
    map.getCanvas().style.cursor = '';
    facilityPopup.remove();
  });

  // cluster click => zoom in
  map.on('click','clusters', e => {
    const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
    if (!features.length) return;
    const clusterId = features[0].properties.cluster_id;
    map.getSource('facilities').getClusterExpansionZoom(clusterId, (err, zoom) => {
      if (err) return;
      map.easeTo({ center: features[0].geometry.coordinates, zoom });
    });
  });

  // unclustered point click => show facilities for that agency
  map.on('click','unclustered-point', e => {
    const props = e.features[0].properties;
    const matchedAgency = agenciesData.find(a => a.Agency === props["Agency"]);
    if (matchedAgency) {
      const facs = facilitiesData.filter(f => f.Agency === matchedAgency.Agency);
      showFacilities(matchedAgency, facs);
    }
  });

  document.getElementById('loading-spinner').style.display = 'none';
}

/* ============ RENDER AGENCY LISTING RIGHT AWAY =========== */
function renderListing() {
  const listingElement = document.getElementById('listing');
  const agencyFilters = document.getElementById('agency-filters');
  const facilityFilters = document.getElementById('facility-filters');

  listingElement.innerHTML = '';
  agencyFilters.style.display = 'block';
  facilityFilters.style.display = 'none';

  // group agencies by COG
  const groups = {};
  agenciesData.forEach(a => {
    const cog = a.COG;
    if (!groups[cog]) groups[cog] = [];
    groups[cog].push(a);
  });

  for (const [cogKey, agencies] of Object.entries(groups)) {
    if (agencies.length > 0) {
      const cogSection = document.createElement('div');
      cogSection.className = 'cog-section';

      const cogHeader = document.createElement('div');
      cogHeader.className = 'cog-header';
      const spelledOut = COGMapping[cogKey] || cogKey;
      cogHeader.textContent = spelledOut;

      const agencyList = document.createElement('div');
      agencyList.className = 'agency-list';
      agencyList.style.display = 'block';
      cogHeader.classList.add('expanded');

      // expand/collapse
      cogHeader.addEventListener('click', () => {
        const isHidden = (agencyList.style.display === 'none');
        cogHeader.classList.toggle('expanded', isHidden);
        agencyList.style.display = isHidden ? 'block' : 'none';
      });

      agencies.sort((a,b) => a.Agency.localeCompare(b.Agency));
      agencies.forEach(a => {
        const agencyDiv = document.createElement('div');
        agencyDiv.className = 'agency-title';
        agencyDiv.textContent = a.Agency;
        agencyDiv.onclick = () => {
          const facs = facilitiesData.filter(f => f.Agency === a.Agency);
          showFacilities(a, facs);
        };
        agencyList.appendChild(agencyDiv);
      });

      cogSection.appendChild(cogHeader);
      cogSection.appendChild(agencyList);
      listingElement.appendChild(cogSection);
    }
  }
}

/* ============ FILTER AGENCIES =========== */
function filterAgencies() {
  const minPop = parseInt(document.getElementById('population-min').value) || 0;
  const maxPop = parseInt(document.getElementById('population-max').value) || Infinity;
  const searchText = document.getElementById('agency-filter').value.toLowerCase().trim();
  const dacFilter = document.getElementById('dac-filter').checked;
  const ces90Filter = document.getElementById('ces90-filter').checked;

  const filtered = agenciesData.filter(a => {
    const nameMatch = !searchText || a.Agency.toLowerCase().includes(searchText);
    const popVal = Number(a.Population) || 0;
    const popMatch = (popVal >= minPop && popVal <= maxPop);
    const isUnderserved = (a["Underserved and/or  Hard to Reach"] || '').toLowerCase() === 'yes';
    const matchDAC = !dacFilter || isUnderserved;
    const calVal = Number(a["CalEnviroScreen Score"]) || 0;
    const matchCal = !ces90Filter || (calVal > 90);

    return nameMatch && popMatch && matchDAC && matchCal;
  });

  const listingElement = document.getElementById('listing');
  listingElement.innerHTML = '';

  if (!filtered.length) {
    listingElement.innerHTML = `<p style="color:#666;font-style:italic;">No matching agencies found.</p>`;
    return;
  }

  const groupByCOG = {};
  filtered.forEach(a => {
    const c = a.COG;
    if (!groupByCOG[c]) groupByCOG[c] = [];
    groupByCOG[c].push(a);
  });

  for (const [cogKey, agencies] of Object.entries(groupByCOG)) {
    if (agencies.length > 0) {
      const cogSection = document.createElement('div');
      cogSection.className = 'cog-section';

      const cogHeader = document.createElement('div');
      cogHeader.className = 'cog-header';
      cogHeader.textContent = COGMapping[cogKey] || cogKey;

      const agencyList = document.createElement('div');
      agencyList.className = 'agency-list';
      agencyList.style.display = 'block';
      cogHeader.classList.add('expanded');

      cogHeader.addEventListener('click', () => {
        const isHidden = (agencyList.style.display === 'none');
        cogHeader.classList.toggle('expanded', isHidden);
        agencyList.style.display = isHidden ? 'block' : 'none';
      });

      agencies.sort((a,b) => a.Agency.localeCompare(b.Agency));
      agencies.forEach(a => {
        const agencyDiv = document.createElement('div');
        agencyDiv.className = 'agency-title';
        agencyDiv.textContent = a.Agency;
        agencyDiv.onclick = () => {
          const facs = facilitiesData.filter(f => f.Agency === a.Agency);
          showFacilities(a, facs);
        };
        agencyList.appendChild(agencyDiv);
      });

      cogSection.appendChild(cogHeader);
      cogSection.appendChild(agencyList);
      listingElement.appendChild(cogSection);
    }
  }
}
document.getElementById('population-min').addEventListener('input', filterAgencies);
document.getElementById('population-max').addEventListener('input', filterAgencies);
document.getElementById('agency-filter').addEventListener('input', filterAgencies);
document.getElementById('dac-filter').addEventListener('change', filterAgencies);
document.getElementById('ces90-filter').addEventListener('change', filterAgencies);

/* ============ FACILITY FILTERS =========== */
document.getElementById('pv-filter').addEventListener('change', refreshFacilityList);
document.getElementById('ev-filter').addEventListener('change', refreshFacilityList);
document.getElementById('cooling-filter').addEventListener('change', refreshFacilityList);

function refreshFacilityList() {
  const title = document.querySelector('#data-overview-title').textContent;
  const foundAgency = agenciesData.find(a => title.includes(a.Agency));
  if (foundAgency) {
    const facs = facilitiesData.filter(f => f.Agency === foundAgency.Agency);
    showFacilities(foundAgency, facs);
  }
}

/* ============ SHOW FACILITIES & AGENCY DATA =========== */
function showFacilities(agency, facilityList) {
  // 1) Re-render the listing as a simple list of facilities
  const listingElement = document.getElementById('listing');
  listingElement.innerHTML = '';

  const backButton = document.createElement('button');
  backButton.id = 'back-button';
  backButton.textContent = 'Back to Agencies';
  backButton.onclick = () => {
    document.getElementById('dashboard').style.display = 'none';
    renderListing();
  };
  listingElement.appendChild(backButton);

  const header = document.createElement('h4');
  header.textContent = `Facilities in ${agency.Agency}`;
  listingElement.appendChild(header);

  document.getElementById('agency-filters').style.display = 'none';
  document.getElementById('facility-filters').style.display = 'block';

  // Apply facility filter checkboxes
  const filteredFacilities = filterFacilities(facilityList);

  if (filteredFacilities.length > 0) {
    filteredFacilities.forEach(f => {
      const div = document.createElement('div');
      div.className = 'agency-title';
      div.textContent = f["Facility Name"];
      listingElement.appendChild(div);
    });
  } else {
    const msg = document.createElement('div');
    msg.id = 'no-facilities-msg';
    msg.textContent = 'Facilities data coming soon';
    listingElement.appendChild(msg);
  }

  // 2) Show the Agency-Level Data on the panel
  const dashboard = document.getElementById('dashboard');
  const agencyDataElement = document.getElementById('agency-data');

  dashboard.style.display = 'block';
  agencyDataElement.style.display = 'block';

  updateAgencyDashboard(agency);
}

/* ============ FILTER FACILITIES BASED ON CHECKBOXES =========== */
function filterFacilities(facList) {
  const pvChecked = document.getElementById('pv-filter').checked;
  const evChecked = document.getElementById('ev-filter').checked;
  const coolChecked = document.getElementById('cooling-filter').checked;

  return facList.filter(f => {
    // Check for PV
    if (pvChecked) {
      const hasPV = f["Exisiting PV or Battery Capabilities (Yes/No)"] &&
        f["Exisiting PV or Battery Capabilities (Yes/No)"].toLowerCase() !== 'no' &&
        f["Exisiting PV or Battery Capabilities (Yes/No)"].toLowerCase() !== 'n/a';
      if (!hasPV) return false;
    }
    // Check for EV
    if (evChecked) {
      const evVal = (f["Existing EV Chargers (Yes/No)"] || '').toLowerCase();
      if (!evVal.includes('yes')) return false;
    }
    // Check for Cooling/Emergency
    if (coolChecked) {
      const usage = (f["Existing Use? (cooling center or emergency ops)"] || '').toLowerCase();
      if (!usage.includes('cooling') && !usage.includes('emergency')) return false;
    }
    return true;
  });
}

/* ============ UPDATE AGENCY DASHBOARD =========== */
function updateAgencyDashboard(agency) {
  const dash = document.getElementById('dashboard');
  dash.style.display = 'block';

  document.getElementById('data-overview-title').textContent = agency.Agency + " Data Overview";

  const agencyDataElement = document.getElementById('agency-data');
  agencyDataElement.style.display = 'block';

  const getSafe = (obj, key) => {
    if (obj[key] === null || obj[key] === undefined) return "N/A";
    if (String(obj[key]).toUpperCase() === 'N/A') return "N/A";
    return obj[key];
  };

  // Fill the fields
  document.getElementById('agency-underserved').textContent = getSafe(agency, "DAC Status");
  document.getElementById('agency-calenviroscore').textContent = getSafe(agency, "CalEnviroScreen Score");
  document.getElementById('agency-pollutionburden').textContent = getSafe(agency, "Pollution Burden");

  let popVal = getSafe(agency, "Population");
  if (!isNaN(popVal)) popVal = parseInt(popVal).toLocaleString();
  document.getElementById('agency-population').textContent = popVal;

  const csVal = getSafe(agency, "% Children and Seniors");
  document.getElementById('agency-children-seniors').textContent = csVal;

  document.getElementById('agency-area').textContent = getSafe(agency, "Agency Area (sq. miles)");

  let denVal = getSafe(agency, "Population Density (per sq mile)");
  if (!isNaN(denVal)) denVal = parseInt(denVal).toLocaleString();
  document.getElementById('agency-density').textContent = denVal;

  document.getElementById('agency-heat-days').textContent = getSafe(agency, "Number of Extreme Heat Days");

  let incVal = getSafe(agency, "Average Household Income");
  if (!isNaN(incVal)) incVal = parseInt(incVal).toLocaleString();
  document.getElementById('agency-income').textContent = incVal;

  document.getElementById('agency-low-income').textContent = getSafe(agency, "% Low-Income Census Tracts");
  document.getElementById('agency-circuits').textContent = getSafe(agency, "Number of Electric Circuits");

  let kwhVal = getSafe(agency, "Annual kWh consumption");
  if (!isNaN(kwhVal)) kwhVal = parseInt(kwhVal).toLocaleString();
  document.getElementById('agency-kwh').textContent = kwhVal;

  let thermVal = getSafe(agency, "Annual Therms Consumption");
  if (!isNaN(thermVal)) thermVal = parseInt(thermVal).toLocaleString();
  document.getElementById('agency-therms').textContent = thermVal;
}

/* ============ WELCOME POPUP =========== */
function closeWelcome() {
  const popup = document.getElementById('welcome-popup');
  popup.classList.add('fade-out');
  setTimeout(() => {
    popup.style.display = 'none';
  }, 400);
}

/* Initialize the listing on page load */
renderListing();
</script>
</body>
</html>
