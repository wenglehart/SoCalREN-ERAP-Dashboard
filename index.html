<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SoCalREN's ERAP Dashboard</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  
  <!-- MAPBOX & FONTS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.js"></script>

  <!-- Aptos font-face (sample) -->
  <style>
  @font-face {
    font-family: 'Aptos';
    /* If you have a local or hosted source for Aptos, declare it here:
       src: url('path-to-aptos.woff2') format('woff2'); 
       Otherwise, the user’s system must have Aptos installed locally. 
    */
    font-weight: 400;
    font-style: normal;
  }
  </style>

  <!-- Mapbox Geocoder -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css" type="text/css">

  <script src="https://unpkg.com/@mapbox/mapbox-sdk/umd/mapbox-sdk.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>

  <style>
    html, body {
      margin: 0; 
      padding: 0;
      height: 100%;
      font-family: 'Aptos', sans-serif;
      background-color: #ffffff;
      overflow: hidden; /* Hide scrollbars */
    }

    /* ============ Password Modal ============ */
    #password-modal {
      position: fixed;
      z-index: 99999;
      top: 0; left: 0;
      width: 100vw; 
      height: 100vh;
      display: flex; 
      align-items: center; 
      justify-content: center;
      background-color: rgba(0,0,0,0.4);
      backdrop-filter: blur(7px);
    }
    #password-modal-content {
      background: #ffffff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.2);
      max-width: 500px;
      width: 90%;
      text-align: center;
    }
    #password-modal-content h2 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-size: 18px;
      line-height: 1.4;
    }
    #password-input {
      width: 100%;
      padding: 10px;
      font-size: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      font-family: 'Aptos', sans-serif;
    }
    #password-submit {
      background: linear-gradient(to right, #374852, #2D3E4F);
      color: #ffffff;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Aptos', sans-serif;
    }
    #password-submit:hover {
      background: linear-gradient(to right, #4a5c6b, #2D3E4F);
    }

    /* ============ Header ============ */
    header {
      width: 100%;
      background: linear-gradient(to right, #2D3E4F, #202f3e);
      color: #ffffff;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      box-sizing: border-box;
      height: 60px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .header-left img {
      height: 50px;
      transition: transform 0.3s ease;
    }
    .header-left img:hover {
      transform: scale(1.05);
    }

    /* ============ Container Layout ============ */
    #container {
      width: 100%;
      height: calc(100vh - 60px);
      position: relative;
      display: flex;
      flex-direction: row;
      overflow: hidden;
    }
    #map {
      flex: 3;
      position: relative;
      min-height: 400px;
    }
    #loading-spinner {
      position: fixed; 
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px; 
      color: #2c3e50; 
      z-index: 999;
      display: none;
    }

    /* Place geocoder in top-left corner, as in the example */
    .mapboxgl-ctrl-geocoder {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 300px;
      z-index: 10;
      font-family: 'Aptos', sans-serif !important;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    }
    .mapboxgl-ctrl-geocoder--input {
      height: 36px !important;
      padding: 6px 35px !important;
      font-family: 'Aptos', sans-serif !important;
    }

    /* ============ Map Overlay Panel ============ */
    .map-overlay {
      flex: 1;
      background: linear-gradient(to bottom, #fff, #f8f9fa);
      border-left: 1px solid rgba(0,0,0,0.1);
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      font-family: 'Aptos', sans-serif;
    }

    /* ============ Dashboard & Listing ============ */
    fieldset {
      background: #f0f0f0;
      border: none;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    input[type="text"], input[type="number"] {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 8px;
      box-sizing: border-box;
      margin-bottom: 10px;
      font-size: 14px;
      width: 100%;
      font-family: 'Aptos', sans-serif;
    }
    #listing {
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
      margin-top: 10px;
    }
    .facility-title {
      display: block;
      padding: 12px;
      margin: 8px 0;
      background: #f8f9fa;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      color: #2c3e50;
      text-decoration: none;
      border: 1px solid #e9ecef;
    }
    .facility-title:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }
    .facility-title.active {
      background: #fff3e0;
      border-left: 3px solid #F05A28;
      transform: translateX(5px);
    }
    .cog-section {
      margin-bottom: 10px;
    }
    .cog-header {
      background: #2D3E4F;
      padding: 12px 15px;
      cursor: pointer;
      border-radius: 5px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s ease;
      color: #ffffff;
      margin-bottom: 8px;
      font-family: 'Aptos', sans-serif;
    }
    .cog-header::after {
      content: '▼';
      font-size: 12px;
      color: #ffffff;
      transition: transform 0.3s ease;
      margin-left: 10px;
      opacity: 0.9;
    }
    .cog-header.expanded::after {
      transform: rotate(180deg);
    }
    .cog-header:hover {
      background: #455463;
    }
    .agency-list {
      margin-top: 5px;
      margin-bottom: 15px;
      padding-left: 10px;
      height: auto;
      overflow-y: visible;
    }
    .agency-title {
      font-size: 14px;
      font-weight: normal;
      margin: 5px 0;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 5px;
      transition: all 0.2s ease;
      color: #2c3e50;
      background: #f8f9fa;
      font-family: 'Aptos', sans-serif;
    }
    .agency-title:hover {
      background: #e0f7fa;
      color: #00796b;
      transform: translateX(5px);
    }
    #no-facilities-msg {
      padding: 10px;
      color: #666;
      font-style: italic;
      background: #f8f9fa;
      border-radius: 4px;
      margin: 10px 0;
      font-family: 'Aptos', sans-serif;
    }

    .filters {
      background: #f0f0f0;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      font-family: 'Aptos', sans-serif;
    }
    .filters label {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .filters input[type=checkbox] {
      margin-right: 5px;
    }

    /* ============ Dashboard ============ */
    .dashboard {
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 30px;
      font-size: 14px;
      margin-top: 20px;
      font-family: 'Aptos', sans-serif;
    }
    .dashboard h3 {
      font-size: 20px;
      margin-top: 0;
      padding-bottom: 15px;
      margin-bottom: 25px;
      border-bottom: 2px solid #ecf0f1;
      font-weight: bold;
      color: #2c3e50;
    }
    .dashboard h4 {
      margin-top: 30px;
      margin-bottom: 20px;
      font-size: 16px;
      color: #34495e;
      font-family: 'Aptos', sans-serif;
    }
    .metric {
      margin-bottom: 20px;
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .metric .metric-label {
      margin-right: 15px;
      flex: 0 0 auto;
    }
    .metric .metric-value {
      flex: 1;
      text-align: right;
    }

    #agency-data, #facility-data {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #ecf0f1;
    }
    #back-button {
      background-color: #2D3E4F;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Aptos', sans-serif;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
      transition: background-color 0.2s ease;
    }
    #back-button:hover {
      background-color: #455463;
    }
    #back-button::before {
      content: "←";
      font-size: 16px;
    }

    /* ============ Intro Section ============ */
    #intro-section {
      display: none;
      font-family: 'Aptos', sans-serif;
    }
    #intro-section h4 {
      font-size: 16px;
      margin: 0 0 10px 0;
      color: #2c3e50;
    }
    #intro-section p, #intro-section li {
      font-size: 14px;
      color: #34495e;
      line-height: 1.6;
    }

    /* ============ Welcome Popup ============ */
    #welcome-popup {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-color: rgba(44,62,80,0.90);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.4s ease;
      backdrop-filter: blur(5px);
    }
    #welcome-popup.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    .welcome-content {
      background: white;
      padding: 60px 70px;
      border-radius: 16px;
      max-width: 800px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      position: relative;
      animation: slideIn 0.5s ease-out;
      font-family: 'Aptos', sans-serif;
    }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    #welcome-popup h1 {
      font-size: 22px;
      margin-bottom: 30px;
      color: #2c3e50;
      line-height: 1.4;
      font-weight: 700;
      border-bottom: 2px solid #ecf0f1;
      padding-bottom: 20px;
    }
    #welcome-popup h2 {
      font-size: 20px;
      color: #F05A28;
      margin: 30px 0 25px;
      font-weight: 600;
      line-height: 1.4;
      text-align: center;
    }
    #welcome-popup p {
      font-size: 16px;
      margin-bottom: 25px;
      color: #546e7a;
      line-height: 1.8;
      font-weight: 400;
      text-align: center;
      max-width: 650px;
      margin-left: auto;
      margin-right: auto;
    }
    #welcome-popup button {
      background-color: #2D3E4F;
      color: white;
      border: none;
      padding: 16px 40px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: block;
      margin: 40px auto 0;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    #welcome-popup button:hover {
      background-color: #455463;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* Boundary Popup styling */
    .boundary-popup .mapboxgl-popup-content {
      background-color: rgba(255,255,255,0.95);
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      font-family: 'Aptos', sans-serif;
      font-size: 13px;
      line-height: 1.4;
    }
    .boundary-popup .mapboxgl-popup-tip {
      border-top-color: rgba(255,255,255,0.95);
    }
    .facility-popup .mapboxgl-popup-content {
      background-color: rgba(255,255,255,0.95);
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      font-family: 'Aptos', sans-serif;
      font-size: 13px;
      line-height: 1.4;
    }
    .facility-popup .mapboxgl-popup-tip {
      border-top-color: rgba(255,255,255,0.95);
    }
    .mapboxgl-popup {
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      #container {
        flex-direction: column;
      }
      #map {
        height: 50vh;
      }
      .map-overlay {
        position: relative;
      }
      .welcome-content {
        padding: 40px;
        width: 85%;
      }
    }
  </style>
</head>
<body>

<!-- ============ PASSWORD MODAL ============ -->
<div id="password-modal">
  <div id="password-modal-content">
    <h2>To access the dashboard, please enter your provided access code</h2>
    <input type="password" id="password-input" placeholder="Access Code">
    <button id="password-submit">Submit</button>
  </div>
</div>

<!-- ============ HEADER ============ -->
<header>
  <div class="header-left">
    <a href="https://socalren.org/" target="_blank">
      <img src="images/socalren_erapdashboard.png" alt="SoCalREN ERAP Logo">
    </a>
  </div>
</header>

<!-- ============ MAIN CONTAINER ============ -->
<div id="container">
  <div id="map"></div>

  <div class="map-overlay" id="dashboard-panel">
    <fieldset>
      <input id="agency-filter" type="text" placeholder="Search for an agency">
    </fieldset>

    <fieldset class="filters" id="agency-filters">
      <legend>Agency Filters</legend>
      <label>
        <input type="checkbox" id="dac-filter"> 
        Show only Underserved and/or Hard to Reach Communities
      </label>
      <label>
        <input type="checkbox" id="ces90-filter"> 
        Show only agencies with CalEnviroScreen Score > 90
      </label>
      
      <div style="margin-top:10px;">
        <label for="population-min">Population Range:</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <input type="number" id="population-min" placeholder="Min" min="0" style="flex:1;">
          <span>to</span>
          <input type="number" id="population-max" placeholder="Max" min="0" style="flex:1;">
        </div>
      </div>
    </fieldset>

    <fieldset class="filters" id="facility-filters" style="display:none;">
      <legend>Facility Filters</legend>
      <label>
        <input type="checkbox" id="pv-filter"> 
        Show only facilities with PV or Battery Storage Capabilities
      </label>
      <label>
        <input type="checkbox" id="ev-filter"> 
        Show only facilities with existing EV chargers
      </label>
      <label>
        <input type="checkbox" id="cooling-filter"> 
        Show only facilities with Existing Resilience Designation
      </label>
    </fieldset>

    <div id="listing"></div>

    <!-- INTRO SECTION -->
    <div id="intro-section">
      <h4>Welcome to SoCalREN's ERAP Dashboard</h4>
      <p>
        This dashboard provides insights into public agencies' energy resilience planning efforts across Southern California that have received support from the SoCalREN Public Agency Programs. Use the filters above to find agencies by name, select a council of governments, or set population thresholds. Click on an agency name to view detailed metrics and access facility information.
      </p>
      <p>
        The data displayed here includes key metrics collected throughout an agency's involvement in the ERAP program. The dashboard can help you understand community needs, identify facilities equipped with Electric Vehicle chargers, Solar or Battery Storage, and plans for resilience improvements.
      </p>
      
      <h4>Getting Started</h4>
      <ul>
        <li>Use the "Search for an agency" box to quickly locate a participating agency.</li>
        <li>Adjust the range filter to focus on agencies with larger populations.</li>
        <li>Click an agency name to view its details and a list of associated facilities that were assessed by SoCalREN.</li>
      </ul>
      
      <h4>What is ERAP?</h4>
      <p>
        SoCalREN's Energy Resilience Action Plan (ERAP) program aims to address the growing impacts of climate change. Developed in collaboration with regional partners, the ERAP program enhances the energy resilience of critical infrastructure and future resilience hub locations for public agencies. By incorporating data-driven analysis and stakeholder input into the planning and development process, ERAP supports agencies in developing an actionable roadmap for near-term to long-term energy resilience strategies that will best serve the community.
      </p>
      <p><em>This dashboard is a living tool designed to evolve and improve as we progress through the program. We welcome any feedback you may have, as it will help shape future versions.</em></p>
    </div>

    <div class="dashboard" id="dashboard" style="display: none;">
      <h3 id="data-overview-title">Data Overview</h3>
  
      <!-- AGENCY DATA -->
      <div id="agency-data" style="display:none; margin-top:20px;">
        <h4>Agency-Level Data</h4>
        <div class="metric">
          <span class="metric-label">Underserved and/or  Hard to Reach:</span>
          <span class="metric-value" id="agency-underserved">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">CalEnviroScreen Score:</span>
          <span class="metric-value" id="agency-calenviroscore">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Pollution Burden Percentile:</span>
          <span class="metric-value" id="agency-pollutionburden">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Population:</span>
          <span class="metric-value" id="agency-population">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">% Children and Seniors:</span>
          <span class="metric-value" id="agency-children-seniors">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">AgencyArea (sq miles):</span>
          <span class="metric-value" id="agency-area">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Population Density (per sq. mile):</span>
          <span class="metric-value" id="agency-density">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Extreme Heat Days (days/year):</span>
          <span class="metric-value" id="agency-heat-days">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Average Household Income ($):</span>
          <span class="metric-value" id="agency-income">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">% Low-Income Census Tracts:</span>
          <span class="metric-value" id="agency-low-income">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label"># of Electric Circuits:</span>
          <span class="metric-value" id="agency-circuits">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Annual  Consumption (kWh):</span>
          <span class="metric-value" id="agency-kwh">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Annual Consumption (Therms):</span>
          <span class="metric-value" id="agency-therms">Not yet available</span>
        </div>
      </div>

      <!-- FACILITY DATA -->
      <div id="facility-data" style="display:none; margin-top:20px;">
        <h4>Facility-Level Data</h4>
        <div class="metric">
          <span class="metric-label">Year Built:</span>
          <span class="metric-value" id="facility-year">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Gross Floor Area (sq ft):</span>
          <span class="metric-value" id="facility-sqft">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Walkability:</span>
          <span class="metric-value" id="facility-walkability">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Existing Resilience Designation:</span>
          <span class="metric-value" id="facility-resilience">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Existing EV Chargers:</span>
          <span class="metric-value" id="facility-ev">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Number of Planned EV Chargers:</span>
          <span class="metric-value" id="facility-planned-ev">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Exisiting PV or Battery Storage Capabilities:</span>
          <span class="metric-value" id="facility-pv">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Planned PV (hours of autonomy):</span>
          <span class="metric-value" id="facility-planned-pv">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Planned Battery Storage (hours of autonomy):</span>
          <span class="metric-value" id="facility-planned-battery">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Building Type:</span>
          <span class="metric-value" id="facility-type">Not yet available</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- WELCOME POPUP -->
<div id="welcome-popup">
  <div class="welcome-content">
    <img src="images/SoCalREN_Logo_2017_PRIMARY.png" alt="SoCalREN Logo" style="width: 500px; margin-bottom: 20px;">
    <h1>
      <span class="title-line">Welcome to Southern California Regional Energy Network (SoCalREN)'s</span>
      <span class="title-line">Energy Resilience Action Plan (ERAP) Dashboard</span>
    </h1>
    <h2>Explore energy resilience planning efforts across Southern California</h2>
    <p>This interactive dashboard provides comprehensive information about facilities and agencies participating in SoCalREN's ERAP program. Use the map to explore geographical data, or search for specific details.</p>
    <button onclick="closeWelcome()">Enter Dashboard</button>
  </div>
</div>

<div id="loading-spinner">
  <i class="fas fa-spinner fa-spin"></i> Loading...
</div>

<script>
/* ============ PASSWORD PROMPT LOGIC ============ */
const passwordModal = document.getElementById('password-modal');
const passwordInput = document.getElementById('password-input');
const passwordSubmit = document.getElementById('password-submit');

document.addEventListener('DOMContentLoaded', () => {
  // Show the password modal immediately
  passwordModal.style.display = 'flex';
});

passwordSubmit.addEventListener('click', () => {
  if (passwordInput.value === 'SoCalREN2025') {
    // Correct => hide modal, init map
    passwordModal.style.display = 'none';
    initMap();
  } else {
    // Wrong => reload
    location.reload();
  }
});

/* ============ MAPBOX SETUP ============ */
mapboxgl.accessToken = 'pk.eyJ1Ijoid2VuZ2xlMSIsImEiOiJjbGh0bTJ0OTUzN2dzM21tbTB0NzFmM2QyIn0.-ItjIktoJtcQUsk6l9TbbQ';
let map;

function initMap() {
  map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12', 
    center: [-118.2437, 34.0522],
    zoom: 10
  });

  // Add Nav/Fullscreen
  map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
  map.addControl(new mapboxgl.NavigationControl(), 'top-right');

  // Add geocoder
  const geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    mapboxgl: mapboxgl,
    placeholder: 'Search for a location'
  });
  // By default, geocoder goes top-left
  map.addControl(geocoder, 'top-left');

  map.on('load', () => {
    document.getElementById('loading-spinner').style.display = 'block';
    loadBoundariesAndFacilities();
    document.getElementById('loading-spinner').style.display = 'none';
  });
}

/* ============ LOAD BOUNDARIES & FACILITIES ============ */
function loadBoundariesAndFacilities() {
  // Boundaries
  fetch('data/la_boundaries.geojson')
    .then(resp => resp.json())
    .then(geojson => {
      map.addSource('la-boundaries', { type: 'geojson', data: geojson });
      map.addLayer({
        id: 'la-boundaries-layer',
        type: 'fill',
        source: 'la-boundaries',
        paint: {
          'fill-color': '#9A5CA7', 
          'fill-opacity': 0.4
        }
      });
    })
    .catch(err => console.error('Error loading boundaries:', err));

  // Facilities
  const facilityGeoJSON = facilitiesToGeoJSON();
  map.addSource('facilities', {
    type: 'geojson',
    data: facilityGeoJSON,
    cluster: true,
    clusterMaxZoom: 14,
    clusterRadius: 50
  });
  addFacilityLayers();
}

function addFacilityLayers() {
  map.addLayer({
    id: 'clusters',
    type: 'circle',
    source: 'facilities',
    filter: ['has','point_count'],
    paint: {
      'circle-radius': [
        'step', ['get','point_count'],
        25, 10,
        30, 25,
        35
      ],
      'circle-color': [
        'step', ['get','point_count'],
        '#F37B43', 10,
        '#F05A28', 25,
        '#9A5CA7'
      ],
      'circle-opacity': 0.9,
      'circle-stroke-width': 2,
      'circle-stroke-color': '#ffffff',
      'circle-stroke-opacity': 0.8
    }
  });

  map.addLayer({
    id: 'cluster-count',
    type: 'symbol',
    source: 'facilities',
    filter: ['has','point_count'],
    layout: {
      'text-field': '{point_count_abbreviated}',
      'text-font': ['DIN Offc Pro Bold','Arial Unicode MS Bold'],
      'text-size': 16,
      'text-allow-overlap': true
    },
    paint: {
      'text-color': '#ffffff',
      'text-halo-color': 'rgba(0,0,0,0.2)',
      'text-halo-width': 1
    }
  });

  map.addLayer({
    id: 'unclustered-point',
    type: 'circle',
    source: 'facilities',
    filter: ['!',['has','point_count']],
    paint: {
      'circle-color': '#F37B43',
      'circle-radius': 8,
      'circle-stroke-width': 2,
      'circle-stroke-color': '#ffffff',
      'circle-opacity': 0.9,
      'circle-stroke-opacity': 0.8
    }
  });

  // cluster click => zoom
  map.on('click','clusters', e => {
    const features = map.queryRenderedFeatures(e.point,{ layers: ['clusters'] });
    if (!features.length) return;
    const clusterId = features[0].properties.cluster_id;
    map.getSource('facilities').getClusterExpansionZoom(clusterId, (err, zoom) => {
      if (err) return;
      map.easeTo({ center: features[0].geometry.coordinates, zoom });
    });
  });

  // unclustered point click => facility detail
  map.on('click','unclustered-point', e => {
    const props = e.features[0].properties;
    const matchedAgency = agenciesData.find(a => a.Agency === props["Agency"]);
    if (matchedAgency) {
      const facs = facilitiesData.filter(f => f.Agency === matchedAgency.Agency);
      showFacilities(matchedAgency, facs);
      showFacilityDetails(props["Agency"], props["Facility Name"]);
      document.getElementById('dashboard-panel').scrollIntoView({ behavior: 'smooth' });
    }
  });

  // Cursor changes for clusters
  map.on('mouseenter','clusters', () => {
    map.getCanvas().style.cursor = 'pointer';
  });
  map.on('mouseleave','clusters', () => {
    map.getCanvas().style.cursor = '';
  });
}

/* ============ AGENCIES & FACILITIES DATA =========== */
const agenciesData = [
  {
    "Agency": "City of Bell",
    "Council of Government": "Gateway Cities Council of Governments",
    "Underserved and/or  Hard to Reach": "Yes",
    "CalEnviroScreen Score": 96,
    "Pollution Burden Percentile": 88,
    "Population": 31864,
    "% Children and Seniors": 36,
    "AgencyArea (sq miles)": 2.5,
    "Population Density (per sq. mile)": 13400,
    "Extreme Heat Days (days/year)": 91,
    "Average Household Income ($)": 47800,
    "% Low-Income Census Tracts": 100,
    "# of Electric Circuits": 14,
    "Annual  Consumption (kWh)": 2200000,
    "Annual Consumption (Therms)": 91100
  },
  {
    "Agency": "City of Maywood",
    "Council of Government": "Gateway Cities Council of Governments",
    "Underserved and/or  Hard to Reach": "Yes",
    "CalEnviroScreen Score": 90,
    "Pollution Burden Percentile": 92,
    "Population": 27127,
    "% Children and Seniors": 38,
    "AgencyArea (sq miles)": 1.18,
    "Population Density (per sq. mile)": 23257,
    "Extreme Heat Days (days/year)": 77,
    "Average Household Income ($)": 50996,
    "% Low-Income Census Tracts": 100,
    "# of Electric Circuits": 6,
    "Annual  Consumption (kWh)": 939153,
    "Annual Consumption (Therms)": 1232
  },
  {
    "Agency": "City of Bell Gardens",
    "Council of Government": "Gateway Cities Council of Governments",
    "Underserved and/or  Hard to Reach": "Yes",
    "CalEnviroScreen Score": 92,
    "Pollution Burden Percentile": 97,
    "Population": 37467,
    "% Children and Seniors": 30,
    "AgencyArea (sq miles)": 2.5,
    "Population Density (per sq. mile)": 17100,
    "Extreme Heat Days (days/year)": 90,
    "Average Household Income ($)": 45300,
    "% Low-Income Census Tracts": 100,
    "# of Electric Circuits": 9,
    "Annual  Consumption (kWh)": 1597960,
    "Annual Consumption (Therms)": 25833
  },
  {
    "Agency": "City of Pomona",
    "Council of Government": "San Gabriel Valley Council of Governments",
    "Underserved and/or  Hard to Reach": "Yes",
    "CalEnviroScreen Score": 97,
    "Pollution Burden Percentile": 81,
    "Population": 151100,
    "% Children and Seniors": 37,
    "AgencyArea (sq miles)": 22.99,
    "Population Density (per sq. mile)": 6572,
    "Extreme Heat Days (days/year)": 118,
    "Average Household Income ($)": 62400,
    "% Low-Income Census Tracts": 82,
    "# of Electric Circuits": 56,
    "Annual  Consumption (kWh)": 20971427,
    "Annual Consumption (Therms)": 23848
  },
  {
    "Agency": "City of Irwindale",
    "Council of Government": "San Gabriel Valley Council of Governments",
    "Underserved and/or  Hard to Reach": "Yes",
    "CalEnviroScreen Score": 83,
    "Pollution Burden Percentile": 100,
    "Population": 1400,
    "% Children and Seniors": "Not yet available",
    "AgencyArea (sq miles)": 9.5,
    "Population Density (per sq. mile)": 142,
    "Extreme Heat Days (days/year)": 146,
    "Average Household Income ($)": 86250,
    "% Low-Income Census Tracts": 100,
    "# of Electric Circuits": 30,
    "Annual  Consumption (kWh)": 2452708,
    "Annual Consumption (Therms)": 11686
  },
  {
    "Agency": "El Monte Union High School District (EMUSHD)",
    "Council of Government": "San Gabriel Valley Council of Governments",
    "Underserved and/or  Hard to Reach": "Yes",
    "CalEnviroScreen Score": 80,
    "Pollution Burden Percentile": 92,
    "Population": 163151,
    "% Children and Seniors": "Not yet available",
    "AgencyArea (sq miles)": 22.38,
    "Population Density (per sq. mile)": 7290,
    "Extreme Heat Days (days/year)": 129,
    "Average Household Income ($)": 62000,
    "% Low-Income Census Tracts": "Not yet available",
    "# of Electric Circuits": 79,
    "Annual  Consumption (kWh)": "Not yet available",
    "Annual Consumption (Therms)": "Not yet available"
  },
  {
    "Agency": "City of Cudahy",
    "Council of Government": "Gateway Cities Council of Governments",
    "Underserved and/or  Hard to Reach": "Yes",
    "CalEnviroScreen Score": 95,
    "Pollution Burden Percentile": 94,
    "Population": 21700,
    "% Children and Seniors": 36,
    "AgencyArea (sq miles)": 1.23,
    "Population Density (per sq. mile)": 17642,
    "Extreme Heat Days (days/year)": 85,
    "Average Household Income ($)": 49600,
    "% Low-Income Census Tracts": 100,
    "# of Electric Circuits": 20,
    "Annual  Consumption (kWh)": "Not yet available",
    "Annual Consumption (Therms)": "Not yet available"
  },
  {
    "Agency": "City of South El Monte",
    "Council of Government": "San Gabriel Valley Council of Governments",
    "Underserved and/or  Hard to Reach": "Yes",
    "CalEnviroScreen Score": 97,
    "Pollution Burden Percentile": 98,
    "Population": 19000,
    "% Children and Seniors": 37,
    "AgencyArea (sq miles)": 2.84,
    "Population Density (per sq. mile)": 6690,
    "Extreme Heat Days (days/year)": 124,
    "Average Household Income ($)": 67700,
    "% Low-Income Census Tracts": 80,
    "# of Electric Circuits": 12,
    "Annual  Consumption (kWh)": 593500,
    "Annual Consumption (Therms)": 39700
  },
  {
    "Agency": "City of Lynwood",
    "Council of Government": "Gateway Cities Council of Governments",
    "Underserved and/or  Hard to Reach": "Yes",
    "CalEnviroScreen Score": 91,
    "Pollution Burden Percentile": 92,
    "Population": 63200,
    "% Children and Seniors": 35,
    "AgencyArea (sq miles)": 4.84,
    "Population Density (per sq. mile)": 13058,
    "Extreme Heat Days (days/year)": 33,
    "Average Household Income ($)": 67400,
    "% Low-Income Census Tracts": 66,
    "# of Electric Circuits": 22,
    "Annual  Consumption (kWh)": 1340300,
    "Annual Consumption (Therms)": 30100
  },
  {
    "Agency": "City of Duarte",
    "Council of Government": "San Gabriel Valley Council of Governments",
    "Underserved and/or  Hard to Reach": "Yes",
    "CalEnviroScreen Score": 78,
    "Pollution Burden Percentile": 58,
    "Population": 23100,
    "% Children and Seniors": 38,
    "AgencyArea (sq miles)": 6.71,
    "Population Density (per sq. mile)": 3443,
    "Extreme Heat Days (days/year)": 132,
    "Average Household Income ($)": 93900,
    "% Low-Income Census Tracts": 20,
    "# of Electric Circuits": 10,
    "Annual  Consumption (kWh)": 417700,
    "Annual Consumption (Therms)": "Not yet available"
  },
  {
    "Agency": "City of Rancho Palos Verdes",
    "Council of Government": "South Bay Cities Council of Governments",
    "Underserved and/or  Hard to Reach": "Yes",
    "CalEnviroScreen Score": 11,
    "Pollution Burden Percentile": 29,
    "Population": 41600,
    "% Children and Seniors": "Not yet available",
    "AgencyArea (sq miles)": 13.5,
    "Population Density (per sq. mile)": 3081,
    "Extreme Heat Days (days/year)": 11,
    "Average Household Income ($)": 146200,
    "% Low-Income Census Tracts": 0,
    "# of Electric Circuits": 25,
    "Annual  Consumption (kWh)": 359100,
    "Annual Consumption (Therms)": 900
  },
  {
    "Agency": "City of El Segundo",
    "Council of Government": "South Bay Cities Council of Governments",
    "Underserved and/or  Hard to Reach": "Yes",
    "CalEnviroScreen Score": 26,
    "Pollution Burden Percentile": 87,
    "Population": 16500,
    "% Children and Seniors": "Not yet available",
    "AgencyArea (sq miles)": 5.5,
    "Population Density (per sq. mile)": 3000,
    "Extreme Heat Days (days/year)": 7,
    "Average Household Income ($)": 115900,
    "% Low-Income Census Tracts": 0,
    "# of Electric Circuits": 20,
    "Annual  Consumption (kWh)": 94470,
    "Annual Consumption (Therms)": 40800
  }
];

const facilitiesData = [
  {
    "Agency": "City of Bell",
    "Facility Name": "Bell Library",
    "Address": "4411 Gage Ave, Bell, CA",
    "Latitude": "33.9765° N",
    "Longitude": "118.1856° W",
    "Year Built": 1965,
    "Gross Floor Area (sq ft)": 5622,
    "Walkability": "High",
    "Existing Resilience Designation": "Not yet available",
    "Existing EV Chargers": "No",
    "Number of Planned EV Chargers": 2,
    "Exisiting PV or Battery Storage Capabilities": "Not yet available",
    "Planned PV (hours of autonomy)": 3912,
    "Planned Battery Storage (hours of autonomy)": 25,
    "Building Type": "Library"
  },
  {
    "Agency": "City of Bell",
    "Facility Name": "Community Center",
    "Address": "6250 Pine Ave, Bell, CA",
    "Latitude": "33.9760° N",
    "Longitude": "118.1820° W",
    "Year Built": 1980,
    "Gross Floor Area (sq ft)": 16011,
    "Walkability": "High",
    "Existing Resilience Designation": "Cooling Center",
    "Existing EV Chargers": "No",
    "Number of Planned EV Chargers": 2,
    "Exisiting PV or Battery Storage Capabilities": "Solar went live in August 2020",
    "Planned PV (hours of autonomy)": 1899,
    "Planned Battery Storage (hours of autonomy)": 1748,
    "Building Type": "Community center"
  },
  {
    "Agency": "City of Bell",
    "Facility Name": "Camp Little Bear Park",
    "Address": "6704 Orchard Ave, Bell, CA",
    "Latitude": "33.9770° N",
    "Longitude": "118.1890° W",
    "Year Built": 1962,
    "Gross Floor Area (sq ft)": 5783,
    "Walkability": "Medium",
    "Existing Resilience Designation": "Not yet available",
    "Existing EV Chargers": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Storage Capabilities": "Not yet available",
    "Planned PV (hours of autonomy)": 664,
    "Planned Battery Storage (hours of autonomy)": 81,
    "Building Type": "Park"
  },
  {
    "Agency": "City of Bell",
    "Facility Name": "Veterans Memorial Park",
    "Address": "6500 Wilcox Ave, Bell, CA",
    "Latitude": "33.9765° N",
    "Longitude": "118.1875° W",
    "Year Built": 1955,
    "Gross Floor Area (sq ft)": 7500,
    "Walkability": "Medium",
    "Existing Resilience Designation": "Cooling Center",
    "Existing EV Chargers": "No Capacity",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Storage Capabilities": "Not yet available",
    "Planned PV (hours of autonomy)": 3397,
    "Planned Battery Storage (hours of autonomy)": 381,
    "Building Type": "Park"
  },
  {
    "Agency": "City of Maywood",
    "Facility Name": "City Hall & Sheriff's Office",
    "Address": "4319 Slauson Ave, Maywood, CA",
    "Latitude": "33.9880° N",
    "Longitude": "118.1850° W",
    "Year Built": 1938,
    "Gross Floor Area (sq ft)": 9534,
    "Walkability": "High",
    "Existing Resilience Designation": "Cooling Center",
    "Existing EV Chargers": "No",
    "Number of Planned EV Chargers": 4,
    "Exisiting PV or Battery Storage Capabilities": "No",
    "Planned PV (hours of autonomy)": 2646,
    "Planned Battery Storage (hours of autonomy)": 0,
    "Building Type": "Office"
  },
  {
    "Agency": "City of Maywood",
    "Facility Name": "Teen Center",
    "Address": "4801 E. Slauson Ave, Maywood, CA",
    "Latitude": "33.9885° N",
    "Longitude": "118.1700° W",
    "Year Built": "Not yet available",
    "Gross Floor Area (sq ft)": "Not yet available",
    "Walkability": "Medium",
    "Existing Resilience Designation": "Not yet available",
    "Existing EV Chargers": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Storage Capabilities": "No",
    "Planned PV (hours of autonomy)": "Whole Year",
    "Planned Battery Storage (hours of autonomy)": "Whole year",
    "Building Type": "Community center"
  },
  {
    "Agency": "City of Maywood",
    "Facility Name": "Maywood Park (YMCA)",
    "Address": "4801 E. 58th St, Maywood, CA",
    "Latitude": "33.9890° N",
    "Longitude": "118.1705° W",
    "Year Built": 1999,
    "Gross Floor Area (sq ft)": 30819,
    "Walkability": "Medium",
    "Existing Resilience Designation": "Not yet available",
    "Existing EV Chargers": "No",
    "Number of Planned EV Chargers": 4,
    "Exisiting PV or Battery Storage Capabilities": "No",
    "Planned PV (hours of autonomy)": 1140,
    "Planned Battery Storage (hours of autonomy)": 5,
    "Building Type": "Community center"
  },
  {
    "Agency": "City of Maywood",
    "Facility Name": "Cesar Chavez Library",
    "Address": "4323 Slauson Ave, Maywood, CA",
    "Latitude": "33.9880° N",
    "Longitude": "118.1845° W",
    "Year Built": 1938,
    "Gross Floor Area (sq ft)": 3382,
    "Walkability": "High",
    "Existing Resilience Designation": "Not yet available",
    "Existing EV Chargers": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Storage Capabilities": "No",
    "Planned PV (hours of autonomy)": 2311,
    "Planned Battery Storage (hours of autonomy)": 5,
    "Building Type": "Library"
  },
  {
    "Agency": "City of Bell Gardens",
    "Facility Name": "Ford Park and Recreation Center",
    "Address": "8000 Park Lane, Bell Gardens, CA",
    "Latitude": "33.9650° N",
    "Longitude": "118.1510° W",
    "Year Built": 1976,
    "Gross Floor Area (sq ft)": 9083,
    "Walkability": "High",
    "Existing Resilience Designation": "Not yet available",
    "Existing EV Chargers": "No",
    "Number of Planned EV Chargers": 10,
    "Exisiting PV or Battery Storage Capabilities": "Not yet available",
    "Planned PV (hours of autonomy)": 3563,
    "Planned Battery Storage (hours of autonomy)": 13,
    "Building Type": "Community center"
  },
  {
    "Agency": "City of Bell Gardens",
    "Facility Name": "Community Family Services Center & Veterans Park",
    "Address": "6662 Loveland St, Bell Gardens, CA",
    "Latitude": "33.9660° N",
    "Longitude": "118.1530° W",
    "Year Built": 1976,
    "Gross Floor Area (sq ft)": 20000,
    "Walkability": "Low",
    "Existing Resilience Designation": "Not yet available",
    "Existing EV Chargers": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Storage Capabilities": "Not yet available",
    "Planned PV (hours of autonomy)": 3330,
    "Planned Battery Storage (hours of autonomy)": 71,
    "Building Type": "Community center"
  },
  {
    "Agency": "City of Bell Gardens",
    "Facility Name": "Youth Center",
    "Address": "5856 Ludell St, Bell Gardens, CA",
    "Latitude": "33.9680° N",
    "Longitude": "118.1500° W",
    "Year Built": 1948,
    "Gross Floor Area (sq ft)": 11446,
    "Walkability": "Medium",
    "Existing Resilience Designation": "Not yet available",
    "Existing EV Chargers": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Storage Capabilities": "Not yet available",
    "Planned PV (hours of autonomy)": 3406,
    "Planned Battery Storage (hours of autonomy)": 11,
    "Building Type": "Community center"
  },
  {
    "Agency": "City of Bell Gardens",
    "Facility Name": "Civic Center",
    "Address": "7100 Garfield St, Bell Gardens, CA",
    "Latitude": "33.9655° N",
    "Longitude": "118.1515° W",
    "Year Built": 1967,
    "Gross Floor Area (sq ft)": 18500,
    "Walkability": "Medium",
    "Existing Resilience Designation": "Not yet available",
    "Existing EV Chargers": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Storage Capabilities": "Not yet available",
    "Planned PV (hours of autonomy)": 5,
    "Planned Battery Storage (hours of autonomy)": 0,
    "Building Type": "City Hall"
  },
  {
    "Agency": "City of Pomona",
    "Facility Name": "Library",
    "Address": "625 S Garey Ave, Pomona, CA",
    "Latitude": "34.0530° N",
    "Longitude": "117.7500° W",
    "Year Built": 1956,
    "Gross Floor Area (sq ft)": 25977,
    "Walkability": "High",
    "Existing Resilience Designation": "Cooling Center",
    "Existing EV Chargers": "Yes",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Storage Capabilities": "Not yet available",
    "Planned PV (hours of autonomy)": 2057,
    "Planned Battery Storage (hours of autonomy)": 0,
    "Building Type": "Library"
  },
  {
    "Agency": "City of Pomona",
    "Facility Name": "City Hall",
    "Address": "505 S Garey Ave, Pomona, CA",
    "Latitude": "34.0525° N",
    "Longitude": "117.7505° W",
    "Year Built": 1969,
    "Gross Floor Area (sq ft)": 44996,
    "Walkability": "High",
    "Existing Resilience Designation": "Not yet available",
    "Existing EV Chargers": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Storage Capabilities": "Not yet available",
    "Planned PV (hours of autonomy)": 2482,
    "Planned Battery Storage (hours of autonomy)": 14,
    "Building Type": "Office"
  },
  {
    "Agency": "City of Pomona",
    "Facility Name": "Palomares Park",
    "Address": "499 E Arrow Hwy, Pomona, CA",
    "Latitude": "34.1000° N",
    "Longitude": "117.7400° W",
    "Year Built": 1983,
    "Gross Floor Area (sq ft)": 15704,
    "Walkability": "Low",
    "Existing Resilience Designation": "Cooling Center",
    "Existing EV Chargers": "Yes",
    "Number of Planned EV Chargers": 19,
    "Exisiting PV or Battery Storage Capabilities": "Not yet available",
    "Planned PV (hours of autonomy)": 6470,
    "Planned Battery Storage (hours of autonomy)": 48,
    "Building Type": "Community center"
  },
  {
    "Agency": "City of Pomona",
    "Facility Name": "Washington Senior Center",
    "Address": "865 E Grand Ave, Pomona, CA",
    "Latitude": "34.0600° N",
    "Longitude": "117.7400° W",
    "Year Built": 1935,
    "Gross Floor Area (sq ft)": 2539,
    "Walkability": "Low",
    "Existing Resilience Designation": "Cooling Center",
    "Existing EV Chargers": "No",
    "Number of Planned EV Chargers": 6,
    "Exisiting PV or Battery Storage Capabilities": "Not yet available",
    "Planned PV (hours of autonomy)": 4070,
    "Planned Battery Storage (hours of autonomy)": 883,
    "Building Type": "Senior Center"
  },
  {
    "Agency": "City of Irwindale",
    "Facility Name": "Dan Diaz Recreation Center and Library",
    "Address": "16053 Calle De Paseo, Irwindale, CA",
    "Latitude": "34.1100° N",
    "Longitude": "117.9700° W",
    "Year Built": 1970,
    "Gross Floor Area (sq ft)": 22855,
    "Walkability": "Low",
    "Existing Resilience Designation": "Not yet available",
    "Existing EV Chargers": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Storage Capabilities": "Not yet available",
    "Planned PV (hours of autonomy)": 1068,
    "Planned Battery Storage (hours of autonomy)": 1,
    "Building Type": "Library and recreation center"
  },
  {
    "Agency": "City of Irwindale",
    "Facility Name": "City Hall and Police Department",
    "Address": "5050 N Irwindale Ave, Irwindale, CA",
    "Latitude": "34.1105° N",
    "Longitude": "117.9350° W",
    "Year Built": 1957,
    "Gross Floor Area (sq ft)": 20600,
    "Walkability": "Low",
    "Existing Resilience Designation": "Emergency Operations Center",
    "Existing EV Chargers": "No",
    "Number of Planned EV Chargers": 4,
    "Exisiting PV or Battery Storage Capabilities": "Not yet available",
    "Planned PV (hours of autonomy)": 4,
    "Planned Battery Storage (hours of autonomy)": 0,
    "Building Type": "Office"
  },
  {
    "Agency": "City of Irwindale",
    "Facility Name": "Senior Center and Annex",
    "Address": "16116 Arrow Hwy, Irwindale, CA",
    "Latitude": "34.1100° N",
    "Longitude": "117.9705° W",
    "Year Built": 1985,
    "Gross Floor Area (sq ft)": 20678,
    "Walkability": "Low",
    "Existing Resilience Designation": "Cooling Center",
    "Existing EV Chargers": "No",
    "Number of Planned EV Chargers": 4,
    "Exisiting PV or Battery Storage Capabilities": "Not yet available",
    "Planned PV (hours of autonomy)": 24,
    "Planned Battery Storage (hours of autonomy)": 0,
    "Building Type": "Multi-purpose / office"
  },
  {
    "Agency": "City of Irwindale",
    "Facility Name": "New Library (Planned for 2026)",
    "Address": "Not yet available",
    "Latitude": "Not yet available",
    "Longitude": "Not yet available",
    "Year Built": "Not yet available",
    "Gross Floor Area (sq ft)": "Not yet available",
    "Walkability": "Not yet available",
    "Existing Resilience Designation": "Not yet available",
    "Existing EV Chargers": "Not yet available",
    "Number of Planned EV Chargers": "Not yet available",
    "Exisiting PV or Battery Storage Capabilities": "Not yet available",
    "Planned PV (hours of autonomy)": "Not yet available",
    "Planned Battery Storage (hours of autonomy)": "Not yet available",
    "Building Type": "Library"
  }
];

/* ============ UTILITY =========== */
function parseCoordinate(coordStr) {
  if (!coordStr || coordStr.toString().trim().toUpperCase() === 'NOT YET AVAILABLE') return null;
  const parts = coordStr.split('°');
  if (parts.length < 2) return null;
  let value = parseFloat(parts[0].trim());
  let direction = parts[1].trim().toUpperCase();
  if (direction.startsWith('S') || direction.startsWith('W')) {
    value = -value;
  }
  return value;
}

function normalizeValue(val) {
  if (!val) return 'Not yet available';
  const str = String(val).trim();
  if (str.toUpperCase() === 'N/A') return 'Not yet available';
  return val;
}

function facilitiesToGeoJSON() {
  const features = facilitiesData.map(f => {
    const lat = parseCoordinate(f["Latitude"]);
    const lon = parseCoordinate(f["Longitude"]);
    if (lat === null || lon === null) return null;
    return {
      type: 'Feature',
      properties: { ...f },
      geometry: { type: 'Point', coordinates: [lon, lat] }
    };
  }).filter(Boolean);
  return { type: 'FeatureCollection', features };
}

/* ============ RENDER LISTING & FILTERS =========== */
function renderListing() {
  const listingElement = document.getElementById('listing');
  const introSection = document.getElementById('intro-section');
  const agencyFilters = document.getElementById('agency-filters');
  const facilityFilters = document.getElementById('facility-filters');

  listingElement.innerHTML = '';
  introSection.style.display = 'block';
  agencyFilters.style.display = 'block';
  facilityFilters.style.display = 'none';

  // Group by Council
  const groups = {};
  agenciesData.forEach(a => {
    const cog = a["Council of Government"];
    if (!groups[cog]) groups[cog] = [];
    groups[cog].push(a);
  });

  for (const [cog, agencies] of Object.entries(groups)) {
    if (agencies.length > 0) {
      const cogSection = document.createElement('div');
      cogSection.className = 'cog-section';

      const cogHeader = document.createElement('div');
      cogHeader.className = 'cog-header';
      cogHeader.textContent = cog;

      const agencyList = document.createElement('div');
      agencyList.className = 'agency-list';

      // expand/collapse
      cogHeader.addEventListener('click', () => {
        cogHeader.classList.toggle('expanded');
        agencyList.style.display = (agencyList.style.display === 'none') ? 'block' : 'none';
      });

      agencies.sort((a,b) => a.Agency.localeCompare(b.Agency));
      agencies.forEach(a => {
        const div = document.createElement('div');
        div.className = 'agency-title';
        div.textContent = a.Agency;
        div.onclick = () => {
          const facs = facilitiesData.filter(f => f.Agency === a.Agency);
          showFacilities(a, facs);
        };
        agencyList.appendChild(div);
      });

      cogSection.appendChild(cogHeader);
      cogSection.appendChild(agencyList);
      listingElement.appendChild(cogSection);
    }
  }
}

function filterAgencies() {
  const minPop = parseInt(document.getElementById('population-min').value) || 0;
  const maxPop = parseInt(document.getElementById('population-max').value) || Infinity;
  const searchText = document.getElementById('agency-filter').value.toLowerCase().trim();
  const dacFilter = document.getElementById('dac-filter').checked;
  const ces90Filter = document.getElementById('ces90-filter').checked;

  const filtered = agenciesData.filter(a => {
    const matchSearch = (searchText === '') || a.Agency.toLowerCase().includes(searchText);
    const pop = Number(a["Population"]) || 0;
    const matchPop = (pop >= minPop && pop <= maxPop);
    const isUnderserved = (a["Underserved and/or  Hard to Reach"] || "").toLowerCase() === 'yes';
    const matchDAC = !dacFilter || isUnderserved;
    const calVal = Number(a["CalEnviroScreen Score"]) || 0;
    const matchCal = !ces90Filter || (calVal > 90);
    return matchSearch && matchPop && matchDAC && matchCal;
  });

  const listingElement = document.getElementById('listing');
  listingElement.innerHTML = '';
  const introSection = document.getElementById('intro-section');

  const groupByCOG = {};
  filtered.forEach(a => {
    const c = a["Council of Government"];
    if (!groupByCOG[c]) groupByCOG[c] = [];
    groupByCOG[c].push(a);
  });

  for (const [cog, agencies] of Object.entries(groupByCOG)) {
    if (agencies.length > 0) {
      const cogSection = document.createElement('div');
      cogSection.className = 'cog-section';

      const cogHeader = document.createElement('div');
      cogHeader.className = 'cog-header';
      cogHeader.textContent = cog;
      cogHeader.addEventListener('click', () => {
        cogHeader.classList.toggle('expanded');
        agencyList.style.display = (agencyList.style.display === 'none') ? 'block' : 'none';
      });

      const agencyList = document.createElement('div');
      agencyList.className = 'agency-list';
      agencyList.style.display = 'block';

      agencies.sort((a,b) => a.Agency.localeCompare(b.Agency));
      agencies.forEach(a => {
        const agencyDiv = document.createElement('div');
        agencyDiv.className = 'agency-title';
        agencyDiv.textContent = a.Agency;
        agencyDiv.onclick = () => {
          const facs = facilitiesData.filter(f => f.Agency === a.Agency);
          showFacilities(a, facs);
        };
        agencyList.appendChild(agencyDiv);
      });

      cogSection.appendChild(cogHeader);
      cogSection.appendChild(agencyList);
      listingElement.appendChild(cogSection);
    }
  }

  introSection.style.display = filtered.length > 0 ? 'block' : 'none';
}

function refreshFacilityList() {
  const title = document.querySelector('#data-overview-title').textContent;
  let currentAgency = agenciesData.find(a => title.includes(a.Agency));
  if (currentAgency) {
    const facs = facilitiesData.filter(f => f.Agency === currentAgency.Agency);
    showFacilities(currentAgency, facs);
  }
}

/* ============ SHOW FACILITIES =========== */
function showFacilities(agency, facilityList) {
  const listingElement = document.getElementById('listing');
  const dashboardElement = document.getElementById('dashboard');
  const agencyDataElement = document.getElementById('agency-data');
  const facilityDataElement = document.getElementById('facility-data');
  const introSection = document.getElementById('intro-section');
  const agencyFilters = document.getElementById('agency-filters');
  const facilityFilters = document.getElementById('facility-filters');

  listingElement.innerHTML = '';

  // Back button
  const backButton = document.createElement('button');
  backButton.id = 'back-button';
  backButton.textContent = 'Back to Agencies';
  backButton.onclick = () => {
    dashboardElement.style.display = 'none';
    renderListing();
  };
  listingElement.appendChild(backButton);

  // Title
  const header = document.createElement('h4');
  header.textContent = `Facilities in ${agency.Agency}`;
  listingElement.appendChild(header);

  // Filter facility data
  const filteredFacilities = filterFacilityData(facilityList);
  if (filteredFacilities.length > 0) {
    filteredFacilities.forEach(f => {
      const facilityDiv = document.createElement('div');
      facilityDiv.className = 'facility-title';
      facilityDiv.textContent = f["Facility Name"];
      facilityDiv.onclick = () => showFacilityDetails(f.Agency, f["Facility Name"]);
      listingElement.appendChild(facilityDiv);
    });
  } else {
    const noFacilitiesMsg = document.createElement('div');
    noFacilitiesMsg.id = 'no-facilities-msg';
    noFacilitiesMsg.textContent = 'No facilities found matching the selected filters.';
    listingElement.appendChild(noFacilitiesMsg);
  }

  introSection.style.display = 'none';
  agencyFilters.style.display = 'none';
  facilityFilters.style.display = 'block';

  dashboardElement.style.display = 'block';
  agencyDataElement.style.display = 'block';
  facilityDataElement.style.display = 'none';

  updateAgencyDashboard(agency);
}

function filterFacilityData(facilities) {
  const pvChecked = document.getElementById('pv-filter').checked;
  const evChecked = document.getElementById('ev-filter').checked;
  const coolChecked = document.getElementById('cooling-filter').checked;

  return facilities.filter(f => {
    const hasPV = (f["Exisiting PV or Battery Storage Capabilities"] || "").toLowerCase() !== 'not yet available'
                  && (f["Exisiting PV or Battery Storage Capabilities"] || "").toLowerCase() !== 'no';
    const hasEV = (f["Existing EV Chargers"] || "").toLowerCase() !== 'not yet available'
                  && (f["Existing EV Chargers"] || "").toLowerCase() !== 'no'
                  && (f["Existing EV Chargers"] || "") !== '0';
    const hasCooling = (f["Existing Resilience Designation"] || "").toLowerCase() !== 'not yet available'
                       && (f["Existing Resilience Designation"] || "").toLowerCase() !== 'no';

    const passPV = !pvChecked || hasPV;
    const passEV = !evChecked || hasEV;
    const passCool = !coolChecked || hasCooling;
    return passPV && passEV && passCool;
  });
}

function updateAgencyDashboard(agency) {
  document.getElementById('data-overview-title').textContent = `${agency.Agency} Data Overview`;
  document.getElementById('agency-underserved').textContent = normalizeValue(agency["Underserved and/or  Hard to Reach"]);
  document.getElementById('agency-calenviroscore').textContent = normalizeValue(agency["CalEnviroScreen Score"]);
  document.getElementById('agency-pollutionburden').textContent = normalizeValue(agency["Pollution Burden Percentile"]);

  let popVal = normalizeValue(agency["Population"]);
  if (!isNaN(parseInt(popVal))) popVal = parseInt(popVal).toLocaleString();
  document.getElementById('agency-population').textContent = popVal;

  document.getElementById('agency-children-seniors').textContent = normalizeValue(agency["% Children and Seniors"]);
  document.getElementById('agency-area').textContent = normalizeValue(agency["AgencyArea (sq miles)"]);

  let denVal = normalizeValue(agency["Population Density (per sq. mile)"]);
  if (!isNaN(parseInt(denVal))) denVal = parseInt(denVal).toLocaleString();
  document.getElementById('agency-density').textContent = denVal;

  document.getElementById('agency-heat-days').textContent = normalizeValue(agency["Extreme Heat Days (days/year)"]);

  let incVal = normalizeValue(agency["Average Household Income ($)"]);
  if (!isNaN(parseInt(incVal))) incVal = parseInt(incVal).toLocaleString();
  document.getElementById('agency-income').textContent = incVal;

  document.getElementById('agency-low-income').textContent = normalizeValue(agency["% Low-Income Census Tracts"]);
  document.getElementById('agency-circuits').textContent = normalizeValue(agency["# of Electric Circuits"]);

  let kwhVal = normalizeValue(agency["Annual  Consumption (kWh)"]);
  if (!isNaN(parseInt(kwhVal))) kwhVal = parseInt(kwhVal).toLocaleString();
  document.getElementById('agency-kwh').textContent = kwhVal;

  let thermVal = normalizeValue(agency["Annual Consumption (Therms)"]);
  if (!isNaN(parseInt(thermVal))) thermVal = parseInt(thermVal).toLocaleString();
  document.getElementById('agency-therms').textContent = thermVal;
}

function showFacilityDetails(agencyName, facilityName) {
  const facility = facilitiesData.find(f => f.Agency === agencyName && f["Facility Name"] === facilityName);
  if (!facility) return;

  document.getElementById('facility-data').style.display = 'block';
  document.getElementById('agency-data').style.display = 'none';
  document.getElementById('data-overview-title').textContent = facilityName;

  document.getElementById('facility-year').textContent = normalizeValue(facility["Year Built"]);
  document.getElementById('facility-sqft').textContent = normalizeValue(facility["Gross Floor Area (sq ft)"]);
  document.getElementById('facility-walkability').textContent = normalizeValue(facility["Walkability"]);
  document.getElementById('facility-resilience').textContent = normalizeValue(facility["Existing Resilience Designation"]);
  document.getElementById('facility-ev').textContent = normalizeValue(facility["Existing EV Chargers"]);
  document.getElementById('facility-planned-ev').textContent = normalizeValue(facility["Number of Planned EV Chargers"]);
  document.getElementById('facility-pv').textContent = normalizeValue(facility["Exisiting PV or Battery Storage Capabilities"]);
  document.getElementById('facility-planned-pv').textContent = normalizeValue(facility["Planned PV (hours of autonomy)"]);
  document.getElementById('facility-planned-battery').textContent = normalizeValue(facility["Planned Battery Storage (hours of autonomy)"]);
  document.getElementById('facility-type').textContent = normalizeValue(facility["Building Type"]);

  // highlight
  const facilityEls = document.querySelectorAll('.facility-title');
  facilityEls.forEach(el => {
    el.classList.toggle('active', el.textContent.trim() === facilityName);
  });

  // center map
  const lat = parseCoordinate(facility["Latitude"]);
  const lon = parseCoordinate(facility["Longitude"]);
  if (lat !== null && lon !== null) {
    map.flyTo({ center: [lon, lat], zoom: 15 });
  }
}

/* ============ WELCOME POPUP =========== */
function closeWelcome() {
  const popup = document.getElementById('welcome-popup');
  popup.classList.add('fade-out');
  setTimeout(() => {
    popup.style.display = 'none';
  }, 400);
}

/* ============ FILTER EVENTS =========== */
document.getElementById('population-min').addEventListener('input', filterAgencies);
document.getElementById('population-max').addEventListener('input', filterAgencies);
document.getElementById('agency-filter').addEventListener('input', filterAgencies);
document.getElementById('dac-filter').addEventListener('change', filterAgencies);
document.getElementById('ces90-filter').addEventListener('change', filterAgencies);

document.getElementById('pv-filter').addEventListener('change', refreshFacilityList);
document.getElementById('ev-filter').addEventListener('change', refreshFacilityList);
document.getElementById('cooling-filter').addEventListener('change', refreshFacilityList);

/* ============ INITIALIZE LISTING =========== */
renderListing();
</script>
</body>
</html>
