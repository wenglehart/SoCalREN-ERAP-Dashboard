<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>SoCalREN's ERAP Dashboard</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto:wght@300;400&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css" type="text/css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        header {
            width: 100%;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            height: 60px;
            box-sizing: border-box;
        }
        .header-left {
            flex: 0 0 auto;
        }
        .header-left h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 20px;
            margin: 0;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
            justify-content: flex-end;
            max-width: 800px;
            margin-left: 40px;
        }
        .geocoder-container {
            flex: 1;
            max-width: 400px;
            min-width: 200px;
        }
        .style-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 4px;
        }
        .style-selector label {
            font-size: 14px;
            white-space: nowrap;
        }
        .style-selector select {
            background-color: transparent;
            color: #ecf0f1;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        .style-selector select:hover {
            border-color: rgba(255, 255, 255, 0.5);
        }
        .style-selector select option {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        .mapboxgl-ctrl-geocoder {
            box-shadow: none !important;
            width: 100% !important;
            max-width: none !important;
            font-family: 'Montserrat', sans-serif !important;
            border-radius: 4px;
        }
        .mapboxgl-ctrl-geocoder--input {
            height: 36px !important;
            padding: 6px 35px !important;
        }
        #container {
            flex: 1;
            display: flex;
            flex-direction: row;
            position: relative;
            overflow: hidden;
        }
        #map {
            width: 60%;
            height: 100%;
        }
        .map-overlay {
            width: 40%;
            height: 100%;
            font: 14px/22px 'Roboto', sans-serif;
            background-color: #fafafa;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        fieldset {
            background: #f0f0f0;
            border: none;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        input[type="text"], input[type="number"], input[type="range"] {
            border: 1px solid #ccc;
            width: 100%;
            border-radius: 5px;
            padding: 8px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        #agency-filter {
            position: relative;
        }
        #agency-suggestions {
            position: absolute;
            background: #fff;
            border: 1px solid #ccc;
            width: calc(100% - 16px);
            margin: 0;
            padding: 0;
            list-style: none;
            max-height: 150px;
            overflow-y: auto;
            z-index: 9999;
        }
        #agency-suggestions li {
            padding: 8px;
            cursor: pointer;
        }
        #agency-suggestions li:hover {
            background: #e0f7fa;
            color: #00796b;
        }
        .listing {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        .listing a {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            color: #404;
            text-decoration: none;
            display: block;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
            font-size: 14px;
        }
        .facilities-container {
            position: relative;
            z-index: 2;
            margin-top: 10px;
            display: block;
            max-height: calc(100vh - 400px);
            overflow-y: auto;
        }

        #listing {
            position: relative;
            height: auto;
            min-height: 200px;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            padding: 10px;
            margin-top: 10px;
        }
        .listing a:hover {
            background: #e0f7fa;
            color: #00796b;
        }
        .filters {
            margin-bottom: 10px;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        .filters label {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .filters input[type=checkbox] {
            margin-right: 5px;
        }
        .filters select {
            width: 100%;
            margin-bottom: 10px;
            font-size: 12px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .dashboard {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            font-size: 14px;
            margin-top: 10px;
        }
        .dashboard h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            font-weight: bold;
            color: #2c3e50;
        }
        .dashboard h4 {
            margin-bottom: 10px;
            font-size: 15px;
        }
        .metric {
            margin-bottom: 10px;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .metric .metric-value {
            font-weight: bold;
            font-size: 16px;
        }
        .chart-section {
            margin-top: 20px;
        }
        .chart-section h4 {
            margin-bottom: 10px;
        }
        #populationChartContainer,
        #facilitiesPieContainer {
            margin-bottom: 20px;
        }
        #populationChartContainer canvas,
        #facilitiesPieContainer canvas {
            background: #fff;
            border-radius: 8px;
            padding: 10px;
        }
        #loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #00796b;
            display: none;
            z-index: 999;
        }
        #back-button {
            background: #34495e;
            color: #ecf0f1;
            border: none;
            padding: 5px 10px;
            margin-bottom: 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
        #back-button:hover {
            background: #3b5771;
        }
        .cog-section {
            margin-bottom: 10px;
        }
        .cog-header {
            background: #2c3e50;
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
            color: #ffffff;
            margin-bottom: 8px;
        }
        .cog-header::after {
            content: 'â–¼';
            font-size: 12px;
            color: #ffffff;
            transition: transform 0.3s ease;
            margin-left: 10px;
            opacity: 0.9;
        }
        .cog-header.expanded::after {
            transform: rotate(180deg);
        }
        .cog-header:hover {
            background: #34495e;
        }
        .agency-list {
            margin-top: 5px;
            margin-bottom: 15px;
            padding-left: 10px;
        }
        .agency-title {
            font-size: 14px;
            font-weight: normal;
            margin: 5px 0;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s ease;
            color: #2c3e50;
            background: #f8f9fa;
        }
        .agency-title:hover {
            background: #e0f7fa;
            color: #00796b;
            transform: translateX(5px);
        }
        .facility-title {
            display: block;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: #2c3e50;
            text-decoration: none;
            border: 1px solid #e9ecef;
        }

        .facility-title:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        #listing {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            margin-top: 10px;
        }

        #listing h4 {
            margin: 10px 0;
            color: #2c3e50;
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            color: #2c3e50;
            margin: 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            font-weight: bold;
        }

        #no-facilities-msg {
            padding: 10px;
            color: #666;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 4px;
            margin: 10px 0;
        }

        .style-overlay {
            background-color: #34495e;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #ecf0f1;
            margin-right: 10px;
        }
        .style-overlay label {
            display: block;
            margin-bottom: 5px;
            font-weight: normal;
        }
        .style-overlay select {
            width: 100%;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            color: #000;
        }
        #welcome-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(44, 62, 80, 0.90);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.4s ease;
            backdrop-filter: blur(5px);
        }

        #welcome-popup.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        #welcome-popup .welcome-content {
            background: white;
            padding: 60px 70px;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            position: relative;
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        #welcome-popup h1 {
            font-family: 'Nunito', sans-serif;
            font-size: 28px;
            margin-bottom: 30px;
            color: #2c3e50;
            line-height: 1.4;
            font-weight: 700;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 20px;
        }

        #welcome-popup h1 .title-line {
            display: block;
            margin-bottom: 5px;
        }

        #welcome-popup h2 {
            font-family: 'Nunito', sans-serif;
            font-size: 22px;
            color: #ff9800;
            margin: 30px 0 25px;
            font-weight: 600;
            line-height: 1.4;
            text-align: center;
        }

        #welcome-popup p {
            font-family: 'Nunito', sans-serif;
            font-size: 17px;
            margin-bottom: 25px;
            color: #546e7a;
            line-height: 1.8;
            font-weight: 400;
            text-align: center;
            max-width: 650px;
            margin-left: auto;
            margin-right: auto;
        }

        #welcome-popup button {
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 17px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Nunito', sans-serif;
            display: block;
            margin: 40px auto 0;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        #welcome-popup button:hover {
            background-color: #34495e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #welcome-popup button:active {
            transform: translateY(0);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #welcome-popup .welcome-content {
                padding: 40px;
                width: 85%;
            }

            #welcome-popup h1 {
                font-size: 28px;
            }

            #welcome-popup h2 {
                font-size: 20px;
            }

            #welcome-popup p {
                font-size: 16px;
            }

            #welcome-popup button {
                padding: 14px 35px;
                font-size: 16px;
            }
        }
                /* Responsive styling */
                @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            #map {
                flex: none;
                height: 50vh;
            }
            .map-overlay {
                position: relative;
                transform: none !important;
            }
        }

        #intro-section {
            margin-top: 20px;
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        #intro-section h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-family: 'Montserrat', sans-serif;
            color: #2c3e50;
        }
        #intro-section p {
            margin: 0 0 15px 0;
            font-size: 14px;
            line-height: 1.6;
            color: #34495e;
        }
        #intro-section ul {
            list-style: inside square;
            margin: 0 0 15px 0;
            padding: 0;
        }
        #intro-section li {
            margin-bottom: 8px;
            font-size: 14px;
            color: #34495e;
        }

        .facility-popup .mapboxgl-popup-content {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-family: 'Montserrat', sans-serif;
            font-size: 13px;
            line-height: 1.4;
        }

        .facility-popup .mapboxgl-popup-tip {
            border-top-color: rgba(255, 255, 255, 0.95);
        }

        .facility-title.active {
            background: #fff3e0;
            border-left: 3px solid #ff9800;
            transform: translateX(5px);
        }

        .mapboxgl-ctrl-geocoder {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            font-family: 'Montserrat', sans-serif !important;
        }

        .mapboxgl-ctrl-geocoder--input {
            font-family: 'Roboto', sans-serif !important;
        }

        .mapboxgl-ctrl-geocoder--suggestion {
            font-family: 'Roboto', sans-serif !important;
        }

        .fullscreen-container {
            margin-left: 10px;
        }

        .mapboxgl-ctrl-fullscreen {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .mapboxgl-ctrl-fullscreen:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        #populationChartContainer {
            height: 300px;
            margin-bottom: 20px;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #populationChart {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<header>
    <div class="header-left">
        <h1>SoCalREN's ERAP Dashboard</h1>
    </div>
    <div class="header-controls">
        <div class="geocoder-container" id="geocoder"></div>
        <div class="style-selector">
            <label for="style-selector">Map Style</label>
            <select id="style-selector">
                <option value="mapbox://styles/wengle1/cm4m4sedc001v01sqdtx0cioz">Custom Style</option>
                <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
                <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
                <option value="mapbox://styles/mapbox/light-v10">Light</option>
                <option value="mapbox://styles/mapbox/dark-v10">Dark</option>
                <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
            </select>
        </div>
        <div class="fullscreen-container" id="fullscreen-control"></div>
    </div>
</header>
<div id="container">
    <div id="map"></div>
    <div class="map-overlay" id="dashboard-panel">
        <fieldset>
            <input id="agency-filter" type="text" placeholder="Search for an agency">
            <ul id="agency-suggestions" style="display:none;"></ul>
        </fieldset>
        <fieldset class="filters" id="agency-filters">
            <legend>Agency Filters</legend>
            <label><input type="checkbox" id="dac-filter"> Show only Disadvantaged Communities (DAC)</label>
            <label><input type="checkbox" id="ces90-filter"> Show only agencies with CalEnviroScreen Score > 90</label>
            <label for="cog-select">Filter by Council of Governments:</label>
            <select id="cog-select">
                <option value="">All</option>
                <option value="Gateway Cities">Gateway Cities Council of Governments (GCCOG)</option>
                <option value="San Gabriel Valley COG">San Gabriel Valley Council of Governments (SGVCOG)</option>
                <option value="South Bay Cities">South Bay Cities Council of Governments (SBCOG)</option>
            </select>
            <div id="cog-dropdowns">
                <!-- COG dropdowns will be injected here by JavaScript -->
            </div>
            <label for="population-threshold">Population greater than:</label>
            <input type="range" id="population-threshold" min="0" max="200000" value="0">
            <span id="population-threshold-value">0</span>
        </fieldset>
        <fieldset class="filters" id="facility-filters" style="display:none;">
            <legend>Facility Filters</legend>
            <label><input type="checkbox" id="pv-filter"> Show only facilities with PV capabilities</label>
            <label><input type="checkbox" id="ev-filter"> Show only facilities with existing EV chargers</label>
            <label><input type="checkbox" id="cooling-filter"> Show only Cooling Centers / Emergency Ops</label>
        </fieldset>
        <div id="listing" class="listing"></div>
        <div id="intro-section">
            <h4>Welcome to SoCalREN's ERAP Dashboard</h4>
            <p>
                This dashboard provides insights into public agencies' energy resilience planning efforts across Southern California that have received support from the SoCalREN Public Agency Programs.
            </p>
            <p>
                The data displayed here includes key metrics collected throughout an agency's involvement in the ERAP program. The dashboard can help you understand community needs, identify facilities, etc.
            </p>
            <h4>Getting Started</h4>
            <ul>
                <li>Use the "Filter by agency name" box to quickly locate a participating agency.</li>
                <li>Adjust the range filter to focus on agencies with larger populations.</li>
                <li>Click an agency name to view its details and a list of associated facilities that were assessed by SoCalREN.</li>
            </ul>
            <h4>What is ERAP?</h4>
            <p>
                SoCalREN's Energy Resilience Action Plan (ERAP) program aims to address the growing impacts of climate change. Developed in collaboration with regional partners, the ERAP program enhances community resilience.
            </p>
        </div>
        <div class="dashboard" id="dashboard">
            <button id="back-button">Back</button>
            <h3 id="data-overview-title">Data Overview</h3>
            <div id="agency-data" style="display:none; margin-top:20px;">
                <h4>Agency-Level Data</h4>
                <div class="metric">
                    <span class="metric-label">DAC Status:</span>
                    <span class="metric-value" id="agency-dac">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">CalEnviroscreen:</span>
                    <span class="metric-value" id="agency-cal">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Population:</span>
                    <span class="metric-value" id="agency-pop">N/A</span>
                </div>
            </div>
            <div class="chart-section">
                <div id="populationChartContainer">
                    <canvas id="populationChart"></canvas>
                </div>
                <div id="facilitiesPieContainer">
                    <canvas id="facilitiesPieChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="welcome-popup">
    <div class="welcome-content">
        <h1>
            <span class="title-line">Welcome to SoCalREN's</span>
            <span class="title-line">Energy Resilience Action Plan (ERAP) GIS Hub</span>
        </h1>
        <h2>Explore Energy Resilience Planning Across Southern California</h2>
        <p>
            This interactive dashboard provides comprehensive insights into public agencies' energy resilience planning efforts. 
            Discover facilities with existing and planned energy resilience features, understand community needs, and explore 
            opportunities for enhanced resilience across the region.
        </p>
        <p>
            Navigate through participating agencies, filter by various criteria, and access detailed information about facilities 
            and their energy resilience capabilities.
        </p>
        <button onclick="closeWelcome()">Enter Dashboard</button>
    </div>
</div>

<script>
    // Initialize global variables for data
    let agencyData = [];
    let facilityData = [];
    let facilityGeoJSON = {
        type: 'FeatureCollection',
        features: []
    };

    // Mapbox token
    mapboxgl.accessToken = 'pk.eyJ1Ijoid2VuZ2xlMSIsImEiOiJjbGh0bTJ0OTUzN2dzM21tbTB0NzFmM2QyIn0.-ItjIktoJtcQUsk6l9TbbQ';

    // Function to load CSV data using Papa Parse
    async function loadCSVData(url) {
        return new Promise((resolve, reject) => {
            Papa.parse(url, {
                download: true,
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    resolve(results.data);
                },
                error: function(error) {
                    reject(error);
                }
            });
        });
    }

    // Function to create COG dropdowns
    function createCOGDropdowns(agencies) {
        const cogDropdowns = document.getElementById('cog-dropdowns');
        const cogs = [...new Set(agencies.map(agency => agency['Council of Government']))];

        cogs.forEach(cog => {
            const dropdown = document.createElement('select');
            dropdown.id = `cog-${cog.replace(/\s+/g, '-').toLowerCase()}`;
            dropdown.style.display = 'none';

            const defaultOption = document.createElement('option');
            defaultOption.textContent = `Select an agency under ${cog}`;
            defaultOption.value = '';
            dropdown.appendChild(defaultOption);

            agencies.filter(agency => agency['Council of Government'] === cog)
                    .forEach(agency => {
                        const option = document.createElement('option');
                        option.textContent = agency.Agency;
                        option.value = agency.Agency;
                        dropdown.appendChild(option);
                    });

            cogDropdowns.appendChild(dropdown);
        });

        document.getElementById('cog-select').addEventListener('change', function () {
            const selectedCOG = this.value;
            cogs.forEach(cog => {
                const dropdown = document.getElementById(`cog-${cog.replace(/\s+/g, '-').toLowerCase()}`);
                dropdown.style.display = cog === selectedCOG ? 'block' : 'none';
            });
        });
    }

    // Load data and initialize dropdowns
    async function loadAllData() {
    try {
        // Complete hardcoded agency data
        agencyData = [
            {
                Agency: "City of Bell",
                COG: "Gateway Cities",
                DAC: true,
                CalEnviroScreen: 96,
                Population: 31864,
                ChildrenPercent: 36,
                ExtremeHeat: 2.5,
                AverageHVI: 13400,
                LowIncome: 91,
                ElectricityBurden: 47800,
                PopulationDAC: 100,
                NumberEVChargers: 14,
                AnnualConsumption: 2200000,
                AnnualCost: 91100
            },
            {
                Agency: "City of Bell Gardens",
                COG: "Gateway Cities",
                DAC: true,
                CalEnviroScreen: 90,
                Population: 27127,
                ChildrenPercent: 38,
                ExtremeHeat: 1.18,
                AverageHVI: 23257,
                LowIncome: 77,
                ElectricityBurden: 50996,
                PopulationDAC: 100,
                NumberEVChargers: 6,
                AnnualConsumption: 939153,
                AnnualCost: 1232
            },
            {
                Agency: "City of Bell Gardens",
                COG: "Gateway Cities",
                DAC: true,
                CalEnviroScreen: 92,
                Population: 37467,
                ChildrenPercent: 30,
                ExtremeHeat: 2.5,
                AverageHVI: 17100,
                LowIncome: 90,
                ElectricityBurden: 45300,
                PopulationDAC: 100,
                NumberEVChargers: 9,
                AnnualConsumption: 1597960,
                AnnualCost: 25833
            },
            {
                Agency: "City of Pomona",
                COG: "San Gabriel Valley",
                DAC: true,
                CalEnviroScreen: 97,
                Population: 151100,
                ChildrenPercent: 37,
                ExtremeHeat: 22.99,
                AverageHVI: 6572,
                LowIncome: 118,
                ElectricityBurden: 62400,
                PopulationDAC: 82,
                NumberEVChargers: 56,
                AnnualConsumption: 20971427,
                AnnualCost: 23848
            },
            {
                Agency: "City of Irwindale",
                COG: "San Gabriel Valley",
                DAC: true,
                CalEnviroScreen: 83,
                Population: 1400,
                ChildrenPercent: null,
                ExtremeHeat: 9.5,
                AverageHVI: 142,
                LowIncome: 146,
                ElectricityBurden: 86250,
                PopulationDAC: 100,
                NumberEVChargers: 30,
                AnnualConsumption: 2452708,
                AnnualCost: 11686
            },
            {
                Agency: "El Monte",
                COG: "San Gabriel Valley",
                DAC: true,
                CalEnviroScreen: 80,
                Population: 163151,
                ChildrenPercent: null,
                ExtremeHeat: 22.38,
                AverageHVI: 7290,
                LowIncome: 129,
                ElectricityBurden: 62000,
                PopulationDAC: null,
                NumberEVChargers: 79,
                AnnualConsumption: null,
                AnnualCost: null
            },
            {
                Agency: "City of Cudahy",
                COG: "Gateway Cities",
                DAC: true,
                CalEnviroScreen: 95,
                Population: 21700,
                ChildrenPercent: 36,
                ExtremeHeat: 1.23,
                AverageHVI: 17642,
                LowIncome: 85,
                ElectricityBurden: 49600,
                PopulationDAC: 100,
                NumberEVChargers: 20,
                AnnualConsumption: null,
                AnnualCost: null
            },
            {
                Agency: "City of South El Monte",
                COG: "San Gabriel Valley",
                DAC: true,
                CalEnviroScreen: 97,
                Population: 19000,
                ChildrenPercent: 37,
                ExtremeHeat: 2.84,
                AverageHVI: 6690,
                LowIncome: 124,
                ElectricityBurden: 67700,
                PopulationDAC: 80,
                NumberEVChargers: 12,
                AnnualConsumption: 593500,
                AnnualCost: 39700
            },
            {
                Agency: "City of Lynwood",
                COG: "Gateway Cities",
                DAC: true,
                CalEnviroScreen: 91,
                Population: 63200,
                ChildrenPercent: 35,
                ExtremeHeat: 4.84,
                AverageHVI: 13058,
                LowIncome: 33,
                ElectricityBurden: 67400,
                PopulationDAC: 66,
                NumberEVChargers: 22,
                AnnualConsumption: 1340300,
                AnnualCost: 30100
            },
            {
                Agency: "City of Duarte",
                COG: "San Gabriel Valley",
                DAC: true,
                CalEnviroScreen: 78,
                Population: 23100,
                ChildrenPercent: 38,
                ExtremeHeat: 6.71,
                AverageHVI: 3443,
                LowIncome: 132,
                ElectricityBurden: 39300,
                PopulationDAC: 20,
                NumberEVChargers: 10,
                AnnualConsumption: 417700,
                AnnualCost: null
            },
            {
                Agency: "City of Rancho Palos Verdes",
                COG: "South Bay Cities",
                DAC: false,
                CalEnviroScreen: 11,
                Population: 41600,
                ChildrenPercent: null,
                ExtremeHeat: 13.5,
                AverageHVI: 3081,
                LowIncome: 11,
                ElectricityBurden: 146200,
                PopulationDAC: 0,
                NumberEVChargers: 25,
                AnnualConsumption: 359100,
                AnnualCost: 900
            },
            {
                Agency: "City of El Segundo",
                COG: "South Bay Cities",
                DAC: false,
                CalEnviroScreen: 26,
                Population: 16500,
                ChildrenPercent: null,
                ExtremeHeat: 5.5,
                AverageHVI: 3000,
                LowIncome: 7,
                ElectricityBurden: 115900,
                PopulationDAC: 0,
                NumberEVChargers: 20,
                AnnualConsumption: 94470,
                AnnualCost: 40800
            }
        ];

        // Complete hardcoded facility data
        facilityData = [
            {
                Agency: "City of Bell",
                FacilityName: "Bell Library",
                Address: "4411 Gage Ave",
                Latitude: 33.9765,
                Longitude: -118.1856,
                YearBuilt: 1965,
                GrossFloorArea: 5622,
                Walkability: "High",
                CoolingCenter: null,
                ExistingEV: false,
                ExistingPV: false,
                PlannedPV: 3912,
                PlannedBattery: 25,
                BuildingType: "Library"
            },
            {
                Agency: "City of Bell",
                FacilityName: "Community Center",
                Address: "6250 Pine Ave",
                Latitude: 33.9760,
                Longitude: -118.1820,
                YearBuilt: 1980,
                GrossFloorArea: 16011,
                Walkability: "High",
                CoolingCenter: "No",
                ExistingEV: false,
                ExistingPV: true,
                PlannedPV: 1899,
                PlannedBattery: 1748,
                BuildingType: "Community Center"
            },
            {
                Agency: "City of Bell",
                FacilityName: "Camp Little Bear",
                Address: "6704 Orchard",
                Latitude: 33.9770,
                Longitude: -118.1890,
                YearBuilt: 1962,
                GrossFloorArea: 5783,
                Walkability: "Medium",
                CoolingCenter: null,
                ExistingEV: false,
                ExistingPV: false,
                PlannedPV: 664,
                PlannedBattery: 81,
                BuildingType: "Park"
            },
            {
                Agency: "City of Bell",
                FacilityName: "Veterans Memorial Park",
                Address: "6500 Wilcox Ave",
                Latitude: 33.9765,
                Longitude: -118.1875,
                YearBuilt: 1955,
                GrossFloorArea: 7500,
                Walkability: "Medium",
                CoolingCenter: "No",
                ExistingEV: false,
                ExistingPV: false,
                PlannedPV: 3397,
                PlannedBattery: 381,
                BuildingType: "Park"
            },
            {
                Agency: "City of Maywood",
                FacilityName: "City Hall",
                Address: "4319 Slauson Ave",
                Latitude: 33.9880,
                Longitude: -118.1850,
                YearBuilt: 1938,
                GrossFloorArea: 9534,
                Walkability: "High",
                CoolingCenter: "No",
                ExistingEV: true,
                ExistingPV: false,
                PlannedPV: 2646,
                PlannedBattery: 0,
                BuildingType: "Office"
            },
            {
                Agency: "City of Maywood",
                FacilityName: "Teen Center",
                Address: "4801 E. 58th St",
                Latitude: 33.9885,
                Longitude: -118.1700,
                YearBuilt: null,
                GrossFloorArea: null,
                Walkability: "Medium",
                CoolingCenter: "No",
                ExistingEV: false,
                ExistingPV: false,
                PlannedPV: null,
                PlannedBattery: null,
                BuildingType: "Community Center"
            },
            {
                Agency: "City of Maywood",
                FacilityName: "Maywood Activity Center",
                Address: "4801 E. 58th St",
                Latitude: 33.9890,
                Longitude: -118.1705,
                YearBuilt: 1999,
                GrossFloorArea: 30819,
                Walkability: null,
                CoolingCenter: null,
                ExistingEV: false,
                ExistingPV: false,
                PlannedPV: 1140,
                PlannedBattery: 5,
                BuildingType: "Community Center"
            },
            {
                Agency: "City of Maywood",
                FacilityName: "Cesar Chavez Park",
                Address: "4323 Slauson Ave",
                Latitude: 33.9880,
                Longitude: -118.1845,
                YearBuilt: 1938,
                GrossFloorArea: 3382,
                Walkability: "High",
                CoolingCenter: null,
                ExistingEV: false,
                ExistingPV: false,
                PlannedPV: 2311,
                PlannedBattery: 5,
                BuildingType: "Library"
            },
            {
                Agency: "City of Bell",
                FacilityName: "Ford Park",
                Address: "8000 Park Ave",
                Latitude: 33.9550,
                Longitude: -118.1510,
                YearBuilt: 1976,
                GrossFloorArea: 9083,
                Walkability: "High",
                CoolingCenter: null,
                ExistingEV: true,
                ExistingPV: false,
                PlannedPV: 3563,
                PlannedBattery: 13,
                BuildingType: "Community Center"
            },
            {
                Agency: "City of Bell",
                FacilityName: "Community Center",
                Address: "5662 Loveland St",
                Latitude: 33.9660,
                Longitude: -118.1530,
                YearBuilt: 1976,
                GrossFloorArea: 20000,
                Walkability: "Low",
                CoolingCenter: null,
                ExistingEV: false,
                ExistingPV: false,
                PlannedPV: 3330,
                PlannedBattery: 71,
                BuildingType: "Community Center"
            },
            {
                Agency: "City of Bell",
                FacilityName: "Youth Center",
                Address: "5856 Ludell St",
                Latitude: 33.9680,
                Longitude: -118.1500,
                YearBuilt: 1948,
                GrossFloorArea: 11446,
                Walkability: "Medium",
                CoolingCenter: null,
                ExistingEV: false,
                ExistingPV: false,
                PlannedPV: 3406,
                PlannedBattery: 11,
                BuildingType: "Community Center"
            },
            {
                Agency: "City of Bell",
                FacilityName: "Civic Center",
                Address: "7100 Garfield Ave",
                Latitude: 33.9655,
                Longitude: -118.1515,
                YearBuilt: 1967,
                GrossFloorArea: 18500,
                Walkability: "Medium",
                CoolingCenter: null,
                ExistingEV: false,
                ExistingPV: false,
                PlannedPV: 5,
                PlannedBattery: 0,
                BuildingType: "City Hall"
            },
            {
                Agency: "City of Bell",
                FacilityName: "City Library",
                Address: "625 S Garfield Ave",
                Latitude: 34.0230,
                Longitude: -117.7500,
                YearBuilt: 1956,
                GrossFloorArea: 25977,
                Walkability: "High",
                CoolingCenter: "Yes",
                ExistingEV: false,
                ExistingPV: false,
                PlannedPV: 2057,
                PlannedBattery: 0,
                BuildingType: "Library"
            },
            {
                Agency: "City of Pomona",
                FacilityName: "City Hall",
                Address: "505 S Garey Ave",
                Latitude: 34.0525,
                Longitude: -117.7505,
                YearBuilt: 1969,
                GrossFloorArea: 44996,
                Walkability: "High",
                CoolingCenter: null,
                ExistingEV: false,
                ExistingPV: false,
                PlannedPV: 2482,
                PlannedBattery: 14,
                BuildingType: "Office"
            },
            {
                Agency: "City of Pomona",
                FacilityName: "Palomares Park",
                Address: "499 E Arrow Hwy",
                Latitude: 34.1000,
                Longitude: -117.7400,
                YearBuilt: 1983,
                GrossFloorArea: 15704,
                Walkability: "Low",
                CoolingCenter: "Yes",
                ExistingEV: true,
                ExistingPV: false,
                PlannedPV: 6470,
                PlannedBattery: 48,
                BuildingType: "Community Center"
            },
            {
                Agency: "City of Pomona",
                FacilityName: "Washington Park",
                Address: "865 E Grand Ave",
                Latitude: 34.0600,
                Longitude: -117.7400,
                YearBuilt: 1935,
                GrossFloorArea: 2539,
                Walkability: "Low",
                CoolingCenter: "No",
                ExistingEV: true,
                ExistingPV: false,
                PlannedPV: 4070,
                PlannedBattery: 883,
                BuildingType: "Senior Center"
            },
            {
                Agency: "City of Irwindale",
                FacilityName: "Dan Diaz Library",
                Address: "16053 Calle del Norte",
                Latitude: 34.1100,
                Longitude: -117.9700,
                YearBuilt: 1970,
                GrossFloorArea: 22855,
                Walkability: "Low",
                CoolingCenter: null,
                ExistingEV: false,
                ExistingPV: false,
                PlannedPV: 1068,
                PlannedBattery: 1,
                BuildingType: "Library"
            },
            {
                Agency: "City of Irwindale",
                FacilityName: "City Hall",
                Address: "5050 N Irwindale Ave",
                Latitude: 34.1105,
                Longitude: -117.9350,
                YearBuilt: 1957,
                GrossFloorArea: 20600,
                Walkability: "Low",
                CoolingCenter: "Emergency",
                ExistingEV: true,
                ExistingPV: false,
                PlannedPV: 4,
                PlannedBattery: 0,
                BuildingType: "Office"
            },
            {
                Agency: "City of Irwindale",
                FacilityName: "Senior Center",
                Address: "16116 Arrow Hwy",
                Latitude: 34.1100,
                Longitude: -117.9705,
                YearBuilt: 1985,
                GrossFloorArea: 20678,
                Walkability: "Low",
                CoolingCenter: "No",
                ExistingEV: true,
                ExistingPV: false,
                PlannedPV: 24,
                PlannedBattery: 0,
                BuildingType: "Multi-purpose"
            },
            {
                Agency: "City of Irwindale",
                FacilityName: "New Library",
                Address: null,
                Latitude: null,
                Longitude: null,
                YearBuilt: null,
                GrossFloorArea: null,
                Walkability: null,
                CoolingCenter: null,
                ExistingEV: null,
                ExistingPV: null,
                PlannedPV: null,
                PlannedBattery: null,
                BuildingType: "Library"
            }
        ];

        // Convert facilities to GeoJSON
        facilityGeoJSON = {
            type: 'FeatureCollection',
            features: facilityData.map(f => ({
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [f.Longitude, f.Latitude]
                },
                properties: {
                    Agency: f.Agency,
                    FacilityName: f.FacilityName,
                    Address: f.Address,
                    ActualUse: f.BuildingType,
                    ExistingEV: f.ExistingEV,
                    ExistingPV: f.ExistingPV,
                    CoolingCenter: f.CoolingCenter
                }
            })).filter(f => f.geometry.coordinates[0] !== null && f.geometry.coordinates[1] !== null)
        };

        // Load boundaries data (keeping this the same as in your original code)
        const boundariesResponse = await fetch('./data/la_boundaries.geojson');
        const boundariesData = await boundariesResponse.json();

        // Initialize map and other components
        initializeMap(boundariesData);
        createCOGDropdowns(agencyData);
        updateListing(agencyData);

        if (document.getElementById('loading-spinner')) {
            document.getElementById('loading-spinner').style.display = 'none';
        }

    } catch (error) {
        console.error('Error loading data:', error);
        if (document.getElementById('loading-spinner')) {
            document.getElementById('loading-spinner').innerHTML = 'Error loading data. Please refresh the page.';
        }
    }
}

// Update charts function
function updateCharts(agency, facilities) {
    // Update or create population chart
    const popCtx = document.getElementById('populationChart');
    if (window.populationChart) {
        window.populationChart.destroy();
    }

    const popData = {
        labels: ['Population'],
        datasets: [{
            label: agency.Agency,
            data: [agency.Population],
            backgroundColor: 'rgba(52, 152, 219, 0.5)',
            borderColor: 'rgba(52, 152, 219, 1)',
            borderWidth: 1
        }]
    };

    window.populationChart = new Chart(popCtx, {
        type: 'bar',
        data: popData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Population'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Agency Population'
                }
            }
        }
    });
        // Update or create facilities pie chart
        const pieCtx = document.getElementById('facilitiesPieChart');
    if (window.facilitiesPieChart) {
        window.facilitiesPieChart.destroy();
    }

    // Count facilities by type
    const facilityTypes = facilities.reduce((acc, facility) => {
        const type = facility.ActualUse || 'Unspecified';
        acc[type] = (acc[type] || 0) + 1;
        return acc;
    }, {});

    const pieData = {
        labels: Object.keys(facilityTypes),
        datasets: [{
            data: Object.values(facilityTypes),
            backgroundColor: [
                'rgba(52, 152, 219, 0.8)',
                'rgba(46, 204, 113, 0.8)',
                'rgba(155, 89, 182, 0.8)',
                'rgba(241, 196, 15, 0.8)',
                'rgba(231, 76, 60, 0.8)'
            ]
        }]
    };

    window.facilitiesPieChart = new Chart(pieCtx, {
        type: 'pie',
        data: pieData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Facilities by Type'
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Welcome popup functions
function showWelcome() {
    const popup = document.getElementById('welcome-popup');
    popup.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeWelcome() {
    const popup = document.getElementById('welcome-popup');
    popup.classList.add('fade-out');
    document.body.style.overflow = '';
    setTimeout(() => {
        popup.style.display = 'none';
        popup.classList.remove('fade-out');
    }, 400);
}

// Update data overview function
function updateDataOverview(agencies) {
    const totalAgencies = agencies.length;
    const totalPopulation = agencies.reduce((sum, agency) => sum + (agency.Population || 0), 0);
    const dacAgencies = agencies.filter(a => a.DAC).length;
    
    const metrics = {
        'Total Agencies': totalAgencies,
        'Total Population Served': totalPopulation.toLocaleString(),
        'DAC Agencies': dacAgencies,
        'Non-DAC Agencies': totalAgencies - dacAgencies
    };

    const agencyData = document.getElementById('agency-data');
    agencyData.innerHTML = '<h4>Overview Metrics</h4>';

    Object.entries(metrics).forEach(([label, value]) => {
        const metricDiv = document.createElement('div');
        metricDiv.className = 'metric';
        metricDiv.innerHTML = `
            <span class="metric-label">${label}:</span>
            <span class="metric-value">${value}</span>
        `;
        agencyData.appendChild(metricDiv);
    });
}

// Initialize the application
document.addEventListener('DOMContentLoaded', () => {
    // Show welcome popup
    showWelcome();
    
    // Load data and initialize map
    loadAllData();
});

// Style selector event listener
document.getElementById('style-selector').addEventListener('change', (event) => {
    const selectedStyle = event.target.value;
    const currentZoom = map.getZoom();
    const currentCenter = map.getCenter();
    
    map.setStyle(selectedStyle);
    
    map.on('style.load', () => {
        // Re-add sources and layers after style change
        const dashboardCities = agencyData.map(a => {
            return a.Agency.replace('City of ', '').trim().toUpperCase();
        });
                // Re-add boundaries source and layers
                map.addSource('la-boundaries', {
            'type': 'geojson',
            'data': './data/la_boundaries.geojson'
        });

        // Re-add facilities source
        map.addSource('facilities', {
            'type': 'geojson',
            'data': facilityGeoJSON,
            'cluster': true,
            'clusterMaxZoom': 14,
            'clusterRadius': 50
        });

        // Re-add all layers
        map.addLayer({
            'id': 'la-fills',
            'type': 'fill',
            'source': 'la-boundaries',
            'layout': {},
            'paint': {
                'fill-color': '#3498db',
                'fill-opacity': 0.4
            }
        });

        map.addLayer({
            'id': 'la-borders',
            'type': 'line',
            'source': 'la-boundaries',
            'layout': {},
            'paint': {
                'line-color': '#2980b9',
                'line-width': 1
            }
        });

        map.addLayer({
            'id': 'la-fills-hover',
            'type': 'fill',
            'source': 'la-boundaries',
            'paint': {
                'fill-color': '#2ecc71',
                'fill-opacity': 0.7
            },
            'filter': ['==', ['get', 'CITY_COMM_NAME'], '']
        });

        map.addLayer({
            'id': 'clusters',
            'type': 'circle',
            'source': 'facilities',
            'filter': ['has', 'point_count'],
            'paint': {
                'circle-radius': [
                    'step',
                    ['get', 'point_count'],
                    25,
                    10,
                    30,
                    25,
                    35
                ],
                'circle-color': [
                    'step',
                    ['get', 'point_count'],
                    '#ff9800',
                    10,
                    '#f57c00',
                    25,
                    '#e65100'
                ],
                'circle-opacity': 0.9,
                'circle-stroke-width': 2,
                'circle-stroke-color': '#ffffff',
                'circle-stroke-opacity': 0.8
            }
        });

        map.addLayer({
            'id': 'cluster-count',
            'type': 'symbol',
            'source': 'facilities',
            'filter': ['has', 'point_count'],
            'layout': {
                'text-field': '{point_count_abbreviated}',
                'text-font': ['DIN Offc Pro Bold', 'Arial Unicode MS Bold'],
                'text-size': 16
            },
            'paint': {
                'text-color': '#ffffff'
            }
        });

        map.addLayer({
            'id': 'unclustered-point',
            'type': 'circle',
            'source': 'facilities',
            'filter': ['!', ['has', 'point_count']],
            'paint': {
                'circle-color': '#ff9800',
                'circle-radius': 8,
                'circle-stroke-width': 2,
                'circle-stroke-color': '#ffffff',
                'circle-opacity': 0.9,
                'circle-stroke-opacity': 0.8
            }
        });

        // Apply filters to boundary layers
        map.setFilter('la-fills', ['in', ['get', 'CITY_COMM_NAME'], ['literal', dashboardCities]]);
        map.setFilter('la-borders', ['in', ['get', 'CITY_COMM_NAME'], ['literal', dashboardCities]]);

        // Restore the zoom and center position
        map.setZoom(currentZoom);
        map.setCenter(currentCenter);

        // Re-add event listeners
        addMapEventListeners();
    });
});

</script>
</body>
</html>
