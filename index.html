<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>SoCalREN's ERAP GIS Hub</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto:wght@300;400&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css" type="text/css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        header {
            width: 100%;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            height: 60px;
            box-sizing: border-box;
        }
        .header-left {
            flex: 0 0 auto;
        }
        .header-left h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 20px;
            margin: 0;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
            justify-content: flex-end;
            max-width: 800px;
            margin-left: 40px;
        }
        .geocoder-container {
            flex: 1;
            max-width: 400px;
            min-width: 200px;
        }
        .style-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 4px;
        }
        .style-selector label {
            font-size: 14px;
            white-space: nowrap;
        }
        .style-selector select {
            background-color: transparent;
            color: #ecf0f1;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        .style-selector select:hover {
            border-color: rgba(255, 255, 255, 0.5);
        }
        .style-selector select option {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        .mapboxgl-ctrl-geocoder {
            box-shadow: none !important;
            width: 100% !important;
            max-width: none !important;
            font-family: 'Montserrat', sans-serif !important;
            border-radius: 4px;
        }
        .mapboxgl-ctrl-geocoder--input {
            height: 36px !important;
            padding: 6px 35px !important;
        }
        #container {
            flex: 1;
            display: flex;
            flex-direction: row;
            position: relative;
            overflow: hidden;
        }
        #map {
            width: 60%;  /* Adjust this percentage as needed */
            height: 100%;
        }
        .map-overlay {
            width: 40%;  /* Adjust this percentage as needed */
            height: 100%;
            font: 14px/22px 'Roboto', sans-serif;
            background-color: #fafafa;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        fieldset {
            background: #f0f0f0;
            border: none;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        input[type="text"], input[type="number"], input[type="range"] {
            border: 1px solid #ccc;
            width: 100%;
            border-radius: 5px;
            padding: 8px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        #agency-filter {
            position: relative;
        }
        #agency-suggestions {
            position: absolute;
            background: #fff;
            border: 1px solid #ccc;
            width: calc(100% - 16px);
            margin: 0;
            padding: 0;
            list-style: none;
            max-height: 150px;
            overflow-y: auto;
            z-index: 9999;
        }
        #agency-suggestions li {
            padding: 8px;
            cursor: pointer;
        }
        #agency-suggestions li:hover {
            background: #e0f7fa;
            color: #00796b;
        }
        .listing {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        .listing a {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            color: #404;
            text-decoration: none;
            display: block;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
            font-size: 14px;
        }
        .facilities-container {
            position: relative;
            z-index: 2;
            margin-top: 10px;
            display: block;
            max-height: calc(100vh - 400px);
            overflow-y: auto;
        }

        #listing {
            position: relative;
            height: auto;
            min-height: 200px;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            padding: 10px;
            margin-top: 10px;
        }
        .listing a:hover {
            background: #e0f7fa;
            color: #00796b;
        }
        .filters {
            margin-bottom: 10px;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        .filters label {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .filters input[type=checkbox] {
            margin-right: 5px;
        }
        .filters select {
            width: 100%;
            margin-bottom: 10px;
            font-size: 12px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .dashboard {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            font-size: 14px;
            margin-top: 10px;
        }
        .dashboard h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            font-weight: bold;
            color: #2c3e50;
        }
        .dashboard h4 {
            margin-bottom: 10px;
            font-size: 15px;
        }
        .metric {
            margin-bottom: 10px;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .metric .metric-value {
            font-weight: bold;
            font-size: 16px;
        }
        .chart-section {
            margin-top: 20px;
        }
        .chart-section h4 {
            margin-bottom: 10px;
        }
        #populationChartContainer,
        #facilitiesPieContainer {
            margin-bottom: 20px;
        }
        #populationChartContainer canvas,
        #facilitiesPieContainer canvas {
            background: #fff;
            border-radius: 8px;
            padding: 10px;
        }
        #loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #00796b;
            display: none;
            z-index: 999;
        }
        #back-button {
            background: #34495e;
            color: #ecf0f1;
            border: none;
            padding: 5px 10px;
            margin-bottom: 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
        #back-button:hover {
            background: #3b5771;
        }
        .cog-section {
            margin-bottom: 10px;
        }
        .cog-header {
            background: #2c3e50;
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
            color: #ffffff;
            margin-bottom: 8px;
        }
        .cog-header::after {
            content: 'â–¼';
            font-size: 12px;
            color: #ffffff;
            transition: transform 0.3s ease;
            margin-left: 10px;
            opacity: 0.9;
        }
        .cog-header.expanded::after {
            transform: rotate(180deg);
        }
        .cog-header:hover {
            background: #34495e;
        }
        .agency-list {
            margin-top: 5px;
            margin-bottom: 15px;
            padding-left: 10px;
        }
        .agency-title {
            font-size: 14px;
            font-weight: normal;
            margin: 5px 0;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s ease;
            color: #2c3e50;
            background: #f8f9fa;
        }
        .agency-title:hover {
            background: #e0f7fa;
            color: #00796b;
            transform: translateX(5px);
        }
        .facility-title {
            display: block;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: #2c3e50;
            text-decoration: none;
            border: 1px solid #e9ecef;
        }

        .facility-title:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        #listing {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            margin-top: 10px;
        }

        #listing h4 {
            margin: 10px 0;
            color: #2c3e50;
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            color: #2c3e50;
            margin: 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            font-weight: bold;
        }

        #no-facilities-msg {
            padding: 10px;
            color: #666;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 4px;
            margin: 10px 0;
        }

        .style-overlay {
            background-color: #34495e;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #ecf0f1;
            margin-right: 10px;
        }
        .style-overlay label {
            display: block;
            margin-bottom: 5px;
            font-weight: normal;
        }
        .style-overlay select {
            width: 100%;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            color: #000;
        }
        #welcome-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(44, 62, 80, 0.90);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.4s ease;
            backdrop-filter: blur(5px);
        }

        #welcome-popup.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        #welcome-popup .welcome-content {
            background: white;
            padding: 60px 70px;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            position: relative;
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        #welcome-popup h1 {
            font-family: 'Nunito', sans-serif;
            font-size: 28px;
            margin-bottom: 30px;
            color: #2c3e50;
            line-height: 1.4;
            font-weight: 700;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 20px;
        }

        #welcome-popup h1 .title-line {
            display: block;
            margin-bottom: 5px;
        }

        #welcome-popup h2 {
            font-family: 'Nunito', sans-serif;
            font-size: 22px;
            color: #ff9800;
            margin: 30px 0 25px;
            font-weight: 600;
            line-height: 1.4;
            text-align: center;
        }

        #welcome-popup p {
            font-family: 'Nunito', sans-serif;
            font-size: 17px;
            margin-bottom: 25px;
            color: #546e7a;
            line-height: 1.8;
            font-weight: 400;
            text-align: center;
            max-width: 650px;
            margin-left: auto;
            margin-right: auto;
        }

        #welcome-popup button {
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 17px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Nunito', sans-serif;
            display: block;
            margin: 40px auto 0;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        #welcome-popup button:hover {
            background-color: #34495e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #welcome-popup button:active {
            transform: translateY(0);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #welcome-popup .welcome-content {
                padding: 40px;
                width: 85%;
            }

            #welcome-popup h1 {
                font-size: 28px;
            }

            #welcome-popup h2 {
                font-size: 20px;
            }

            #welcome-popup p {
                font-size: 16px;
            }

            #welcome-popup button {
                padding: 14px 35px;
                font-size: 16px;
            }
        }
                /* Responsive styling */
                @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            #map {
                flex: none;
                height: 50vh;
            }
            .map-overlay {
                position: relative;
                transform: none !important;
            }
        }

        #intro-section {
            margin-top: 20px;
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        #intro-section h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-family: 'Montserrat', sans-serif;
            color: #2c3e50;
        }
        #intro-section p {
            margin: 0 0 15px 0;
            font-size: 14px;
            line-height: 1.6;
            color: #34495e;
        }
        #intro-section ul {
            list-style: inside square;
            margin: 0 0 15px 0;
            padding: 0;
        }   
        #intro-section li {
            margin-bottom: 8px;
            font-size: 14px;
            color: #34495e;
        }

        .facility-popup .mapboxgl-popup-content {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-family: 'Montserrat', sans-serif;
            font-size: 13px;
            line-height: 1.4;
        }

        .facility-popup .mapboxgl-popup-tip {
            border-top-color: rgba(255, 255, 255, 0.95);
        }

        .facility-title.active {
            background: #fff3e0;
            border-left: 3px solid #ff9800;
            transform: translateX(5px);
        }

        .mapboxgl-ctrl-geocoder {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            font-family: 'Montserrat', sans-serif !important;
        }

        .mapboxgl-ctrl-geocoder--input {
            font-family: 'Roboto', sans-serif !important;
        }

        .mapboxgl-ctrl-geocoder--suggestion {
            font-family: 'Roboto', sans-serif !important;
        }

        .fullscreen-container {
            margin-left: 10px;
        }

        .mapboxgl-ctrl-fullscreen {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .mapboxgl-ctrl-fullscreen:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        #populationChartContainer {
            height: 300px;
            margin-bottom: 20px;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #populationChart {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<header>
    <div class="header-left">
        <h1>SoCalREN's ERAP GIS Hub</h1>
    </div>
    <div class="header-controls">
        <div class="geocoder-container" id="geocoder"></div>
        <div class="style-selector">
            <label for="style-selector">Map Style</label>
            <select id="style-selector">
                <option value="mapbox://styles/wengle1/cm4m4sedc001v01sqdtx0cioz">Custom Style</option>
                <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
                <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
                <option value="mapbox://styles/mapbox/light-v10">Light</option>
                <option value="mapbox://styles/mapbox/dark-v10">Dark</option>
                <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
            </select>
        </div>
        <div class="fullscreen-container" id="fullscreen-control"></div>
    </div>
</header>
<div id="container">
    <div id="map"></div>
    <div class="map-overlay" id="dashboard-panel">
        <fieldset>
            <input id="agency-filter" type="text" placeholder="Search for an agency">
            <ul id="agency-suggestions" style="display:none;"></ul>
        </fieldset>
        <fieldset class="filters" id="agency-filters">
            <legend>Agency Filters</legend>
            <label><input type="checkbox" id="dac-filter"> Show only Disadvantaged Communities (DAC)</label>
            <label><input type="checkbox" id="ces90-filter"> Show only agencies with CalEnviroScreen Score > 90</label>
            <label for="cog-select">Filter by Council of Governments:</label>
            <select id="cog-select">
                <option value="">All</option>
                <option value="Gateway Cities">Gateway Cities Council of Governments (GCCOG)</option>
                <option value="San Gabriel Valley COG">San Gabriel Valley Council of Governments (SGVCOG)</option>
                <option value="South Bay Cities">South Bay Cities Council of Governments (SBCOG)</option>
            </select>
            <label for="population-threshold">Population greater than:</label>
            <input type="range" id="population-threshold" min="0" max="200000" value="0">
            <span id="population-threshold-value">0</span>
        </fieldset>
        <fieldset class="filters" id="facility-filters" style="display:none;">
            <legend>Facility Filters</legend>
            <label><input type="checkbox" id="pv-filter"> Show only facilities with PV capabilities</label>
            <label><input type="checkbox" id="ev-filter"> Show only facilities with existing EV chargers</label>
            <label><input type="checkbox" id="cooling-filter"> Show only Cooling Centers / Emergency Ops</label>
        </fieldset>
        <div id="listing" class="listing"></div>
        <div id="intro-section">
            <h4>Welcome to SoCalREN's ERAP Dashboard</h4>
            <p>
                This dashboard provides insights into public agencies' energy resilience planning efforts across Southern California that have received support from the SoCalREN Public Agency Programs.
            </p>
            <p>
                The data displayed here includes key metrics collected throughout an agency's involvement in the ERAP program. The dashboard can help you understand community needs, identify facilities, etc.
            </p>
            <h4>Getting Started</h4>
            <ul>
                <li>Use the "Filter by agency name" box to quickly locate a participating agency.</li>
                <li>Adjust the range filter to focus on agencies with larger populations.</li>
                <li>Click an agency name to view its details and a list of associated facilities that were assessed by SoCalREN.</li>
            </ul>
            <h4>What is ERAP?</h4>
            <p>
                SoCalREN's Energy Resilience Action Plan (ERAP) program aims to address the growing impacts of climate change. Developed in collaboration with regional partners, the ERAP program enhances community resilience.
            </p>
        </div>
        <div class="dashboard" id="dashboard">
            <button id="back-button">Back</button>
            <h3 id="data-overview-title">Data Overview</h3>
            <div id="agency-data" style="display:none; margin-top:20px;">
                <h4>Agency-Level Data</h4>
                <div class="metric">
                    <span class="metric-label">DAC Status:</span>
                    <span class="metric-value" id="agency-dac">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">CalEnviroscreen:</span>
                    <span class="metric-value" id="agency-cal">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Population:</span>
                    <span class="metric-value" id="agency-pop">N/A</span>
                </div>
            </div>
            <div class="chart-section">
                <div id="populationChartContainer">
                    <canvas id="populationChart"></canvas>
                </div>
                <div id="facilitiesPieContainer">
                    <canvas id="facilitiesPieChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="welcome-popup">
    <div class="welcome-content">
        <h1>
            <span class="title-line">Welcome to SoCalREN's</span>
            <span class="title-line">Energy Resilience Action Plan (ERAP) GIS Hub</span>
        </h1>
        <h2>Explore Energy Resilience Planning Across Southern California</h2>
        <p>
            This interactive dashboard provides comprehensive insights into public agencies' energy resilience planning efforts. 
            Discover facilities with existing and planned energy resilience features, understand community needs, and explore 
            opportunities for enhanced resilience across the region.
        </p>
        <p>
            Navigate through participating agencies, filter by various criteria, and access detailed information about facilities 
            and their energy resilience capabilities.
        </p>
        <button onclick="closeWelcome()">Enter Dashboard</button>
    </div>
</div>

<script>
// Initialize global variables for data
let agencyData = [];
let facilityData = [];
let facilityGeoJSON = {
    type: 'FeatureCollection',
    features: []
};
// Mapbox token
mapboxgl.accessToken = 'pk.eyJ1Ijoid2VuZ2xlMSIsImEiOiJjbGh0bTJ0OTUzN2dzM21tbTB0NzFmM2QyIn0.-ItjIktoJtcQUsk6l9TbbQ';

// Function to load CSV data using Papa Parse
async function loadCSVData(url) {
    return new Promise((resolve, reject) => {
        Papa.parse(url, {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                resolve(results.data);
            },
            error: function(error) {
                reject(error);
            }
        });
    });
}

// Function to load all data
async function loadAllData() {
    try {
        // Show loading spinner or message if you have one
        if (document.getElementById('loading-spinner')) {
            document.getElementById('loading-spinner').style.display = 'block';
        }

        // Load agencies and facilities data
        const [agencies, facilities] = await Promise.all([
            loadCSVData('./data/agencies_df.csv'),
            loadCSVData('./data/facilities_df.csv')
        ]);

        // Load GeoJSON data
        const boundariesResponse = await fetch('./data/la_boundaries.geojson');
        const boundariesData = await boundariesResponse.json();

        // Store the data globally
        agencyData = agencies;
        facilityData = facilities;

        // Convert facilities data to GeoJSON
        facilityGeoJSON = {
            type: 'FeatureCollection',
            features: facilities.map(facility => ({
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [facility.Longitude, facility.Latitude]
                },
                properties: {
                    Agency: facility.Agency,
                    FacilityName: facility.FacilityName,
                    Address: facility.Address,
                    ActualUse: facility.ActualUse,
                    ExistingEV: facility.ExistingEV,
                    ExistingPV: facility.ExistingPV
                }
            }))
        };

        // Initialize the map with the loaded data
        initializeMap(boundariesData);

        // Hide loading spinner
        if (document.getElementById('loading-spinner')) {
            document.getElementById('loading-spinner').style.display = 'none';
        }

    } catch (error) {
        console.error('Error loading data:', error);
        // Show error message to user
        if (document.getElementById('loading-spinner')) {
            document.getElementById('loading-spinner').innerHTML = 'Error loading data. Please refresh the page.';
        }
    }
}

// Initialize map function
function initializeMap(boundariesData) {
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/wengle1/cm4m4sedc001v01sqdtx0cioz', // Updated style URL
        center: [-118.2437, 34.0522],
        zoom: 10
    });
        // Add geocoder control
        const geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        marker: false,
        placeholder: 'Search for a location',
        bbox: [-118.9517, 33.7037, -117.6462, 34.8233], // Bounds for LA County
        proximity: {
            longitude: -118.2437,
            latitude: 34.0522
        }
    });
    document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

    map.on('load', () => {
        // Add boundaries source
        map.addSource('la-boundaries', {
            'type': 'geojson',
            'data': boundariesData
        });

        // Add facilities source
        map.addSource('facilities', {
            'type': 'geojson',
            'data': facilityGeoJSON,
            'cluster': true,
            'clusterMaxZoom': 14,
            'clusterRadius': 50
        });

        // Add boundary layers
        map.addLayer({
            'id': 'la-fills',
            'type': 'fill',
            'source': 'la-boundaries',
            'layout': {},
            'paint': {
                'fill-color': '#3498db',
                'fill-opacity': 0.4
            }
        });

        map.addLayer({
            'id': 'la-borders',
            'type': 'line',
            'source': 'la-boundaries',
            'layout': {},
            'paint': {
                'line-color': '#2980b9',
                'line-width': 1
            }
        });

        // Add hover layer for boundaries
        map.addLayer({
            'id': 'la-fills-hover',
            'type': 'fill',
            'source': 'la-boundaries',
            'paint': {
                'fill-color': '#2ecc71',
                'fill-opacity': 0.7
            },
            'filter': ['==', ['get', 'CITY_COMM_NAME'], '']
        });

        // Add clusters layer
        map.addLayer({
            'id': 'clusters',
            'type': 'circle',
            'source': 'facilities',
            'filter': ['has', 'point_count'],
            'paint': {
                'circle-radius': [
                    'step',
                    ['get', 'point_count'],
                    25,
                    10,
                    30,
                    25,
                    35
                ],
                'circle-color': [
                    'step',
                    ['get', 'point_count'],
                    '#ff9800',
                    10,
                    '#f57c00',
                    25,
                    '#e65100'
                ],
                'circle-opacity': 0.9,
                'circle-stroke-width': 2,
                'circle-stroke-color': '#ffffff',
                'circle-stroke-opacity': 0.8
            }
        });

        // Add cluster count layer
        map.addLayer({
            'id': 'cluster-count',
            'type': 'symbol',
            'source': 'facilities',
            'filter': ['has', 'point_count'],
            'layout': {
                'text-field': '{point_count_abbreviated}',
                'text-font': ['DIN Offc Pro Bold', 'Arial Unicode MS Bold'],
                'text-size': 16
            },
            'paint': {
                'text-color': '#ffffff'
            }
        });
                // Add unclustered point layer
                map.addLayer({
            'id': 'unclustered-point',
            'type': 'circle',
            'source': 'facilities',
            'filter': ['!', ['has', 'point_count']],
            'paint': {
                'circle-color': '#ff9800',
                'circle-radius': 8,
                'circle-stroke-width': 2,
                'circle-stroke-color': '#ffffff',
                'circle-opacity': 0.9,
                'circle-stroke-opacity': 0.8
            }
        });

        // Add labels layer
        map.addLayer({
            'id': 'boundary-labels',
            'type': 'symbol',
            'source': 'la-boundaries',
            'layout': {
                'text-field': ['get', 'CITY_COMM_NAME'],
                'text-variable-anchor': ['center'],
                'text-radial-offset': 0,
                'text-justify': 'center',
                'text-size': 14,
                'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                'text-padding': 3
            },
            'paint': {
                'text-color': '#2c3e50',
                'text-halo-color': '#ffffff',
                'text-halo-width': 2
            }
        });

        // Mouse enter event for boundaries
        map.on('mouseenter', 'la-fills', (e) => {
            map.getCanvas().style.cursor = 'pointer';
            if (e.features.length > 0) {
                map.setFilter('la-fills-hover', ['==', ['get', 'CITY_COMM_NAME'], e.features[0].properties.CITY_COMM_NAME]);
            }
        });

        // Mouse leave event for boundaries
        map.on('mouseleave', 'la-fills', () => {
            map.getCanvas().style.cursor = '';
            map.setFilter('la-fills-hover', ['==', ['get', 'CITY_COMM_NAME'], '']);
        });

        // Mouse enter event for facilities
        map.on('mouseenter', 'unclustered-point', (e) => {
            map.getCanvas().style.cursor = 'pointer';
            const coordinates = e.features[0].geometry.coordinates.slice();
            const properties = e.features[0].properties;

            // Create popup content
            const popupContent = `
                <strong>${properties.FacilityName}</strong><br>
                ${properties.Agency}<br>
                ${properties.Address}<br>
                ${properties.ActualUse || 'Use not specified'}<br>
                ${properties.ExistingEV ? 'âœ“ EV Charging Available' : 'âœ— No EV Charging'}<br>
                ${properties.ExistingPV ? 'âœ“ Solar PV Installed' : 'âœ— No Solar PV'}
            `;

            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            new mapboxgl.Popup()
                .setLngLat(coordinates)
                .setHTML(popupContent)
                .addTo(map);
        });

        // Mouse leave event for facilities
        map.on('mouseleave', 'unclustered-point', () => {
            map.getCanvas().style.cursor = '';
        });
                // Click event for boundaries
                map.on('click', 'la-fills', (e) => {
            if (e.features.length > 0) {
                const cityName = e.features[0].properties.CITY_COMM_NAME;
                const matchingAgency = agencyData.find(a => 
                    a.Agency.replace('City of ', '').trim().toUpperCase() === cityName.trim()
                );
                
                if (matchingAgency) {
                    onAgencyClick(matchingAgency);
                    document.getElementById('dashboard-panel').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            }
        });

        // Click event for clusters
        map.on('click', 'clusters', (e) => {
            const features = map.queryRenderedFeatures(e.point, {
                layers: ['clusters']
            });
            const clusterId = features[0].properties.cluster_id;
            map.getSource('facilities').getClusterExpansionZoom(
                clusterId,
                (err, zoom) => {
                    if (err) return;
                    map.easeTo({
                        center: features[0].geometry.coordinates,
                        zoom: zoom
                    });
                }
            );
        });

        // Click event for unclustered points
        map.on('click', 'unclustered-point', (e) => {
            const props = e.features[0].properties;
            const matchingAgency = agencyData.find(a => a.Agency === props.Agency);
            if (matchingAgency) {
                onAgencyClick(matchingAgency);
                const matchingFacility = facilityData.find(f => 
                    f.Agency === props.Agency && 
                    f.FacilityName === props.FacilityName
                );
                
                if (matchingFacility) {
                    updateFacilityDashboard(matchingFacility);
                    const facilityLinks = document.querySelectorAll('.facility-title');
                    facilityLinks.forEach(link => {
                        if (link.textContent === props.FacilityName) {
                            link.classList.add('active');
                            link.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            link.classList.remove('active');
                        }
                    });
                }
                
                document.getElementById('dashboard-panel').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        });

        // Initialize filters
        initializeFilters();
        
        // Show intro section
        document.getElementById('intro-section').style.display = 'block';
    });

    // Add navigation controls
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');
    
    return map;
}
// Initialize filters function
function initializeFilters() {
    // Agency filter input
    const agencyFilter = document.getElementById('agency-filter');
    const suggestionsList = document.getElementById('agency-suggestions');

    agencyFilter.addEventListener('input', (e) => {
        const searchText = e.target.value.toLowerCase();
        if (searchText.length < 2) {
            suggestionsList.style.display = 'none';
            return;
        }

        const suggestions = agencyData
            .filter(agency => agency.Agency.toLowerCase().includes(searchText))
            .map(agency => agency.Agency);

        if (suggestions.length > 0) {
            suggestionsList.innerHTML = suggestions
                .map(agency => `<li>${agency}</li>`)
                .join('');
            suggestionsList.style.display = 'block';
        } else {
            suggestionsList.style.display = 'none';
        }
    });

    suggestionsList.addEventListener('click', (e) => {
        if (e.target.tagName === 'LI') {
            agencyFilter.value = e.target.textContent;
            suggestionsList.style.display = 'none';
            const selectedAgency = agencyData.find(a => a.Agency === e.target.textContent);
            if (selectedAgency) {
                onAgencyClick(selectedAgency);
            }
        }
    });

    // DAC filter
    document.getElementById('dac-filter').addEventListener('change', updateFilters);
    
    // CES90 filter
    document.getElementById('ces90-filter').addEventListener('change', updateFilters);
    
    // COG filter
    document.getElementById('cog-select').addEventListener('change', updateFilters);
    
    // Population threshold
    const populationThreshold = document.getElementById('population-threshold');
    const populationValue = document.getElementById('population-threshold-value');
    
    populationThreshold.addEventListener('input', (e) => {
        const value = e.target.value;
        populationValue.textContent = value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        updateFilters();
    });

    // Facility filters
    document.getElementById('pv-filter').addEventListener('change', updateFilters);
    document.getElementById('ev-filter').addEventListener('change', updateFilters);
    document.getElementById('cooling-filter').addEventListener('change', updateFilters);
}

// Update filters function
function updateFilters() {
    const dacFilter = document.getElementById('dac-filter').checked;
    const ces90Filter = document.getElementById('ces90-filter').checked;
    const cogSelect = document.getElementById('cog-select').value;
    const populationThreshold = parseInt(document.getElementById('population-threshold').value);
    const pvFilter = document.getElementById('pv-filter').checked;
    const evFilter = document.getElementById('ev-filter').checked;
    const coolingFilter = document.getElementById('cooling-filter').checked;

    // Filter agencies
    let filteredAgencies = agencyData.filter(agency => {
        if (dacFilter && !agency.DAC) return false;
        if (ces90Filter && agency.CalEnviroScreen <= 90) return false;
        if (cogSelect && agency.COG !== cogSelect) return false;
        if (agency.Population < populationThreshold) return false;
        return true;
    });

    // Update the listing
    updateListing(filteredAgencies);

    // Filter facilities if facility filters are active
    if (pvFilter || evFilter || coolingFilter) {
        const filteredFacilities = facilityData.filter(facility => {
            if (pvFilter && !facility.ExistingPV) return false;
            if (evFilter && !facility.ExistingEV) return false;
            if (coolingFilter && !facility.CoolingCenter) return false;
            return true;
        });

        // Update facility GeoJSON
        const newGeoJSON = {
            type: 'FeatureCollection',
            features: filteredFacilities.map(f => ({
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [f.Longitude, f.Latitude]
                },
                properties: {
                    Agency: f.Agency,
                    FacilityName: f.FacilityName,
                    Address: f.Address,
                    ActualUse: f.ActualUse,
                    ExistingEV: f.ExistingEV,
                    ExistingPV: f.ExistingPV
                }
            }))
        };

        // Update the map source
        if (map.getSource('facilities')) {
            map.getSource('facilities').setData(newGeoJSON);
        }
    }
}
// Update listing function
function updateListing(agencies) {
    const listing = document.getElementById('listing');
    if (!listing) return;

    // Clear existing content
    listing.innerHTML = '';

    // Group agencies by COG
    const cogGroups = {};
    agencies.forEach(agency => {
        const cog = agency.COG || 'Other';
        if (!cogGroups[cog]) {
            cogGroups[cog] = [];
        }
        cogGroups[cog].push(agency);
    });

    // Create sections for each COG
    Object.keys(cogGroups).sort().forEach(cog => {
        if (cog === 'null' || cog === 'undefined') return;

        const cogSection = document.createElement('div');
        cogSection.className = 'cog-section';

        const cogHeader = document.createElement('div');
        cogHeader.className = 'cog-header';
        cogHeader.textContent = cog;
        cogHeader.addEventListener('click', () => {
            cogHeader.classList.toggle('expanded');
            agencyList.style.display = agencyList.style.display === 'none' ? 'block' : 'none';
        });

        const agencyList = document.createElement('div');
        agencyList.className = 'agency-list';
        agencyList.style.display = 'none';

        // Sort agencies alphabetically
        cogGroups[cog].sort((a, b) => a.Agency.localeCompare(b.Agency));

        cogGroups[cog].forEach(agency => {
            const agencyDiv = document.createElement('div');
            agencyDiv.className = 'agency-title';
            agencyDiv.textContent = agency.Agency;
            agencyDiv.addEventListener('click', () => onAgencyClick(agency));
            agencyList.appendChild(agencyDiv);
        });

        cogSection.appendChild(cogHeader);
        cogSection.appendChild(agencyList);
        listing.appendChild(cogSection);
    });

    // Update the data overview
    updateDataOverview(agencies);
}

// Agency click handler
function onAgencyClick(agency) {
    // Update agency data display
    document.getElementById('agency-dac').textContent = agency.DAC ? 'Yes' : 'No';
    document.getElementById('agency-cal').textContent = agency.CalEnviroScreen || 'N/A';
    document.getElementById('agency-pop').textContent = agency.Population ? 
        agency.Population.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : 
        'N/A';

    // Show agency data section
    document.getElementById('agency-data').style.display = 'block';
    
    // Update title
    document.getElementById('data-overview-title').textContent = agency.Agency;

    // Show back button
    const backButton = document.getElementById('back-button');
    backButton.style.display = 'block';
    backButton.onclick = () => {
        document.getElementById('agency-data').style.display = 'none';
        document.getElementById('data-overview-title').textContent = 'Data Overview';
        backButton.style.display = 'none';
        document.getElementById('facility-filters').style.display = 'none';
        updateListing(agencyData);
    };

    // Filter and display facilities for this agency
    const agencyFacilities = facilityData.filter(f => f.Agency === agency.Agency);
    displayFacilities(agencyFacilities);

    // Show facility filters
    document.getElementById('facility-filters').style.display = 'block';

    // Update charts
    updateCharts(agency, agencyFacilities);

    // Fly to agency on map
    const agencyBoundary = map.querySourceFeatures('la-boundaries', {
        filter: ['==', ['get', 'CITY_COMM_NAME'], 
                agency.Agency.replace('City of ', '').trim().toUpperCase()]
    })[0];

    if (agencyBoundary) {
        const bounds = new mapboxgl.LngLatBounds();
        agencyBoundary.geometry.coordinates[0].forEach(coord => {
            bounds.extend(coord);
        });
        map.fitBounds(bounds, {
            padding: 50,
            duration: 1000
        });
    }
}
// Display facilities function
function displayFacilities(facilities) {
    const listing = document.getElementById('listing');
    listing.innerHTML = '';

    if (facilities.length === 0) {
        listing.innerHTML = '<div id="no-facilities-msg">No facilities found matching the current filters.</div>';
        return;
    }

    const facilitiesTitle = document.createElement('h4');
    facilitiesTitle.textContent = 'Facilities';
    listing.appendChild(facilitiesTitle);

    const facilitiesContainer = document.createElement('div');
    facilitiesContainer.className = 'facilities-container';

    facilities.forEach(facility => {
        const facilityLink = document.createElement('a');
        facilityLink.className = 'facility-title';
        facilityLink.textContent = facility.FacilityName;
        facilityLink.href = '#';
        facilityLink.onclick = (e) => {
            e.preventDefault();
            updateFacilityDashboard(facility);
            
            // Remove active class from all facilities
            document.querySelectorAll('.facility-title').forEach(link => {
                link.classList.remove('active');
            });
            
            // Add active class to clicked facility
            facilityLink.classList.add('active');

            // Fly to facility location
            map.flyTo({
                center: [facility.Longitude, facility.Latitude],
                zoom: 16,
                duration: 1000
            });
        };
        facilitiesContainer.appendChild(facilityLink);
    });

    listing.appendChild(facilitiesContainer);
}

// Update facility dashboard
function updateFacilityDashboard(facility) {
    const dashboardTitle = document.getElementById('data-overview-title');
    dashboardTitle.textContent = facility.FacilityName;

    // Update metrics
    const metrics = {
        'Actual Use': facility.ActualUse || 'Not specified',
        'Address': facility.Address,
        'EV Charging': facility.ExistingEV ? 'Available' : 'Not available',
        'Solar PV': facility.ExistingPV ? 'Installed' : 'Not installed',
        'Cooling Center': facility.CoolingCenter ? 'Yes' : 'No'
    };

    const agencyData = document.getElementById('agency-data');
    agencyData.innerHTML = '<h4>Facility Details</h4>';

    Object.entries(metrics).forEach(([label, value]) => {
        const metricDiv = document.createElement('div');
        metricDiv.className = 'metric';
        metricDiv.innerHTML = `
            <span class="metric-label">${label}:</span>
            <span class="metric-value">${value}</span>
        `;
        agencyData.appendChild(metricDiv);
    });
}

// Update charts function
function updateCharts(agency, facilities) {
    // Update or create population chart
    const popCtx = document.getElementById('populationChart');
    if (window.populationChart) {
        window.populationChart.destroy();
    }

    const popData = {
        labels: ['Population'],
        datasets: [{
            label: agency.Agency,
            data: [agency.Population],
            backgroundColor: 'rgba(52, 152, 219, 0.5)',
            borderColor: 'rgba(52, 152, 219, 1)',
            borderWidth: 1
        }]
    };

    window.populationChart = new Chart(popCtx, {
        type: 'bar',
        data: popData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Population'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Agency Population'
                }
            }
        }
    });
        // Update or create facilities pie chart
        const pieCtx = document.getElementById('facilitiesPieChart');
    if (window.facilitiesPieChart) {
        window.facilitiesPieChart.destroy();
    }

    // Count facilities by type
    const facilityTypes = facilities.reduce((acc, facility) => {
        const type = facility.ActualUse || 'Unspecified';
        acc[type] = (acc[type] || 0) + 1;
        return acc;
    }, {});

    const pieData = {
        labels: Object.keys(facilityTypes),
        datasets: [{
            data: Object.values(facilityTypes),
            backgroundColor: [
                'rgba(52, 152, 219, 0.8)',
                'rgba(46, 204, 113, 0.8)',
                'rgba(155, 89, 182, 0.8)',
                'rgba(241, 196, 15, 0.8)',
                'rgba(231, 76, 60, 0.8)'
            ]
        }]
    };

    window.facilitiesPieChart = new Chart(pieCtx, {
        type: 'pie',
        data: pieData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Facilities by Type'
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Welcome popup functions
function showWelcome() {
    const popup = document.getElementById('welcome-popup');
    popup.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeWelcome() {
    const popup = document.getElementById('welcome-popup');
    popup.classList.add('fade-out');
    document.body.style.overflow = '';
    setTimeout(() => {
        popup.style.display = 'none';
        popup.classList.remove('fade-out');
    }, 400);
}

// Update data overview function
function updateDataOverview(agencies) {
    const totalAgencies = agencies.length;
    const totalPopulation = agencies.reduce((sum, agency) => sum + (agency.Population || 0), 0);
    const dacAgencies = agencies.filter(a => a.DAC).length;
    
    const metrics = {
        'Total Agencies': totalAgencies,
        'Total Population Served': totalPopulation.toLocaleString(),
        'DAC Agencies': dacAgencies,
        'Non-DAC Agencies': totalAgencies - dacAgencies
    };

    const agencyData = document.getElementById('agency-data');
    agencyData.innerHTML = '<h4>Overview Metrics</h4>';

    Object.entries(metrics).forEach(([label, value]) => {
        const metricDiv = document.createElement('div');
        metricDiv.className = 'metric';
        metricDiv.innerHTML = `
            <span class="metric-label">${label}:</span>
            <span class="metric-value">${value}</span>
        `;
        agencyData.appendChild(metricDiv);
    });
}

// Initialize the application
document.addEventListener('DOMContentLoaded', () => {
    // Show welcome popup
    showWelcome();
    
    // Load data and initialize map
    loadAllData();
});

// Style selector event listener
document.getElementById('style-selector').addEventListener('change', (event) => {
    const selectedStyle = event.target.value;
    const currentZoom = map.getZoom();
    const currentCenter = map.getCenter();
    
    map.setStyle(selectedStyle);
    
    map.on('style.load', () => {
        // Re-add sources and layers after style change
        const dashboardCities = agencyData.map(a => {
            return a.Agency.replace('City of ', '').trim().toUpperCase();
        });
                // Re-add boundaries source and layers
                map.addSource('la-boundaries', {
            'type': 'geojson',
            'data': './data/la_boundaries.geojson'
        });

        // Re-add facilities source
        map.addSource('facilities', {
            'type': 'geojson',
            'data': facilityGeoJSON,
            'cluster': true,
            'clusterMaxZoom': 14,
            'clusterRadius': 50
        });

        // Re-add all layers
        map.addLayer({
            'id': 'la-fills',
            'type': 'fill',
            'source': 'la-boundaries',
            'layout': {},
            'paint': {
                'fill-color': '#3498db',
                'fill-opacity': 0.4
            }
        });

        map.addLayer({
            'id': 'la-borders',
            'type': 'line',
            'source': 'la-boundaries',
            'layout': {},
            'paint': {
                'line-color': '#2980b9',
                'line-width': 1
            }
        });

        map.addLayer({
            'id': 'la-fills-hover',
            'type': 'fill',
            'source': 'la-boundaries',
            'paint': {
                'fill-color': '#2ecc71',
                'fill-opacity': 0.7
            },
            'filter': ['==', ['get', 'CITY_COMM_NAME'], '']
        });

        map.addLayer({
            'id': 'clusters',
            'type': 'circle',
            'source': 'facilities',
            'filter': ['has', 'point_count'],
            'paint': {
                'circle-radius': [
                    'step',
                    ['get', 'point_count'],
                    25,
                    10,
                    30,
                    25,
                    35
                ],
                'circle-color': [
                    'step',
                    ['get', 'point_count'],
                    '#ff9800',
                    10,
                    '#f57c00',
                    25,
                    '#e65100'
                ],
                'circle-opacity': 0.9,
                'circle-stroke-width': 2,
                'circle-stroke-color': '#ffffff',
                'circle-stroke-opacity': 0.8
            }
        });

        map.addLayer({
            'id': 'cluster-count',
            'type': 'symbol',
            'source': 'facilities',
            'filter': ['has', 'point_count'],
            'layout': {
                'text-field': '{point_count_abbreviated}',
                'text-font': ['DIN Offc Pro Bold', 'Arial Unicode MS Bold'],
                'text-size': 16
            },
            'paint': {
                'text-color': '#ffffff'
            }
        });

        map.addLayer({
            'id': 'unclustered-point',
            'type': 'circle',
            'source': 'facilities',
            'filter': ['!', ['has', 'point_count']],
            'paint': {
                'circle-color': '#ff9800',
                'circle-radius': 8,
                'circle-stroke-width': 2,
                'circle-stroke-color': '#ffffff',
                'circle-opacity': 0.9,
                'circle-stroke-opacity': 0.8
            }
        });

        // Apply filters to boundary layers
        map.setFilter('la-fills', ['in', ['get', 'CITY_COMM_NAME'], ['literal', dashboardCities]]);
        map.setFilter('la-borders', ['in', ['get', 'CITY_COMM_NAME'], ['literal', dashboardCities]]);

        // Restore the zoom and center position
        map.setZoom(currentZoom);
        map.setCenter(currentCenter);

        // Re-add event listeners
        addMapEventListeners();
    });
});

</script>
</body>
</html>
