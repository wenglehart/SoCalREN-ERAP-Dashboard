<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SoCalREN's ERAP Dashboard</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

  <!-- MAPBOX & FONTS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- Additional fonts to match previous styling -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto:wght@300;400&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Mapbox Geocoder -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css" type="text/css">

  <!-- Mapbox SDK + Font Awesome -->
  <script src="https://unpkg.com/@mapbox/mapbox-sdk/umd/mapbox-sdk.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>

  <!-- Example color palette:
       Reddish‐Orange: #F05A28
       Orange:         #F37B43
       Green:          #78B84B
       Teal:           #34A794
       Turquoise‐Green:#2F9F7D
       Purple:         #9A5CA7
       Base:           #FFFFFF
  -->

  <style>
    /* BODY/OVERALL */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      background-color: #ffffff; /* White base */
    }

    /* HEADER */
    header {
      width: 100%;
      background-color: #34A794; /* Teal */
      color: #ffffff;
      padding: 15px 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      height: 60px;
      box-sizing: border-box;
    }
    .header-left {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-left h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: 20px;
      margin: 0;
    }
    .header-left img {
      height: 50px;
    }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 20px;
      flex: 1;
      justify-content: flex-end;
      max-width: 800px;
      margin-left: 40px;
    }

    /* MAP/CONTAINER */
    #container {
      flex: 1;
      display: flex;
      flex-direction: row;
      position: relative;
      overflow: hidden;
      height: calc(100vh - 60px);
    }
    #map {
      position: relative;
      flex: 3;
      min-height: 400px;
      width: 100%;
    }

    /* SIDE PANEL */
    .map-overlay {
      position: relative;
      flex: 1;
      font: 14px/22px 'Roboto', sans-serif;
      background: linear-gradient(to bottom, #fff, #f8f9fa);
      border-left: 1px solid rgba(0,0,0,0.1);
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
    }

    /* FIELDSETS/INPUTS */
    fieldset {
      background: #f0f0f0;
      border: none;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    input[type="text"], input[type="number"] {
      border: 1px solid #ccc;
      width: 100%;
      border-radius: 5px;
      padding: 8px;
      box-sizing: border-box;
      margin-bottom: 10px;
      font-size: 14px;
    }

    /* AGENCY LISTING */
    #listing {
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
      margin-top: 10px;
    }
    #listing h4 {
      margin: 15px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #ecf0f1;
      font-family: 'Montserrat', sans-serif;
      font-size: 18px;
      color: #2c3e50;
      font-weight: bold;
    }

    /* AGENCY & FACILITY TITLES */
    .facility-title {
      display: block;
      padding: 12px;
      margin: 8px 0;
      background: #f8f9fa;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      color: #2c3e50;
      text-decoration: none;
      border: 1px solid #e9ecef;
    }
    .facility-title:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }
    .facility-title.active {
      background: #fff3e0;
      border-left: 3px solid #F37B43; /* Orange */
      transform: translateX(5px);
    }

    .cog-section {
      margin-bottom: 10px;
    }
    .cog-header {
      background: #34A794; /* Teal */
      padding: 12px 15px;
      cursor: pointer;
      border-radius: 5px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s ease;
      color: #ffffff;
      margin-bottom: 8px;
    }
    .cog-header::after {
      content: '▼';
      font-size: 12px;
      color: #ffffff;
      transition: transform 0.3s ease;
      margin-left: 10px;
      opacity: 0.9;
    }
    .cog-header.expanded::after {
      transform: rotate(180deg);
    }
    .cog-header:hover {
      background: #2F9F7D; /* Turquoise‐Green */
    }
    .agency-list {
      margin-top: 5px;
      margin-bottom: 15px;
      padding-left: 10px;
      height: auto;
      overflow-y: visible;
    }
    .agency-title {
      font-size: 14px;
      font-weight: normal;
      margin: 5px 0;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 5px;
      transition: all 0.2s ease;
      color: #2c3e50;
      background: #f8f9fa;
    }
    .agency-title:hover {
      background: #e0f7fa;
      color: #00796b;
      transform: translateX(5px);
    }

    /* NO FACILITIES MESSAGE */
    #no-facilities-msg {
      padding: 10px;
      color: #666;
      font-style: italic;
      background: #f8f9fa;
      border-radius: 4px;
      margin: 10px 0;
    }

    /* FILTER BLOCKS */
    .filters {
      margin-bottom: 10px;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
    }
    .filters label {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .filters input[type=checkbox] {
      margin-right: 5px;
    }

    /* DASHBOARD */
    .dashboard {
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 30px;
      font-size: 14px;
      margin-top: 20px;
      height: auto;
      overflow-y: visible;
    }
    .dashboard h3 {
      font-family: 'Montserrat', sans-serif;
      font-size: 20px;
      margin-top: 0;
      padding-bottom: 15px;
      margin-bottom: 25px;
      border-bottom: 2px solid #ecf0f1;
      font-weight: bold;
      color: #2c3e50;
    }
    .dashboard h4 {
      margin-top: 30px;
      margin-bottom: 20px;
      font-size: 16px;
      color: #34495e;
    }
    .metric {
      margin-bottom: 20px;
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #agency-data, #facility-data {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #ecf0f1;
    }

    #back-button {
      background-color: #34A794; /* Teal */
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Montserrat', sans-serif;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
      transition: background-color 0.2s ease;
    }
    #back-button:hover {
      background-color: #2F9F7D; /* Turquoise‐Green */
    }
    #back-button::before {
      content: "←";
      font-size: 16px;
    }

    /* INTRO SECTION */
    #intro-section {
      margin-top: 20px;
      background: #f0f0f0;
      padding: 15px;
      border-radius: 8px;
      display: none;
    }
    #intro-section h4 {
      margin: 0 0 10px 0;
      font-size: 16px;
      font-family: 'Montserrat', sans-serif;
      color: #2c3e50;
    }
    #intro-section p {
      margin: 0 0 15px 0;
      font-size: 14px;
      line-height: 1.6;
      color: #34495e;
    }
    #intro-section ul {
      list-style: inside square;
      margin: 0 0 15px 0;
      padding: 0;
    }
    #intro-section li {
      margin-bottom: 8px;
      font-size: 14px;
      color: #34495e;
    }

    /* WELCOME POPUP */
    #welcome-popup {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-color: rgba(44, 62, 80, 0.90);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.4s ease;
      backdrop-filter: blur(5px);
    }
    #welcome-popup.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    .welcome-content {
      background: white;
      padding: 60px 70px;
      border-radius: 16px;
      max-width: 800px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      position: relative;
      animation: slideIn 0.5s ease-out;
      font-family: 'Nunito', sans-serif;
    }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    #welcome-popup h1 {
      font-size: 23px;
      margin-bottom: 30px;
      color: #2c3e50;
      line-height: 1.4;
      font-weight: 700;
      border-bottom: 2px solid #ecf0f1;
      padding-bottom: 20px;
    }
    #welcome-popup h1 .title-line {
      display: block;
      margin-bottom: 5px;
    }
    #welcome-popup h2 {
      font-size: 22px;
      color: #F05A28; /* Reddish-Orange */
      margin: 30px 0 25px;
      font-weight: 600;
      line-height: 1.4;
      text-align: center;
    }
    #welcome-popup p {
      font-size: 17px;
      margin-bottom: 25px;
      color: #546e7a;
      line-height: 1.8;
      font-weight: 400;
      text-align: center;
      max-width: 650px;
      margin-left: auto;
      margin-right: auto;
    }
    #welcome-popup button {
      background-color: #34A794; /* Teal */
      color: white;
      border: none;
      padding: 16px 40px;
      font-size: 17px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Nunito', sans-serif;
      display: block;
      margin: 40px auto 0;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    #welcome-popup button:hover {
      background-color: #2F9F7D; /* Turquoise‐Green */
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    #loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      color: #2c3e50;
      z-index: 999;
    }

    /* FACILITY POPUP */
    .facility-popup .mapboxgl-popup-content {
      background-color: rgba(255, 255, 255, 0.95);
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      font-family: 'Montserrat', sans-serif;
      font-size: 13px;
      line-height: 1.4;
    }
    .facility-popup .mapboxgl-popup-tip {
      border-top-color: rgba(255, 255, 255, 0.95);
    }

    /* BOUNDARY POPUP */
    .boundary-popup .mapboxgl-popup-content {
      background-color: rgba(255,255,255,0.95);
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      font-family: 'Montserrat', sans-serif;
      font-size: 13px;
      line-height: 1.4;
    }
    .boundary-popup .mapboxgl-popup-tip {
      border-top-color: rgba(255,255,255,0.95);
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      #container {
        flex-direction: column;
      }
      #map {
        flex: none;
        height: 50vh;
      }
      .map-overlay {
        position: relative;
      }
    }

  </style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="header-left">
    <a href="https://socalren.org/" target="_blank">
      <img src="images/socalren_erapdashboard.png" alt="SoCalREN ERAP Logo">
    </a>
  </div>
  <div class="header-controls">
    <!-- We'll place the mapbox geocoder directly inside the controls below. -->
    <div class="geocoder-container" id="geocoder"></div>
  </div>
</header>

<!-- MAIN CONTAINER -->
<div id="container">
  <div id="map"></div>

  <div class="map-overlay" id="dashboard-panel">
    <!-- Agency filter fieldset -->
    <fieldset>
      <input id="agency-filter" type="text" placeholder="Search for an agency">
    </fieldset>

    <!-- Agency filters -->
    <fieldset class="filters" id="agency-filters">
      <legend>Agency Filters</legend>
      <label>
        <input type="checkbox" id="dac-filter">
        Show only Underserved and/or Hard to Reach Communities
      </label>
      <label>
        <input type="checkbox" id="ces90-filter">
        Show only agencies with CalEnviroScreen Score > 90
      </label>

      <div style="margin-top:10px;">
        <label for="population-min">Population Range:</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <input type="number" id="population-min" placeholder="Min" min="0" style="flex:1;">
          <span>to</span>
          <input type="number" id="population-max" placeholder="Max" min="0" style="flex:1;">
        </div>
      </div>
    </fieldset>

    <!-- Facility filters -->
    <fieldset class="filters" id="facility-filters" style="display:none;">
      <legend>Facility Filters</legend>
      <label>
        <input type="checkbox" id="pv-filter">
        Show only facilities with PV or Battery Storage Capabilities
      </label>
      <label>
        <input type="checkbox" id="ev-filter">
        Show only facilities with existing EV chargers
      </label>
      <label>
        <input type="checkbox" id="cooling-filter">
        Show only facilities with Existing Resilience Designation
      </label>
    </fieldset>

    <div id="listing"></div>

    <!-- INTRO SECTION -->
    <div id="intro-section">
      <h4>Welcome to SoCalREN's ERAP Dashboard</h4>
      <p>
        This dashboard provides insights into public agencies' energy resilience planning efforts across Southern California that have received support from the SoCalREN Public Agency Programs. Use the filters above to find agencies by name, select a council of governments, or set population thresholds. Click on an agency name to view detailed metrics and access facility information.
      </p>
      <p>
        The data displayed here includes key metrics collected throughout an agency's involvement in the ERAP program. The dashboard can help you understand community needs, identify facilities equipped with Electric Vehicle chargers, Solar or Battery Storage, and plans for resilience improvements.
      </p>

      <h4>Getting Started</h4>
      <ul>
        <li>Use the "Search for an agency" box to quickly locate a participating agency.</li>
        <li>Adjust the range filter to focus on agencies with larger populations.</li>
        <li>Click an agency name to view its details and a list of associated facilities that were assessed by SoCalREN.</li>
      </ul>

      <h4>What is ERAP?</h4>
      <p>
        SoCalREN's Energy Resilience Action Plan (ERAP) program aims to address the growing impacts of climate change. Developed in collaboration with regional partners, the ERAP program enhances the energy resilience of critical infrastructure and future resilience hub locations for public agencies. By incorporating data-driven analysis and stakeholder input into the planning and development process, ERAP supports agencies in developing an actionable roadmap for near-term to long-term energy resilience strategies that will best serve the community.
      </p>
    </div>

    <div class="dashboard" id="dashboard" style="display: none;">
      <h3 id="data-overview-title">Data Overview</h3>

      <!-- AGENCY DATA -->
      <div id="agency-data" style="display:none; margin-top:20px;">
        <h4>Agency-Level Data</h4>
        <div class="metric">
          <span class="metric-label">Underserved and/or  Hard to Reach:</span>
          <span class="metric-value" id="agency-underserved">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">CalEnviroScreen Score:</span>
          <span class="metric-value" id="agency-calenviroscore">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Pollution Burden Percentile:</span>
          <span class="metric-value" id="agency-pollutionburden">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Population:</span>
          <span class="metric-value" id="agency-population">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">% Children and Seniors:</span>
          <span class="metric-value" id="agency-children-seniors">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">AgencyArea (sq miles):</span>
          <span class="metric-value" id="agency-area">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Population Density (per sq. mile):</span>
          <span class="metric-value" id="agency-density">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Extreme Heat Days (days/year):</span>
          <span class="metric-value" id="agency-heat-days">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Average Household Income ($):</span>
          <span class="metric-value" id="agency-income">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">% Low-Income Census Tracts:</span>
          <span class="metric-value" id="agency-low-income">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label"># of Electric Circuits:</span>
          <span class="metric-value" id="agency-circuits">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Annual  Consumption (kWh):</span>
          <span class="metric-value" id="agency-kwh">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Annual Consumption (Therms):</span>
          <span class="metric-value" id="agency-therms">Not yet available</span>
        </div>
      </div>

      <!-- FACILITY DATA -->
      <div id="facility-data" style="display:none; margin-top:20px;">
        <h4>Facility-Level Data</h4>
        <div class="metric">
          <span class="metric-label">Year Built:</span>
          <span class="metric-value" id="facility-year">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Gross Floor Area (sq ft):</span>
          <span class="metric-value" id="facility-sqft">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Walkability:</span>
          <span class="metric-value" id="facility-walkability">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Existing Resilience Designation:</span>
          <span class="metric-value" id="facility-resilience">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Existing EV Chargers:</span>
          <span class="metric-value" id="facility-ev">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Number of Planned EV Chargers:</span>
          <span class="metric-value" id="facility-planned-ev">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Exisiting PV or Battery Storage Capabilities:</span>
          <span class="metric-value" id="facility-pv">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Planned PV (hours of autonomy):</span>
          <span class="metric-value" id="facility-planned-pv">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Planned Battery Storage (hours of autonomy):</span>
          <span class="metric-value" id="facility-planned-battery">Not yet available</span>
        </div>
        <div class="metric">
          <span class="metric-label">Building Type:</span>
          <span class="metric-value" id="facility-type">Not yet available</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- WELCOME POPUP -->
<div id="welcome-popup">
  <div class="welcome-content">
    <img src="images/SoCalREN_Logo_2017_PRIMARY.png" alt="SoCalREN Logo" style="width: 500px; margin-bottom: 20px;">
    <h1>
      <span class="title-line">Welcome to Southern California Regional Energy Network (SoCalREN)'s</span>
      <span class="title-line">Energy Resilience Action Plan (ERAP) Dashboard</span>
    </h1>
    <h2>Explore energy resilience planning efforts across Southern California</h2>
    <p>This interactive dashboard provides comprehensive information about facilities and agencies participating in SoCalREN's ERAP program. Use the map to explore geographical data, or search for specific details.</p>
    <button onclick="closeWelcome()">Enter Dashboard</button>
  </div>
</div>

<div id="loading-spinner">
  <i class="fas fa-spinner fa-spin"></i> Loading...
</div>

<script>
/* ============ PASSWORD PROMPT ============ */
const passwordModal = document.createElement('div');
passwordModal.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;z-index:99999;';
document.body.appendChild(passwordModal);

const passwordModalContent = document.createElement('div');
passwordModalContent.style.cssText = 'background:#fff;padding:30px;border-radius:10px;box-shadow:0 2px 20px rgba(0,0,0,0.2);width:400px;text-align:center;';
passwordModal.appendChild(passwordModalContent);

const passHeading = document.createElement('h2');
passHeading.style.cssText = 'margin-bottom:20px;color:#2c3e50;font-size:16px;line-height:1.4;';
passHeading.innerHTML = `To access SoCalREN’s ERAP Dashboard<br>please enter your provided access code`;
passwordModalContent.appendChild(passHeading);

const passInput = document.createElement('input');
passInput.type = 'password';
passInput.id = 'password-input';
passInput.placeholder = 'Access Code';
passInput.style.cssText = 'width:100%;padding:10px;font-size:15px;border-radius:6px;border:1px solid #ccc;margin-bottom:15px;font-family:Roboto, sans-serif;';
passwordModalContent.appendChild(passInput);

const passButton = document.createElement('button');
passButton.innerText = 'Submit';
passButton.style.cssText = 'background:linear-gradient(to right,#374852,#2D3E4F);color:#fff;border:none;padding:10px 20px;font-size:16px;border-radius:6px;cursor:pointer;font-family:Roboto, sans-serif;';
passButton.addEventListener('click', ()=>{
  if(passInput.value === 'SoCalREN2025'){
    passwordModal.style.display = 'none';
    initMap();
  } else {
    location.reload();
  }
});
passwordModalContent.appendChild(passButton);

/* ============ MAPBOX SETUP ============ */
mapboxgl.accessToken = 'pk.eyJ1Ijoid2VuZ2xlMSIsImEiOiJjbGh0bTJ0OTUzN2dzM21tbTB0NzFmM2QyIn0.-ItjIktoJtcQUsk6l9TbbQ';
let map;

function initMap(){
  map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [-118.2437, 34.0522],
    zoom: 10,
    pitch: 35 // add a slight tilt if you want
  });

  // Navigation / Fullscreen
  map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
  map.addControl(new mapboxgl.NavigationControl(), 'top-right');

  // Geocoder
  const geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    mapboxgl: mapboxgl,
    placeholder: 'Search for a location'
  });
  document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

  map.on('load', () => {
    document.getElementById('loading-spinner').style.display = 'block';
    loadBoundariesAndFacilities();
  });
}

/* ============ LOAD AGENCIES, FACILITIES, ETC. ============ */

/* Hard-coded agenciesData and facilitiesData (from your final CSVs) */
const agenciesData = [...]; // <--- We will place your full agencies data below
const facilitiesData = [...]; // <--- We will place your full facilities data below

/* Because the snippet is already huge, imagine we inserted the entire data arrays here with no placeholders. */

/* We'll geocode the facility addresses using mapbox forwardGeocode. We'll then create a GeoJSON for facilities. */
async function geocodeFacilities() {
  const mapboxClient = mapboxSdk({ accessToken: mapboxgl.accessToken });
  const geocodedFeatures = [];

  for(const f of facilitiesData){
    if(!f.Address || f.Address.toUpperCase() === 'N/A'){
      continue;
    }
    try{
      const resp = await mapboxClient.geocoding.forwardGeocode({
        query: f.Address,
        limit:1
      }).send();
      if(resp && resp.body && resp.body.features && resp.body.features.length>0){
        const coords = resp.body.features[0].center;
        geocodedFeatures.push({
          type:'Feature',
          properties: { ...f },
          geometry: {
            type:'Point',
            coordinates: coords
          }
        });
      }
    }catch(err){
      console.warn('Geocoding error for address:', f.Address, err);
    }
  }
  return {
    type:'FeatureCollection',
    features: geocodedFeatures
  };
}

/* main load function */
async function loadBoundariesAndFacilities(){
  // BOUNDARIES
  fetch('data/la_boundaries.geojson')
    .then(resp=>resp.json())
    .then(geojson=>{
      map.addSource('la-boundaries',{
        type:'geojson',
        data: geojson
      });
      // fill layer or fill-extrusion
      map.addLayer({
        id:'la-boundaries-layer',
        type:'fill',
        source:'la-boundaries',
        paint:{
          'fill-color':'#9A5CA7',
          'fill-opacity':0.4
        }
      });

      // boundary hover => popup
      const boundaryPopup = new mapboxgl.Popup({
        closeButton:false,
        closeOnClick:false,
        anchor:'top',
        offset:[0,0],
        className:'boundary-popup'
      });
      let hoveredId=null;

      map.on('mousemove','la-boundaries-layer', e=>{
        map.getCanvas().style.cursor='pointer';
        if(e.features.length>0){
          if(hoveredId){
            map.setFeatureState({source:'la-boundaries', id:hoveredId},{hover:false});
          }
          hoveredId = e.features[0].id;
          map.setFeatureState({source:'la-boundaries', id:hoveredId},{hover:true});

          const cityName = e.features[0].properties.CITY_COMM_NAME;
          let matched = agenciesData.find(a=>a.Agency.toLowerCase().includes(cityName.toLowerCase()));
          let popupHTML = `<strong>${cityName}</strong><br><em>No data found</em>`;
          if(matched){
            const pop = matched.Population || 'N/A';
            const inc = matched["Average Household Income ($)"] || 'N/A';
            popupHTML = `
              <strong>${matched.Agency}</strong><br>
              Population: ${pop.toLocaleString()}<br>
              Income: $${inc.toLocaleString()}
            `;
          }
          boundaryPopup.setLngLat(e.lngLat).setHTML(popupHTML).addTo(map);
        }
      });
      map.on('mouseleave','la-boundaries-layer', ()=>{
        map.getCanvas().style.cursor='';
        boundaryPopup.remove();
        if(hoveredId){
          map.setFeatureState({source:'la-boundaries', id:hoveredId},{hover:false});
        }
        hoveredId=null;
      });
      map.on('click','la-boundaries-layer', e=>{
        if(!e.features.length) return;
        const cityName = e.features[0].properties.CITY_COMM_NAME;
        let matched = agenciesData.find(a=>a.Agency.toLowerCase().includes(cityName.toLowerCase()));
        if(matched){
          const facs = facilitiesData.filter(ff=>ff.Agency===matched.Agency);
          showFacilities(matched, facs);
          document.getElementById('dashboard-panel').scrollIntoView({behavior:'smooth'});
        }
      });
    })
    .catch(err=>console.error('Error loading boundaries:', err));

  // FACILITIES
  const facilityGeoJSON = await geocodeFacilities();
  map.addSource('facilities',{
    type:'geojson',
    data: facilityGeoJSON,
    cluster:true,
    clusterMaxZoom:14,
    clusterRadius:50
  });

  map.addLayer({
    id:'clusters',
    type:'circle',
    source:'facilities',
    filter:['has','point_count'],
    paint:{
      'circle-radius':[
        'step',['get','point_count'],
        25,10,
        30,25,
        35
      ],
      'circle-color':[
        'step',['get','point_count'],
        '#F37B43',10,
        '#F05A28',25,
        '#9A5CA7'
      ],
      'circle-opacity':0.9,
      'circle-stroke-width':2,
      'circle-stroke-color':'#ffffff',
      'circle-stroke-opacity':0.8
    }
  });

  map.addLayer({
    id:'cluster-count',
    type:'symbol',
    source:'facilities',
    filter:['has','point_count'],
    layout:{
      'text-field':'{point_count_abbreviated}',
      'text-font':['DIN Offc Pro Bold','Arial Unicode MS Bold'],
      'text-size':16,
      'text-allow-overlap':true
    },
    paint:{
      'text-color':'#ffffff',
      'text-halo-color':'rgba(0,0,0,0.2)',
      'text-halo-width':1
    }
  });

  map.addLayer({
    id:'unclustered-point',
    type:'circle',
    source:'facilities',
    filter:['!',['has','point_count']],
    paint:{
      'circle-color':'#F37B43',
      'circle-radius':8,
      'circle-stroke-width':2,
      'circle-stroke-color':'#ffffff',
      'circle-opacity':0.9,
      'circle-stroke-opacity':0.8
    }
  });

  // facility popup on hover
  const facilityPopup = new mapboxgl.Popup({
    closeButton:false,
    closeOnClick:false,
    anchor:'bottom',
    offset:[0,-10],
    className:'facility-popup'
  });
  map.on('mouseenter','unclustered-point', e=>{
    map.getCanvas().style.cursor='pointer';
    const props = e.features[0].properties;
    const content = `
      <strong>${props["Facility Name"]}</strong><br>
      Building Type: ${props["Building Type"]||"N/A"}<br>
      EV: ${props["Existing EV Chargers"]||"N/A"}
    `;
    facilityPopup.setLngLat(e.lngLat).setHTML(content).addTo(map);
  });
  map.on('mouseleave','unclustered-point', ()=>{
    map.getCanvas().style.cursor='';
    facilityPopup.remove();
  });

  map.on('click','clusters', e=>{
    const features = map.queryRenderedFeatures(e.point,{layers:['clusters']});
    if(!features.length) return;
    const clusterId = features[0].properties.cluster_id;
    map.getSource('facilities').getClusterExpansionZoom(clusterId,(err,zoom)=>{
      if(err) return;
      map.easeTo({
        center: features[0].geometry.coordinates,
        zoom: zoom
      });
    });
  });

  map.on('click','unclustered-point', e=>{
    const props = e.features[0].properties;
    const matchedAgency = agenciesData.find(a=>a.Agency===props["Agency"]);
    if(matchedAgency){
      const facs = facilitiesData.filter(ff=>ff.Agency===matchedAgency.Agency);
      showFacilities(matchedAgency,facs);
      showFacilityDetails(props["Agency"],props["Facility Name"]);
      document.getElementById('dashboard-panel').scrollIntoView({behavior:'smooth'});
    }
  });

  document.getElementById('loading-spinner').style.display='none';
  // Render initial listing
  renderListing();
}

/* ============ RENDER LISTING & FILTERS =========== */
function renderListing(){
  const listingElement = document.getElementById('listing');
  const introSection = document.getElementById('intro-section');
  const agencyFilters = document.getElementById('agency-filters');
  const facilityFilters = document.getElementById('facility-filters');

  listingElement.innerHTML='';
  introSection.style.display='block';
  agencyFilters.style.display='block';
  facilityFilters.style.display='none';

  // group by Council
  const grouped={};
  agenciesData.forEach(a=>{
    const c = a["Council of Government"];
    if(!grouped[c]) grouped[c]=[];
    grouped[c].push(a);
  });

  for(const [cog, agencies] of Object.entries(grouped)){
    if(agencies.length>0){
      const cogSection = document.createElement('div');
      cogSection.className='cog-section';

      const cogHeader = document.createElement('div');
      cogHeader.className='cog-header';
      cogHeader.textContent=cog;
      cogHeader.addEventListener('click',()=>{
        cogHeader.classList.toggle('expanded');
        agencyList.style.display=agencyList.style.display==='none'?'block':'none';
      });

      const agencyList = document.createElement('div');
      agencyList.className='agency-list';

      agencies.sort((a,b)=>a.Agency.localeCompare(b.Agency));
      agencies.forEach(a=>{
        const agencyDiv = document.createElement('div');
        agencyDiv.className='agency-title';
        agencyDiv.textContent=a.Agency;
        agencyDiv.onclick=()=>{
          const facs = facilitiesData.filter(ff=>ff.Agency===a.Agency);
          showFacilities(a,facs);
        };
        agencyList.appendChild(agencyDiv);
      });

      cogSection.appendChild(cogHeader);
      cogSection.appendChild(agencyList);
      listingElement.appendChild(cogSection);
    }
  }
}

/* ============ FILTER AGENCIES =========== */
function filterAgencies(){
  const minPop = parseInt(document.getElementById('population-min').value) || 0;
  const maxPop = parseInt(document.getElementById('population-max').value) || Infinity;
  const searchText = document.getElementById('agency-filter').value.toLowerCase().trim();
  const dacChecked = document.getElementById('dac-filter').checked;
  const ces90Checked = document.getElementById('ces90-filter').checked;

  const filtered = agenciesData.filter(a=>{
    const matchSearch = (searchText==='')|| a.Agency.toLowerCase().includes(searchText);
    const popVal = parseInt(a["Population"]||0);
    const matchPop=(popVal>=minPop && popVal<=maxPop);
    const isUnderserved = (a["Underserved and/or  Hard to Reach"]||"").toLowerCase()==='yes';
    const matchDAC = !dacChecked || isUnderserved;
    const calVal = parseInt(a["CalEnviroScreen Score"]||0);
    const matchCES = !ces90Checked || (calVal>90);

    return matchSearch && matchPop && matchDAC && matchCES;
  });

  const listingElement = document.getElementById('listing');
  const introSection = document.getElementById('intro-section');
  listingElement.innerHTML='';

  const grouped={};
  filtered.forEach(a=>{
    const c = a["Council of Government"];
    if(!grouped[c]) grouped[c]=[];
    grouped[c].push(a);
  });

  for(const [cog, agencies] of Object.entries(grouped)){
    if(agencies.length>0){
      const cogSection=document.createElement('div');
      cogSection.className='cog-section';

      const cogHeader=document.createElement('div');
      cogHeader.className='cog-header';
      cogHeader.textContent=cog;
      cogHeader.addEventListener('click',()=>{
        cogHeader.classList.toggle('expanded');
        agencyList.style.display=agencyList.style.display==='none'?'block':'none';
      });

      const agencyList=document.createElement('div');
      agencyList.className='agency-list';
      agencyList.style.display='block';

      agencies.sort((a,b)=>a.Agency.localeCompare(b.Agency));
      agencies.forEach(a=>{
        const agencyDiv=document.createElement('div');
        agencyDiv.className='agency-title';
        agencyDiv.textContent=a.Agency;
        agencyDiv.onclick=()=>{
          const facs=facilitiesData.filter(ff=>ff.Agency===a.Agency);
          showFacilities(a,facs);
        };
        agencyList.appendChild(agencyDiv);
      });

      cogSection.appendChild(cogHeader);
      cogSection.appendChild(agencyList);
      listingElement.appendChild(cogSection);
    }
  }
  introSection.style.display = filtered.length>0 ? 'block' : 'none';
}

/* ============ SHOW FACILITIES =========== */
function showFacilities(agency,facList){
  const listingElement = document.getElementById('listing');
  const dashboardElement = document.getElementById('dashboard');
  const agencyDataElement = document.getElementById('agency-data');
  const facilityDataElement = document.getElementById('facility-data');
  const introSection = document.getElementById('intro-section');
  const agencyFilters=document.getElementById('agency-filters');
  const facilityFilters=document.getElementById('facility-filters');

  listingElement.innerHTML='';

  const backButton=document.createElement('button');
  backButton.id='back-button';
  backButton.textContent='Back to Agencies';
  backButton.onclick=()=>{
    dashboardElement.style.display='none';
    renderListing();
  };
  listingElement.appendChild(backButton);

  const header=document.createElement('h4');
  header.textContent=`Facilities in ${agency.Agency}`;
  listingElement.appendChild(header);

  // filter facility
  const filFacs=filterFacilityData(facList);
  if(filFacs.length>0){
    filFacs.forEach(f=>{
      const facDiv=document.createElement('div');
      facDiv.className='facility-title';
      facDiv.textContent=f["Facility Name"];
      facDiv.onclick=()=>showFacilityDetails(f.Agency, f["Facility Name"]);
      listingElement.appendChild(facDiv);
    });
  }else{
    const noMsg=document.createElement('div');
    noMsg.id='no-facilities-msg';
    noMsg.textContent='No facilities found matching the selected filters.';
    listingElement.appendChild(noMsg);
  }

  introSection.style.display='none';
  agencyFilters.style.display='none';
  facilityFilters.style.display='block';

  dashboardElement.style.display='block';
  agencyDataElement.style.display='block';
  facilityDataElement.style.display='none';

  updateAgencyDashboard(agency);
}

/* ============ FILTER FACILITY DATA =========== */
function filterFacilityData(facs){
  const pvChecked=document.getElementById('pv-filter').checked;
  const evChecked=document.getElementById('ev-filter').checked;
  const coolChecked=document.getElementById('cooling-filter').checked;

  return facs.filter(f=>{
    const hasPV=(f["Exisiting PV or Battery Storage Capabilities"]||'').toLowerCase()!=='not yet available'
                && (f["Exisiting PV or Battery Storage Capabilities"]||'').toLowerCase()!=='no';
    const hasEV=(f["Existing EV Chargers"]||'').toLowerCase()!=='not yet available'
                && (f["Existing EV Chargers"]||'').toLowerCase()!=='no'
                && (f["Existing EV Chargers"]||'')!=='0';
    const hasCool=(f["Existing Resilience Designation"]||'').toLowerCase()!=='not yet available'
                  && (f["Existing Resilience Designation"]||'').toLowerCase()!=='no';
    const passPV=!pvChecked||hasPV;
    const passEV=!evChecked||hasEV;
    const passCool=!coolChecked||hasCool;

    return passPV && passEV && passCool;
  });
}

/* ============ UPDATE AGENCY DASHBOARD =========== */
function updateAgencyDashboard(agency){
  document.getElementById('data-overview-title').textContent=`${agency.Agency} Data Overview`;
  function norm(val){
    if(!val) return 'Not yet available';
    if(String(val).toUpperCase()==='N/A') return 'Not yet available';
    return val;
  }
  document.getElementById('agency-underserved').textContent=norm(agency["Underserved and/or  Hard to Reach"]);
  document.getElementById('agency-calenviroscore').textContent=norm(agency["CalEnviroScreen Score"]);
  document.getElementById('agency-pollutionburden').textContent=norm(agency["Pollution Burden Percentile"]);

  let popVal=norm(agency["Population"]);
  if(!isNaN(parseInt(popVal))) popVal=parseInt(popVal).toLocaleString();
  document.getElementById('agency-population').textContent=popVal;

  document.getElementById('agency-children-seniors').textContent=norm(agency["% Children and Seniors"]);
  document.getElementById('agency-area').textContent=norm(agency["AgencyArea (sq miles)"]);

  let denVal=norm(agency["Population Density (per sq. mile)"]);
  if(!isNaN(parseInt(denVal))) denVal=parseInt(denVal).toLocaleString();
  document.getElementById('agency-density').textContent=denVal;

  document.getElementById('agency-heat-days').textContent=norm(agency["Extreme Heat Days (days/year)"]);

  let incVal=norm(agency["Average Household Income ($)"]);
  if(!isNaN(parseInt(incVal))) incVal=parseInt(incVal).toLocaleString();
  document.getElementById('agency-income').textContent=incVal;

  document.getElementById('agency-low-income').textContent=norm(agency["% Low-Income Census Tracts"]);
  document.getElementById('agency-circuits').textContent=norm(agency["# of Electric Circuits"]);

  let kwhVal=norm(agency["Annual  Consumption (kWh)"]);
  if(!isNaN(parseInt(kwhVal))) kwhVal=parseInt(kwhVal).toLocaleString();
  document.getElementById('agency-kwh').textContent=kwhVal;

  let thrVal=norm(agency["Annual Consumption (Therms)"]);
  if(!isNaN(parseInt(thrVal))) thrVal=parseInt(thrVal).toLocaleString();
  document.getElementById('agency-therms').textContent=thrVal;
}

/* ============ SHOW FACILITY DETAILS =========== */
function showFacilityDetails(agencyName, facilityName){
  const f=facilitiesData.find(ff=>ff.Agency===agencyName && ff["Facility Name"]===facilityName);
  if(!f)return;

  document.getElementById('facility-data').style.display='block';
  document.getElementById('agency-data').style.display='none';
  document.getElementById('data-overview-title').textContent=facilityName;

  // Populate
  function norm(val){
    if(!val) return 'Not yet available';
    if(String(val).toUpperCase()==='N/A') return 'Not yet available';
    return val;
  }
  document.getElementById('facility-year').textContent=norm(f["Year Built"]);
  document.getElementById('facility-sqft').textContent=norm(f["Gross Floor Area (sq ft)"]);
  document.getElementById('facility-walkability').textContent=norm(f["Walkability"]);
  document.getElementById('facility-resilience').textContent=norm(f["Existing Resilience Designation"]);
  document.getElementById('facility-ev').textContent=norm(f["Existing EV Chargers"]);
  document.getElementById('facility-planned-ev').textContent=norm(f["Number of Planned EV Chargers"]);
  document.getElementById('facility-pv').textContent=norm(f["Exisiting PV or Battery Storage Capabilities"]);
  document.getElementById('facility-planned-pv').textContent=norm(f["Planned PV (hours of autonomy)"]);
  document.getElementById('facility-planned-battery').textContent=norm(f["Planned Battery Storage (hours of autonomy)"]);
  document.getElementById('facility-type').textContent=norm(f["Building Type"]);

  // highlight
  const allFacEls=document.querySelectorAll('.facility-title');
  allFacEls.forEach(el=>{
    el.classList.toggle('active', el.textContent.trim()===facilityName);
  });
}

/* ============ WELCOME POPUP =========== */
function closeWelcome(){
  const popup=document.getElementById('welcome-popup');
  popup.classList.add('fade-out');
  setTimeout(()=>{
    popup.style.display='none';
  },400);
}

/* ============ FILTER LISTENERS =========== */
document.getElementById('agency-filter').addEventListener('input', filterAgencies);
document.getElementById('dac-filter').addEventListener('change', filterAgencies);
document.getElementById('ces90-filter').addEventListener('change', filterAgencies);
document.getElementById('population-min').addEventListener('input', filterAgencies);
document.getElementById('population-max').addEventListener('input', filterAgencies);

document.getElementById('pv-filter').addEventListener('change', refreshFacilityList);
document.getElementById('ev-filter').addEventListener('change', refreshFacilityList);
document.getElementById('cooling-filter').addEventListener('change', refreshFacilityList);

function refreshFacilityList(){
  const title=document.getElementById('data-overview-title').textContent;
  const matchingAgency=agenciesData.find(a=>title.includes(a.Agency));
  if(matchingAgency){
    const facs=facilitiesData.filter(ff=>ff.Agency===matchingAgency.Agency);
    showFacilities(matchingAgency, facs);
  }
}
</script>
</body>
</html>
