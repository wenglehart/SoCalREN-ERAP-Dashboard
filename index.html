<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SoCalREN's ERAP Dashboard</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

  <!-- MAPBOX & FONTS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.js"></script>

  <!-- Aptos font-face -->
  <style>
  @font-face {
    font-family: 'Aptos';
    font-weight: 400;
    font-style: normal;
  }
  </style>

  <!-- Mapbox Geocoder -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css" type="text/css">

  <!-- FontAwesome for icons -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>

  <style>
    /* ============ BASE & LAYOUT ============ */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #ffffff;
      font-family: 'Aptos', sans-serif;
      overflow: hidden; /* Hide scrollbars */
    }
    body {
      color: #2D3E4F;
      font-size: 16px;
    }

    /* ============ PASSWORD MODAL ============ */
    #password-modal {
      position: fixed;
      z-index: 99999;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(0,0,0,0.4);
      backdrop-filter: blur(10px);
    }
    #password-modal-content {
      background: #ffffff;
      padding: 20px 25px;
      border-radius: 10px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.2);
      width: 320px;
      text-align: center;
    }
    #password-modal-content h2 {
      font-size: 15px;
      font-weight: 600;
      line-height: 1.4;
      margin-bottom: 15px;
      color: #2c3e50;
    }
    #password-input {
      width: 90%;
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      font-family: 'Aptos', sans-serif;
    }
    #password-submit {
      background: linear-gradient(to right, #374852, #2D3E4F);
      color: #ffffff;
      border: none;
      padding: 8px 20px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Aptos', sans-serif;
    }
    #password-submit:hover {
      background: linear-gradient(to right, #4a5c6b, #2D3E4F);
    }

    /* ============ HEADER ============ */
    header {
      width: 100%;
      background: linear-gradient(to right, #2D3E4F, #202f3e);
      color: #ffffff;
      height: 45px; 
      padding: 5px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .header-left img {
      height: 35px;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
      position: relative;
    }
    .header-right > .menu-link {
      color: #ffffff;
      text-decoration: none;
      font-size: 14px;
      padding: 4px 8px;
      transition: background-color 0.2s ease;
      cursor: pointer;
      position: relative;
    }
    .header-right > .menu-link:hover {
      background-color: rgba(255,255,255,0.1);
      border-radius: 4px;
    }

    /* ============ MAIN WRAPPER ============ */
    #container {
      display: flex;
      width: 100%;
      height: calc(100vh - 45px);
      flex-direction: row;
    }
    #map {
      flex: 0 0 70%;
      position: relative;
      min-height: 400px;
    }

    /* ============ PANEL (30%) ============ */
    .map-overlay {
      flex: 0 0 30%;
      display: flex;
      flex-direction: column;
      background-color: #ffffff;
      border-left: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      overflow-x: hidden;
      overflow-y: auto;
      font-size: 14px;
      box-sizing: border-box;
      padding: 15px; /* consistent side padding */
    }

    /* LOADING SPINNER */
    #loading-spinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      color: #2c3e50;
      z-index: 999;
      display: none;
    }

    /* MAPBOX GEOCODER */
    .mapboxgl-ctrl-geocoder {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 300px;
      z-index: 10;
      font-family: 'Aptos', sans-serif !important;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    }
    .mapboxgl-ctrl-geocoder--input {
      height: 36px !important;
      padding: 6px 35px !important;
    }

    /* ============ PANEL CONTENT SECTIONS ============ */
    #filters-section,
    #listing-section,
    #agency-dashboard {
      margin-top: 10px;
    }

    /* search bar margin etc. */
    #agency-filter {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 14px;
      margin-bottom: 10px;
    }

    fieldset.legend-block {
      border: none;
      margin-bottom: 12px;
    }
    fieldset.legend-block legend {
      font-size: 13px;
      margin-bottom: 6px;
      color: #2D3E4F;
      font-weight: 600;
    }
    .filters label {
      display: block;
      margin-bottom: 8px; /* more space => less compact */
      font-size: 12px;
      color: #2D3E4F;
      cursor: pointer;
    }

    #listing {
      margin-top: 8px; 
      border: none;
      padding: 0;
    }
    .cog-section {
      margin-bottom: 8px;
    }
    .cog-header {
      background: #2D3E4F;
      color: #ffffff;
      padding: 6px 10px;
      border-radius: 5px;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .cog-header::after {
      content: '▼';
      font-size: 12px;
      transition: transform 0.3s ease;
      margin-left: 10px;
      opacity: 0.9;
    }
    .cog-header.expanded::after {
      transform: rotate(180deg);
    }
    .cog-header:hover {
      background: #374852;
    }
    .agency-list {
      margin: 0;
      padding-left: 0;
    }

    /* Subtle fill color on hover => agencies less compact */
    .agency-title {
      background: #f9f9f9;
      margin-bottom: 6px; /* increased from 4px => less compact */
      padding: 8px 10px;  /* increased top/bottom => less compact */
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      color: #2D3E4F;
      cursor: pointer;
      transition: background-color 0.2s ease;
      font-size: 13px;
    }
    .agency-title:hover {
      background-color: #e6f4fa; /* subtle highlight color */
      border-color: #cbe8f3;
    }

    #no-facilities-msg {
      padding: 8px;
      color: #666;
      font-style: italic;
      background: #f9f9f9;
      border-radius: 4px;
      margin: 8px 0;
      border: 1px solid #e0e0e0;
    }

    .dashboard {
      background-color: #ffffff;
      border-radius: 6px;
      padding: 10px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.05);
    }

    /* Larger, green with navy underline => agency data overview */
    #dashboard h3 {
      margin: 0 0 8px 0;
      font-size: 20px;
      font-weight: 700;
      color: #F05A28; /* green */
      border-bottom: 2px solid #001f3f; /* navy underline */
      padding-bottom: 4px;
    }

    .metric {
      margin-bottom: 6px;
      background-color: #f9f9f9;
      padding: 6px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .metric .metric-label {
      color: #2D3E4F;
      font-weight: 500;
      margin-right: 6px;
      flex: 0 0 auto;
      font-size: 12px;
    }
    .metric .metric-value {
      flex: 1;
      text-align: right;
      font-size: 12px;
      color: #34495e;
    }

    /* INTRO SECTION => narrower with side margin, consistent with listing */
    #intro-section {
      background-color: #ffffff;
      color: #2D3E4F;
      border: none;
      margin-top: 8px;
      margin-bottom: 8px;
    }
    /* Purple outline text => text-shadow trick */
    #intro-section h4.welcome-title {
      margin-top: 0;
      font-size: 17px;
      margin-bottom: 8px;
      color: #F05A28;
      font-weight: 700;
    }
    #intro-section .intro-text-container {
      margin: 0 8px;
    }
    #intro-section p,
    #intro-section li {
      font-size: 13px;
      color: #2D3E4F;
      line-height: 1.5;
      margin-bottom: 6px;
    }
    #intro-section ul {
      list-style: disc;
      margin-left: 20px;
    }

    /* WELCOME POPUP */
    #welcome-popup {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-color: rgba(44,62,80,0.90);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.4s ease;
      backdrop-filter: blur(5px);
    }
    #welcome-popup.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    .welcome-content {
      background: white;
      padding: 40px 50px;
      border-radius: 8px;
      max-width: 800px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      position: relative;
      animation: slideIn 0.5s ease-out;
      font-family: 'Aptos', sans-serif;
    }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    #welcome-popup h1 {
      font-size: 18px;
      margin-bottom: 18px;
      color: #2c3e50;
      line-height: 1.4;
      font-weight: 700;
      border-bottom: 1px solid #ecf0f1;
      padding-bottom: 10px;
    }
    #welcome-popup h2 {
      font-size: 16px;
      color: #F05A28;
      margin: 20px 0 15px;
      font-weight: 600;
      line-height: 1.4;
      text-align: center;
    }
    #welcome-popup p {
      font-size: 13px;
      margin-bottom: 15px;
      color: #546e7a;
      line-height: 1.6;
      font-weight: 400;
      text-align: center;
      max-width: 650px;
      margin-left: auto;
      margin-right: auto;
    }
    #welcome-popup button {
      background-color: #2D3E4F;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      letter-spacing: 0.5px;
      margin-top: 20px;
    }
    #welcome-popup button:hover {
      background-color: #455463;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* BOUNDARY & FACILITY POPUPS */
    .boundary-popup .mapboxgl-popup-content,
    .facility-popup .mapboxgl-popup-content {
      background-color: rgba(255,255,255,0.95);
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      font-family: 'Aptos', sans-serif;
      font-size: 13px;
      line-height: 1.4;
    }
    .boundary-popup .mapboxgl-popup-tip,
    .facility-popup .mapboxgl-popup-tip {
      border-top-color: rgba(255,255,255,0.95);
    }
    .mapboxgl-popup {
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* LAYER TOGGLE LEGEND */
    #layer-toggle-legend {
      position: absolute;
      top: 130px; 
      left: 10px;
      z-index: 12; 
      background-color: #ffffff;
      border: 1px solid #ccc;
      padding: 8px 12px;
      border-radius: 6px;
      font-family: 'Aptos', sans-serif;
      font-size: 13px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #layer-toggle-legend label {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      cursor: pointer;
    }
    #layer-toggle-legend input[type="checkbox"] {
      margin-right: 6px;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      #container {
        flex-direction: column;
      }
      #map {
        flex: 0 0 auto;
        height: 50vh;
      }
      .map-overlay {
        flex: 1;
        max-height: 50vh;
      }
      #filters-section,
      #listing-section,
      #agency-dashboard {
        margin-top: 8px;
      }
    }
  </style>
</head>
<body>

<!-- ============ HEADER ============ -->
<header>
  <div class="header-left">
    <a href="https://wenglehart.github.io/SoCalREN-ERAP-Dashboard/" target="_blank">
      <img src="images/socalren_erapdashboard.png" alt="SoCalREN ERAP Logo">
    </a>
  </div>
  <div class="header-right">
    <!-- "About SoCalREN" link -->
    <a href="https://socalren.org/about" target="_blank" class="menu-link">
      About SoCalREN
    </a>
    <!-- "Contact Us" link -->
    <a href="https://socalren.org/about/contact" target="_blank" class="menu-link">
      Contact Us
    </a>
  </div>
</header>

<!-- ============ MAIN CONTAINER ============ -->
<div id="container">
  <!-- ============ PASSWORD MODAL ============ -->
  <div id="password-modal">
    <div id="password-modal-content">
      <h2>
        To access SoCalREN’s ERAP Dashboard<br>
        please enter your provided access code
      </h2>
      <input type="password" id="password-input" placeholder="Access Code">
      <button id="password-submit">Submit</button>
    </div>
  </div>

  <!-- ============ MAP (70%) ============ -->
  <div id="map"></div>

  <!-- LAYER TOGGLE LEGEND -->
  <div id="layer-toggle-legend">
    <label>
      <input type="checkbox" id="toggle-scr" checked>
      SoCalREN Territory
    </label>
    <label>
      <input type="checkbox" id="toggle-boundaries" checked>
      Agencies
    </label>
    <label>
      <input type="checkbox" id="toggle-facilities" checked>
      Facilities
    </label>
  </div>

  <!-- ============ PANEL (30%) ============ -->
  <div class="map-overlay" id="dashboard-panel">

    <!-- Panel search bar -->
    <input id="agency-filter" type="text" placeholder="Search dashboard">

    <!-- Filters Section -->
    <section id="filters-section">
      <!-- Agency Filters -->
      <fieldset class="filters legend-block" id="agency-filters">
        <legend>Agency Search Filters</legend>
        <label>
          <input type="checkbox" id="dac-filter">
          Show only Underserved and/or Hard to Reach
        </label>
        <label>
          <input type="checkbox" id="ces90-filter">
          Show only agencies with CalEnviroScreen Score > 90
        </label>
        <label style="margin-top:6px;">Population Range:</label>
        <div style="display:flex; gap:4px; align-items:center; margin-bottom:6px;">
          <input type="number" id="population-min" placeholder="Min" min="0" style="width:60px; font-size:12px;">
          <span>to</span>
          <input type="number" id="population-max" placeholder="Max" min="0" style="width:60px; font-size:12px;">
        </div>
      </fieldset>

      <!-- Facility Filters -->
      <fieldset class="filters legend-block" id="facility-filters" style="display:none;">
        <legend>Facility Search Filters</legend>
        <label>
          <input type="checkbox" id="pv-filter">
          Show only facilities with PV/Battery
        </label>
        <label>
          <input type="checkbox" id="ev-filter">
          Show only facilities with EV chargers
        </label>
        <label>
          <input type="checkbox" id="cooling-filter">
          Show only Cooling/Emergency
        </label>

        <label style="margin-top:6px;">Min # of Planned EV Chargers:</label>
        <input type="number" id="evChargersMin" min="0" style="width:60px; font-size:12px; margin-bottom:6px;">

        <label>Min PV Hours of Autonomy:</label>
        <input type="number" id="pvHoursMin" min="0" style="width:60px; font-size:12px; margin-bottom:6px;">

        <label>Min Battery Hours of Autonomy:</label>
        <input type="number" id="batteryHoursMin" min="0" style="width:60px; font-size:12px;">
      </fieldset>
    </section>

    <!-- Listing Section -->
    <section id="listing-section">
      <div id="listing"></div>
    </section>

    <!-- AGENCY DASHBOARD SECTION -->
    <section id="agency-dashboard">
      <div class="dashboard" id="dashboard" style="display: none;">
        <h3 id="data-overview-title">Data Overview</h3>

        <!-- AGENCY DATA -->
        <div id="agency-data" style="display:none;">
          <div class="metric">
            <span class="metric-label">Underserved/Hard to Reach:</span>
            <span class="metric-value" id="agency-underserved">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">CalEnviroScreen Score:</span>
            <span class="metric-value" id="agency-calenviroscore">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Pollution Burden Percentile:</span>
            <span class="metric-value" id="agency-pollutionburden">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Population:</span>
            <span class="metric-value" id="agency-population">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">% Children and Seniors:</span>
            <span class="metric-value" id="agency-children-seniors">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Agency Area (sq miles):</span>
            <span class="metric-value" id="agency-area">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Population Density:</span>
            <span class="metric-value" id="agency-density">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Extreme Heat Days:</span>
            <span class="metric-value" id="agency-heat-days">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Avg Household Income ($):</span>
            <span class="metric-value" id="agency-income">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">% Low-Income Census Tracts:</span>
            <span class="metric-value" id="agency-low-income">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label"># of Electric Circuits:</span>
            <span class="metric-value" id="agency-circuits">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Annual kWh Consumption:</span>
            <span class="metric-value" id="agency-kwh">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Annual Therms Consumption:</span>
            <span class="metric-value" id="agency-therms">N/A</span>
          </div>
        </div>

        <!-- FACILITY DATA -->
        <div id="facility-data" style="display:none;">
          <h4>Facility-Level Data</h4>
          <div class="metric">
            <span class="metric-label">Address:</span>
            <span class="metric-value" id="fac-address">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Existing Resilience Designation:</span>
            <span class="metric-value" id="fac-res-designation">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Existing EV Chargers:</span>
            <span class="metric-value" id="fac-ev-existing">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Planned EV Chargers:</span>
            <span class="metric-value" id="fac-ev-planned">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Exisiting PV or Battery:</span>
            <span class="metric-value" id="fac-pv-existing">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Planned PV (hrs):</span>
            <span class="metric-value" id="fac-pv-planned">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Planned Battery (hrs):</span>
            <span class="metric-value" id="fac-batt-planned">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Existing use:</span>
            <span class="metric-value" id="fac-use">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Walkability:</span>
            <span class="metric-value" id="fac-walk">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Gross Floor Area (sqft):</span>
            <span class="metric-value" id="fac-floor">N/A</span>
          </div>
          <div class="metric">
            <span class="metric-label">Year Built:</span>
            <span class="metric-value" id="fac-year">N/A</span>
          </div>
        </div>
      </div>
    </section>

    <!-- INTRO / WELCOME -->
    <section id="intro-section">
      <!-- Title with purple outline text-shadow -->
      <h4 class="welcome-title">Welcome to SoCalREN's ERAP Dashboard</h4>
      <div class="intro-text-container">
        <p>
          This dashboard provides insights into public agencies' energy resilience planning efforts across Southern California that have received support from the SoCalREN Public Agency Programs. Use the filters above to find agencies by name, select a council of governments, or set population thresholds. Click on an agency name to view detailed metrics and access facility information.
        </p>
        <p>
          The data displayed here includes key metrics collected throughout an agency's involvement in the ERAP program. The dashboard can help you understand community needs, identify facilities equipped with Electric Vehicle chargers, Solar or Battery Storage, and plans for resilience improvements.
        </p>
        <h4>Getting Started</h4>
        <ul>
          <li>Use the "Search dashboard" box to locate a participating agency or facility.</li>
          <li>Adjust the range filter to focus on agencies with larger or smaller populations.</li>
          <li>Click an agency name to view its details and a list of associated facilities.</li>
        </ul>
        <h4>What is ERAP?</h4>
        <p>
          SoCalREN's Energy Resilience Action Plan (ERAP) program aims to address the growing impacts of climate change. Developed in collaboration with regional partners, the ERAP program enhances the energy resilience of critical infrastructure and future resilience hub locations for public agencies. By incorporating data-driven analysis and stakeholder input, ERAP supports agencies in developing a roadmap of near-term and long-term energy resilience strategies.
        </p>
        <p><em>This dashboard is a living tool. We welcome your feedback!</em></p>
      </div>
    </section>
  </div>
</div>

<!-- WELCOME POPUP -->
<div id="welcome-popup">
  <div class="welcome-content">
    <img src="images/SoCalREN_Logo_2017_PRIMARY.png" alt="SoCalREN Logo" style="width: 300px; margin-bottom: 20px;">
    <h1>Welcome to Southern California Regional Energy Network (SoCalREN)'s <br>Energy Resilience Action Plan (ERAP) Dashboard</h1>
    <h2>Explore energy resilience planning efforts across Southern California</h2>
    <p>This interactive dashboard provides comprehensive information about facilities and agencies participating in SoCalREN's ERAP program. Use the map to explore geographical data, or search for specific details.</p>
    <button onclick="closeWelcome()">Enter Dashboard</button>
  </div>
</div>

<div id="loading-spinner">
  <i class="fas fa-spinner fa-spin"></i> Loading...
</div>

<script>
/* ============ MAPBOX TOKEN ============ */
mapboxgl.accessToken = 'pk.eyJ1Ijoid2VuZ2xlMSIsImEiOiJjbHBtaWx0N2IwMGljMmxwNjBsMnU4a2E4In0.Dzf3G-WBKzDfgnXsGHiMXw';

/* ============ PASSWORD PROMPT ============ */
const passwordModal = document.getElementById('password-modal');
const passwordInput = document.getElementById('password-input');
const passwordSubmit = document.getElementById('password-submit');

document.addEventListener('DOMContentLoaded', () => {
  passwordModal.style.display = 'flex';
});

passwordSubmit.addEventListener('click', () => {
  if (passwordInput.value === 'SoCalREN2025') {
    passwordModal.style.display = 'none';
    initMap();
  } else {
    location.reload();
  }
});

/* LAYER TOGGLES */
const toggleSCR = document.getElementById('toggle-scr');
const toggleBoundaries = document.getElementById('toggle-boundaries');
const toggleFacilities = document.getElementById('toggle-facilities');

/* MAP & DATA */
let map;

const COGMapping = {
  "GCCOG": "Gateway Cities Council of Governments",
  "SGVCOG": "San Gabriel Valley Council of Governments",
  "SBCOG": "South Bay Cities Council of Governments"
};

/* ============ AGENCIES DATA (FULL) ============ */
const agenciesData = [
  {
    "Agency": "Bell",
    "COG": "GCCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 96,
    "Population": 31864,
    "Agency Area (sq. miles)": 2.5,
    "Population Density (per sq mile)": 13400,
    "Number of Extreme Heat Days": 91,
    "% Children and Seniors": 36.1,
    "Average Household Income": 47800,
    "Pollution Burden": 88,
    "% Low-Income Census Tracts": 100,
    "Number of Electric Circuits": 14,
    "Annual kWh consumption": 2200000,
    "Annual Therms Consumption": 91100,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "Maywood",
    "COG": "GCCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 90,
    "Population": 27127,
    "Agency Area (sq. miles)": 1.18,
    "Population Density (per sq mile)": 23257,
    "Number of Extreme Heat Days": 77,
    "% Children and Seniors": 37.9,
    "Average Household Income": 50996,
    "Pollution Burden": 92,
    "% Low-Income Census Tracts": 100,
    "Number of Electric Circuits": 6,
    "Annual kWh consumption": 939153,
    "Annual Therms Consumption": 1232,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "Bell Gardens",
    "COG": "GCCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 92,
    "Population": 37467,
    "Agency Area (sq. miles)": 2.5,
    "Population Density (per sq mile)": 17100,
    "Number of Extreme Heat Days": 90,
    "% Children and Seniors": 30.4,
    "Average Household Income": 45300,
    "Pollution Burden": 97,
    "% Low-Income Census Tracts": 100,
    "Number of Electric Circuits": 9,
    "Annual kWh consumption": 1597960,
    "Annual Therms Consumption": 25833,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "Pomona",
    "COG": "SGVCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 97,
    "Population": 151100,
    "Agency Area (sq. miles)": 22.99,
    "Population Density (per sq mile)": 6572,
    "Number of Extreme Heat Days": 118,
    "% Children and Seniors": 36.5,
    "Average Household Income": 62400,
    "Pollution Burden": 81,
    "% Low-Income Census Tracts": 81.5,
    "Number of Electric Circuits": 56,
    "Annual kWh consumption": 20971427,
    "Annual Therms Consumption": 23848,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "Irwindale",
    "COG": "SGVCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 83,
    "Population": 1400,
    "Agency Area (sq. miles)": 9.5,
    "Population Density (per sq mile)": 142,
    "Number of Extreme Heat Days": 146,
    "% Children and Seniors": null,
    "Average Household Income": 86250,
    "Pollution Burden": 100,
    "% Low-Income Census Tracts": 100,
    "Number of Electric Circuits": 30,
    "Annual kWh consumption": 2452708,
    "Annual Therms Consumption": 11686,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "El Monte Union High School District",
    "COG": "SGVCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 80,
    "Population": 163151,
    "Agency Area (sq. miles)": 22.38,
    "Population Density (per sq mile)": 7290.035746,
    "Number of Extreme Heat Days": 129,
    "% Children and Seniors": null,
    "Average Household Income": 62000,
    "Pollution Burden": 92,
    "% Low-Income Census Tracts": null,
    "Number of Electric Circuits": 79,
    "Annual kWh consumption": null,
    "Annual Therms Consumption": null,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "Cudahy",
    "COG": "GCCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 95,
    "Population": 21700,
    "Agency Area (sq. miles)": 1.23,
    "Population Density (per sq mile)": 17642.27642,
    "Number of Extreme Heat Days": 85,
    "% Children and Seniors": 36,
    "Average Household Income": 49600,
    "Pollution Burden": 94,
    "% Low-Income Census Tracts": 100,
    "Number of Electric Circuits": 20,
    "Annual kWh consumption": null,
    "Annual Therms Consumption": null,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "South El Monte",
    "COG": "SGVCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 97,
    "Population": 19000,
    "Agency Area (sq. miles)": 2.84,
    "Population Density (per sq mile)": 6690.140845,
    "Number of Extreme Heat Days": 124,
    "% Children and Seniors": 37,
    "Average Household Income": 67700,
    "Pollution Burden": 98,
    "% Low-Income Census Tracts": 80,
    "Number of Electric Circuits": 12,
    "Annual kWh consumption": 593500,
    "Annual Therms Consumption": 39700,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "Lynwood",
    "COG": "GCCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 91,
    "Population": 63200,
    "Agency Area (sq. miles)": 4.84,
    "Population Density (per sq mile)": 13057.85124,
    "Number of Extreme Heat Days": 33,
    "% Children and Seniors": 35,
    "Average Household Income": 67400,
    "Pollution Burden": 92,
    "% Low-Income Census Tracts": 66,
    "Number of Electric Circuits": 22,
    "Annual kWh consumption": 1340300,
    "Annual Therms Consumption": 30100,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "Duarte",
    "COG": "SGVCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 78,
    "Population": 23100,
    "Agency Area (sq. miles)": 6.71,
    "Population Density (per sq mile)": 3442.622951,
    "Number of Extreme Heat Days": 132,
    "% Children and Seniors": 38,
    "Average Household Income": 93900,
    "Pollution Burden": 58,
    "% Low-Income Census Tracts": 20,
    "Number of Electric Circuits": 10,
    "Annual kWh consumption": 417700,
    "Annual Therms Consumption": null,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "Rancho Palos Verdes",
    "COG": "SBCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 11,
    "Population": 41600,
    "Agency Area (sq. miles)": 13.5,
    "Population Density (per sq mile)": 3081.481481,
    "Number of Extreme Heat Days": 11,
    "% Children and Seniors": null,
    "Average Household Income": 146200,
    "Pollution Burden": 29,
    "% Low-Income Census Tracts": 0,
    "Number of Electric Circuits": 25,
    "Annual kWh consumption": 359100,
    "Annual Therms Consumption": 900,
    "Underserved and/or  Hard to Reach": "Yes"
  },
  {
    "Agency": "El Segundo",
    "COG": "SBCOG",
    "DAC Status": "Yes",
    "CalEnviroScreen Score": 26,
    "Population": 16500,
    "Agency Area (sq. miles)": 5.5,
    "Population Density (per sq mile)": 3000,
    "Number of Extreme Heat Days": 7,
    "% Children and Seniors": null,
    "Average Household Income": 115900,
    "Pollution Burden": 87,
    "% Low-Income Census Tracts": 0,
    "Number of Electric Circuits": 20,
    "Annual kWh consumption": 94470,
    "Annual Therms Consumption": 40800,
    "Underserved and/or  Hard to Reach": "Yes"
  }
];

/* ============ FACILITIES DATA (FULL) ============ */
const facilitiesData = [
  {
    "Agency": "Bell",
    "Facility Name": "Bell Library",
    "Address": "4411 Gage Ave, Bell, CA",
    "Existing Resilience Designation": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 2,
    "Exisiting PV or Battery Capabilities": "N/A",
    "Planned PV (hours of autonomy)": 3912,
    "Planned Battery Storage (hours of autonomy)": 25,
    "Existing use": "Library",
    "Walkability": "High",
    "Gross Floor Area (sqft)": 5622,
    "Year Built": 1965,
    "Latitude": 33.97842,
    "Longitude": -118.188728
  },
  {
    "Agency": "Bell",
    "Facility Name": "Community Center",
    "Address": "6250 Pine Ave, Bell, CA",
    "Existing Resilience Designation": "Cooling Center",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 2,
    "Exisiting PV or Battery Capabilities": "Solar went live in August 2020",
    "Planned PV (hours of autonomy)": 1899,
    "Planned Battery Storage (hours of autonomy)": 1748,
    "Existing use": "Community center",
    "Walkability": "High",
    "Gross Floor Area (sqft)": 16011,
    "Year Built": 1980,
    "Latitude": 33.979983,
    "Longitude": -118.188726
  },
  {
    "Agency": "Bell",
    "Facility Name": "Camp Little Bear Park",
    "Address": "6704 Orchard Ave, Bell, CA",
    "Existing Resilience Designation": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities": "N/A",
    "Planned PV (hours of autonomy)": 664,
    "Planned Battery Storage (hours of autonomy)": 81,
    "Existing use": "Park",
    "Walkability": "Medium",
    "Gross Floor Area (sqft)": 5783,
    "Year Built": 1962,
    "Latitude": 33.976608,
    "Longitude": -118.19976
  },
  {
    "Agency": "Bell",
    "Facility Name": "Veterans Memorial Park",
    "Address": "6500 Wilcox Ave, Bell, CA",
    "Existing Resilience Designation": "Cooling Center",
    "Existing EV Chargers (Yes/No)": "No Capacity",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities": "N/A",
    "Planned PV (hours of autonomy)": 3397,
    "Planned Battery Storage (hours of autonomy)": 381,
    "Existing use": "Park",
    "Walkability": "Medium",
    "Gross Floor Area (sqft)": 7500,
    "Year Built": 1955,
    "Latitude": 33.975866,
    "Longitude": -118.176767
  },
  {
    "Agency": "Maywood",
    "Facility Name": "City Hall + Sheriff's Office",
    "Address": "4319 Slauson Ave, Bell, CA",
    "Existing Resilience Designation": "Cooling Center",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 4,
    "Exisiting PV or Battery Capabilities": "No",
    "Planned PV (hours of autonomy)": 2646,
    "Planned Battery Storage (hours of autonomy)": 0,
    "Existing use": "Office",
    "Walkability": "High",
    "Gross Floor Area (sqft)": 9534,
    "Year Built": 1938,
    "Latitude": 33.986554,
    "Longitude": -118.170803
  },
  {
    "Agency": "Maywood",
    "Facility Name": "Teen Center",
    "Address": "4801 E. Slauson Ave, Bell, CA",
    "Existing Resilience Designation": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities": "No",
    "Planned PV (hours of autonomy)": "Whole year",
    "Planned Battery Storage (hours of autonomy)": "Whole year",
    "Existing use": "Community center",
    "Walkability": "Medium",
    "Gross Floor Area (sqft)": "N/A",
    "Year Built": "N/A",
    "Latitude": 33.986554,
    "Longitude": -118.170803
  },
  {
    "Agency": "Maywood",
    "Facility Name": "(YMCA) Maywood Park",
    "Address": "4801 E. 58th St, Bell, CA",
    "Existing Resilience Designation": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 4,
    "Exisiting PV or Battery Capabilities": "No",
    "Planned PV (hours of autonomy)": 1140,
    "Planned Battery Storage (hours of autonomy)": 5,
    "Existing use": "Community center",
    "Walkability": "Medium",
    "Gross Floor Area (sqft)": 30819,
    "Year Built": 1999,
    "Latitude": 33.98746,
    "Longitude": -118.178804
  },
  {
    "Agency": "Maywood",
    "Facility Name": "Cesar Chavez Library",
    "Address": "4323 Slauson Ave, Bell, CA",
    "Existing Resilience Designation": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities": "No",
    "Planned PV (hours of autonomy)": 2311,
    "Planned Battery Storage (hours of autonomy)": 5,
    "Existing use": "Library",
    "Walkability": "High",
    "Gross Floor Area (sqft)": 3382,
    "Year Built": 1938,
    "Latitude": 33.986554,
    "Longitude": -118.170803
  },
  {
    "Agency": "Bell Gardens",
    "Facility Name": "Ford Park and Recreation Center",
    "Address": "8000 Park Lane, Bell, CA",
    "Existing Resilience Designation": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 10,
    "Exisiting PV or Battery Capabilities": "N/A",
    "Planned PV (hours of autonomy)": 3563,
    "Planned Battery Storage (hours of autonomy)": 13,
    "Existing use": "Community center",
    "Walkability": "High",
    "Gross Floor Area (sqft)": 9083,
    "Year Built": 1976,
    "Latitude": 33.959218,
    "Longitude": -118.154753
  },
  {
    "Agency": "Bell Gardens",
    "Facility Name": "Community Family Services Center & Veterans Park",
    "Address": "6662 Loveland St, Bell, CA",
    "Existing Resilience Designation": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities": "N/A",
    "Planned PV (hours of autonomy)": 3330,
    "Planned Battery Storage (hours of autonomy)": 71,
    "Existing use": "Community center",
    "Walkability": "Low",
    "Gross Floor Area (sqft)": 20000,
    "Year Built": 1976,
    "Latitude": 33.968177,
    "Longitude": -118.143887
  },
  {
    "Agency": "Bell Gardens",
    "Facility Name": "Youth Center",
    "Address": "5856 Ludell St, Bell, CA",
    "Existing Resilience Designation": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities": "N/A",
    "Planned PV (hours of autonomy)": 3406,
    "Planned Battery Storage (hours of autonomy)": 11,
    "Existing use": "Community center",
    "Walkability": "Medium",
    "Gross Floor Area (sqft)": 11446,
    "Year Built": 1948,
    "Latitude": 33.968683,
    "Longitude": -118.160906
  },
  {
    "Agency": "Bell Gardens",
    "Facility Name": "Civic Center",
    "Address": "7100 Garfield St, Bell, CA",
    "Existing Resilience Designation": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities": "N/A",
    "Planned PV (hours of autonomy)": 5,
    "Planned Battery Storage (hours of autonomy)": 0,
    "Existing use": "City Hall",
    "Walkability": "Medium",
    "Gross Floor Area (sqft)": 18500,
    "Year Built": 1967,
    "Latitude": 33.967687,
    "Longitude": -118.150114
  },
  {
    "Agency": "Pomona",
    "Facility Name": "Library",
    "Address": "625 S Garey Ave, Pomona, CA",
    "Existing Resilience Designation": "Cooling Center",
    "Existing EV Chargers (Yes/No)": "Yes",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities": "N/A",
    "Planned PV (hours of autonomy)": 2057,
    "Planned Battery Storage (hours of autonomy)": 0,
    "Existing use": "Library",
    "Walkability": "High",
    "Gross Floor Area (sqft)": 25977,
    "Year Built": 1956,
    "Latitude": 34.053897,
    "Longitude": -117.750631
  },
  {
    "Agency": "Pomona",
    "Facility Name": "City Hall",
    "Address": "505 S Garey Ave, Pomona, CA",
    "Existing Resilience Designation": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities": "N/A",
    "Planned PV (hours of autonomy)": 2482,
    "Planned Battery Storage (hours of autonomy)": 14,
    "Existing use": "Office",
    "Walkability": "High",
    "Gross Floor Area (sqft)": 44996,
    "Year Built": 1969,
    "Latitude": 34.054554,
    "Longitude": -117.751251
  },
  {
    "Agency": "Pomona",
    "Facility Name": "Palomares Park",
    "Address": "499 E Arrow Hwy, Pomona, CA",
    "Existing Resilience Designation": "Cooling Center",
    "Existing EV Chargers (Yes/No)": "Yes",
    "Number of Planned EV Chargers": 19,
    "Exisiting PV or Battery Capabilities": "N/A",
    "Planned PV (hours of autonomy)": 6470,
    "Planned Battery Storage (hours of autonomy)": 48,
    "Existing use": "Community center",
    "Walkability": "Low",
    "Gross Floor Area (sqft)": 15704,
    "Year Built": 1983,
    "Latitude": 34.090168,
    "Longitude": -117.742428
  },
  {
    "Agency": "Pomona",
    "Facility Name": "Washington Senior Center",
    "Address": "865 E Granf Ave, Pomona, CA",
    "Existing Resilience Designation": "Cooling Center",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 6,
    "Exisiting PV or Battery Capabilities": "N/A",
    "Planned PV (hours of autonomy)": 4070,
    "Planned Battery Storage (hours of autonomy)": 883,
    "Existing use": "Senior Center",
    "Walkability": "Low",
    "Gross Floor Area (sqft)": 2539,
    "Year Built": 1935,
    "Latitude": 34.048184,
    "Longitude": -117.739664
  },
  {
    "Agency": "Irwindale",
    "Facility Name": "Dan Diaz Recreation Center and Library",
    "Address": "16053 Calle De Paseo, Irwindale, CA",
    "Existing Resilience Designation": "N/A",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 0,
    "Exisiting PV or Battery Capabilities": "N/A",
    "Planned PV (hours of autonomy)": 1068,
    "Planned Battery Storage (hours of autonomy)": 1,
    "Existing use": "Library and recreation center",
    "Walkability": "Low",
    "Gross Floor Area (sqft)": 22855,
    "Year Built": 1970,
    "Latitude": 34.103841,
    "Longitude": -117.932137
  },
  {
    "Agency": "Irwindale",
    "Facility Name": "City Hall and Police Department",
    "Address": "5050 N Irwindale Ave, Irwindale, CA",
    "Existing Resilience Designation": "Emergency Operations Center",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 4,
    "Exisiting PV or Battery Capabilities": "N/A",
    "Planned PV (hours of autonomy)": 4,
    "Planned Battery Storage (hours of autonomy)": 0,
    "Existing use": "Office",
    "Walkability": "Low",
    "Gross Floor Area (sqft)": 20600,
    "Year Built": 1957,
    "Latitude": 34.127586,
    "Longitude": -117.933637
  },
  {
    "Agency": "Irwindale",
    "Facility Name": "Senior Center and Annex",
    "Address": "16116 Arrow Hwy, Irwindale, CA",
    "Existing Resilience Designation": "Cooling Center",
    "Existing EV Chargers (Yes/No)": "No",
    "Number of Planned EV Chargers": 4,
    "Exisiting PV or Battery Capabilities": "N/A",
    "Planned PV (hours of autonomy)": 24,
    "Planned Battery Storage (hours of autonomy)": 0,
    "Existing use": "Multi-purpose/ office",
    "Walkability": "Low",
    "Gross Floor Area (sqft)": 20678,
    "Year Built": 1985,
    "Latitude": 34.106818,
    "Longitude": -117.930958
  },
  {
    "Agency": "Irwindale",
    "Facility Name": "New Library (Planned for 2026)",
    "Address": "TBD - south of City Hall/west of existing library",
    "Existing Resilience Designation": "N/A",
    "Existing EV Chargers (Yes/No)": "N/A",
    "Number of Planned EV Chargers": "N/A",
    "Exisiting PV or Battery Capabilities": "N/A",
    "Planned PV (hours of autonomy)": "N/A",
    "Planned Battery Storage (hours of autonomy)": "N/A",
    "Existing use": "Library",
    "Walkability": "N/A",
    "Gross Floor Area (sqft)": "N/A",
    "Year Built": "N/A",
    "Latitude": null,
    "Longitude": null
  }
];

/* INIT MAP */
function initMap() {
  map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [-118.2437, 34.0522],
    zoom: 8, /* one level further out than original */
    pitch: 45
  });

  map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
  map.addControl(new mapboxgl.NavigationControl(), 'top-right');

  const geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    mapboxgl: mapboxgl,
    placeholder: 'Search for a location'
  });
  map.addControl(geocoder, 'top-left');

  map.on('load', () => {
    document.getElementById('loading-spinner').style.display = 'block';

    // highlight source for selected agency
    map.addSource('selected-agency', {
      type: 'geojson',
      data: {
        type: 'FeatureCollection',
        features: []
      }
    });
    // highlight line
    map.addLayer({
      id: 'selected-agency-highlight',
      type: 'line',
      source: 'selected-agency',
      paint: {
        'line-color': '#FF0000',
        'line-width': 3
      }
    });

    loadBoundariesAndFacilities();
  });
}

/* LOAD BOUNDARIES, FACILITIES, ETC. */
async function loadBoundariesAndFacilities() {
  // SoCalREN territory
  fetch('data/scr_territory.geojson')
    .then(resp => resp.json())
    .then(scrData => {
      map.addSource('scr-territory', {
        type: 'geojson',
        data: scrData
      });
      map.addLayer({
        id: 'scr-territory-fill',
        type: 'fill',
        source: 'scr-territory',
        paint: {
          'fill-color': 'rgba(0, 128, 255, 0.25)',
          'fill-outline-color': 'rgba(0,0,0,0)'
        }
      }, 'water');
    })
    .catch(err => console.error('Error loading scr_territory:', err));

  // AGENCY boundaries => 2D orange fill
  fetch('data/la_boundaries.geojson')
    .then(resp => resp.json())
    .then(geojson => {
      map.addSource('la-boundaries', { type: 'geojson', data: geojson });
      map.addLayer({
        id: 'la-boundaries-2d',
        type: 'fill',
        source: 'la-boundaries',
        paint: {
          'fill-color': '#FFA500',   /* orange */
          'fill-opacity': 0.4
        }
      });

      let hoveredId = null;
      const boundaryPopup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false,
        anchor: 'top',
        offset: [0,0],
        className: 'boundary-popup'
      });

      map.on('mousemove', 'la-boundaries-2d', e => {
        map.getCanvas().style.cursor = 'pointer';
        if (e.features.length) {
          if (hoveredId) {
            map.setFeatureState({ source: 'la-boundaries', id: hoveredId }, { hover: false });
          }
          hoveredId = e.features[0].id;
          map.setFeatureState({ source: 'la-boundaries', id: hoveredId }, { hover: true });

          const cityName = e.features[0].properties.CITY_COMM_NAME || '';
          let matchedAgency = agenciesData.find(a => a.Agency.toLowerCase() === cityName.toLowerCase());
          if (!matchedAgency) {
            matchedAgency = agenciesData.find(a => cityName.toLowerCase().includes(a.Agency.toLowerCase()));
          }

          let popupHtml = `<strong>${cityName}</strong><br><em>No data found</em>`;
          if (matchedAgency) {
            const dac = matchedAgency["DAC Status"] || 'N/A';
            const score = matchedAgency["CalEnviroScreen Score"] || 'N/A';
            const pop = matchedAgency["Population"] || 'N/A';
            popupHtml = `
              <strong>${matchedAgency.Agency}</strong><br>
              DAC Status: ${dac}<br>
              CalEnviroScreen Score: ${score}<br>
              Population: ${Number(pop).toLocaleString()}
            `;
          }
          boundaryPopup.setLngLat(e.lngLat).setHTML(popupHtml).addTo(map);
        }
      });

      map.on('mouseleave', 'la-boundaries-2d', () => {
        map.getCanvas().style.cursor = '';
        boundaryPopup.remove();
        if (hoveredId) {
          map.setFeatureState({ source: 'la-boundaries', id: hoveredId }, { hover: false });
        }
        hoveredId = null;
      });

      // click => show listing for that city
      map.on('click', 'la-boundaries-2d', e => {
        if (!e.features.length) return;
        const cityName = e.features[0].properties.CITY_COMM_NAME || '';
        if (cityName) {
          let matched = agenciesData.find(a => a.Agency.toLowerCase() === cityName.toLowerCase());
          if (!matched) {
            matched = agenciesData.find(a => cityName.toLowerCase().includes(a.Agency.toLowerCase()));
          }
          if (matched) {
            const facs = facilitiesData.filter(f => f.Agency === matched.Agency);
            showFacilities(matched, facs);
          }
        }
      });
    })
    .catch(err => console.error('Error loading boundaries:', err));

  // Facilities => cluster => purple markers
  const facilityFeatures = [];
  facilitiesData.forEach(fac => {
    const lat = parseFloat(fac.Latitude);
    const lng = parseFloat(fac.Longitude);
    if (!isNaN(lat) && !isNaN(lng)) {
      facilityFeatures.push({
        type: 'Feature',
        geometry: { type: 'Point', coordinates: [lng, lat] },
        properties: { ...fac }
      });
    }
  });
  const facilityGeoJSON = {
    type: 'FeatureCollection',
    features: facilityFeatures
  };

  map.addSource('facilities', {
    type: 'geojson',
    data: facilityGeoJSON,
    cluster: true,
    clusterMaxZoom: 14,
    clusterRadius: 50
  });

  // Note: Second argument removed so these layers draw on top by default
  map.addLayer({
    id: 'clusters',
    type: 'circle',
    source: 'facilities',
    filter: ['has','point_count'],
    paint: {
      'circle-radius': [
        'step', ['get','point_count'],
        25, 10,
        30, 25,
        35
      ],
      'circle-color': [
        'step', ['get','point_count'],
        '#F37B43', 10,
        '#F05A28', 25,
        '#9A5CA7'
      ],
      'circle-opacity': 0.9,
      'circle-stroke-width': 2,
      'circle-stroke-color': '#ffffff',
      'circle-stroke-opacity': 0.9
    }
  });

  map.addLayer({
    id: 'cluster-count',
    type: 'symbol',
    source: 'facilities',
    filter: ['has','point_count'],
    layout: {
      'text-field': '{point_count_abbreviated}',
      'text-font': ['DIN Offc Pro Bold','Arial Unicode MS Bold'],
      'text-size': 16,
      'text-allow-overlap': true
    },
    paint: {
      'text-color': '#ffffff',
      'text-halo-color': 'rgba(0,0,0,0.2)',
      'text-halo-width': 1
    }
  });

  map.addLayer({
    id: 'unclustered-point',
    type: 'circle',
    source: 'facilities',
    filter: ['!',['has','point_count']],
    paint: {
      'circle-color': '#9A5CA7', /* purple facility marker */
      'circle-radius': 8,
      'circle-stroke-width': 2,
      'circle-stroke-color': '#ffffff',
      'circle-opacity': 0.9,
      'circle-stroke-opacity': 0.9
    }
  });

  // cluster click => zoom
  map.on('click','clusters', e => {
    const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
    if (!features.length) return;
    const clusterId = features[0].properties.cluster_id;
    map.getSource('facilities').getClusterExpansionZoom(clusterId, (err, zoom) => {
      if (err) return;
      map.easeTo({ center: features[0].geometry.coordinates, zoom });
    });
  });

  // facility popup
  const facilityPopup = new mapboxgl.Popup({
    closeButton: true,
    closeOnClick: false,
    anchor: 'bottom',
    offset: [0, -10],
    className: 'facility-popup'
  });

  map.on('click','unclustered-point', e => {
    const props = e.features[0].properties;
    const name = props["Facility Name"] || "Unknown Facility";
    const address = props["Address"] || "N/A";
    const designation = props["Existing Resilience Designation"] || "N/A";
    const agencyName = props["Agency"] || "";

    const content = `
      <strong>${name}</strong><br>
      Address: ${address}<br>
      Resilience: ${designation}<br><br>
      <button id="popup-facility-button" style="padding:6px 12px;background:#2D3E4F;color:#fff;border:none;border-radius:4px;cursor:pointer;">
        View in Panel
      </button>
    `;

    facilityPopup
      .setLngLat(e.lngLat)
      .setHTML(content)
      .addTo(map);

    facilityPopup.on('open', () => {
      const btn = document.getElementById('popup-facility-button');
      if (btn) {
        btn.addEventListener('click', () => {
          facilityPopup.remove();
          const matchedAgency = agenciesData.find(a => a.Agency === agencyName);
          if (matchedAgency) {
            const facs = facilitiesData.filter(f => f.Agency === matchedAgency.Agency);
            showFacilities(matchedAgency, facs);
          }
        });
      }
    });
  });

  document.getElementById('loading-spinner').style.display = 'none';
  setupLayerToggles();
}

/* LAYER TOGGLE SETUP */
function setupLayerToggles() {
  toggleSCR.addEventListener('change', e => {
    const visible = e.target.checked ? 'visible' : 'none';
    map.setLayoutProperty('scr-territory-fill', 'visibility', visible);
  });

  toggleBoundaries.addEventListener('change', e => {
    const visible = e.target.checked ? 'visible' : 'none';
    map.setLayoutProperty('la-boundaries-2d', 'visibility', visible);
  });

  toggleFacilities.addEventListener('change', e => {
    const visible = e.target.checked ? 'visible' : 'none';
    map.setLayoutProperty('clusters', 'visibility', visible);
    map.setLayoutProperty('cluster-count', 'visibility', visible);
    map.setLayoutProperty('unclustered-point', 'visibility', visible);
  });
}

/* RENDER INITIAL AGENCY LIST */
function renderListing() {
  // show intro
  document.getElementById('intro-section').style.display = 'block';

  // hide facility filters
  document.getElementById('agency-filters').style.display = 'block';
  document.getElementById('facility-filters').style.display = 'none';

  // hide facility data
  document.getElementById('facility-data').style.display = 'none';

  // reset HTML
  const listingElement = document.getElementById('listing');
  listingElement.innerHTML = '';

  // group agencies by COG
  const groups = {};
  agenciesData.forEach(a => {
    const cog = a.COG;
    if (!groups[cog]) groups[cog] = [];
    groups[cog].push(a);
  });

  for (const [cogKey, agencies] of Object.entries(groups)) {
    if (agencies.length > 0) {
      const cogSection = document.createElement('div');
      cogSection.className = 'cog-section';

      const cogHeader = document.createElement('div');
      cogHeader.className = 'cog-header';
      const spelledOut = COGMapping[cogKey] || cogKey;
      cogHeader.textContent = spelledOut;

      const agencyList = document.createElement('div');
      agencyList.className = 'agency-list';
      agencyList.style.display = 'block';
      cogHeader.classList.add('expanded');

      cogHeader.addEventListener('click', () => {
        const isHidden = (agencyList.style.display === 'none');
        cogHeader.classList.toggle('expanded', isHidden);
        agencyList.style.display = isHidden ? 'block' : 'none';
      });

      agencies.sort((a,b) => a.Agency.localeCompare(b.Agency));
      agencies.forEach(a => {
        const agencyDiv = document.createElement('div');
        agencyDiv.className = 'agency-title';
        agencyDiv.textContent = a.Agency;
        agencyDiv.onclick = () => {
          const facs = facilitiesData.filter(f => f.Agency === a.Agency);
          showFacilities(a, facs);
        };
        agencyList.appendChild(agencyDiv);
      });

      cogSection.appendChild(cogHeader);
      cogSection.appendChild(agencyList);
      listingElement.appendChild(cogSection);
    }
  }
}

/* FILTER AGENCIES */
document.getElementById('population-min').addEventListener('input', filterAgencies);
document.getElementById('population-max').addEventListener('input', filterAgencies);
document.getElementById('agency-filter').addEventListener('input', filterAgencies);
document.getElementById('dac-filter').addEventListener('change', filterAgencies);
document.getElementById('ces90-filter').addEventListener('change', filterAgencies);

function filterAgencies() {
  const minPop = parseInt(document.getElementById('population-min').value) || 0;
  const maxPop = parseInt(document.getElementById('population-max').value) || Infinity;
  const searchText = document.getElementById('agency-filter').value.toLowerCase().trim();
  const dacFilter = document.getElementById('dac-filter').checked;
  const ces90Filter = document.getElementById('ces90-filter').checked;

  const filtered = agenciesData.filter(a => {
    const nameMatch = !searchText || a.Agency.toLowerCase().includes(searchText);
    const popVal = Number(a.Population) || 0;
    const popMatch = (popVal >= minPop && popVal <= maxPop);
    const isUnderserved = (a["Underserved and/or  Hard to Reach"] || '').toLowerCase() === 'yes';
    const matchDAC = !dacFilter || isUnderserved;
    const calVal = Number(a["CalEnviroScreen Score"]) || 0;
    const matchCal = !ces90Filter || (calVal > 90);

    return nameMatch && popMatch && matchDAC && matchCal;
  });

  const listingElement = document.getElementById('listing');
  listingElement.innerHTML = '';

  if (!filtered.length) {
    listingElement.innerHTML = `<p style="color:#666;font-style:italic;">No matching agencies found.</p>`;
    return;
  }

  const groupByCOG = {};
  filtered.forEach(a => {
    const c = a.COG;
    if (!groupByCOG[c]) groupByCOG[c] = [];
    groupByCOG[c].push(a);
  });

  for (const [cogKey, agencies] of Object.entries(groupByCOG)) {
    if (agencies.length > 0) {
      const cogSection = document.createElement('div');
      cogSection.className = 'cog-section';

      const cogHeader = document.createElement('div');
      cogHeader.className = 'cog-header';
      cogHeader.textContent = COGMapping[cogKey] || cogKey;

      const agencyList = document.createElement('div');
      agencyList.className = 'agency-list';
      agencyList.style.display = 'block';
      cogHeader.classList.add('expanded');

      cogHeader.addEventListener('click', () => {
        const isHidden = (agencyList.style.display === 'none');
        cogHeader.classList.toggle('expanded', isHidden);
        agencyList.style.display = isHidden ? 'block' : 'none';
      });

      agencies.sort((a,b) => a.Agency.localeCompare(b.Agency));
      agencies.forEach(a => {
        const agencyDiv = document.createElement('div');
        agencyDiv.className = 'agency-title';
        agencyDiv.textContent = a.Agency;
        agencyDiv.onclick = () => {
          const facs = facilitiesData.filter(f => f.Agency === a.Agency);
          showFacilities(a, facs);
        };
        agencyList.appendChild(agencyDiv);
      });

      cogSection.appendChild(cogHeader);
      cogSection.appendChild(agencyList);
      listingElement.appendChild(cogSection);
    }
  }
}

/* FACILITY FILTERS */
document.getElementById('pv-filter').addEventListener('change', refreshFacilityList);
document.getElementById('ev-filter').addEventListener('change', refreshFacilityList);
document.getElementById('cooling-filter').addEventListener('change', refreshFacilityList);
document.getElementById('evChargersMin').addEventListener('input', refreshFacilityList);
document.getElementById('pvHoursMin').addEventListener('input', refreshFacilityList);
document.getElementById('batteryHoursMin').addEventListener('input', refreshFacilityList);

function refreshFacilityList() {
  const title = document.getElementById('data-overview-title').textContent;
  const foundAgency = agenciesData.find(a => title.includes(a.Agency));
  if (foundAgency) {
    const facs = facilitiesData.filter(f => f.Agency === foundAgency.Agency);
    showFacilities(foundAgency, facs);
  }
}

/* SHOW FACILITIES & AGENCY DATA */
function showFacilities(agency, facilityList) {
  // Hide the intro
  document.getElementById('intro-section').style.display = 'none';

  // Switch filters
  document.getElementById('agency-filters').style.display = 'none';
  document.getElementById('facility-filters').style.display = 'block';

  // Clear listing
  const listingElement = document.getElementById('listing');
  listingElement.innerHTML = '';

  // Overwrite "Data Overview" => agency name
  document.getElementById('data-overview-title').textContent = agency.Agency + " Data Overview";

  // Show the agency data, hide facility data
  document.getElementById('agency-data').style.display = 'block';
  document.getElementById('facility-data').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';

  updateAgencyDashboard(agency);
  highlightAgency(agency);

  // ~~~ Expandable facilities listing => start expanded so they appear ~~~
  const header = document.createElement('div');
  header.className = 'cog-header';
  header.textContent = `View Facilities in ${agency.Agency}`;
  header.classList.add('expanded');

  let expanded = true;

  const facilitiesContainer = document.createElement('div');
  facilitiesContainer.style.display = 'block';

  header.addEventListener('click', () => {
    expanded = !expanded;
    header.classList.toggle('expanded', expanded);
    facilitiesContainer.style.display = expanded ? 'block' : 'none';
  });

  listingElement.appendChild(header);

  // Filter the facilities
  const filteredFacilities = filterFacilities(facilityList);
  if (filteredFacilities.length > 0) {
    filteredFacilities.forEach(f => {
      const facDiv = document.createElement('div');
      facDiv.className = 'agency-title';
      facDiv.textContent = f["Facility Name"];
      facDiv.onclick = () => {
        showFacilityDetails(f);
      };
      facilitiesContainer.appendChild(facDiv);
    });
  } else {
    const msg = document.createElement('div');
    msg.id = 'no-facilities-msg';
    msg.textContent = 'No facilities matched your filters.';
    facilitiesContainer.appendChild(msg);
  }
  listingElement.appendChild(facilitiesContainer);

  // Add a small "Back to Agencies" button
  const backBtn = document.createElement('button');
  backBtn.textContent = "← Back to Agencies";
  backBtn.style.backgroundColor = "#2D3E4F";
  backBtn.style.color = "#ffffff";
  backBtn.style.border = "none";
  backBtn.style.padding = "6px 12px";
  backBtn.style.borderRadius = "4px";
  backBtn.style.cursor = "pointer";
  backBtn.style.marginTop = "10px";
  backBtn.style.fontSize = "12px";
  backBtn.onclick = () => {
    document.getElementById('facility-data').style.display = 'none';
    document.getElementById('dashboard').style.display = 'none';
    renderListing();
  };
  listingElement.appendChild(backBtn);
}

/* UPDATE AGENCY DASHBOARD => show agency metrics */
function updateAgencyDashboard(agency) {
  function getSafe(obj, key) {
    if (obj[key] === null || obj[key] === undefined) return "N/A";
    if (String(obj[key]).toUpperCase() === 'N/A') return "N/A";
    return obj[key];
  }

  document.getElementById('agency-underserved').textContent = getSafe(agency, "DAC Status");
  document.getElementById('agency-calenviroscore').textContent = getSafe(agency, "CalEnviroScreen Score");
  document.getElementById('agency-pollutionburden').textContent = getSafe(agency, "Pollution Burden");

  let popVal = getSafe(agency, "Population");
  if (!isNaN(popVal)) popVal = parseInt(popVal).toLocaleString();
  document.getElementById('agency-population').textContent = popVal;

  document.getElementById('agency-children-seniors').textContent = getSafe(agency, "% Children and Seniors");
  document.getElementById('agency-area').textContent = getSafe(agency, "Agency Area (sq. miles)");

  let denVal = getSafe(agency, "Population Density (per sq mile)");
  if (!isNaN(denVal)) denVal = parseInt(denVal).toLocaleString();
  document.getElementById('agency-density').textContent = denVal;

  document.getElementById('agency-heat-days').textContent = getSafe(agency, "Number of Extreme Heat Days");

  let incVal = getSafe(agency, "Average Household Income");
  if (!isNaN(incVal)) incVal = parseInt(incVal).toLocaleString();
  document.getElementById('agency-income').textContent = incVal;

  document.getElementById('agency-low-income').textContent = getSafe(agency, "% Low-Income Census Tracts");
  document.getElementById('agency-circuits').textContent = getSafe(agency, "Number of Electric Circuits");

  let kwhVal = getSafe(agency, "Annual kWh consumption");
  if (!isNaN(kwhVal)) kwhVal = parseInt(kwhVal).toLocaleString();
  document.getElementById('agency-kwh').textContent = kwhVal;

  let thermVal = getSafe(agency, "Annual Therms Consumption");
  if (!isNaN(thermVal)) thermVal = parseInt(thermVal).toLocaleString();
  document.getElementById('agency-therms').textContent = thermVal;
}

/* FILTER FACILITIES */
function parseAutonomyValue(value) {
  if (!value) return 0;
  const str = String(value).toLowerCase().trim();
  if (str === 'whole year') return 8760;
  if (str === 'n/a') return 0;
  const parsed = parseInt(value, 10);
  return isNaN(parsed) ? 0 : parsed;
}

function filterFacilities(facList) {
  const pvChecked = document.getElementById('pv-filter').checked;
  const evChecked = document.getElementById('ev-filter').checked;
  const coolChecked = document.getElementById('cooling-filter').checked;

  const evMin = parseInt(document.getElementById('evChargersMin').value) || 0;
  const pvMin = parseInt(document.getElementById('pvHoursMin').value) || 0;
  const batteryMin = parseInt(document.getElementById('batteryHoursMin').value) || 0;

  return facList.filter(f => {
    const pvCap = (f["Exisiting PV or Battery Capabilities"] || '').toLowerCase();

    if (pvChecked && (pvCap === 'no' || pvCap === 'n/a')) {
      return false;
    }
    if (evChecked) {
      const evVal = (f["Existing EV Chargers (Yes/No)"] || '').toLowerCase();
      if (!evVal.includes('yes')) return false;
    }
    if (coolChecked) {
      const ed = (f["Existing Resilience Designation"] || '').toLowerCase();
      if (!ed.includes('cooling') && !ed.includes('emergency')) return false;
    }

    const plannedEV = parseInt(f["Number of Planned EV Chargers"]) || 0;
    if (plannedEV < evMin) return false;

    const pvVal = parseAutonomyValue(f["Planned PV (hours of autonomy)"]);
    if (pvVal < pvMin) return false;

    const battVal = parseAutonomyValue(f["Planned Battery Storage (hours of autonomy)"]);
    if (battVal < batteryMin) return false;

    return true;
  });
}

/* SHOW FACILITY DETAILS => replace agency data with facility data */
function showFacilityDetails(fac) {
  // Hide agency data => show facility data
  document.getElementById('agency-data').style.display = 'none';
  document.getElementById('facility-data').style.display = 'block';

  // Larger, green with navy underline => we keep that for the "data-overview-title"
  const facilityTitle = fac["Facility Name"] || "Facility";
  document.getElementById('data-overview-title').textContent = facilityTitle + " Data Overview";

  document.getElementById('fac-address').textContent = fac["Address"] || 'N/A';
  document.getElementById('fac-res-designation').textContent = fac["Existing Resilience Designation"] || 'N/A';
  document.getElementById('fac-ev-existing').textContent = fac["Existing EV Chargers (Yes/No)"] || 'N/A';
  document.getElementById('fac-ev-planned').textContent = fac["Number of Planned EV Chargers"] || 'N/A';
  document.getElementById('fac-pv-existing').textContent = fac["Exisiting PV or Battery Capabilities"] || 'N/A';
  document.getElementById('fac-pv-planned').textContent = fac["Planned PV (hours of autonomy)"] || 'N/A';
  document.getElementById('fac-batt-planned').textContent = fac["Planned Battery Storage (hours of autonomy)"] || 'N/A';
  document.getElementById('fac-use').textContent = fac["Existing use"] || 'N/A';
  document.getElementById('fac-walk').textContent = fac["Walkability"] || 'N/A';
  document.getElementById('fac-floor').textContent = fac["Gross Floor Area (sqft)"] || 'N/A';
  document.getElementById('fac-year').textContent = fac["Year Built"] || 'N/A';

  // Zoom map to facility coords
  const lat = parseFloat(fac.Latitude);
  const lng = parseFloat(fac.Longitude);
  if (!isNaN(lat) && !isNaN(lng)) {
    map.easeTo({ center: [lng, lat], zoom: 15 });
  }
}

/* HIGHLIGHT AGENCY & ZOOM */
function highlightAgency(agency) {
  const boundaryFeatures = map.querySourceFeatures('la-boundaries', {
    filter: ['==', ['downcase', ['get', 'CITY_COMM_NAME']], agency.Agency.toLowerCase()]
  });

  if (boundaryFeatures.length > 0) {
    map.getSource('selected-agency').setData({
      type: 'Feature',
      geometry: boundaryFeatures[0].geometry
    });
    const bounds = getBoundingBox(boundaryFeatures[0].geometry);
    map.fitBounds(bounds, { padding: 50 });
  } else {
    map.getSource('selected-agency').setData({
      type: 'FeatureCollection',
      features: []
    });
  }
}

/* GET BOUNDING BOX */
function getBoundingBox(geometry) {
  let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
  if (geometry.type === 'Polygon') {
    geometry.coordinates[0].forEach(coord => {
      const [x, y] = coord;
      if (x < minX) minX = x;
      if (x > maxX) maxX = x;
      if (y < minY) minY = y;
      if (y > maxY) maxY = y;
    });
  } else if (geometry.type === 'MultiPolygon') {
    geometry.coordinates.forEach(polygon => {
      polygon[0].forEach(coord => {
        const [x, y] = coord;
        if (x < minX) minX = x;
        if (x > maxX) maxX = x;
        if (y < minY) minY = y;
        if (y > maxY) maxY = y;
      });
    });
  }
  return [[minX, minY], [maxX, maxY]];
}

/* WELCOME POPUP */
function closeWelcome() {
  const popup = document.getElementById('welcome-popup');
  popup.classList.add('fade-out');
  setTimeout(() => {
    popup.style.display = 'none';
  }, 400);
}

/* INIT on page load => listing */
renderListing();
</script>
</body>
</html>
