<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>SoCalREN's ERAP GIS Hub</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto:wght@300;400&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css" type="text/css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        header {
            width: 100%;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            height: 60px;
            box-sizing: border-box;
        }
        .header-left {
            flex: 0 0 auto;
        }
        .header-left h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 20px;
            margin: 0;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
            justify-content: flex-end;
            max-width: 800px;
            margin-left: 40px;
        }
        .geocoder-container {
            flex: 1;
            max-width: 400px;
            min-width: 200px;
        }
        .style-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 4px;
        }
        .style-selector label {
            font-size: 14px;
            white-space: nowrap;
        }
        .style-selector select {
            background-color: transparent;
            color: #ecf0f1;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        .style-selector select:hover {
            border-color: rgba(255, 255, 255, 0.5);
        }
        .style-selector select option {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        .mapboxgl-ctrl-geocoder {
            box-shadow: none !important;
            width: 100% !important;
            max-width: none !important;
            font-family: 'Montserrat', sans-serif !important;
            border-radius: 4px;
        }
        .mapboxgl-ctrl-geocoder--input {
            height: 36px !important;
            padding: 6px 35px !important;
        }
        #container {
            flex: 1;
            display: flex;
            flex-direction: row;
            position: relative;
            overflow: hidden;
        }
        #map {
            position: relative;
            flex: 3;
        }
        .map-overlay {
            position: relative;
            flex: 1;
            font: 14px/22px 'Roboto', sans-serif;
            background-color: #fafafa;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        fieldset {
            background: #f0f0f0;
            border: none;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        input[type="text"], input[type="number"], input[type="range"] {
            border: 1px solid #ccc;
            width: 100%;
            border-radius: 5px;
            padding: 8px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        #agency-filter {
            position: relative;
        }
        #agency-suggestions {
            position: absolute;
            background: #fff;
            border: 1px solid #ccc;
            width: calc(100% - 16px);
            margin: 0;
            padding: 0;
            list-style: none;
            max-height: 150px;
            overflow-y: auto;
            z-index: 9999;
        }
        #agency-suggestions li {
            padding: 8px;
            cursor: pointer;
        }
        #agency-suggestions li:hover {
            background: #e0f7fa;
            color: #00796b;
        }
        .listing {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        .listing a {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            color: #404;
            text-decoration: none;
            display: block;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
            font-size: 14px;
        }
        .facilities-container {
            position: relative;
            z-index: 2;
            margin-top: 10px;
            display: block;
            max-height: calc(100vh - 400px);
            overflow-y: auto;
        }

        #listing {
            position: relative;
            height: auto;
            min-height: 200px;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            padding: 10px;
            margin-top: 10px;
        }
        .listing a:hover {
            background: #e0f7fa;
            color: #00796b;
        }
        .filters {
            margin-bottom: 10px;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        .filters label {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .filters input[type=checkbox] {
            margin-right: 5px;
        }
        .filters select {
            width: 100%;
            margin-bottom: 10px;
            font-size: 12px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .dashboard {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            font-size: 14px;
            margin-top: 10px;
        }
        .dashboard h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            font-weight: bold;
            color: #2c3e50;
        }
        .dashboard h4 {
            margin-bottom: 10px;
            font-size: 15px;
        }
        .metric {
            margin-bottom: 10px;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .metric .metric-value {
            font-weight: bold;
            font-size: 16px;
        }
        .chart-section {
            margin-top: 20px;
        }
        .chart-section h4 {
            margin-bottom: 10px;
        }
        #populationChartContainer,
        #facilitiesPieContainer {
            margin-bottom: 20px;
        }
        #populationChartContainer canvas,
        #facilitiesPieContainer canvas {
            background: #fff;
            border-radius: 8px;
            padding: 10px;
        }
        #loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #00796b;
            display: none;
            z-index: 999;
        }
        #back-button {
            background: #34495e;
            color: #ecf0f1;
            border: none;
            padding: 5px 10px;
            margin-bottom: 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
        #back-button:hover {
            background: #3b5771;
        }
        .cog-section {
            margin-bottom: 10px;
        }
        .cog-header {
            background: #2c3e50;
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
            color: #ffffff;
            margin-bottom: 8px;
        }
        .cog-header::after {
            content: 'â–¼';
            font-size: 12px;
            color: #ffffff;
            transition: transform 0.3s ease;
            margin-left: 10px;
            opacity: 0.9;
        }
        .cog-header.expanded::after {
            transform: rotate(180deg);
        }
        .cog-header:hover {
            background: #34495e;
        }
        .agency-list {
            margin-top: 5px;
            margin-bottom: 15px;
            padding-left: 10px;
        }
        .agency-title {
            font-size: 14px;
            font-weight: normal;
            margin: 5px 0;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s ease;
            color: #2c3e50;
            background: #f8f9fa;
        }
        .agency-title:hover {
            background: #e0f7fa;
            color: #00796b;
            transform: translateX(5px);
        }
        .facility-title {
            display: block;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: #2c3e50;
            text-decoration: none;
            border: 1px solid #e9ecef;
        }

        .facility-title:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        #listing {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            margin-top: 10px;
        }

        /* Add this to ensure facility titles are visible */
        #listing h4 {
            margin: 10px 0;
            color: #2c3e50;
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            color: #2c3e50;
            margin: 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            font-weight: bold;
        }

        /* Style for when no facilities are found */
        #no-facilities-msg {
            padding: 10px;
            color: #666;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 4px;
            margin: 10px 0;
        }

        .style-overlay {
            background-color: #34495e;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #ecf0f1;
            margin-right: 10px;
        }
        .style-overlay label {
            display: block;
            margin-bottom: 5px;
            font-weight: normal;
        }
        .style-overlay select {
            width: 100%;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            color: #000;
        }
        #welcome-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(44, 62, 80, 0.90);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.4s ease;
            backdrop-filter: blur(5px);
        }

        #welcome-popup.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        #welcome-popup .welcome-content {
            background: white;
            padding: 60px 70px;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            text-align: center;  /* Center all content */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            position: relative;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        #welcome-popup h1 {
            font-family: 'Nunito', sans-serif;
            font-size: 28px;
            margin-bottom: 30px;
            color: #2c3e50;  /* dark navy */
            line-height: 1.4;
            font-weight: 700;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 20px;
        }

        #welcome-popup h1 .title-line {
            display: block;
            margin-bottom: 5px;
        }

        #welcome-popup h2 {
            font-family: 'Nunito', sans-serif;
            font-size: 22px;  /* Increased from 22px */
            color: #ff9800;  /* orange */
            margin: 30px 0 25px;
            font-weight: 600;
            line-height: 1.4;
            text-align: center;  /* Center the subtitle */
        }

        #welcome-popup p {
            font-family: 'Nunito', sans-serif;
            font-size: 17px;
            margin-bottom: 25px;
            color: #546e7a;
            line-height: 1.8;
            font-weight: 400;
            text-align: center;
            max-width: 650px;  /* Limit line length for better readability */
            margin-left: auto;  /* Center the paragraph block */
            margin-right: auto;
        }

        #welcome-popup button {
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 17px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Nunito', sans-serif;
            display: block;
            margin: 40px auto 0;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        #welcome-popup button:hover {
            background-color: #34495e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #welcome-popup button:active {
            transform: translateY(0);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #welcome-popup .welcome-content {
                padding: 40px;
                width: 85%;
            }

            #welcome-popup h1 {
                font-size: 28px;
            }

            #welcome-popup h2 {
                font-size: 20px;
            }

            #welcome-popup p {
                font-size: 16px;
            }

            #welcome-popup button {
                padding: 14px 35px;
                font-size: 16px;
            }
        }
        /* Responsive styling */
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            #map {
                flex: none;
                height: 50vh;
            }
            .map-overlay {
                position: relative;
                transform: none !important;
            }
        }

        /* Intro section (revised to "Welcome to SoCalREN's ERAP Dashboard") */
        #intro-section {
            margin-top: 20px;
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            display: none; /* Start hidden and show only when agencies are listed */
        }
        #intro-section h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-family: 'Montserrat', sans-serif;
            color: #2c3e50;
        }
        #intro-section p {
            margin: 0 0 15px 0;
            font-size: 14px;
            line-height: 1.6;
            color: #34495e;
        }
        #intro-section ul {
            list-style: inside square;
            margin: 0 0 15px 0;
            padding: 0;
        }   
        #intro-section li {
            margin-bottom: 8px;
            font-size: 14px;
            color: #34495e;
        }

        .facility-popup .mapboxgl-popup-content {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-family: 'Montserrat', sans-serif;
            font-size: 13px;
            line-height: 1.4;
        }

        .facility-popup .mapboxgl-popup-tip {
            border-top-color: rgba(255, 255, 255, 0.95);
        }

        .facility-title.active {
            background: #fff3e0;
            border-left: 3px solid #ff9800;
            transform: translateX(5px);
        }

        .mapboxgl-ctrl-geocoder {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            font-family: 'Montserrat', sans-serif !important;
        }

        .mapboxgl-ctrl-geocoder--input {
            font-family: 'Roboto', sans-serif !important;
        }

        .mapboxgl-ctrl-geocoder--suggestion {
            font-family: 'Roboto', sans-serif !important;
        }

        .fullscreen-container {
            margin-left: 10px;
        }

        .mapboxgl-ctrl-fullscreen {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .mapboxgl-ctrl-fullscreen:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        #populationChartContainer {
            height: 300px;
            margin-bottom: 20px;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #populationChart {
            width: 100%;
            height: 100%;
        }

    </style>
</head>
<body>
<header>
    <div class="header-left">
        <h1>SoCalREN's ERAP GIS Hub</h1>
    </div>
    <div class="header-controls">
        <div class="geocoder-container" id="geocoder"></div>
        <div class="style-selector">
            <label for="style-selector">Map Style</label>
            <select id="style-selector">
                <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
                <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
                <option value="mapbox://styles/mapbox/light-v10">Light</option>
                <option value="mapbox://styles/mapbox/dark-v10">Dark</option>
                <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
            </select>
        </div>
        <div class="fullscreen-container" id="fullscreen-control"></div>
    </div>
</header>
<div id="container">
    <div id="map"></div>
    <div class="map-overlay" id="dashboard-panel">
        <fieldset>
            <input id="agency-filter" type="text" placeholder="Search for an agency">
            <ul id="agency-suggestions" style="display:none;"></ul>
        </fieldset>

        <fieldset class="filters" id="agency-filters">
            <legend>Agency Filters</legend>
            <label><input type="checkbox" id="dac-filter"> Show only Disadvantaged Communities (DAC)</label>
            <label><input type="checkbox" id="ces90-filter"> Show only agencies with CalEnviroScreen Score > 90</label>
            <label for="cog-select">Filter by Council of Governments:</label>
            <select id="cog-select">
                <option value="">All</option>
                <option value="Gateway Cities">Gateway Cities Council of Governments (GCCOG)</option>
                <option value="San Gabriel Valley COG">San Gabriel Valley Council of Governments (SGVCOG)</option>
                <option value="South Bay Cities">South Bay Cities Council of Governments (SBCOG)</option>
            </select>
            <label for="population-threshold">Population greater than:</label>
            <input type="range" id="population-threshold" min="0" max="200000" value="0">
            <span id="population-threshold-value">0</span>
        </fieldset>

        <fieldset class="filters" id="facility-filters" style="display:none;">
            <legend>Facility Filters</legend>
            <label><input type="checkbox" id="pv-filter"> Show only facilities with PV capabilities</label>
            <label><input type="checkbox" id="ev-filter"> Show only facilities with existing EV chargers</label>
            <label><input type="checkbox" id="cooling-filter"> Show only Cooling Centers / Emergency Ops</label>
        </fieldset>

        <div id="listing" class="listing"></div>

        <div id="intro-section">
            <h4>Welcome to SoCalREN's ERAP Dashboard</h4>
            <p>
                This dashboard provides insights into public agencies' energy resilience planning efforts across Southern California that have received support from the SoCalREN Public Agency Programs. Use the filters above to find agencies by name, select a council of governments, or set population thresholds. Click on an agency to view detailed metrics and access facility information.
            </p>
            <p>
                The data displayed here includes key metrics collected throughout an agency's involvement in the ERAP program. The dashboard can help you understand community needs, identify facilities equipped with Electric Vehicle chargers, Solar or Battery Storage, and plans for resilience improvements.
            </p>
            
            <h4>Getting Started</h4>
            <ul>
                <li>Use the "Filter by agency name" box to quickly locate a participating agency.</li>
                <li>Adjust the range filter to focus on agencies with larger populations.</li>
                <li>Click an agency name to view its details and a list of associated facilities that were assessed by SoCalREN.</li>
            </ul>
            
            <h4>What is ERAP?</h4>
            <p>
                SoCalREN's Energy Resilience Action Plan (ERAP) program aims to address the growing impacts of climate change. Developed in collaboration with regional partners, the ERAP program enhances the energy resilience of critical infrastructure and future resilience hub locations for public agencies. By incorporating data-driven analysis and stakeholder input into the planning and development process, ERAP supports agencies in developing an actionable roadmap for near-term to long-term energy resilience strategies that will best serve the community.
            </p>
        </div>

        <div class="dashboard" id="dashboard">
            <button id="back-button">Back</button>
            <h3 id="data-overview-title">Data Overview</h3>

            <div id="agency-data" style="display:none; margin-top:20px;">
                <h4>Agency-Level Data</h4>
                <div class="metric">
                    <span class="metric-label">DAC Status:</span>
                    <span class="metric-value" id="agency-dac">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">CalEnviroscreen:</span>
                    <span class="metric-value" id="agency-cal">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Population:</span>
                    <span class="metric-value" id="agency-pop">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Agency Area (sq. miles):</span>
                    <span class="metric-value" id="agency-area">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Population Density (per sq. mile):</span>
                    <span class="metric-value" id="agency-density">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Number of Extreme Heat Days:</span>
                    <span class="metric-value" id="agency-heat">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">% Children and Seniors:</span>
                    <span class="metric-value" id="agency-children-seniors">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Average Household Income ($):</span>
                    <span class="metric-value" id="agency-income">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Pollution Burden:</span>
                    <span class="metric-value" id="agency-pollution">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">% Low-Income Census Tracts:</span>
                    <span class="metric-value" id="agency-lowincome">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Number of Electric Circuits:</span>
                    <span class="metric-value" id="agency-circuits">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Annual Consumption (kWh):</span>
                    <span class="metric-value" id="agency-kwh">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Annual Consumption (Therms):</span>
                    <span class="metric-value" id="agency-therms">N/A</span>
                </div>
            </div>

            <div id="facility-data" style="display:none; margin-top:20px;">
                <h4>Facility-Level Data</h4>
                <div class="metric">
                    <span class="metric-label">Existing Use:</span>
                    <span class="metric-value" id="facility-use">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Existing EV Chargers (Yes/No):</span>
                    <span class="metric-value" id="facility-ev">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Number of Planned EV Chargers:</span>
                    <span class="metric-value" id="facility-planned-ev">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Existing PV or Battery Capabilities (Yes/No):</span>
                    <span class="metric-value" id="facility-pv">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Planned PV (hours of autonomy):</span>
                    <span class="metric-value" id="facility-pv-hours">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Planned Battery Storage (hours of autonomy):</span>
                    <span class="metric-value" id="facility-battery-hours">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Walk Score (RHOA):</span>
                    <span class="metric-value" id="facility-walkscore">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Sq Ft:</span>
                    <span class="metric-value" id="facility-sqft">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Yr Built (RHOA):</span>
                    <span class="metric-value" id="facility-yrbuilt">N/A</span>
                </div>
            </div>

            <div class="chart-section" id="chart-section" style="display:none;">
                <div id="populationChartContainer">
                    <h4>Population Comparison in This COG</h4>
                    <canvas id="populationChart"></canvas>
                </div>
                <div id="facilitiesPieContainer">
                    <h4>Facilities with PV/EV</h4>
                    <canvas id="facilitiesPie"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="welcome-popup">
    <div class="welcome-content">
        <h1>
            <span class="title-line">Welcome to the</span>
            <span class="title-line">Southern California Regional Energy Network (SoCalREN)'s</span>
            <span class="title-line">Energy Resilience Action Plan (ERAP) Dashboard</span>
        </h1>
        <h2>Explore energy resilience planning efforts across Southern California</h2>
        <p>This interactive dashboard provides comprehensive information about facilities and agencies participating in SoCalREN's ERAP program. Use the map to explore geographical data, or search for specific agencies to view detailed information about their facilities and energy resilience initiatives.</p>
        <button onclick="closeWelcome()">Enter Dashboard</button>
    </div>
</div>

<div id="loading-spinner">
    <i class="fas fa-spinner fa-spin"></i> Loading...
</div>

<script src="https://unpkg.com/@mapbox/mapbox-sdk/umd/mapbox-sdk.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css" type="text/css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>

<script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoid2VuZ2xlMSIsImEiOiJjbGh0bTJ0OTUzN2dzM21tbTB0NzFmM2QyIn0.-ItjIktoJtcQUsk6l9TbbQ';

    function closeWelcomePopup() {
        document.getElementById('welcome-popup').classList.add('fade-out');
    }

    document.getElementById('loading-spinner').style.display = 'none';

    let currentAgency = null;
    let currentCOG = null;
    let populationChartInstance = null;
    let facilitiesPieInstance = null;

    // Agency data:
    const agencyData = [
        {"Agency":"City of Bell","Council":"Gateway Cities","DAC":"Yes","CalEnviroscreen":96,"Population":31864,"AgencyArea":2.5,"PopulationDensity":13400,"ExtremeHeatDays":91,"ChildrenSeniors":36,"AvgHouseholdIncome":47800,"PollutionBurden":88,"LowIncomeTracts":100,"ElectricCircuits":14,"AnnualKWh":2200000,"AnnualTherms":91100},
        {"Agency":"City of Maywood","Council":"Gateway Cities","DAC":"Yes","CalEnviroscreen":90,"Population":27127,"AgencyArea":1.18,"PopulationDensity":23257,"ExtremeHeatDays":77,"ChildrenSeniors":38,"AvgHouseholdIncome":50996,"PollutionBurden":92,"LowIncomeTracts":100,"ElectricCircuits":6,"AnnualKWh":939153,"AnnualTherms":1232},
        {"Agency":"City of Bell Gardens","Council":"Gateway Cities","DAC":"Yes","CalEnviroscreen":92,"Population":37467,"AgencyArea":2.5,"PopulationDensity":17100,"ExtremeHeatDays":90,"ChildrenSeniors":30,"AvgHouseholdIncome":45300,"PollutionBurden":97,"LowIncomeTracts":100,"ElectricCircuits":9,"AnnualKWh":1597960,"AnnualTherms":25833},
        {"Agency":"City of Pomona","Council":"San Gabriel Valley COG","DAC":"Yes","CalEnviroscreen":97,"Population":151100,"AgencyArea":22.99,"PopulationDensity":6572,"ExtremeHeatDays":118,"ChildrenSeniors":37,"AvgHouseholdIncome":62400,"PollutionBurden":81,"LowIncomeTracts":82,"ElectricCircuits":56,"AnnualKWh":20971427,"AnnualTherms":23848},
        {"Agency":"City of Irwindale","Council":"San Gabriel Valley COG","DAC":"Yes","CalEnviroscreen":83,"Population":1400,"AgencyArea":9.5,"PopulationDensity":142,"ExtremeHeatDays":146,"ChildrenSeniors":"N/A","AvgHouseholdIncome":86250,"PollutionBurden":100,"LowIncomeTracts":100,"ElectricCircuits":30,"AnnualKWh":2452708,"AnnualTherms":11686},
        {"Agency":"El Monte Union High School District (EMUSHD)","Council":"San Gabriel Valley COG","DAC":"Yes","CalEnviroscreen":80,"Population":163151,"AgencyArea":22.38,"PopulationDensity":7290,"ExtremeHeatDays":129,"ChildrenSeniors":"N/A","AvgHouseholdIncome":62000,"PollutionBurden":92,"LowIncomeTracts":"N/A","ElectricCircuits":79,"AnnualKWh":"N/A","AnnualTherms":"N/A"},
        {"Agency":"City of Cudahy","Council":"Gateway Cities","DAC":"Yes","CalEnviroscreen":95,"Population":21700,"AgencyArea":1.23,"PopulationDensity":17642,"ExtremeHeatDays":85,"ChildrenSeniors":36,"AvgHouseholdIncome":49600,"PollutionBurden":94,"LowIncomeTracts":100,"ElectricCircuits":20,"AnnualKWh":"N/A","AnnualTherms":"N/A"},
        {"Agency":"City of South El Monte","Council":"San Gabriel Valley COG","DAC":"Yes","CalEnviroscreen":97,"Population":19000,"AgencyArea":2.84,"PopulationDensity":6690,"ExtremeHeatDays":124,"ChildrenSeniors":37,"AvgHouseholdIncome":67700,"PollutionBurden":98,"LowIncomeTracts":80,"ElectricCircuits":12,"AnnualKWh":593500,"AnnualTherms":39700},
        {"Agency":"City of Lynwood","Council":"Gateway Cities","DAC":"Yes","CalEnviroscreen":91,"Population":63200,"AgencyArea":4.84,"PopulationDensity":13058,"ExtremeHeatDays":33,"ChildrenSeniors":35,"AvgHouseholdIncome":67400,"PollutionBurden":92,"LowIncomeTracts":66,"ElectricCircuits":22,"AnnualKWh":1340300,"AnnualTherms":30100},
        {"Agency":"City of Duarte","Council":"San Gabriel Valley COG","DAC":"Yes","CalEnviroscreen":78,"Population":23100,"AgencyArea":6.71,"PopulationDensity":3443,"ExtremeHeatDays":132,"ChildrenSeniors":38,"AvgHouseholdIncome":93900,"PollutionBurden":58,"LowIncomeTracts":20,"ElectricCircuits":10,"AnnualKWh":417700,"AnnualTherms":"N/A"},
        {"Agency":"City of Rancho Palos Verdes","Council":"South Bay Cities","DAC":"Yes","CalEnviroscreen":11,"Population":41600,"AgencyArea":13.5,"PopulationDensity":3081,"ExtremeHeatDays":11,"ChildrenSeniors":"N/A","AvgHouseholdIncome":146200,"PollutionBurden":29,"LowIncomeTracts":0,"ElectricCircuits":25,"AnnualKWh":359100,"AnnualTherms":900},
        {"Agency":"City of El Segundo","Council":"South Bay Cities","DAC":"Yes","CalEnviroscreen":26,"Population":16500,"AgencyArea":5.5,"PopulationDensity":3000,"ExtremeHeatDays":7,"ChildrenSeniors":"N/A","AvgHouseholdIncome":115900,"PollutionBurden":87,"LowIncomeTracts":0,"ElectricCircuits":20,"AnnualKWh":94470,"AnnualTherms":40800}
    ];

    function parseCoordinate(coordStr) {
        if (!coordStr || coordStr.trim().toUpperCase() === 'N/A') return null;
        let parts = coordStr.split('Â°');
        if (parts.length < 2) return null;
        let value = parseFloat(parts[0].trim());
        let direction = parts[1].trim().toUpperCase();
        if (direction.startsWith('S') || direction.startsWith('W')) {
            value = -value;
        }
        return value;
    }

    const rawFacilityData = [
        ["City of Bell","Bell Library","4411 Gage Ave, Bell, CA","33.9765Â° N","118.1856Â° W","N/A","No","2","N/A","3,912","25","Library","High","5,622","1965"],
        ["City of Bell","Community Center","6250 Pine Ave, Bell, CA","33.9760Â° N","118.1820Â° W","Cooling Center","No","2","Solar went live in August 2020","1,899","1,748","Community center","High","16,011","1980"],
        ["City of Bell","Camp Little Bear Park","6704 Orchard Ave, Bell, CA","33.9770Â° N","118.1890Â° W","N/A","No","0","N/A","664","81","Park","Medium","5,783","1962"],
        ["City of Bell","Veterans Memorial Park","6500 Wilcox Ave, Bell, CA","33.9765Â° N","118.1875Â° W","Cooling Center","No Capacity","0","N/A","3,397","381","Park","Medium","7,500","1955"],
        ["City of Maywood","City Hall & Sheriff's Office","4319 Slauson Ave, Maywood, CA","33.9880Â° N","118.1850Â° W","Cooling Center","No","4","No","2,646","0","Office","High","9,534","1938"],
        ["City of Maywood","Teen Center","4801 E. Slauson Ave, Maywood, CA","33.9885Â° N","118.1700Â° W","N/A","No","0","No","Whole Year","Whole year","Community center","Medium","N/A","N/A"],
        ["City of Maywood","Maywood Park (YMCA)","4801 E. 58th St, Maywood, CA","33.9890Â° N","118.1705Â° W","N/A","No","4","No","1,140","5","Community center","Medium","30,819","1999"],
        ["City of Maywood","Cesar Chavez Library","4323 Slauson Ave, Maywood, CA","33.9880Â° N","118.1845Â° W","N/A","No","0","No","2,311","5","Library","High","3,382","1938"],
        ["City of Bell Gardens","Ford Park and Recreation Center","8000 Park Lane, Bell Gardens, CA","33.9650Â° N","118.1510Â° W","N/A","No","10","N/A","3,563","13","Community center","High","9,083","1976"],
        ["City of Bell Gardens","Community Family Services Center & Veterans Park","6662 Loveland St, Bell Gardens, CA","33.9660Â° N","118.1530Â° W","N/A","No","0","N/A","3,330","71","Community center","Low","20,000","1976"],
        ["City of Bell Gardens","Youth Center","5856 Ludell St, Bell Gardens, CA","33.9680Â° N","118.1500Â° W","N/A","No","0","N/A","3,406","11","Community center","Medium","11,446","1948"],
        ["City of Bell Gardens","Civic Center","7100 Garfield St, Bell Gardens, CA","33.9655Â° N","118.1515Â° W","N/A","No","0","N/A","5","0","City Hall","Medium","18,500","1967"],
        ["City of Pomona","Library","625 S Garey Ave, Pomona, CA","34.0530Â° N","117.7500Â° W","Cooling Center","Yes","0","N/A","2,057","0","Library","High","25,977","1956"],
        ["City of Pomona","City Hall","505 S Garey Ave, Pomona, CA","34.0525Â° N","117.7505Â° W","N/A","No","0","N/A","2,482","14","Office","High","44,996","1969"],
        ["City of Pomona","Palomares Park","499 E Arrow Hwy, Pomona, CA","34.1000Â° N","117.7400Â° W","Cooling Center","Yes","19","N/A","6,470","48","Community center","Low","15,704","1983"],
        ["City of Pomona","Washington Senior Center","865 E Granf Ave, Pomona, CA","34.0600Â° N","117.7400Â° W","Cooling Center","No","6","N/A","4,070","883","Senior Center","Low","2,539","1935"],
        ["City of Irwindale","Dan Diaz Recreation Center and Library","16053 Calle De Paseo, Irwindale, CA","34.1100Â° N","117.9700Â° W","N/A","No","0","N/A","1,068","1","Library and recreation center","Low","22,855","1970"],
        ["City of Irwindale","City Hall and Police Department","5050 N Irwindale Ave, Irwindale, CA","34.1105Â° N","117.9350Â° W","Emergency Operations Center","No","4","N/A","4","0","Office","Low","20,600","1957"],
        ["City of Irwindale","Senior Center and Annex","16116 Arrow Hwy, Irwindale, CA","34.1100Â° N","117.9705Â° W","Cooling Center","No","4","N/A","24","0","Multi-purpose/ office","Low","20,678","1985"],
        ["City of Irwindale","New Library (Planned for 2026)","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","Library","N/A","N/A","N/A"]
    ];

    const facilityData = rawFacilityData.map(row => {
        const [
            Agency, FacilityName, Address, LatStr, LonStr,
            ExistingUse, ExistingEV, PlannedEV, ExistingPV,
            PlannedPV, PlannedBattery, ActualUse, WalkScore,
            SqFt, YrBuilt
        ] = row;
        const lat = parseCoordinate(LatStr);
        const lon = parseCoordinate(LonStr);
        return {
            Agency, FacilityName, Address,
            Latitude: lat,
            Longitude: lon,
            ExistingUse,
            ExistingEV,
            PlannedEV: isNaN(parseInt(PlannedEV)) ? PlannedEV : parseInt(PlannedEV),
            ExistingPV,
            PlannedPV: isNaN(parseInt((PlannedPV || "").replace(/,/g,''))) && typeof PlannedPV === "string" ? PlannedPV : parseInt((PlannedPV||"").replace(/,/g,'')) || PlannedPV,
            PlannedBattery: isNaN(parseInt(PlannedBattery)) ? PlannedBattery : parseInt(PlannedBattery),
            ActualUse,
            WalkScore,
            SqFt: (SqFt && SqFt.toUpperCase() !== "N/A") ? SqFt : "N/A",
            YrBuilt: (YrBuilt && YrBuilt.toUpperCase() !== "N/A") ? YrBuilt : "N/A"
        };
    });

    const councilNameMapping = {
        "Gateway Cities": "Gateway Cities Council of Governments (GCCOG)",
        "San Gabriel Valley COG": "San Gabriel Valley Council of Governments (SGVCOG)",
        "South Bay Cities": "South Bay Cities Council of Governments (SBCOG)"
    };

    function groupAgenciesByCouncil(data) {
        const map = {};
        data.forEach(a => {
            if (!map[a.Council]) {
                map[a.Council] = [];
            }
            map[a.Council].push(a);
        });
        return map;
    }

    const agenciesByCouncil = groupAgenciesByCouncil(agencyData);

    function facilityToFeature(f) {
        if (f.Latitude !== null && f.Longitude !== null) {
            return {
                'type': 'Feature',
                'properties': {
                    Agency: f.Agency,
                    FacilityName: f.FacilityName,
                    ExistingUse: f.ExistingUse,
                    ExistingEV: f.ExistingEV,
                    PlannedEV: f.PlannedEV,
                    ExistingPV: f.ExistingPV,
                    PlannedPV: f.PlannedPV,
                    PlannedBattery: f.PlannedBattery,
                    ActualUse: f.ActualUse,
                    WalkScore: f.WalkScore,
                    SqFt: f.SqFt,
                    YrBuilt: f.YrBuilt
                },
                'geometry': {
                    'type': 'Point',
                    'coordinates': [f.Longitude, f.Latitude]
                }
            };
        }
        return null;
    }

    const facilityFeatures = facilityData.map(f => facilityToFeature(f)).filter(x => x !== null);
    const facilityGeoJSON = {
        "type": "FeatureCollection",
        "features": facilityFeatures
    };

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [-118.2437, 34.0522],
        zoom: 10
    });

    // Add the geocoder control
    const geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        placeholder: 'Search for an address',
        bbox: [-118.9517, 33.7037, -117.6462, 34.3373], // Bounds for LA County
        proximity: {
            longitude: -118.2437,
            latitude: 34.0522
        }
    });

    // Add the geocoder to the container instead of the map
    document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

    function updateDataOverviewTitle() {
        const agencyVisible = document.getElementById('agency-data').style.display !== 'none';
        const facilityVisible = document.getElementById('facility-data').style.display !== 'none';
        const titleEl = document.getElementById('data-overview-title');
        if (agencyVisible || facilityVisible) {
            titleEl.style.display = 'block';
        } else {
            titleEl.style.display = 'none';
        }
    }
    

    function updateAgencyDashboard(a) {
        document.getElementById('agency-data').style.display = 'block';
        document.getElementById('facility-data').style.display = 'none';

        document.getElementById('agency-dac').textContent = a.DAC;
        document.getElementById('agency-cal').textContent = a.CalEnviroscreen;
        document.getElementById('agency-pop').textContent = a.Population !== "N/A" ? a.Population.toLocaleString() : "N/A";
        document.getElementById('agency-area').textContent = a.AgencyArea !== "N/A" ? a.AgencyArea : "N/A";
        document.getElementById('agency-density').textContent = a.PopulationDensity !== "N/A" ? a.PopulationDensity.toLocaleString() : "N/A";
        document.getElementById('agency-heat').textContent = a.ExtremeHeatDays !== "N/A" ? a.ExtremeHeatDays : "N/A";
        document.getElementById('agency-children-seniors').textContent = a.ChildrenSeniors !== "N/A" ? a.ChildrenSeniors + "%" : "N/A";
        document.getElementById('agency-income').textContent = a.AvgHouseholdIncome !== "N/A" ? "$" + a.AvgHouseholdIncome.toLocaleString() : "N/A";
        document.getElementById('agency-pollution').textContent = a.PollutionBurden !== "N/A" ? a.PollutionBurden : "N/A";
        document.getElementById('agency-lowincome').textContent = a.LowIncomeTracts !== "N/A" ? a.LowIncomeTracts + "%" : "N/A";
        document.getElementById('agency-circuits').textContent = a.ElectricCircuits !== "N/A" ? a.ElectricCircuits : "N/A";
        document.getElementById('agency-kwh').textContent = (a.AnnualKWh !== "N/A" && a.AnnualKWh !== undefined && !isNaN(a.AnnualKWh)) ? a.AnnualKWh.toLocaleString() : (a.AnnualKWh === "N/A" ? "N/A" : a.AnnualKWh);
        document.getElementById('agency-therms').textContent = (a.AnnualTherms !== "N/A" && a.AnnualTherms !== undefined && !isNaN(a.AnnualTherms)) ? a.AnnualTherms.toLocaleString() : (a.AnnualTherms === "N/A" ? "N/A" : a.AnnualTherms);

        updateDataOverviewTitle();
    }

    function updateFacilityDashboard(f) {
        document.getElementById('agency-data').style.display = 'none';
        document.getElementById('facility-data').style.display = 'block';

        document.getElementById('facility-use').textContent = f.ExistingUse;
        document.getElementById('facility-ev').textContent = f.ExistingEV;
        document.getElementById('facility-planned-ev').textContent = f.PlannedEV;
        document.getElementById('facility-pv').textContent = f.ExistingPV;
        document.getElementById('facility-pv-hours').textContent = f.PlannedPV;
        document.getElementById('facility-battery-hours').textContent = f.PlannedBattery;
        document.getElementById('facility-walkscore').textContent = f.WalkScore;
        document.getElementById('facility-sqft').textContent = f.SqFt;
        document.getElementById('facility-yrbuilt').textContent = f.YrBuilt;

        updateDataOverviewTitle();
    }

    function toggleFilters(showAgencyFilters) {
        const agencyFilters = document.getElementById('agency-filters');
        const facilityFilters = document.getElementById('facility-filters');
        const introSection = document.getElementById('intro-section');

        if (showAgencyFilters) {
            agencyFilters.style.display = 'block';
            facilityFilters.style.display = 'none';
            introSection.style.display = 'block'; // Show intro when listing agencies
        } else {
            agencyFilters.style.display = 'none';
            facilityFilters.style.display = 'block';
            introSection.style.display = 'none'; // Hide intro when an agency is selected
        }
    }

    function renderListing() {
        toggleFilters(true);
        currentCOG = null;
        const listingEl = document.getElementById('listing');
        listingEl.innerHTML = '';
        const searchTerm = document.getElementById('agency-filter').value.trim().toLowerCase();
        const dacOnly = document.getElementById('dac-filter').checked;
        const ces90 = document.getElementById('ces90-filter').checked;
        const cogValue = document.getElementById('cog-select').value;
        const popThreshold = parseInt(document.getElementById('population-threshold').value, 10);

        Object.keys(agenciesByCouncil).forEach(council => {
            const displayCouncilName = councilNameMapping[council] || council;
            let originalCouncilName = council; 
            if (cogValue && originalCouncilName !== cogValue) return;

            const section = document.createElement('div');
            section.classList.add('cog-section');

            const header = document.createElement('div');
            header.classList.add('cog-header');
            header.textContent = displayCouncilName;
            header.addEventListener('click', () => {
                const isExpanded = agencyList.style.display !== 'none';
                agencyList.style.display = isExpanded ? 'none' : 'block';
                header.classList.toggle('expanded', !isExpanded);
            });
            section.appendChild(header);

            const agencyList = document.createElement('div');
            agencyList.classList.add('agency-list');

            const filteredAgencies = agenciesByCouncil[council].filter(a => {
                let match = true;
                if (searchTerm && !a.Agency.toLowerCase().includes(searchTerm)) {
                    match = false;
                }
                if (dacOnly && a.DAC.toLowerCase() !== 'yes') {
                    match = false;
                }
                if (ces90 && (isNaN(a.CalEnviroscreen) || a.CalEnviroscreen <= 90)) {
                    match = false;
                }
                if (!isNaN(popThreshold) && a.Population && a.Population <= popThreshold) {
                    match = false;
                }
                return match;
            });

            if (filteredAgencies.length === 0) {
                const noAgencies = document.createElement('div');
                noAgencies.style.fontSize = '12px';
                noAgencies.style.color = '#555';
                noAgencies.textContent = 'No matching agencies.';
                agencyList.appendChild(noAgencies);
            } else {
                filteredAgencies.forEach(a => {
                    const agencyDiv = document.createElement('div');
                    agencyDiv.classList.add('agency-title');
                    agencyDiv.textContent = a.Agency;
                    agencyDiv.addEventListener('click', () => {
                        onAgencyClick(a);
                        currentCOG = originalCouncilName;
                    });
                    agencyList.appendChild(agencyDiv);
                });
            }

            section.appendChild(agencyList);

            header.addEventListener('click', () => {
                agencyList.style.display = agencyList.style.display === 'none' ? 'block' : 'none';
            });

            listingEl.appendChild(section);
        });

        document.getElementById('agency-data').style.display = 'none';
        document.getElementById('facility-data').style.display = 'none';
        document.getElementById('chart-section').style.display = 'none';
        document.getElementById('back-button').style.display = 'none';
        updateDataOverviewTitle();
    }

    function onAgencyClick(aObj) {
        currentAgency = aObj;
        toggleFilters(false);
        document.getElementById('back-button').style.display = 'block';
        
        // Clear and rebuild the listing element
        const listingEl = document.getElementById('listing');
        listingEl.innerHTML = '';

        // 1. Add the facility title
        const facilityTitle = document.createElement('h4');
        facilityTitle.textContent = "Facilities for " + aObj.Agency;
        listingEl.appendChild(facilityTitle);

        // 2. Apply facility filters and show facilities
        applyFacilityFilters(aObj);

        // 3. Create a new container for the dashboard content
        const dashboardContent = document.createElement('div');
        dashboardContent.classList.add('dashboard-content');
        listingEl.appendChild(dashboardContent);

        // 4. Update agency dashboard and charts
        const a = agencyData.find(d => d.Agency === aObj.Agency);
        if (a) {
            updateAgencyDashboard(a);
        }
        loadCharts(aObj);
        updateDataOverviewTitle();
    }

    function applyFacilityFilters(aObj) {
        const listingEl = document.getElementById('listing');
        const pvFilter = document.getElementById('pv-filter').checked;
        const evFilter = document.getElementById('ev-filter').checked;
        const coolingFilter = document.getElementById('cooling-filter').checked;

        // First, get all facilities for this agency
        const agencyFacilities = facilityData.filter(f => f.Agency === aObj.Agency);
        
        // Then apply the additional filters
        const filteredFacilities = agencyFacilities.filter(f => {
            if (pvFilter && (f.ExistingPV || "").toLowerCase() === 'no') return false;
            if (evFilter && (f.ExistingEV || "").toLowerCase() === 'no') return false;
            if (coolingFilter && !(f.ExistingUse || "").toLowerCase().includes('cooling center')) return false;
            return true;
        });

        // Clear and rebuild the listing
        listingEl.innerHTML = '';
        
        // Add the agency title
        const titleEl = document.createElement('h4');
        titleEl.textContent = `Facilities for ${aObj.Agency}`;
        listingEl.appendChild(titleEl);

        // Display facilities or "no results" message
        if (filteredFacilities.length === 0) {
            const noFacEl = document.createElement('div');
            noFacEl.id = 'no-facilities-msg';
            noFacEl.textContent = agencyFacilities.length === 0 ? 
                "No facilities found for this agency." : 
                "No facilities match the current filters.";
            listingEl.appendChild(noFacEl);
        } else {
            const facilitiesContainer = document.createElement('div');
            facilitiesContainer.className = 'facilities-container';
            
            filteredFacilities.forEach(f => {
                const fLink = document.createElement('a');
                fLink.href = '#';
                fLink.className = 'facility-title';
                fLink.textContent = f.FacilityName;
                fLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    onFacilityClick(f);
                    document.querySelectorAll('.facility-title').forEach(el => {
                        el.classList.remove('active');
                    });
                    fLink.classList.add('active');
                });
                facilitiesContainer.appendChild(fLink);
            });
        
            listingEl.appendChild(facilitiesContainer);
        }
    }

    function onFacilityClick(f) {
        updateFacilityDashboard(f);
        if (f.Longitude !== null && f.Latitude !== null) {
            map.flyTo({
                center: [f.Longitude, f.Latitude],
                zoom: 15,
                essential: true
            });
        }
    }

    // Load charts with a clean, professional color palette
    function loadCharts(aObj) {
        document.getElementById('chart-section').style.display = 'block';

        // Get all agencies in the current COG and their populations
        const cogAgencies = agencyData.filter(d => d.Council === currentCOG);
        
        // Sort agencies by population for better visualization
        cogAgencies.sort((a, b) => (b.Population || 0) - (a.Population || 0));

        // Prepare data for the chart
        const labels = cogAgencies.map(a => a.Agency.replace('City of ', ''));
        const populations = cogAgencies.map(a => a.Population || 0);
        
        // Highlight the current agency
        const backgroundColor = labels.map(label => 
            label === aObj.Agency.replace('City of ', '') ? '#2ecc71' : '#3498db'
        );

        if (populationChartInstance) {
            populationChartInstance.destroy();
        }

        const ctxPop = document.getElementById('populationChart').getContext('2d');
        populationChartInstance = new Chart(ctxPop, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Population',
                    data: populations,
                    backgroundColor: backgroundColor,
                    borderColor: backgroundColor.map(color => color === '#2ecc71' ? '#27ae60' : '#2980b9'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'Population Comparison in ' + (currentCOG || 'Current COG'),
                        font: { size: 14, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Population: ' + context.raw.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { 
                            display: true, 
                            text: 'Agencies',
                            font: { size: 12 }
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        title: { 
                            display: true, 
                            text: 'Population',
                            font: { size: 12 }
                        },
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        const agencyFacilities = facilityData.filter(f => f.Agency === aObj.Agency);
        const totalFacilities = agencyFacilities.length;
        const evCount = agencyFacilities.filter(f => (f.ExistingEV || "").toLowerCase() === 'yes').length;
        const pvCount = agencyFacilities.filter(f => {
            const pvVal = (f.ExistingPV || "").toLowerCase();
            return pvVal === 'yes' || (pvVal !== 'no' && pvVal !== 'n/a' && pvVal !== '');
        }).length;

        if (facilitiesPieInstance) {
            facilitiesPieInstance.destroy();
        }
        const ctxPie = document.getElementById('facilitiesPie').getContext('2d');
        facilitiesPieInstance = new Chart(ctxPie, {
            type: 'pie',
            data: {
                labels: ['EV', 'PV', 'None'],
                datasets: [{
                    data: [evCount, pvCount, totalFacilities - (evCount + pvCount)],
                    backgroundColor: ['#e67e22', '#2980b9', '#95a5a6']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    title: {
                        display: true,
                        text: 'Facility Feature Distribution',
                        font: { size: 16 }
                    }
                }
            }
        });
    }

    document.getElementById('back-button').addEventListener('click', () => {
        currentAgency = null;
        renderListing();
    });

    // Agency filter listeners
    document.getElementById('agency-filter').addEventListener('input', () => {
        const val = document.getElementById('agency-filter').value.toLowerCase();
        const allAgencies = agencyData.map(a => a.Agency);
        const suggestions = allAgencies.filter(a => a.toLowerCase().includes(val));
        const suggestionsList = document.getElementById('agency-suggestions');
        suggestionsList.innerHTML = '';
        if (val && suggestions.length > 0) {
            suggestionsList.style.display = 'block';
            suggestions.forEach(s => {
                const li = document.createElement('li');
                li.textContent = s;
                li.addEventListener('click', () => {
                    document.getElementById('agency-filter').value = s;
                    suggestionsList.style.display = 'none';
                    if (!currentAgency) renderListing();
                });
                suggestionsList.appendChild(li);
            });
        } else {
            suggestionsList.style.display = 'none';
        }
        if (!currentAgency) renderListing();
    });

    document.getElementById('dac-filter').addEventListener('change', () => {
        if (currentAgency) return;
        renderListing();
    });

    document.getElementById('ces90-filter').addEventListener('change', () => {
        if (currentAgency) return;
        renderListing();
    });

    document.getElementById('cog-select').addEventListener('change', () => {
        if (currentAgency) return;
        renderListing();
    });

    document.getElementById('population-threshold').addEventListener('input', () => {
        document.getElementById('population-threshold-value').textContent = document.getElementById('population-threshold').value;
        if (currentAgency) return;
        renderListing();
    });

    // Facility filter listeners
    document.getElementById('pv-filter').addEventListener('change', () => {
        if (currentAgency) {
            applyFacilityFilters(currentAgency);
        }
    });

    document.getElementById('ev-filter').addEventListener('change', () => {
        if (currentAgency) {
            applyFacilityFilters(currentAgency);
        }
    });

    document.getElementById('cooling-filter').addEventListener('change', () => {
        if (currentAgency) {
            applyFacilityFilters(currentAgency);
        }
    });

    map.on('load', () => {
        // First add the boundaries source and layers
        map.addSource('la-boundaries', {
            'type': 'geojson',
            'data': './data/la_boundaries.geojson'
        });

        map.addLayer({
            'id': 'la-fills',
            'type': 'fill',
            'source': 'la-boundaries',
            'layout': {},
            'paint': {
                'fill-color': '#3498db',
                'fill-opacity': 0.4  // Increased from 0.2 for better visibility
            }
        });

        map.addLayer({
            'id': 'la-borders',
            'type': 'line',
            'source': 'la-boundaries',
            'layout': {},
            'paint': {
                'line-color': '#2980b9',
                'line-width': 1
            }
        });

        // After your existing boundary layers (la-fills, la-borders)
        map.addLayer({
            'id': 'la-fills-hover',
            'type': 'fill',
            'source': 'la-boundaries',
            'paint': {
                'fill-color': '#2ecc71',
                'fill-opacity': 0.7
            },
            'filter': ['==', ['get', 'CITY_COMM_NAME'], '']
        });

        // Add these event listeners
        map.on('mouseenter', 'la-fills', (e) => {
            map.getCanvas().style.cursor = 'pointer';
            if (e.features.length > 0) {
                map.setFilter('la-fills-hover', ['==', ['get', 'CITY_COMM_NAME'], e.features[0].properties.CITY_COMM_NAME]);
            }
        });

        map.on('mouseleave', 'la-fills', () => {
            map.getCanvas().style.cursor = '';
            map.setFilter('la-fills-hover', ['==', ['get', 'CITY_COMM_NAME'], '']);
        });

        // Filter boundaries to show only participating agencies
        const dashboardCities = agencyData.map(a => {
            return a.Agency.replace('City of ', '').trim().toUpperCase();
        });

        map.setFilter('la-fills', ['in', ['get', 'CITY_COMM_NAME'], ['literal', dashboardCities]]);
        map.setFilter('la-borders', ['in', ['get', 'CITY_COMM_NAME'], ['literal', dashboardCities]]);

        // Add this after your boundary layers (la-fills, la-borders, la-fills-hover)
        // but before the facilities layers
        map.addLayer({
            'id': 'boundary-labels',
            'type': 'symbol',
            'source': 'la-boundaries',
            'filter': ['in', ['get', 'CITY_COMM_NAME'], ['literal', dashboardCities]],
            'layout': {
                'text-field': ['format',
                    ['get', 'CITY_COMM_NAME'], { 'font-scale': 0.8 }
                ],
                'text-variable-anchor': ['center'],
                'text-radial-offset': 0,
                'text-justify': 'center',
                'text-size': 20,
                'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                'text-padding': 3,
                'text-allow-overlap': false,
                'text-optional': true
            },
            'paint': {
                'text-color': '#2c3e50',
                'text-halo-color': '#ffffff',
                'text-halo-width': 1.5
            }
        });

        // First, add the facilities source
        map.addSource('facilities', {
            'type': 'geojson',
            'data': facilityGeoJSON,
            'cluster': true,
            'clusterMaxZoom': 14,
            'clusterRadius': 50
        });

        // Remove existing layers if they exist
        if (map.getLayer('clusters')) map.removeLayer('clusters');
        if (map.getLayer('cluster-count')) map.removeLayer('cluster-count');
        if (map.getLayer('unclustered-point')) map.removeLayer('unclustered-point');

        // Add new cluster layer
        map.addLayer({
            'id': 'clusters',
            'type': 'circle',
            'source': 'facilities',
            'filter': ['has', 'point_count'],
            'paint': {
                'circle-radius': [
                    'step',
                    ['get', 'point_count'],
                    25,    // radius for clusters with count < 10
                    10,    
                    30,    // radius for clusters with count < 25
                    25,    
                    35     // radius for clusters with count >= 25
                ],
                'circle-color': [
                    'step',
                    ['get', 'point_count'],
                    '#ff9800',  // small clusters
                    10,
                    '#f57c00',  // medium clusters
                    25,
                    '#e65100'   // large clusters
                ],
                'circle-opacity': 0.9,
                'circle-stroke-width': 2,
                'circle-stroke-color': '#ffffff',
                'circle-stroke-opacity': 0.8
            }
        });

        // Add new cluster count layer
        map.addLayer({
            'id': 'cluster-count',
            'type': 'symbol',
            'source': 'facilities',
            'filter': ['has', 'point_count'],
            'layout': {
                'text-field': '{point_count_abbreviated}',
                'text-font': ['DIN Offc Pro Bold', 'Arial Unicode MS Bold'],
                'text-size': 16,
                'text-allow-overlap': true
            },
            'paint': {
                'text-color': '#ffffff',
                'text-halo-color': 'rgba(0, 0, 0, 0.2)',
                'text-halo-width': 1
            }
        });

        // Add new unclustered point layer
        map.addLayer({
            'id': 'unclustered-point',
            'type': 'circle',
            'source': 'facilities',
            'filter': ['!', ['has', 'point_count']],
            'paint': {
                'circle-color': '#ff9800',
                'circle-radius': 8,
                'circle-stroke-width': 2,
                'circle-stroke-color': '#ffffff',
                'circle-opacity': 0.9,
                'circle-stroke-opacity': 0.8
            }
        });

        // Update popup styling
        const popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false,
            anchor: 'bottom',
            offset: [0, -10],
            className: 'facility-popup'
        });

        // Add mouse events for popups
        map.on('mouseenter', 'unclustered-point', (e) => {
            map.getCanvas().style.cursor = 'pointer';
            const props = e.features[0].properties;
            const desc = `
                <strong>${props.FacilityName}</strong><br>
                Use: ${props.ActualUse}<br>
                EV: ${props.ExistingEV}<br>
                PV: ${props.ExistingPV}
            `;
            popup.setLngLat(e.features[0].geometry.coordinates)
                 .setHTML(desc)
                 .addTo(map);
        });

        map.on('mouseleave', 'unclustered-point', () => {
            map.getCanvas().style.cursor = '';
            popup.remove();
        });

        // Add click event for clusters
        map.on('click', 'clusters', (e) => {
            const features = map.queryRenderedFeatures(e.point, {
                layers: ['clusters']
            });
            const clusterId = features[0].properties.cluster_id;
            map.getSource('facilities').getClusterExpansionZoom(
                clusterId,
                (err, zoom) => {
                    if (err) return;
                    map.easeTo({
                        center: features[0].geometry.coordinates,
                        zoom: zoom
                    });
                }
            );
        });

        // Change cursor when hovering over clusters
        map.on('mouseenter', 'clusters', () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        
        map.on('mouseleave', 'clusters', () => {
            map.getCanvas().style.cursor = '';
        });

        // Add this click handler for boundary areas after your other map event listeners
        map.on('click', 'la-fills', (e) => {
            if (e.features.length > 0) {
                const cityName = e.features[0].properties.CITY_COMM_NAME;
                // Find matching agency (accounting for "City of" prefix)
                const matchingAgency = agencyData.find(a => 
                    a.Agency.replace('City of ', '').trim().toUpperCase() === cityName.trim()
                );
                
                if (matchingAgency) {
                    // Call existing onAgencyClick function
                    onAgencyClick(matchingAgency);
                    
                    // Scroll dashboard into view if needed
                    document.getElementById('dashboard-panel').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            }
        });

        // Update the click handler for individual facility points
        map.on('click', 'unclustered-point', (e) => {
            const props = e.features[0].properties;
            
            // Find the matching agency first
            const matchingAgency = agencyData.find(a => a.Agency === props.Agency);
            if (matchingAgency) {
                // First show the agency's information
                onAgencyClick(matchingAgency);
                
                // Then find and show the facility's information
                const matchingFacility = facilityData.find(f => 
                    f.Agency === props.Agency && 
                    f.FacilityName === props.FacilityName
                );
                
                if (matchingFacility) {
                    // Update facility dashboard
                    updateFacilityDashboard(matchingFacility);
                    
                    // Find and highlight the facility in the listing
                    const facilityLinks = document.querySelectorAll('.facility-title');
                    facilityLinks.forEach(link => {
                        if (link.textContent === props.FacilityName) {
                            link.classList.add('active');
                            link.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            link.classList.remove('active');
                        }
                    });
                }
                
                // Scroll dashboard into view
                document.getElementById('dashboard-panel').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        });

        renderListing();
    });

    updateDataOverviewTitle();

    // Add this after your map initialization
    const fullscreenControl = new mapboxgl.FullscreenControl();
    map.addControl(fullscreenControl, 'top-right');

    // Add this function to your JavaScript section
    function closeWelcome() {
        const popup = document.getElementById('welcome-popup');
        popup.classList.add('fade-out');
        setTimeout(() => {
            popup.style.display = 'none';
        }, 400);
    }

    // Make sure your welcome popup HTML has the onclick handler
    // <button onclick="closeWelcome()">Enter Dashboard</button>

    // Add this event listener after your map initialization
    document.getElementById('style-selector').addEventListener('change', (event) => {
        const selectedStyle = event.target.value;
        const currentZoom = map.getZoom();
        const currentCenter = map.getCenter();
        
        // Get the current list of dashboard cities before style change
        const dashboardCities = agencyData.map(a => 
            a.Agency.replace('City of ', '').trim().toUpperCase()
        );
        
        map.setStyle(selectedStyle);

        // Re-add the data layers after the style change
        map.on('style.load', () => {
            // Re-add boundaries source
            map.addSource('la-boundaries', {
                'type': 'geojson',
                'data': './data/la_boundaries.geojson'
            });

            // Re-add the fill layer with filter
            map.addLayer({
                'id': 'la-fills',
                'type': 'fill',
                'source': 'la-boundaries',
                'layout': {},
                'paint': {
                    'fill-color': '#3498db',
                    'fill-opacity': 0.4
                },
                'filter': ['in', ['get', 'CITY_COMM_NAME'], ['literal', dashboardCities]]
            });

            // Re-add the border layer with filter
            map.addLayer({
                'id': 'la-borders',
                'type': 'line',
                'source': 'la-boundaries',
                'layout': {},
                'paint': {
                    'line-color': '#2980b9',
                    'line-width': 1
                }
            });

            // Add hover layer
            map.addLayer({
                'id': 'la-fills-hover',
                'type': 'fill',
                'source': 'la-boundaries',
                'paint': {
                    'fill-color': '#2ecc71',
                    'fill-opacity': 0.7
                },
                'filter': ['in', ['get', 'CITY_COMM_NAME'], ['literal', dashboardCities]]
            });

            // Re-add other layers (facilities, etc.)
            // ... rest of your layer additions ...

            // Restore the zoom and center position
            map.setZoom(currentZoom);
            map.setCenter(currentCenter);

            // Re-add event listeners
            addMapEventListeners();
        });
    });

    // Now define the function (remove the extra } that was here)
    function addMapEventListeners() {
        // Mouse events for boundaries
        map.on('mouseenter', 'la-fills', (e) => {
            map.getCanvas().style.cursor = 'pointer';
            if (e.features.length > 0) {
                map.setFilter('la-fills-hover', ['==', ['get', 'CITY_COMM_NAME'], e.features[0].properties.CITY_COMM_NAME]);
            }
        });

        map.on('mouseleave', 'la-fills', () => {
            map.getCanvas().style.cursor = '';
            map.setFilter('la-fills-hover', ['==', ['get', 'CITY_COMM_NAME'], '']);
        });

        // Mouse events for facilities
        map.on('mouseenter', 'unclustered-point', (e) => {
            map.getCanvas().style.cursor = 'pointer';
            // Your existing popup code here
        });

        map.on('mouseleave', 'unclustered-point', () => {
            map.getCanvas().style.cursor = '';
            // Your existing popup removal code here
        });

        // Add click handlers
        map.on('click', 'la-fills', (e) => {
            if (e.features.length > 0) {
                const cityName = e.features[0].properties.CITY_COMM_NAME;
                const matchingAgency = agencyData.find(a => 
                    a.Agency.replace('City of ', '').trim().toUpperCase() === cityName.trim()
                );
                
                if (matchingAgency) {
                    onAgencyClick(matchingAgency);
                    document.getElementById('dashboard-panel').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            }
        });

        map.on('click', 'clusters', (e) => {
            const features = map.queryRenderedFeatures(e.point, {
                layers: ['clusters']
            });
            const clusterId = features[0].properties.cluster_id;
            map.getSource('facilities').getClusterExpansionZoom(
                clusterId,
                (err, zoom) => {
                    if (err) return;
                    map.easeTo({
                        center: features[0].geometry.coordinates,
                        zoom: zoom
                    });
                }
            );
        });

        map.on('click', 'unclustered-point', (e) => {
            const props = e.features[0].properties;
            const matchingAgency = agencyData.find(a => a.Agency === props.Agency);
            if (matchingAgency) {
                onAgencyClick(matchingAgency);
                const matchingFacility = facilityData.find(f => 
                    f.Agency === props.Agency && 
                    f.FacilityName === props.FacilityName
                );
                
                if (matchingFacility) {
                    updateFacilityDashboard(matchingFacility);
                    const facilityLinks = document.querySelectorAll('.facility-title');
                    facilityLinks.forEach(link => {
                        if (link.textContent === props.FacilityName) {
                            link.classList.add('active');
                            link.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            link.classList.remove('active');
                        }
                    });
                }
                
                document.getElementById('dashboard-panel').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        });
    } // Close addMapEventListeners function

    // Add this event listener after your map initialization
    document.getElementById('style-selector').addEventListener('change', (event) => {
        const selectedStyle = event.target.value;
        const currentZoom = map.getZoom();
        const currentCenter = map.getCenter();
        
        map.setStyle(selectedStyle);

        // Re-add the data layers after the style change
        map.on('style.load', () => {
            // Store the dashboard cities for filtering
            const dashboardCities = agencyData.map(a => {
                return a.Agency.replace('City of ', '').trim().toUpperCase();
            });

            // Re-add boundaries source and layers
            map.addSource('la-boundaries', {
                'type': 'geojson',
                'data': './data/la_boundaries.geojson'
            });

            // Add fills layer
            map.addLayer({
                'id': 'la-fills',
                'type': 'fill',
                'source': 'la-boundaries',
                'layout': {},
                'paint': {
                    'fill-color': '#3498db',
                    'fill-opacity': 0.4
                }
            });

            // Add borders layer
            map.addLayer({
                'id': 'la-borders',
                'type': 'line',
                'source': 'la-boundaries',
                'layout': {},
                'paint': {
                    'line-color': '#2980b9',
                    'line-width': 1
                }
            });

            // Add hover layer
            map.addLayer({
                'id': 'la-fills-hover',
                'type': 'fill',
                'source': 'la-boundaries',
                'paint': {
                    'fill-color': '#2ecc71',
                    'fill-opacity': 0.7
                },
                'filter': ['==', ['get', 'CITY_COMM_NAME'], '']
            });

            // Add labels layer
            map.addLayer({
                'id': 'boundary-labels',
                'type': 'symbol',
                'source': 'la-boundaries',
                'filter': ['in', ['get', 'CITY_COMM_NAME'], ['literal', dashboardCities]],
                'layout': {
                    'text-field': ['get', 'CITY_COMM_NAME'],
                    'text-variable-anchor': ['center'],
                    'text-radial-offset': 0,
                    'text-justify': 'center',
                    'text-size': 14,
                    'text-font': ['Nunito Bold', 'Arial Unicode MS Bold'],
                    'text-padding': 3
                },
                'paint': {
                    'text-color': '#2c3e50',
                    'text-halo-color': '#ffffff',
                    'text-halo-width': 2
                }
            });

            // Re-add facilities source and layers
            map.addSource('facilities', {
                'type': 'geojson',
                'data': facilityGeoJSON,
                'cluster': true,
                'clusterMaxZoom': 14,
                'clusterRadius': 50
            });

            // Add clusters layer
            map.addLayer({
                'id': 'clusters',
                'type': 'circle',
                'source': 'facilities',
                'filter': ['has', 'point_count'],
                'paint': {
                    'circle-radius': [
                        'step',
                        ['get', 'point_count'],
                        25,
                        10,
                        30,
                        25,
                        35
                    ],
                    'circle-color': [
                        'step',
                        ['get', 'point_count'],
                        '#ff9800',
                        10,
                        '#f57c00',
                        25,
                        '#e65100'
                    ],
                    'circle-opacity': 0.9,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-opacity': 0.8
                }
            });

            // Add cluster count layer
            map.addLayer({
                'id': 'cluster-count',
                'type': 'symbol',
                'source': 'facilities',
                'filter': ['has', 'point_count'],
                'layout': {
                    'text-field': '{point_count_abbreviated}',
                    'text-font': ['DIN Offc Pro Bold', 'Arial Unicode MS Bold'],
                    'text-size': 16
                },
                'paint': {
                    'text-color': '#ffffff'
                }
            });

            // Add unclustered point layer
            map.addLayer({
                'id': 'unclustered-point',
                'type': 'circle',
                'source': 'facilities',
                'filter': ['!', ['has', 'point_count']],
                'paint': {
                    'circle-color': '#ff9800',
                    'circle-radius': 8,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff',
                    'circle-opacity': 0.9,
                    'circle-stroke-opacity': 0.8
                }
            });

            // Apply filters to boundary layers
            map.setFilter('la-fills', ['in', ['get', 'CITY_COMM_NAME'], ['literal', dashboardCities]]);
            map.setFilter('la-borders', ['in', ['get', 'CITY_COMM_NAME'], ['literal', dashboardCities]]);

            // Restore the zoom and center position
            map.setZoom(currentZoom);
            map.setCenter(currentCenter);

            // Re-add event listeners
            addMapEventListeners();
        });
    }); // Close the style-selector event listener

    // Add this event listener after your map initialization
    document.getElementById('style-selector').addEventListener('change', (event) => {
        const selectedStyle = event.target.value;
        const currentZoom = map.getZoom();
        const currentCenter = map.getCenter();
        
        map.setStyle(selectedStyle);

        // Re-add the data layers after the style change
        map.on('style.load', () => {
            // Store the dashboard cities for filtering
            const dashboardCities = agencyData.map(a => {
                return a.Agency.replace('City of ', '').trim().toUpperCase();
            });

            // Re-add boundaries source and layers
            map.addSource('la-boundaries', {
                'type': 'geojson',
                'data': './data/la_boundaries.geojson'
            });

            // Add fills layer
            map.addLayer({
                'id': 'la-fills',
                'type': 'fill',
                'source': 'la-boundaries',
                'layout': {},
                'paint': {
                    'fill-color': '#3498db',
                    'fill-opacity': 0.4
                }
            });

            // Add borders layer
            map.addLayer({
                'id': 'la-borders',
                'type': 'line',
                'source': 'la-boundaries',
                'layout': {},
                'paint': {
                    'line-color': '#2980b9',
                    'line-width': 1
                }
            });

            // Add hover layer
            map.addLayer({
                'id': 'la-fills-hover',
                'type': 'fill',
                'source': 'la-boundaries',
                'paint': {
                    'fill-color': '#2ecc71',
                    'fill-opacity': 0.7
                },
                'filter': ['==', ['get', 'CITY_COMM_NAME'], '']
            });

            // Add labels layer
            map.addLayer({
                'id': 'boundary-labels',
                'type': 'symbol',
                'source': 'la-boundaries',
                'filter': ['in', ['get', 'CITY_COMM_NAME'], ['literal', dashboardCities]],
                'layout': {
                    'text-field': ['get', 'CITY_COMM_NAME'],
                    'text-variable-anchor': ['center'],
                    'text-radial-offset': 0,
                    'text-justify': 'center',
                    'text-size': 14,
                    'text-font': ['Nunito Bold', 'Arial Unicode MS Bold'],
                    'text-padding': 3
                },
                'paint': {
                    'text-color': '#2c3e50',
                    'text-halo-color': '#ffffff',
                    'text-halo-width': 2
                }
            });

            // Re-add facilities source and layers
            map.addSource('facilities', {
                'type': 'geojson',
                'data': facilityGeoJSON,
                'cluster': true,
                'clusterMaxZoom': 14,
                'clusterRadius': 50
            });

            // Add clusters layer
            map.addLayer({
                'id': 'clusters',
                'type': 'circle',
                'source': 'facilities',
                'filter': ['has', 'point_count'],
                'paint': {
                    'circle-radius': [
                        'step',
                        ['get', 'point_count'],
                        25,
                        10,
                        30,
                        25,
                        35
                    ],
                    'circle-color': [
                        'step',
                        ['get', 'point_count'],
                        '#ff9800',
                        10,
                        '#f57c00',
                        25,
                        '#e65100'
                    ],
                    'circle-opacity': 0.9,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-opacity': 0.8
                }
            });

            // Add cluster count layer
            map.addLayer({
                'id': 'cluster-count',
                'type': 'symbol',
                'source': 'facilities',
                'filter': ['has', 'point_count'],
                'layout': {
                    'text-field': '{point_count_abbreviated}',
                    'text-font': ['DIN Offc Pro Bold', 'Arial Unicode MS Bold'],
                    'text-size': 16
                },
                'paint': {
                    'text-color': '#ffffff'
                }
            });

            // Add unclustered point layer
            map.addLayer({
                'id': 'unclustered-point',
                'type': 'circle',
                'source': 'facilities',
                'filter': ['!', ['has', 'point_count']],
                'paint': {
                    'circle-color': '#ff9800',
                    'circle-radius': 8,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff',
                    'circle-opacity': 0.9,
                    'circle-stroke-opacity': 0.8
                }
            });

            // Apply filters to boundary layers
            map.setFilter('la-fills', ['in', ['get', 'CITY_COMM_NAME'], ['literal', dashboardCities]]);
            map.setFilter('la-borders', ['in', ['get', 'CITY_COMM_NAME'], ['literal', dashboardCities]]);

            // Restore the zoom and center position
            map.setZoom(currentZoom);
            map.setCenter(currentCenter);

            // Re-add event listeners
            addMapEventListeners();
        }); // Close style.load
    }); // Close addEventListener

    // Function to geocode a single address
    async function geocodeAddress(address) {
        const accessToken = mapboxgl.accessToken;
        const query = encodeURIComponent(address + ', CA');
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${query}.json?access_token=${accessToken}&country=US&types=address`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.features && data.features.length > 0) {
                return data.features[0].center;
            }
            return null;
        } catch (error) {
            console.error('Geocoding error:', error);
            return null;
        }
    }

    // Function to update facility coordinates
    async function updateFacilityCoordinates() {
        for (let facility of facilityData) {
            const address = `${facility.Address}`;
            const coordinates = await geocodeAddress(address);
            if (coordinates) {
                facility.Longitude = coordinates[0];
                facility.Latitude = coordinates[1];
            }
        }
        
        // Recreate the GeoJSON with updated coordinates
        facilityGeoJSON = {
            type: 'FeatureCollection',
            features: facilityData.map(f => ({
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [f.Longitude, f.Latitude]
                },
                properties: {
                    Agency: f.Agency,
                    FacilityName: f.FacilityName,
                    Address: f.Address
                }
            }))
        };

        // Update the map source
        if (map.getSource('facilities')) {
            map.getSource('facilities').setData(facilityGeoJSON);
        }
    }

    // Call this function after your data is loaded
    updateFacilityCoordinates();
    </script>
</body>
</html>