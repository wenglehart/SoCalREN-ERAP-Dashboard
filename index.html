<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>SoCalREN's ERAP Dashboard</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <!-- Mapbox GL JS and Geocoder Plugin Versions -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto:wght@300;400&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css" type="text/css">

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background-color: #ffffff; /* White base */
        }

        /* ================= */
        /*   Password Modal  */
        /* ================= */
        #password-modal {
            position: fixed;
            top: 0; 
            left: 0;
            width: 100vw; 
            height: 100vh; 
            background-color: rgba(0,0,0,0.6);
            display: flex; 
            align-items: center; 
            justify-content: center;
            z-index: 10001; /* above everything */
        }
        #password-modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        #password-modal-content h2 {
            font-family: 'Montserrat', sans-serif;
            margin-bottom: 20px;
        }
        #password-input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #ccc;
            margin-bottom: 15px;
        }
        #password-submit {
            background-color: #555;
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        #password-submit:hover {
            background-color: #333;
        }

        /* HEADER STYLES */
        /* Darker, more professional than bright teal */
        header {
            width: 100%;
            background-color: #2D3E4F; 
            color: #ffffff;
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            height: 60px;
            box-sizing: border-box;
        }
        .header-left {
            flex: 0 0 auto;
        }
        .header-left h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 20px;
            margin: 0;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
            justify-content: flex-end;
            max-width: 800px;
            margin-left: 40px;
        }
        .geocoder-container {
            flex: 1;
            max-width: 400px;
            min-width: 200px;
        }
        .style-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 4px;
        }
        .style-selector label {
            font-size: 14px;
            white-space: nowrap;
        }
        .style-selector select {
            background-color: transparent;
            color: #ecf0f1;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        .style-selector select:hover {
            border-color: rgba(255, 255, 255, 0.5);
        }
        .style-selector select option {
            background-color: #2D3E4F;
            color: #ecf0f1;
        }
        .mapboxgl-ctrl-geocoder {
            box-shadow: none !important;
            width: 100% !important;
            max-width: none !important;
            font-family: 'Montserrat', sans-serif !important;
            border-radius: 4px;
        }
        .mapboxgl-ctrl-geocoder--input {
            height: 36px !important;
            padding: 6px 35px !important;
        }

        /* MAIN CONTAINER */
        #container {
            flex: 1;
            display: flex;
            flex-direction: row;
            position: relative;
            overflow: hidden;
            height: calc(100vh - 60px);
        }
        #map {
            position: relative;
            flex: 3;
            min-height: 400px;
            width: 100%;
        }

        .map-overlay {
            position: relative;
            flex: 1;
            font: 14px/22px 'Roboto', sans-serif;
            background: linear-gradient(to bottom, #fff, #f8f9fa);
            border-left: 1px solid rgba(0,0,0,0.1);
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        fieldset {
            background: #f0f0f0;
            border: none;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        input[type="text"], input[type="number"], input[type="range"] {
            border: 1px solid #ccc;
            width: 100%;
            border-radius: 5px;
            padding: 8px;
            box-sizing: border-box;
            margin-bottom: 10px;
            font-size: 14px;
        }

        /* FILTER AND LISTING STYLES */
        #agency-filter {
            position: relative;
        }
        #agency-suggestions {
            position: absolute;
            background: #fff;
            border: 1px solid #ccc;
            width: calc(100% - 16px);
            margin: 0;
            padding: 0;
            list-style: none;
            max-height: 150px;
            overflow-y: auto;
            z-index: 9999;
        }
        #agency-suggestions li {
            padding: 8px;
            cursor: pointer;
        }
        #agency-suggestions li:hover {
            background: #e0f7fa;
            color: #00796b;
        }
        .listing {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        .listing a {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            color: #404;
            text-decoration: none;
            display: block;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
            font-size: 14px;
        }
        .listing a:hover {
            background: #e0f7fa;
            color: #00796b;
        }

        #listing {
            position: relative;
            height: auto;
            min-height: 200px;
            max-height: none;
            overflow-y: visible;
            padding: 10px;
            margin-top: 10px;
        }
        #listing h4 {
            margin: 10px 0;
            color: #2c3e50;
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            margin: 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            font-weight: bold;
        }
        .filters {
            margin-bottom: 10px;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        .filters label {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .filters input[type=checkbox] {
            margin-right: 5px;
        }
        .filters select {
            width: 100%;
            margin-bottom: 10px;
            font-size: 12px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        /* DASHBOARD */
        .dashboard {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 30px;
            font-size: 14px;
            margin-top: 20px;
            height: auto;
            overflow-y: visible;
        }
        .dashboard::-webkit-scrollbar {
            width: 8px;
        }
        .dashboard::-webkit-scrollbar-track {
            background: #f5f6fa;
            border-radius: 4px;
        }
        .dashboard::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 4px;
        }
        .dashboard h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 20px;
            margin-top: 0;
            padding-bottom: 15px;
            margin-bottom: 25px;
            border-bottom: 2px solid #ecf0f1;
            font-weight: bold;
            color: #2c3e50;
        }
        .dashboard h4 {
            margin-top: 30px;
            margin-bottom: 20px;
            font-size: 16px;
            color: #34495e;
        }
        .metric {
            margin-bottom: 20px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .metric .metric-label {
            margin-right: 15px;
        }
        #agency-data, #facility-data {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }
        #back-button {
            background-color: #2D3E4F;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            transition: background-color 0.2s ease;
        }
        #back-button:hover {
            background-color: #4a5c6b;
        }
        #back-button::before {
            content: "←";
            font-size: 16px;
        }
        .cog-section {
            margin-bottom: 10px;
        }
        .cog-header {
            background: #2D3E4F;
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
            color: #ffffff;
            margin-bottom: 8px;
        }
        .cog-header::after {
            content: '▼';
            font-size: 12px;
            color: #ffffff;
            transition: transform 0.3s ease;
            margin-left: 10px;
            opacity: 0.9;
        }
        .cog-header.expanded::after {
            transform: rotate(180deg);
        }
        .cog-header:hover {
            background: #455463;
        }
        .agency-list {
            margin-top: 5px;
            margin-bottom: 15px;
            padding-left: 10px;
            height: auto;
            overflow-y: visible;
        }
        .agency-title {
            font-size: 14px;
            font-weight: normal;
            margin: 5px 0;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s ease;
            color: #2c3e50;
            background: #f8f9fa;
        }
        .agency-title:hover {
            background: #e0f7fa;
            color: #00796b;
            transform: translateX(5px);
        }
        .facility-title {
            display: block;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: #2c3e50;
            text-decoration: none;
            border: 1px solid #e9ecef;
        }
        .facility-title:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        #listing {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            margin-top: 10px;
        }
        #no-facilities-msg {
            padding: 10px;
            color: #666;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 4px;
            margin: 10px 0;
        }
        .style-overlay {
            background-color: #2D3E4F;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #ecf0f1;
            margin-right: 10px;
        }
        .style-overlay label {
            display: block;
            margin-bottom: 5px;
            font-weight: normal;
        }
        .style-overlay select {
            width: 100%;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            color: #000;
        }

        /* WELCOME POPUP */
        #welcome-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(44, 62, 80, 0.90);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.4s ease;
            backdrop-filter: blur(5px);
        }
        #welcome-popup.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        #welcome-popup .welcome-content {
            background: white;
            padding: 60px 70px;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            position: relative;
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        #welcome-popup h1 {
            font-family: 'Nunito', sans-serif;
            font-size: 23px;
            margin-bottom: 30px;
            color: #2c3e50;
            line-height: 1.4;
            font-weight: 700;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 20px;
        }
        #welcome-popup h1 .title-line {
            display: block;
            margin-bottom: 5px;
        }
        #welcome-popup h2 {
            font-family: 'Nunito', sans-serif;
            font-size: 22px;
            color: #F05A28; 
            margin: 30px 0 25px;
            font-weight: 600;
            line-height: 1.4;
            text-align: center;
        }
        #welcome-popup p {
            font-family: 'Nunito', sans-serif;
            font-size: 17px;
            margin-bottom: 25px;
            color: #546e7a;
            line-height: 1.8;
            font-weight: 400;
            text-align: center;
            max-width: 650px;
            margin-left: auto;
            margin-right: auto;
        }
        #welcome-popup button {
            background-color: #2D3E4F;
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 17px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Nunito', sans-serif;
            display: block;
            margin: 40px auto 0;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        #welcome-popup button:hover {
            background-color: #455463;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        #welcome-popup button:active {
            transform: translateY(0);
        }
        @media (max-width: 768px) {
            #welcome-popup .welcome-content {
                padding: 40px;
                width: 85%;
            }
            #welcome-popup h1 {
                font-size: 28px;
            }
            #welcome-popup h2 {
                font-size: 20px;
            }
            #welcome-popup p {
                font-size: 16px;
            }
            #welcome-popup button {
                padding: 14px 35px;
                font-size: 16px;
            }
        }
        /* RESPONSIVE */
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            #map {
                flex: none;
                height: 50vh;
            }
            .map-overlay {
                position: relative;
                transform: none !important;
            }
        }
        #intro-section {
            margin-top: 20px;
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        #intro-section h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-family: 'Montserrat', sans-serif;
            color: #2c3e50;
        }
        #intro-section p {
            margin: 0 0 15px 0;
            font-size: 14px;
            line-height: 1.6;
            color: #34495e;
        }
        #intro-section ul {
            list-style: inside square;
            margin: 0 0 15px 0;
            padding: 0;
        }
        #intro-section li {
            margin-bottom: 8px;
            font-size: 14px;
            color: #34495e;
        }

        /* FACILITY POPUPS */
        .facility-popup .mapboxgl-popup-content {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-family: 'Montserrat', sans-serif;
            font-size: 13px;
            line-height: 1.4;
        }
        .facility-popup .mapboxgl-popup-tip {
            border-top-color: rgba(255, 255, 255, 0.95);
        }
        .facility-title.active {
            background: #fff3e0;
            border-left: 3px solid #F05A28; 
            transform: translateX(5px);
        }
        .mapboxgl-ctrl-geocoder {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            font-family: 'Montserrat', sans-serif !important;
        }
        .mapboxgl-ctrl-geocoder--input {
            font-family: 'Roboto', sans-serif !important;
        }
        .mapboxgl-ctrl-geocoder--suggestion {
            font-family: 'Roboto', sans-serif !important;
        }
        .fullscreen-container {
            margin-left: 10px;
        }
        .mapboxgl-ctrl-fullscreen {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        .mapboxgl-ctrl-fullscreen:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        #populationChartContainer {
            height: 300px;
            margin-bottom: 20px;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #populationChart {
            width: 100%;
            height: 100%;
        }
        .mapboxgl-map.mapboxgl-fullscreen {
            height: 100vh !important;
        }
        #container.mapboxgl-fullscreen {
            height: 100vh !important;
            width: 100vw !important;
        }
        .header-left img {
            transition: transform 0.3s ease;
        }
        .header-left img:hover {
            transform: scale(1.05);
        }
        .map-overlay {
            background: linear-gradient(to bottom, #fff, #f8f9fa);
            border-left: 1px solid rgba(0,0,0,0.1);
            padding: 25px;
        }
        .dashboard {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        .dashboard:hover {
            transform: translateY(-2px);
        }
        .facility-title {
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        .facility-title:hover {
            background: linear-gradient(to right, #e3f2fd, transparent);
            border-left-color: #2196f3;
        }
        .mapboxgl-popup {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @media (max-width: 768px) {
            .header-controls {
                flex-wrap: wrap;
                gap: 10px;
            }
            .map-overlay {
                height: 50vh;
                overflow-y: auto;
            }
        }
        :focus {
            outline: 2px solid #2196f3;
            outline-offset: 2px;
        }
        [role="button"] {
            cursor: pointer;
        }
        .search-box {
            background: #fff;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 12px 16px;
            width: 100%;
            transition: all 0.3s ease;
        }
        .search-box:focus {
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33,150,243,0.1);
        }
        .population-filter {
            margin-top: 15px;
        }
        .population-filter label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #2c3e50;
        }
        .population-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .population-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: calc(50% - 15px);
        }
        .population-inputs span {
            color: #666;
            font-size: 14px;
        }
        .population-input:focus {
            border-color: #2196f3;
            outline: none;
            box-shadow: 0 0 0 2px rgba(33,150,243,0.1);
        }
    </style>
</head>
<body>

<!-- PASSWORD GATE MODAL -->
<div id="password-modal">
    <div id="password-modal-content">
        <h2>Please Enter Password</h2>
        <input type="password" id="password-input" placeholder="Password">
        <button id="password-submit">Submit</button>
    </div>
</div>

<header>
    <div class="header-left">
        <a href="https://socalren.org/" target="_blank">
            <img src="images/socalren_erapdashboard.png" alt="SoCalREN ERAP Logo" style="height: 50px;">
        </a>
    </div>
    <div class="header-controls">
        <div class="geocoder-container" id="geocoder"></div>
        <div class="style-selector">
            <label for="style-selector">Map Style</label>
            <select id="style-selector">
                <option value="mapbox://styles/wengle1/cm4m4sedc001v01sqdtx0cioz" selected>Custom Style</option>
                <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
                <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
                <option value="mapbox://styles/mapbox/light-v10">Light</option>
                <option value="mapbox://styles/mapbox/dark-v10">Dark</option>
                <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
            </select>
        </div>
        <div class="fullscreen-container" id="fullscreen-control"></div>
    </div>
</header>
<div id="container">
    <div id="map"></div>
    <div class="map-overlay" id="dashboard-panel">
        <fieldset>
            <input id="agency-filter" type="text" placeholder="Search for an agency">
            <ul id="agency-suggestions" style="display:none;"></ul>
        </fieldset>

        <fieldset class="filters" id="agency-filters">
            <legend>Agency Filters</legend>
            <label>
                <input type="checkbox" id="dac-filter"> 
                Show only Underserved and/or Hard to Reach Communities
            </label>
            <label>
                <input type="checkbox" id="ces90-filter"> 
                Show only agencies with CalEnviroScreen Score > 90
            </label>
            
            <div class="population-filter">
                <label for="population-min">Population Range:</label>
                <div class="population-inputs">
                    <input type="number" 
                           id="population-min" 
                           placeholder="Min Population" 
                           min="0" 
                           class="population-input">
                    <span>to</span>
                    <input type="number" 
                           id="population-max" 
                           placeholder="Max Population" 
                           min="0" 
                           class="population-input">
                </div>
            </div>
        </fieldset>

        <fieldset class="filters" id="facility-filters" style="display:none;">
            <legend>Facility Filters</legend>
            <label>
                <input type="checkbox" id="pv-filter"> 
                Show only facilities with PV or Battery Storage Capabilities
            </label>
            <label>
                <input type="checkbox" id="ev-filter"> 
                Show only facilities with existing EV chargers
            </label>
            <label>
                <input type="checkbox" id="cooling-filter"> 
                Show only facilities with Existing Resilience Designation
            </label>
        </fieldset>

        <div id="listing" class="listing"></div>

        <div id="intro-section">
            <h4>Welcome to SoCalREN's ERAP Dashboard</h4>
            <p>
                This dashboard provides insights into public agencies' energy resilience planning efforts across Southern California that have received support from the SoCalREN Public Agency Programs. Use the filters above to find agencies by name, select a council of governments, or set population thresholds. Click on an agency name to view detailed metrics and access facility information.
            </p>
            <p>
                The data displayed here includes key metrics collected throughout an agency's involvement in the ERAP program. The dashboard can help you understand community needs, identify facilities equipped with Electric Vehicle chargers, Solar or Battery Storage, and plans for resilience improvements.
            </p>
            
            <h4>Getting Started</h4>
            <ul>
                <li>Use the "Search for an agency" box to quickly locate a participating agency.</li>
                <li>Adjust the range filter to focus on agencies with larger populations.</li>
                <li>Click an agency name to view its details and a list of associated facilities that were assessed by SoCalREN.</li>
            </ul>
            
            <h4>What is ERAP?</h4>
            <p>
                SoCalREN's Energy Resilience Action Plan (ERAP) program aims to address the growing impacts of climate change. Developed in collaboration with regional partners, the ERAP program enhances the energy resilience of critical infrastructure and future resilience hub locations for public agencies. By incorporating data-driven analysis and stakeholder input into the planning and development process, ERAP supports agencies in developing an actionable roadmap for near-term to long-term energy resilience strategies that will best serve the community.
            </p>
            <p><em>This dashboard is a living tool designed to evolve and improve as we progress through the program. We welcome any feedback you may have, as it will help shape future versions.</em></p>
        </div>

        <div class="dashboard" id="dashboard" style="display: none;">
            <h3 id="data-overview-title">Data Overview</h3>
        
            <div id="agency-data" style="display:none; margin-top:20px;">
                <h4>Agency-Level Data</h4>
                <div class="metric">
                    <span class="metric-label">Underserved and/or  Hard to Reach:</span>
                    <span class="metric-value" id="agency-underserved">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">CalEnviroScreen Score:</span>
                    <span class="metric-value" id="agency-calenviroscore">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Pollution Burden Percentile:</span>
                    <span class="metric-value" id="agency-pollutionburden">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Population:</span>
                    <span class="metric-value" id="agency-population">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">% Children and Seniors:</span>
                    <span class="metric-value" id="agency-children-seniors">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">AgencyArea (sq miles):</span>
                    <span class="metric-value" id="agency-area">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Population Density (per sq. mile):</span>
                    <span class="metric-value" id="agency-density">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Extreme Heat Days (days/year):</span>
                    <span class="metric-value" id="agency-heat-days">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Average Household Income ($):</span>
                    <span class="metric-value" id="agency-income">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">% Low-Income Census Tracts:</span>
                    <span class="metric-value" id="agency-low-income">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label"># of Electric Circuits:</span>
                    <span class="metric-value" id="agency-circuits">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Annual  Consumption (kWh):</span>
                    <span class="metric-value" id="agency-kwh">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Annual Consumption (Therms):</span>
                    <span class="metric-value" id="agency-therms">Not yet available</span>
                </div>
            </div>
        
            <div id="facility-data" style="display:none; margin-top:20px;">
                <h4>Facility-Level Data</h4>
                <div class="metric">
                    <span class="metric-label">Year Built:</span>
                    <span class="metric-value" id="facility-year">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Gross Floor Area (sq ft):</span>
                    <span class="metric-value" id="facility-sqft">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Walkability:</span>
                    <span class="metric-value" id="facility-walkability">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Existing Resilience Designation:</span>
                    <span class="metric-value" id="facility-resilience">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Existing EV Chargers:</span>
                    <span class="metric-value" id="facility-ev">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Number of Planned EV Chargers:</span>
                    <span class="metric-value" id="facility-planned-ev">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Exisiting PV or Battery Storage Capabilities:</span>
                    <span class="metric-value" id="facility-pv">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Planned PV (hours of autonomy):</span>
                    <span class="metric-value" id="facility-planned-pv">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Planned Battery Storage (hours of autonomy):</span>
                    <span class="metric-value" id="facility-planned-battery">Not yet available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Building Type:</span>
                    <span class="metric-value" id="facility-type">Not yet available</span>
                </div>
            </div>
        </div>
    </div>

    <div id="welcome-popup">
        <div class="welcome-content">
            <img src="images/SoCalREN_Logo_2017_PRIMARY.png" alt="SoCalREN Logo" style="width: 500px; margin-bottom: 20px;">
            <h1>
                <span class="title-line">Welcome to Southern California Regional Energy Network (SoCalREN)'s</span>
                <span class="title-line">Energy Resilience Action Plan (ERAP) Dashboard</span>
            </h1>
            <h2>Explore energy resilience planning efforts across Southern California</h2>
            <p>This interactive dashboard provides comprehensive information about facilities and agencies participating in SoCalREN's ERAP program. Use the map to explore geographical data, or search for specific details.</p>
            <button onclick="closeWelcome()">Enter Dashboard</button>
        </div>
    </div>

</div>

<div id="loading-spinner" style="display: flex; justify-content: center; align-items: center; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px; color: #2c3e50; z-index: 999;">
    <i class="fas fa-spinner fa-spin"></i> Loading...
</div>

<!-- Include external scripts -->
<script src="https://unpkg.com/@mapbox/mapbox-sdk/umd/mapbox-sdk.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>

<script>
// ============
// PASSWORD GATE
// ============
const passwordModal = document.getElementById('password-modal');
const passwordInput = document.getElementById('password-input');
const passwordSubmit = document.getElementById('password-submit');

// Show password modal on load
document.addEventListener('DOMContentLoaded', () => {
    passwordModal.style.display = 'flex';
});

passwordSubmit.addEventListener('click', () => {
    if (passwordInput.value === 'SoCalREN2025') {
        // Correct password => hide modal, show welcome popup
        passwordModal.style.display = 'none';
    } else {
        // Wrong => reload
        location.reload();
    }
});

// ============
// MAP AND DATA
// ============

// Hard-coded AGENCIES data
const agenciesData = [
    /* Same as before, omitted for brevity; 
       insert your final agencies data array here exactly 
       (or the version from the prior code) */
];

// Hard-coded FACILITIES data
const facilitiesData = [
    /* Same as before, omitted for brevity; 
       insert your final facilities data array here 
       (or from the prior code) */
];

function normalizeValue(value) {
    if (!value) return "Not yet available";
    const valStr = String(value).trim();
    if (valStr.toUpperCase() === "N/A") {
        return "Not yet available";
    }
    return value;
}

// Mapbox
mapboxgl.accessToken = 'pk.eyJ1Ijoid2VuZ2xlMSIsImEiOiJjbHBtaWx0N2IwMGljMmxwNjBsMnU4a2E4In0.Dzf3G-WBKzDfgnXsGHiMXw';
let map;

function initMap() {
    map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/wengle1/cm4m4sedc001v01sqdtx0cioz',
        center: [-118.2437, 34.0522],
        zoom: 10,
        pitch: 35,
        maxBounds: [[-119.5, 33.2], [-117.0, 34.8]]
    });

    map.addControl(new mapboxgl.FullscreenControl({
        container: document.querySelector('#container')
    }), 'top-right');

    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    // We'll load boundaries & facilities in "map.on('load')" + also handle style changes
    map.on('load', () => {
        addLayersAndSources();
        document.getElementById('loading-spinner').style.display = 'none';
    });

    map.on('styledata', () => {
        // Re-check if sources/layers exist. If not, re-add them.
        if (!map.getSource('la-boundaries') || !map.getSource('facilities')) {
            addLayersAndSources();
        }
    });
}

function addLayersAndSources() {
    // 1) Add LA boundaries
    fetch('data/la_boundaries.geojson')
        .then(resp => resp.json())
        .then(geojson => {
            if (!map.getSource('la-boundaries')) {
                map.addSource('la-boundaries', {
                    type: 'geojson',
                    data: geojson
                });
            }
            // Remove old layers if they exist
            if (map.getLayer('la-boundaries-extrusion')) {
                map.removeLayer('la-boundaries-extrusion');
            }

            // 3D fill-extrusion for boundaries
            map.addLayer({
                id: 'la-boundaries-extrusion',
                type: 'fill-extrusion',
                source: 'la-boundaries',
                paint: {
                    'fill-extrusion-color': [
                        'case',
                        ['boolean', ['feature-state', 'hover'], false],
                        '#78B84B', // highlight green
                        '#9A5CA7'  // default purple
                    ],
                    'fill-extrusion-height': 500,  // static height for 3D effect
                    'fill-extrusion-base': 0,
                    'fill-extrusion-opacity': 0.4
                }
            });

            // Hover/click logic
            let hoveredId = null;
            map.on('mousemove', 'la-boundaries-extrusion', e => {
                map.getCanvas().style.cursor = 'pointer';
                if (e.features.length > 0) {
                    if (hoveredId) {
                        map.setFeatureState({ source: 'la-boundaries', id: hoveredId }, { hover: false });
                    }
                    hoveredId = e.features[0].id;
                    map.setFeatureState({ source: 'la-boundaries', id: hoveredId }, { hover: true });

                    // Show a stylized popup
                    const props = e.features[0].properties;
                    const cityName = props.CITY_COMM_NAME || 'Not yet available';
                    boundaryHoverPopup
                        .setLngLat(e.lngLat)
                        .setHTML(`<div style="font-family: 'Montserrat'; font-size:13px;">
                                    <strong>${cityName}</strong>
                                 </div>`)
                        .addTo(map);
                }
            });
            map.on('mouseleave', 'la-boundaries-extrusion', () => {
                map.getCanvas().style.cursor = '';
                if (hoveredId) {
                    map.setFeatureState({ source: 'la-boundaries', id: hoveredId }, { hover: false });
                }
                hoveredId = null;
                boundaryHoverPopup.remove();
            });
            map.on('click', 'la-boundaries-extrusion', e => {
                if (!e.features.length) return;
                const props = e.features[0].properties;
                const cityName = props.CITY_COMM_NAME;
                // Attempt to match cityName to one of our agencies
                if (cityName) {
                    // In some boundary data, cityName might be "City of X"
                    // We'll try a direct match first
                    let matchedAgency = agenciesData.find(a => a.Agency.toLowerCase() === cityName.toLowerCase());
                    // If not found, attempt partial match e.g. "City of Bell Gardens" => "City of Bell Gardens"
                    if (!matchedAgency) {
                        matchedAgency = agenciesData.find(a => {
                            // e.g. boundary says "City of El Segundo", CSV has "City of El Segundo"
                            return cityName.toLowerCase().includes(a.Agency.toLowerCase());
                        });
                    }
                    if (matchedAgency) {
                        const facs = facilitiesData.filter(f => f.Agency === matchedAgency.Agency);
                        showFacilities(matchedAgency, facs);
                        document.getElementById('dashboard-panel').scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                }
            });
        })
        .catch(err => console.error('Error loading boundaries:', err));

    // 2) Add Facilities
    if (!map.getSource('facilities')) {
        const facilityGeoJSON = facilitiesToGeoJSON();
        map.addSource('facilities', {
            type: 'geojson',
            data: facilityGeoJSON,
            cluster: true,
            clusterMaxZoom: 14,
            clusterRadius: 50
        });
    }

    // Layers for facilities
    if (!map.getLayer('clusters')) {
        map.addLayer({
            id: 'clusters',
            type: 'circle',
            source: 'facilities',
            filter: ['has', 'point_count'],
            paint: {
                'circle-radius': [
                    'step',
                    ['get', 'point_count'],
                    25,
                    10,
                    30,
                    25,
                    35
                ],
                'circle-color': [
                    'step',
                    ['get', 'point_count'],
                    '#F37B43',  // orange
                    10,
                    '#F05A28',  // reddish-orange
                    25,
                    '#9A5CA7'   // purple
                ],
                'circle-opacity': 0.9,
                'circle-stroke-width': 2,
                'circle-stroke-color': '#ffffff',
                'circle-stroke-opacity': 0.8
            }
        });
    }
    if (!map.getLayer('cluster-count')) {
        map.addLayer({
            id: 'cluster-count',
            type: 'symbol',
            source: 'facilities',
            filter: ['has', 'point_count'],
            layout: {
                'text-field': '{point_count_abbreviated}',
                'text-font': ['DIN Offc Pro Bold', 'Arial Unicode MS Bold'],
                'text-size': 16,
                'text-allow-overlap': true
            },
            paint: {
                'text-color': '#ffffff',
                'text-halo-color': 'rgba(0, 0, 0, 0.2)',
                'text-halo-width': 1
            }
        });
    }
    if (!map.getLayer('unclustered-point')) {
        map.addLayer({
            id: 'unclustered-point',
            type: 'circle',
            source: 'facilities',
            filter: ['!', ['has', 'point_count']],
            paint: {
                'circle-color': '#F37B43',
                'circle-radius': 8,
                'circle-stroke-width': 2,
                'circle-stroke-color': '#ffffff',
                'circle-opacity': 0.9,
                'circle-stroke-opacity': 0.8
            }
        });
    }
}

// Convert lat/long from strings
function parseCoordinate(coordStr) {
    if (!coordStr || coordStr.toString().trim().toUpperCase() === 'NOT YET AVAILABLE') return null;
    const parts = coordStr.split('°');
    if (parts.length < 2) return null;
    let value = parseFloat(parts[0].trim());
    let direction = parts[1].trim().toUpperCase();
    if (direction.startsWith('S') || direction.startsWith('W')) {
        value = -value;
    }
    return value;
}

// Convert facilities to GeoJSON
function facilitiesToGeoJSON() {
    const features = facilitiesData.map(f => {
        const lat = parseCoordinate(f["Latitude"]);
        const lon = parseCoordinate(f["Longitude"]);
        if (lat === null || lon === null) {
            return null; 
        }
        return {
            type: 'Feature',
            properties: { ...f },
            geometry: {
                type: 'Point',
                coordinates: [lon, lat]
            }
        };
    }).filter(Boolean);
    return { type: 'FeatureCollection', features };
}

// POPUP for boundary hover
const boundaryHoverPopup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false,
    anchor: 'top',
    offset: [0, 0],
    className: 'boundary-popup'
});

// POPUP for facility hover
const facilityHoverPopup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false,
    anchor: 'bottom',
    offset: [0, -10],
    className: 'facility-popup'
});

// Initialize the map
initMap();

// On cluster click => zoom
if (typeof map !== 'undefined') {
    // This will wait until the map is ready
    if (map) {
        map.on('click', 'clusters', e => {
            const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
            const clusterId = features[0].properties.cluster_id;
            map.getSource('facilities').getClusterExpansionZoom(clusterId, (err, zoom) => {
                if (err) return;
                map.easeTo({
                    center: features[0].geometry.coordinates,
                    zoom: zoom
                });
            });
        });

        // Add facility hover for unclustered
        map.on('mouseenter', 'unclustered-point', e => {
            map.getCanvas().style.cursor = 'pointer';
            const props = e.features[0].properties;
            const desc = `
                <strong>${props["Facility Name"]}</strong><br>
                Building Type: ${normalizeValue(props["Building Type"])}<br>
                EV: ${normalizeValue(props["Existing EV Chargers"])}<br>
                PV: ${normalizeValue(props["Exisiting PV or Battery Storage Capabilities"])}
            `;
            facilityHoverPopup.setLngLat(e.lngLat).setHTML(desc).addTo(map);
        });
        map.on('mouseleave', 'unclustered-point', () => {
            map.getCanvas().style.cursor = '';
            facilityHoverPopup.remove();
        });

        map.on('click', 'unclustered-point', e => {
            const props = e.features[0].properties;
            const matchedAgency = agenciesData.find(a => a.Agency === props["Agency"]);
            if (matchedAgency) {
                const facs = facilitiesData.filter(f => f.Agency === matchedAgency.Agency);
                showFacilities(matchedAgency, facs);
                showFacilityDetails(props["Agency"], props["Facility Name"]);
                document.getElementById('dashboard-panel').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });

        // Cursor changes for clusters
        map.on('mouseenter', 'clusters', () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'clusters', () => {
            map.getCanvas().style.cursor = '';
        });
    }
}

// RENDER LISTING
function renderListing() {
    const listingElement = document.getElementById('listing');
    const introSection = document.getElementById('intro-section');
    const agencyFilters = document.getElementById('agency-filters');
    const facilityFilters = document.getElementById('facility-filters');
    if (!listingElement) return;

    listingElement.innerHTML = '';
    introSection.style.display = 'block';
    agencyFilters.style.display = 'block';
    facilityFilters.style.display = 'none';

    // Group agencies by Council
    const groupByCOG = {};
    agenciesData.forEach(a => {
        const cog = a["Council of Government"];
        if (!groupByCOG[cog]) groupByCOG[cog] = [];
        groupByCOG[cog].push(a);
    });

    for (const [cog, agencies] of Object.entries(groupByCOG)) {
        if (agencies.length > 0) {
            const cogSection = document.createElement('div');
            cogSection.className = 'cog-section';

            const cogHeader = document.createElement('div');
            cogHeader.className = 'cog-header';
            cogHeader.textContent = cog;
            cogHeader.addEventListener('click', () => {
                cogHeader.classList.toggle('expanded');
                agencyList.style.display = agencyList.style.display === 'none' ? 'block' : 'none';
            });

            const agencyList = document.createElement('div');
            agencyList.className = 'agency-list';
            agencies.sort((a,b) => a.Agency.localeCompare(b.Agency));
            agencies.forEach(ag => {
                const agencyDiv = document.createElement('div');
                agencyDiv.className = 'agency-title';
                agencyDiv.textContent = ag.Agency;
                agencyDiv.addEventListener('click', () => {
                    const facs = facilitiesData.filter(f => f.Agency === ag.Agency);
                    showFacilities(ag, facs);
                });
                agencyList.appendChild(agencyDiv);
            });

            cogSection.appendChild(cogHeader);
            cogSection.appendChild(agencyList);
            listingElement.appendChild(cogSection);
        }
    }
}

// Show facilities for an agency
function showFacilities(agency, facilityList) {
    const listingElement = document.getElementById('listing');
    const dashboardElement = document.getElementById('dashboard');
    const agencyDataElement = document.getElementById('agency-data');
    const facilityDataElement = document.getElementById('facility-data');
    const introSection = document.getElementById('intro-section');
    const agencyFilters = document.getElementById('agency-filters');
    const facilityFilters = document.getElementById('facility-filters');

    listingElement.innerHTML = '';

    // Back button
    const backButton = document.createElement('button');
    backButton.id = 'back-button';
    backButton.textContent = 'Back to Agencies';
    backButton.onclick = () => {
        dashboardElement.style.display = 'none';
        renderListing();
    };
    listingElement.appendChild(backButton);

    // Title
    const header = document.createElement('h4');
    header.textContent = `Facilities in ${agency.Agency}`;
    listingElement.appendChild(header);

    // Filter facility data
    const filteredFacilities = filterFacilityData(facilityList);
    if (filteredFacilities.length > 0) {
        filteredFacilities.forEach(f => {
            const facilityDiv = document.createElement('div');
            facilityDiv.className = 'facility-title';
            facilityDiv.textContent = f["Facility Name"];
            facilityDiv.onclick = () => showFacilityDetails(f.Agency, f["Facility Name"]);
            listingElement.appendChild(facilityDiv);
        });
    } else {
        const noFacilitiesMsg = document.createElement('div');
        noFacilitiesMsg.id = 'no-facilities-msg';
        noFacilitiesMsg.textContent = 'No facilities found matching the selected filters.';
        listingElement.appendChild(noFacilitiesMsg);
    }

    introSection.style.display = 'none';
    agencyFilters.style.display = 'none';
    facilityFilters.style.display = 'block';

    dashboardElement.style.display = 'block';
    agencyDataElement.style.display = 'block';
    facilityDataElement.style.display = 'none';

    updateAgencyDashboard(agency);
}

// Filter facility data by user checkboxes
function filterFacilityData(facilities) {
    const pvChecked = document.getElementById('pv-filter').checked;
    const evChecked = document.getElementById('ev-filter').checked;
    const coolChecked = document.getElementById('cooling-filter').checked;

    return facilities.filter(f => {
        const hasPV = (f["Exisiting PV or Battery Storage Capabilities"] || "").toLowerCase() !== 'not yet available'
                      && (f["Exisiting PV or Battery Storage Capabilities"] || "").toLowerCase() !== 'no';
        const hasEV = (f["Existing EV Chargers"] || "").toLowerCase() !== 'not yet available'
                      && (f["Existing EV Chargers"] || "").toLowerCase() !== 'no'
                      && (f["Existing EV Chargers"] || "") !== '0';
        const hasCooling = (f["Existing Resilience Designation"] || "").toLowerCase() !== 'not yet available'
                           && (f["Existing Resilience Designation"] || "").toLowerCase() !== 'no';

        const passPV = !pvChecked || hasPV;
        const passEV = !evChecked || hasEV;
        const passCool = !coolChecked || hasCooling;
        return passPV && passEV && passCool;
    });
}

// Show facility details
function showFacilityDetails(agencyName, facilityName) {
    const facility = facilitiesData.find(f => 
        f.Agency === agencyName && f["Facility Name"] === facilityName
    );
    if (!facility) return;

    document.getElementById('facility-data').style.display = 'block';
    document.getElementById('agency-data').style.display = 'none';
    document.getElementById('data-overview-title').textContent = facilityName;

    document.getElementById('facility-year').textContent = normalizeValue(facility["Year Built"]);
    document.getElementById('facility-sqft').textContent = normalizeValue(facility["Gross Floor Area (sq ft)"]);
    document.getElementById('facility-walkability').textContent = normalizeValue(facility["Walkability"]);
    document.getElementById('facility-resilience').textContent = normalizeValue(facility["Existing Resilience Designation"]);
    document.getElementById('facility-ev').textContent = normalizeValue(facility["Existing EV Chargers"]);
    document.getElementById('facility-planned-ev').textContent = normalizeValue(facility["Number of Planned EV Chargers"]);
    document.getElementById('facility-pv').textContent = normalizeValue(facility["Exisiting PV or Battery Storage Capabilities"]);
    document.getElementById('facility-planned-pv').textContent = normalizeValue(facility["Planned PV (hours of autonomy)"]);
    document.getElementById('facility-planned-battery').textContent = normalizeValue(facility["Planned Battery Storage (hours of autonomy)"]);
    document.getElementById('facility-type').textContent = normalizeValue(facility["Building Type"]);

    // highlight
    const facilityEls = document.querySelectorAll('.facility-title');
    facilityEls.forEach(el => {
        el.classList.toggle('active', el.textContent.trim() === facilityName);
    });

    // Center map
    const lat = parseCoordinate(facility["Latitude"]);
    const lon = parseCoordinate(facility["Longitude"]);
    if (lat !== null && lon !== null) {
        map.flyTo({ center: [lon, lat], zoom: 15 });
    }
}

// Show agency data
function updateAgencyDashboard(agency) {
    document.getElementById('data-overview-title').textContent = `${agency.Agency} Data Overview`;
    document.getElementById('agency-underserved').textContent = normalizeValue(agency["Underserved and/or  Hard to Reach"]);
    document.getElementById('agency-calenviroscore').textContent = normalizeValue(agency["CalEnviroScreen Score"]);
    document.getElementById('agency-pollutionburden').textContent = normalizeValue(agency["Pollution Burden Percentile"]);

    // population
    let popVal = normalizeValue(agency["Population"]);
    if (!isNaN(parseInt(popVal))) popVal = parseInt(popVal).toLocaleString();
    document.getElementById('agency-population').textContent = popVal;

    document.getElementById('agency-children-seniors').textContent = normalizeValue(agency["% Children and Seniors"]);
    document.getElementById('agency-area').textContent = normalizeValue(agency["AgencyArea (sq miles)"]);

    // density
    let denVal = normalizeValue(agency["Population Density (per sq. mile)"]);
    if (!isNaN(parseInt(denVal))) denVal = parseInt(denVal).toLocaleString();
    document.getElementById('agency-density').textContent = denVal;

    document.getElementById('agency-heat-days').textContent = normalizeValue(agency["Extreme Heat Days (days/year)"]);

    // income
    let incVal = normalizeValue(agency["Average Household Income ($)"]);
    if (!isNaN(parseInt(incVal))) incVal = parseInt(incVal).toLocaleString();
    document.getElementById('agency-income').textContent = incVal;

    document.getElementById('agency-low-income').textContent = normalizeValue(agency["% Low-Income Census Tracts"]);
    document.getElementById('agency-circuits').textContent = normalizeValue(agency["# of Electric Circuits"]);

    // kwh
    let kwhVal = normalizeValue(agency["Annual  Consumption (kWh)"]);
    if (!isNaN(parseInt(kwhVal))) kwhVal = parseInt(kwhVal).toLocaleString();
    document.getElementById('agency-kwh').textContent = kwhVal;

    // therms
    let thermVal = normalizeValue(agency["Annual Consumption (Therms)"]);
    if (!isNaN(parseInt(thermVal))) thermVal = parseInt(thermVal).toLocaleString();
    document.getElementById('agency-therms').textContent = thermVal;
}

// Filter agencies
function filterAgencies() {
    const minPop = parseInt(document.getElementById('population-min').value) || 0;
    const maxPop = parseInt(document.getElementById('population-max').value) || Infinity;
    const searchText = document.getElementById('agency-filter').value.toLowerCase().trim();
    const dacFilter = document.getElementById('dac-filter').checked;
    const ces90Filter = document.getElementById('ces90-filter').checked;

    const filtered = agenciesData.filter(a => {
        // search
        const matchSearch = searchText === '' || a.Agency.toLowerCase().includes(searchText);
        // population
        const pop = Number(a["Population"]) || 0;
        const matchPop = (pop >= minPop && pop <= maxPop);
        // DAC
        const isUnderserved = (a["Underserved and/or  Hard to Reach"] || "").toLowerCase() === 'yes';
        const matchDAC = !dacFilter || isUnderserved;
        // CES
        const calVal = Number(a["CalEnviroScreen Score"]) || 0;
        const matchCal = !ces90Filter || (calVal > 90);

        return matchSearch && matchPop && matchDAC && matchCal;
    });

    const listingElement = document.getElementById('listing');
    listingElement.innerHTML = '';

    // group by COG
    const groupByCOG = {};
    filtered.forEach(ag => {
        const c = ag["Council of Government"];
        if (!groupByCOG[c]) groupByCOG[c] = [];
        groupByCOG[c].push(ag);
    });

    for (const [cog, agencies] of Object.entries(groupByCOG)) {
        if (agencies.length > 0) {
            const cogSection = document.createElement('div');
            cogSection.className = 'cog-section';

            const cogHeader = document.createElement('div');
            cogHeader.className = 'cog-header';
            cogHeader.textContent = cog;
            cogHeader.addEventListener('click', () => {
                cogHeader.classList.toggle('expanded');
                agencyList.style.display = agencyList.style.display === 'none' ? 'block' : 'none';
            });

            const agencyList = document.createElement('div');
            agencyList.className = 'agency-list';
            agencyList.style.display = 'block';

            agencies.sort((a,b) => a.Agency.localeCompare(b.Agency));
            agencies.forEach(a => {
                const agencyDiv = document.createElement('div');
                agencyDiv.className = 'agency-title';
                agencyDiv.textContent = a.Agency;
                agencyDiv.onclick = () => {
                    const facs = facilitiesData.filter(f => f.Agency === a.Agency);
                    showFacilities(a, facs);
                };
                agencyList.appendChild(agencyDiv);
            });

            cogSection.appendChild(cogHeader);
            cogSection.appendChild(agencyList);
            listingElement.appendChild(cogSection);
        }
    }
    const introSection = document.getElementById('intro-section');
    introSection.style.display = filtered.length > 0 ? 'block' : 'none';
}

// Refresh facility list if user toggles facility filters
function refreshFacilityList() {
    // find current agency
    const title = document.querySelector('#data-overview-title').textContent;
    let currentAgency = agenciesData.find(a => title.includes(a.Agency));
    if (currentAgency) {
        const facs = facilitiesData.filter(f => f.Agency === currentAgency.Agency);
        showFacilities(currentAgency, facs);
    }
}

// Close welcome popup
function closeWelcome() {
    const popup = document.getElementById('welcome-popup');
    popup.classList.add('fade-out');
    setTimeout(() => {
        popup.style.display = 'none';
    }, 400);
}

// Map Style
document.getElementById('style-selector').addEventListener('change', (e) => {
    map.setStyle(e.target.value);
});

// FILTER events
document.getElementById('population-min').addEventListener('input', filterAgencies);
document.getElementById('population-max').addEventListener('input', filterAgencies);
document.getElementById('agency-filter').addEventListener('input', filterAgencies);
document.getElementById('dac-filter').addEventListener('change', filterAgencies);
document.getElementById('ces90-filter').addEventListener('change', filterAgencies);

// facility filter
document.getElementById('pv-filter').addEventListener('change', refreshFacilityList);
document.getElementById('ev-filter').addEventListener('change', refreshFacilityList);
document.getElementById('cooling-filter').addEventListener('change', refreshFacilityList);

// On DOM load, also render listing
document.addEventListener('DOMContentLoaded', () => {
    renderListing();
});
</script>
</body>
</html>
